"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("lodash"),t=require("events"),r=require("fs"),n=require("moment"),s=require("stream"),o=require("@shelacek/ubjson"),a=require("net"),i=require("reconnect-core"),l=require("iconv-lite"),c=require("path"),u=require("semver");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function m(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,t}var h=p(r),E=p(n),T=p(a),f=p(i),d=p(l),A=p(c),_=p(u),S={0:{name:"Captain Falcon",shortName:"Falcon",colors:["Black","Red","White","Green","Blue"]},1:{name:"Donkey Kong",shortName:"DK",colors:["Black","Red","Blue","Green"]},2:{name:"Fox",colors:["Red","Blue","Green"]},3:{name:"Mr. Game & Watch",shortName:"G&W",colors:["Red","Blue","Green"]},4:{name:"Kirby",colors:["Yellow","Blue","Red","Green","White"]},5:{name:"Bowser",colors:["Red","Blue","Black"]},6:{name:"Link",colors:["Red","Blue","Black","White"]},7:{name:"Luigi",colors:["White","Blue","Red"]},8:{name:"Mario",colors:["Yellow","Black","Blue","Green"]},9:{name:"Marth",colors:["Red","Green","Black","White"]},10:{name:"Mewtwo",colors:["Red","Blue","Green"]},11:{name:"Ness",colors:["Yellow","Blue","Green"]},12:{name:"Peach",colors:["Daisy","White","Blue","Green"]},13:{name:"Pikachu",colors:["Red","Party Hat","Cowboy Hat"]},14:{name:"Ice Climbers",shortName:"ICs",colors:["Green","Orange","Red"]},15:{name:"Jigglypuff",shortName:"Puff",colors:["Red","Blue","Headband","Crown"]},16:{name:"Samus",colors:["Pink","Black","Green","Purple"]},17:{name:"Yoshi",colors:["Red","Blue","Yellow","Pink","Cyan"]},18:{name:"Zelda",colors:["Red","Blue","Green","White"]},19:{name:"Sheik",colors:["Red","Blue","Green","White"]},20:{name:"Falco",colors:["Red","Blue","Green"]},21:{name:"Young Link",shortName:"YLink",colors:["Red","Blue","White","Black"]},22:{name:"Dr. Mario",shortName:"Doc",colors:["Red","Blue","Green","Black"]},23:{name:"Roy",colors:["Red","Blue","Green","Yellow"]},24:{name:"Pichu",colors:["Red","Blue","Green"]},25:{name:"Ganondorf",shortName:"Ganon",colors:["Red","Blue","Green","Purple"]},26:{name:"Master Hand"},27:{name:"Wireframe (Male)"},28:{name:"Wireframe (Female)"},29:{name:"Gigabowser"},30:{name:"Crazy Hand"},31:{name:"Sandbag"},32:{name:"Popo"}};const C={id:-1,name:"Unknown Character",shortName:"Unknown",colors:["Default"]};function R(e,t){var r,n;return t?{id:e,name:t.name,shortName:null!=(r=t.shortName)?r:t.name,colors:["Default",...null!=(n=t.colors)?n:[]]}:C}function N(e){const t=S[e.toString()];return R(e,t)}var g={__proto__:null,UnknownCharacter:C,getAllCharacters:function(){return Object.entries(S).map((([e,t])=>R(parseInt(e,10),t))).sort(((e,t)=>e.id-t.id))},getCharacterInfo:N,getCharacterShortName:function(e){return N(e).shortName},getCharacterName:function(e){return N(e).name},getCharacterColorName:function(e,t){return N(e).colors[t]||"Default"}},I={1:{name:"Miscellaneous",shortName:"misc"},2:{name:"Jab",shortName:"jab"},3:{name:"Jab",shortName:"jab"},4:{name:"Jab",shortName:"jab"},5:{name:"Rapid Jabs",shortName:"rapid-jabs"},6:{name:"Dash Attack",shortName:"dash"},7:{name:"Forward Tilt",shortName:"ftilt"},8:{name:"Up Tilt",shortName:"utilt"},9:{name:"Down Tilt",shortName:"dtilt"},10:{name:"Forward Smash",shortName:"fsmash"},11:{name:"Up Smash",shortName:"usmash"},12:{name:"Down Smash",shortName:"dsmash"},13:{name:"Neutral Air",shortName:"nair"},14:{name:"Forward Air",shortName:"fair"},15:{name:"Back Air",shortName:"bair"},16:{name:"Up Air",shortName:"uair"},17:{name:"Down Air",shortName:"dair"},18:{name:"Neutral B",shortName:"neutral-b"},19:{name:"Side B",shortName:"side-b"},20:{name:"Up B",shortName:"up-b"},21:{name:"Down B",shortName:"down-b"},50:{name:"Getup Attack",shortName:"getup"},51:{name:"Getup Attack (Slow)",shortName:"getup-slow"},52:{name:"Grab Pummel",shortName:"pummel"},53:{name:"Forward Throw",shortName:"fthrow"},54:{name:"Back Throw",shortName:"bthrow"},55:{name:"Up Throw",shortName:"uthrow"},56:{name:"Down Throw",shortName:"dthrow"},61:{name:"Edge Attack (Slow)",shortName:"edge-slow"},62:{name:"Edge Attack",shortName:"edge"}};const D={id:-1,name:"Unknown Move",shortName:"unknown"};function O(e){const t=I[e.toString()];return t?{id:e,name:t.name,shortName:t.shortName}:D}var x={__proto__:null,UnknownMove:D,getMoveInfo:O,getMoveShortName:function(e){return O(e).shortName},getMoveName:function(e){return O(e).name}},y={2:"Fountain of Dreams",3:"Pokémon Stadium",4:"Princess Peach's Castle",5:"Kongo Jungle",6:"Brinstar",7:"Corneria",8:"Yoshi's Story",9:"Onett",10:"Mute City",11:"Rainbow Cruise",12:"Jungle Japes",13:"Great Bay",14:"Hyrule Temple",15:"Brinstar Depths",16:"Yoshi's Island",17:"Green Greens",18:"Fourside",19:"Mushroom Kingdom I",20:"Mushroom Kingdom II",22:"Venom",23:"Poké Floats",24:"Big Blue",25:"Icicle Mountain",26:"Icetop",27:"Flat Zone",28:"Dream Land N64",29:"Yoshi's Island N64",30:"Kongo Jungle N64",31:"Battlefield",32:"Final Destination",33:"Target Test (Mario)",34:"Target Test (Captain Falcon)",35:"Target Test (Young Link)",36:"Target Test (Donkey Kong)",37:"Target Test (Dr. Mario)",38:"Target Test (Falco)",39:"Target Test (Fox)",40:"Target Test (Ice Climbers)",41:"Target Test (Kirby)",42:"Target Test (Bowser)",43:"Target Test (Link)",44:"Target Test (Luigi)",45:"Target Test (Marth)",46:"Target Test (Mewtwo)",47:"Target Test (Ness)",48:"Target Test (Peach)",49:"Target Test (Pichu)",50:"Target Test (Pikachu)",51:"Target Test (Jigglypuff)",52:"Target Test (Samus)",53:"Target Test (Sheik)",54:"Target Test (Yoshi)",55:"Target Test (Zelda)",56:"Target Test (Mr. Game & Watch)",57:"Target Test (Roy)",58:"Target Test (Ganondorf)",84:"Home-Run Contest"};const F={id:-1,name:"Unknown Stage"};function G(e){const t=y[e.toString()];return t?{id:e,name:t}:F}var B,M,L,P={__proto__:null,UnknownStage:F,getStageInfo:G,getStageName:function(e){return G(e).name}};exports.Character=void 0,(B=exports.Character||(exports.Character={}))[B.CAPTAIN_FALCON=0]="CAPTAIN_FALCON",B[B.DONKEY_KONG=1]="DONKEY_KONG",B[B.FOX=2]="FOX",B[B.GAME_AND_WATCH=3]="GAME_AND_WATCH",B[B.KIRBY=4]="KIRBY",B[B.BOWSER=5]="BOWSER",B[B.LINK=6]="LINK",B[B.LUIGI=7]="LUIGI",B[B.MARIO=8]="MARIO",B[B.MARTH=9]="MARTH",B[B.MEWTWO=10]="MEWTWO",B[B.NESS=11]="NESS",B[B.PEACH=12]="PEACH",B[B.PIKACHU=13]="PIKACHU",B[B.ICE_CLIMBERS=14]="ICE_CLIMBERS",B[B.JIGGLYPUFF=15]="JIGGLYPUFF",B[B.SAMUS=16]="SAMUS",B[B.YOSHI=17]="YOSHI",B[B.ZELDA=18]="ZELDA",B[B.SHEIK=19]="SHEIK",B[B.FALCO=20]="FALCO",B[B.YOUNG_LINK=21]="YOUNG_LINK",B[B.DR_MARIO=22]="DR_MARIO",B[B.ROY=23]="ROY",B[B.PICHU=24]="PICHU",B[B.GANONDORF=25]="GANONDORF",B[B.MASTER_HAND=26]="MASTER_HAND",B[B.WIREFRAME_MALE=27]="WIREFRAME_MALE",B[B.WIREFRAME_FEMALE=28]="WIREFRAME_FEMALE",B[B.GIGA_BOWSER=29]="GIGA_BOWSER",B[B.CRAZY_HAND=30]="CRAZY_HAND",B[B.SANDBAG=31]="SANDBAG",B[B.POPO=32]="POPO",exports.Stage=void 0,(M=exports.Stage||(exports.Stage={}))[M.FOUNTAIN_OF_DREAMS=2]="FOUNTAIN_OF_DREAMS",M[M.POKEMON_STADIUM=3]="POKEMON_STADIUM",M[M.PEACHS_CASTLE=4]="PEACHS_CASTLE",M[M.KONGO_JUNGLE=5]="KONGO_JUNGLE",M[M.BRINSTAR=6]="BRINSTAR",M[M.CORNERIA=7]="CORNERIA",M[M.YOSHIS_STORY=8]="YOSHIS_STORY",M[M.ONETT=9]="ONETT",M[M.MUTE_CITY=10]="MUTE_CITY",M[M.RAINBOW_CRUISE=11]="RAINBOW_CRUISE",M[M.JUNGLE_JAPES=12]="JUNGLE_JAPES",M[M.GREAT_BAY=13]="GREAT_BAY",M[M.HYRULE_TEMPLE=14]="HYRULE_TEMPLE",M[M.BRINSTAR_DEPTHS=15]="BRINSTAR_DEPTHS",M[M.YOSHIS_ISLAND=16]="YOSHIS_ISLAND",M[M.GREEN_GREENS=17]="GREEN_GREENS",M[M.FOURSIDE=18]="FOURSIDE",M[M.MUSHROOM_KINGDOM=19]="MUSHROOM_KINGDOM",M[M.MUSHROOM_KINGDOM_2=20]="MUSHROOM_KINGDOM_2",M[M.VENOM=22]="VENOM",M[M.POKE_FLOATS=23]="POKE_FLOATS",M[M.BIG_BLUE=24]="BIG_BLUE",M[M.ICICLE_MOUNTAIN=25]="ICICLE_MOUNTAIN",M[M.ICETOP=26]="ICETOP",M[M.FLAT_ZONE=27]="FLAT_ZONE",M[M.DREAMLAND=28]="DREAMLAND",M[M.YOSHIS_ISLAND_N64=29]="YOSHIS_ISLAND_N64",M[M.KONGO_JUNGLE_N64=30]="KONGO_JUNGLE_N64",M[M.BATTLEFIELD=31]="BATTLEFIELD",M[M.FINAL_DESTINATION=32]="FINAL_DESTINATION",M[M.TARGET_TEST_MARIO=33]="TARGET_TEST_MARIO",M[M.TARGET_TEST_CAPTAIN_FALCON=34]="TARGET_TEST_CAPTAIN_FALCON",M[M.TARGET_TEST_YOUNG_LINK=35]="TARGET_TEST_YOUNG_LINK",M[M.TARGET_TEST_DONKEY_KONG=36]="TARGET_TEST_DONKEY_KONG",M[M.TARGET_TEST_DR_MARIO=37]="TARGET_TEST_DR_MARIO",M[M.TARGET_TEST_FALCO=38]="TARGET_TEST_FALCO",M[M.TARGET_TEST_FOX=39]="TARGET_TEST_FOX",M[M.TARGET_TEST_ICE_CLIMBERS=40]="TARGET_TEST_ICE_CLIMBERS",M[M.TARGET_TEST_KIRBY=41]="TARGET_TEST_KIRBY",M[M.TARGET_TEST_BOWSER=42]="TARGET_TEST_BOWSER",M[M.TARGET_TEST_LINK=43]="TARGET_TEST_LINK",M[M.TARGET_TEST_LUIGI=44]="TARGET_TEST_LUIGI",M[M.TARGET_TEST_MARTH=45]="TARGET_TEST_MARTH",M[M.TARGET_TEST_MEWTWO=46]="TARGET_TEST_MEWTWO",M[M.TARGET_TEST_NESS=47]="TARGET_TEST_NESS",M[M.TARGET_TEST_PEACH=48]="TARGET_TEST_PEACH",M[M.TARGET_TEST_PICHU=49]="TARGET_TEST_PICHU",M[M.TARGET_TEST_PIKACHU=50]="TARGET_TEST_PIKACHU",M[M.TARGET_TEST_JIGGLYPUFF=51]="TARGET_TEST_JIGGLYPUFF",M[M.TARGET_TEST_SAMUS=52]="TARGET_TEST_SAMUS",M[M.TARGET_TEST_SHEIK=53]="TARGET_TEST_SHEIK",M[M.TARGET_TEST_YOSHI=54]="TARGET_TEST_YOSHI",M[M.TARGET_TEST_ZELDA=55]="TARGET_TEST_ZELDA",M[M.TARGET_TEST_GAME_AND_WATCH=56]="TARGET_TEST_GAME_AND_WATCH",M[M.TARGET_TEST_ROY=57]="TARGET_TEST_ROY",M[M.TARGET_TEST_GANONDORF=58]="TARGET_TEST_GANONDORF",M[M.HOME_RUN_CONTEST=84]="HOME_RUN_CONTEST",exports.State=void 0,(L=exports.State||(exports.State={}))[L.DAMAGE_START=75]="DAMAGE_START",L[L.DAMAGE_END=91]="DAMAGE_END",L[L.CAPTURE_START=223]="CAPTURE_START",L[L.CAPTURE_END=232]="CAPTURE_END",L[L.GUARD_START=178]="GUARD_START",L[L.GUARD_END=182]="GUARD_END",L[L.GROUNDED_CONTROL_START=14]="GROUNDED_CONTROL_START",L[L.GROUNDED_CONTROL_END=24]="GROUNDED_CONTROL_END",L[L.SQUAT_START=39]="SQUAT_START",L[L.SQUAT_END=41]="SQUAT_END",L[L.DOWN_START=183]="DOWN_START",L[L.DOWN_END=198]="DOWN_END",L[L.TECH_START=199]="TECH_START",L[L.TECH_END=204]="TECH_END",L[L.DYING_START=0]="DYING_START",L[L.DYING_END=10]="DYING_END",L[L.CONTROLLED_JUMP_START=24]="CONTROLLED_JUMP_START",L[L.CONTROLLED_JUMP_END=34]="CONTROLLED_JUMP_END",L[L.GROUND_ATTACK_START=44]="GROUND_ATTACK_START",L[L.GROUND_ATTACK_END=64]="GROUND_ATTACK_END",L[L.AERIAL_ATTACK_START=65]="AERIAL_ATTACK_START",L[L.AERIAL_ATTACK_END=74]="AERIAL_ATTACK_END",L[L.ROLL_FORWARD=233]="ROLL_FORWARD",L[L.ROLL_BACKWARD=234]="ROLL_BACKWARD",L[L.SPOT_DODGE=235]="SPOT_DODGE",L[L.AIR_DODGE=236]="AIR_DODGE",L[L.ACTION_WAIT=14]="ACTION_WAIT",L[L.ACTION_DASH=20]="ACTION_DASH",L[L.ACTION_KNEE_BEND=24]="ACTION_KNEE_BEND",L[L.GUARD_ON=178]="GUARD_ON",L[L.TECH_MISS_UP=183]="TECH_MISS_UP",L[L.TECH_MISS_DOWN=191]="TECH_MISS_DOWN",L[L.NEUTRAL_TECH=199]="NEUTRAL_TECH",L[L.FORWARD_TECH=200]="FORWARD_TECH",L[L.BACKWARD_TECH=201]="BACKWARD_TECH",L[L.WALL_TECH=202]="WALL_TECH",L[L.MISSED_WALL_TECH=247]="MISSED_WALL_TECH",L[L.DASH=20]="DASH",L[L.TURN=18]="TURN",L[L.LANDING_FALL_SPECIAL=43]="LANDING_FALL_SPECIAL",L[L.JUMP_FORWARD=25]="JUMP_FORWARD",L[L.JUMP_BACKWARD=26]="JUMP_BACKWARD",L[L.FALL_FORWARD=30]="FALL_FORWARD",L[L.FALL_BACKWARD=31]="FALL_BACKWARD",L[L.GRAB=212]="GRAB",L[L.GRAB_WAIT=216]="GRAB_WAIT",L[L.PUMMEL=217]="PUMMEL",L[L.CLIFF_CATCH=252]="CLIFF_CATCH",L[L.THROW_UP=221]="THROW_UP",L[L.THROW_FORWARD=219]="THROW_FORWARD",L[L.THROW_DOWN=222]="THROW_DOWN",L[L.THROW_BACK=220]="THROW_BACK",L[L.DAMAGE_FALL=38]="DAMAGE_FALL",L[L.BARREL_WAIT=293]="BARREL_WAIT",L[L.COMMAND_GRAB_RANGE1_START=266]="COMMAND_GRAB_RANGE1_START",L[L.COMMAND_GRAB_RANGE1_END=304]="COMMAND_GRAB_RANGE1_END",L[L.COMMAND_GRAB_RANGE2_START=327]="COMMAND_GRAB_RANGE2_START",L[L.COMMAND_GRAB_RANGE2_END=338]="COMMAND_GRAB_RANGE2_END";const v={PUNISH_RESET_FRAMES:45,RECOVERY_RESET_FRAMES:45,COMBO_STRING_RESET_FRAMES:45};function U(e){return e&&2===e.players.length?[{playerIndex:e.players[0].playerIndex,opponentIndex:e.players[1].playerIndex},{playerIndex:e.players[1].playerIndex,opponentIndex:e.players[0].playerIndex}]:[]}function w(e,t){return!(!e||!t)&&t.stocksRemaining-e.stocksRemaining>0}function k(e){const t=e>=exports.State.GROUNDED_CONTROL_START&&e<=exports.State.GROUNDED_CONTROL_END,r=e>=exports.State.SQUAT_START&&e<=exports.State.SQUAT_END,n=e>exports.State.GROUND_ATTACK_START&&e<=exports.State.GROUND_ATTACK_END,s=e===exports.State.GRAB;return t||r||n||s}function b(e){return e>=exports.State.TECH_START&&e<=exports.State.TECH_END}function H(e){return e>=exports.State.DOWN_START&&e<=exports.State.DOWN_END}function W(e){return e>=exports.State.DAMAGE_START&&e<=exports.State.DAMAGE_END||e===exports.State.DAMAGE_FALL}function K(e){return e>=exports.State.CAPTURE_START&&e<=exports.State.CAPTURE_END}function Y(e){return(e>=exports.State.COMMAND_GRAB_RANGE1_START&&e<=exports.State.COMMAND_GRAB_RANGE1_END||e>=exports.State.COMMAND_GRAB_RANGE2_START&&e<=exports.State.COMMAND_GRAB_RANGE2_END)&&e!==exports.State.BARREL_WAIT}function J(e){return e>=exports.State.DYING_START&&e<=exports.State.DYING_END}function z(e,t){var r,n;return(null!=(r=e.percent)?r:0)-(null!=(n=t.percent)?n:0)}const $=[exports.State.DASH,exports.State.TURN,exports.State.DASH];class j{constructor(){this.playerPermutations=new Array,this.state=new Map}setup(e){this.state=new Map,this.playerPermutations=U(e),this.playerPermutations.forEach((e=>{this.state.set(e,{playerCounts:{playerIndex:e.playerIndex,wavedashCount:0,wavelandCount:0,airDodgeCount:0,dashDanceCount:0,spotDodgeCount:0,ledgegrabCount:0,rollCount:0,lCancelCount:{success:0,fail:0},grabCount:{success:0,fail:0},throwCount:{up:0,forward:0,back:0,down:0},groundTechCount:{away:0,in:0,neutral:0,fail:0},wallTechCount:{success:0,fail:0}},animations:[]})}))}processFrame(t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(t,r,n){const s=n.players[r.playerIndex].post,o=n.players[r.opponentIndex].post,a=(r,n)=>{if(!n)return;const s=e.get(t.playerCounts,r,0);e.set(t.playerCounts,r,s+1)},i=s.actionStateId;t.animations.push(i);const l=t.animations.slice(-3),c=l[l.length-2],u=i!==c;a("dashDanceCount",e.isEqual(l,$));const p=function(e,t){const r=Z(e),n=Z(t);return r&&!n}(i,c);a("rollCount",p);const m=function(e,t){const r=V(e),n=V(t);return r&&!n}(i,c);a("spotDodgeCount",m);const h=function(e,t){const r=X(e),n=X(t);return r&&!n}(i,c);a("airDodgeCount",h);const E=function(e,t){const r=q(e),n=q(t);return r&&!n}(i,c);a("ledgegrabCount",E);const T=function(e,t){return t===exports.State.GRAB&&e<=exports.State.GRAB_WAIT&&e>exports.State.GRAB}(i,c);a("grabCount.success",T);const f=function(e,t){return t===exports.State.GRAB&&(e>exports.State.GRAB_WAIT||e<exports.State.GRAB)}(i,c);if(a("grabCount.fail",f),a("throwCount.up",i===exports.State.THROW_UP&&u),a("throwCount.forward",i===exports.State.THROW_FORWARD&&u),a("throwCount.down",i===exports.State.THROW_DOWN&&u),a("throwCount.back",i===exports.State.THROW_BACK&&u),u){a("groundTechCount.fail",(d=i)===exports.State.TECH_MISS_DOWN||d===exports.State.TECH_MISS_UP);let e=1,t=!1;s.positionX>o.positionX&&(e=-1),s.facingDirection==e&&(t=!0),a("groundTechCount.in",i===exports.State.FORWARD_TECH&&t),a("groundTechCount.in",i===exports.State.BACKWARD_TECH&&!t),a("groundTechCount.neutral",i===exports.State.NEUTRAL_TECH),a("groundTechCount.away",i===exports.State.BACKWARD_TECH&&t),a("groundTechCount.away",i===exports.State.FORWARD_TECH&&!t),a("wallTechCount.success",i===exports.State.WALL_TECH),a("wallTechCount.fail",i===exports.State.MISSED_WALL_TECH)}var d;(function(e){return e>=exports.State.AERIAL_ATTACK_START&&e<=exports.State.AERIAL_ATTACK_END})(i)&&(a("lCancelCount.success",1===s.lCancelStatus),a("lCancelCount.fail",2===s.lCancelStatus)),function(t,r){const n=e.last(r)===exports.State.LANDING_FALL_SPECIAL,s=function(e){if(e===exports.State.AIR_DODGE)return!0;const t=e>=exports.State.CONTROLLED_JUMP_START,r=e<=exports.State.CONTROLLED_JUMP_END;return t&&r}(r[r.length-2]);if(!n||!s)return;const o=r.slice(-8),a=e.keyBy(o,(e=>e));2===e.size(a)&&a[exports.State.AIR_DODGE]||(a[exports.State.AIR_DODGE]&&(t.airDodgeCount-=1),a[exports.State.ACTION_KNEE_BEND]?t.wavedashCount+=1:t.wavelandCount+=1)}(t.playerCounts,t.animations)}(n,r,t)}))}fetch(){return Array.from(this.state.values()).map((e=>e.playerCounts))}}function Z(e){return e===exports.State.ROLL_BACKWARD||e===exports.State.ROLL_FORWARD}function V(e){return e===exports.State.SPOT_DODGE}function X(e){return e===exports.State.AIR_DODGE}function q(e){return e===exports.State.CLIFF_CATCH}var Q,ee,te,re,ne;!function(e){e.COMBO_START="COMBO_START",e.COMBO_EXTEND="COMBO_EXTEND",e.COMBO_END="COMBO_END"}(Q||(Q={}));class se extends t.EventEmitter{constructor(...e){super(...e),this.playerPermutations=new Array,this.state=new Map,this.combos=new Array,this.settings=null}setup(e){this.settings=e,this.state=new Map,this.combos=[],this.playerPermutations=U(e),this.playerPermutations.forEach((e=>{this.state.set(e,{combo:null,move:null,resetCounter:0,lastHitAnimation:null,event:null})}))}processFrame(t,r){this.playerPermutations.forEach((n=>{const s=this.state.get(n);s&&(function(e,t,r,n,s){const o=n.frame,a=n.players[r.playerIndex].post,i=n.players[r.opponentIndex].post,l=o-1;let c=null,u=null;e[l]&&(c=e[l].players[r.playerIndex].post,u=e[l].players[r.opponentIndex].post);const p=i.actionStateId,m=W(p),h=K(p),E=Y(p),T=u?z(i,u):0;if((a.actionStateId!==t.lastHitAnimation||a.actionStateCounter<(c?c.actionStateCounter:0))&&(t.lastHitAnimation=null),m||h||E){let e=!1;var f,d;t.combo||(t.combo={playerIndex:r.opponentIndex,startFrame:o,endFrame:null,startPercent:u&&null!=(f=u.percent)?f:0,currentPercent:null!=(d=i.percent)?d:0,endPercent:null,moves:[],didKill:!1,lastHitBy:r.playerIndex},s.push(t.combo),e=!0),T&&(null===t.lastHitAnimation&&(t.move={playerIndex:r.playerIndex,frame:o,moveId:a.lastAttackLanded,hitCount:0,damage:0},t.combo.moves.push(t.move),e||(t.event=Q.COMBO_EXTEND)),t.move&&(t.move.hitCount+=1,t.move.damage+=T),t.lastHitAnimation=c?c.actionStateId:null),e&&(t.event=Q.COMBO_START)}if(!t.combo)return;const A=b(p),_=H(p),S=u&&w(i,u),C=J(p);var R;S||(t.combo.currentPercent=null!=(R=i.percent)?R:0),m||h||E||A||_||C?t.resetCounter=0:t.resetCounter+=1;let N=!1;var g;S&&(t.combo.didKill=!0,N=!0),t.resetCounter>v.COMBO_STRING_RESET_FRAMES&&(N=!0),N&&(t.combo.endFrame=a.frame,t.combo.endPercent=u&&null!=(g=u.percent)?g:0,t.event=Q.COMBO_END,t.combo=null,t.move=null)}(r,s,n,t,this.combos),null!==s.event&&(this.emit(s.event,{combo:e.last(this.combos),settings:this.settings}),s.event=null))}))}fetch(){return this.combos}}class oe extends t.EventEmitter{constructor(){super(),this.playerPermutations=new Array,this.conversions=new Array,this.state=new Map,this.metadata=void 0,this.settings=null,this.metadata={lastEndFrameByOppIdx:{}}}setup(e){this.playerPermutations=U(e),this.conversions=[],this.state=new Map,this.metadata={lastEndFrameByOppIdx:{}},this.settings=e,this.playerPermutations.forEach((e=>{this.state.set(e,{conversion:null,move:null,resetCounter:0,lastHitAnimation:null})}))}processFrame(t,r){this.playerPermutations.forEach((n=>{const s=this.state.get(n);if(s){const o=function(e,t,r,n,s){const o=n.frame,a=n.players[r.playerIndex].post,i=n.players[r.opponentIndex].post,l=o-1;let c=null,u=null;e[l]&&(c=e[l].players[r.playerIndex].post,u=e[l].players[r.opponentIndex].post);const p=i.actionStateId,m=W(p),h=K(p),E=Y(p),T=u?z(i,u):0;var f,d;if((a.actionStateId!==t.lastHitAnimation||a.actionStateCounter<(c?c.actionStateCounter:0))&&(t.lastHitAnimation=null),(m||h||E)&&(t.conversion||(t.conversion={playerIndex:r.opponentIndex,lastHitBy:r.playerIndex,startFrame:o,endFrame:null,startPercent:u&&null!=(f=u.percent)?f:0,currentPercent:null!=(d=i.percent)?d:0,endPercent:null,moves:[],didKill:!1,openingType:"unknown"},s.push(t.conversion)),T&&(null===t.lastHitAnimation&&(t.move={playerIndex:r.playerIndex,frame:o,moveId:a.lastAttackLanded,hitCount:0,damage:0},t.conversion.moves.push(t.move)),t.move&&(t.move.hitCount+=1,t.move.damage+=T),t.lastHitAnimation=c?c.actionStateId:null)),!t.conversion)return!1;const A=k(p),_=u&&w(i,u);var S;_||(t.conversion.currentPercent=null!=(S=i.percent)?S:0),(m||h||E)&&(t.resetCounter=0),(0===t.resetCounter&&A||t.resetCounter>0)&&(t.resetCounter+=1);let C=!1;var R;return _&&(t.conversion.didKill=!0,C=!0),t.resetCounter>v.PUNISH_RESET_FRAMES&&(C=!0),C&&(t.conversion.endFrame=a.frame,t.conversion.endPercent=u&&null!=(R=u.percent)?R:0,t.conversion=null,t.move=null),C}(r,s,n,t,this.conversions);o&&this.emit("CONVERSION",{combo:e.last(this.conversions),settings:this.settings})}}))}fetch(){return this._populateConversionTypes(),this.conversions}_populateConversionTypes(){const t=e.filter(this.conversions,(e=>"unknown"===e.openingType)),r=e.groupBy(t,"startFrame");e.orderBy(r,(t=>e.get(t,[0,"startFrame"]))).forEach((t=>{const r=t.length>=2;t.forEach((t=>{if(this.metadata.lastEndFrameByOppIdx[t.playerIndex]=t.endFrame,r)return void(t.openingType="trade");const n=e.last(t.moves),s=this.metadata.lastEndFrameByOppIdx[n?n.playerIndex:t.playerIndex];t.openingType=s&&s>t.startFrame?"counter-attack":"neutral-win"}))}))}}exports.Command=void 0,(ee=exports.Command||(exports.Command={}))[ee.MESSAGE_SIZES=53]="MESSAGE_SIZES",ee[ee.GAME_START=54]="GAME_START",ee[ee.PRE_FRAME_UPDATE=55]="PRE_FRAME_UPDATE",ee[ee.POST_FRAME_UPDATE=56]="POST_FRAME_UPDATE",ee[ee.GAME_END=57]="GAME_END",ee[ee.ITEM_UPDATE=59]="ITEM_UPDATE",ee[ee.FRAME_BOOKEND=60]="FRAME_BOOKEND",exports.GameMode=void 0,(te=exports.GameMode||(exports.GameMode={}))[te.VS=2]="VS",te[te.ONLINE=8]="ONLINE",exports.Frames=void 0,(re=exports.Frames||(exports.Frames={}))[re.FIRST=-123]="FIRST",re[re.FIRST_PLAYABLE=-39]="FIRST_PLAYABLE",function(e){e[e.DZ=0]="DZ",e[e.NE=1]="NE",e[e.SE=2]="SE",e[e.SW=3]="SW",e[e.NW=4]="NW",e[e.N=5]="N",e[e.E=6]="E",e[e.S=7]="S",e[e.W=8]="W"}(ne||(ne={}));class ae{constructor(){this.state=new Map,this.playerPermutations=new Array}setup(e){this.state=new Map,this.playerPermutations=U(e),this.playerPermutations.forEach((e=>{this.state.set(e,{playerIndex:e.playerIndex,opponentIndex:e.opponentIndex,inputCount:0,joystickInputCount:0,cstickInputCount:0,buttonInputCount:0,triggerInputCount:0})}))}processFrame(e,t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(e,t,r,n){const s=n.players[r.playerIndex].pre,o=s.frame,a=o-1,i=e[a]?e[a].players[r.playerIndex].pre:null;if(o<exports.Frames.FIRST_PLAYABLE||!i)return;const l=function(e){let t,r=e;for(t=0;r;t+=1)r&=r-1;return t}(~i.physicalButtons&s.physicalButtons&4095);t.inputCount+=l,t.buttonInputCount+=l;const c=ie(i.joystickX,i.joystickY),u=ie(s.joystickX,s.joystickY);c!==u&&u!==ne.DZ&&(t.inputCount+=1,t.joystickInputCount+=1);const p=ie(i.cStickX,i.cStickY),m=ie(s.cStickX,s.cStickY);p!==m&&m!==ne.DZ&&(t.inputCount+=1,t.cstickInputCount+=1),i.physicalLTrigger<.3&&s.physicalLTrigger>=.3&&(t.inputCount+=1,t.triggerInputCount+=1),i.physicalRTrigger<.3&&s.physicalRTrigger>=.3&&(t.inputCount+=1,t.triggerInputCount+=1)}(t,n,r,e)}))}fetch(){return Array.from(this.state.values())}}function ie(e,t){let r=ne.DZ;return e>=.2875&&t>=.2875?r=ne.NE:e>=.2875&&t<=-.2875?r=ne.SE:e<=-.2875&&t<=-.2875?r=ne.SW:e<=-.2875&&t>=.2875?r=ne.NW:t>=.2875?r=ne.N:e>=.2875?r=ne.E:t<=-.2875?r=ne.S:e<=-.2875&&(r=ne.W),r}function le({settings:t,inputs:r,conversions:n,playableFrameCount:s}){const o=e.keyBy(r,"playerIndex"),a=n,i=e.groupBy(n,(e=>{var t;return null==(t=e.moves[0])?void 0:t.playerIndex})),l=e.mapValues(i,(t=>e.groupBy(t,"openingType"))),c=s/3600;return t.players.map((r=>{const n=r.playerIndex,s=e.get(o,n)||{},i={buttons:e.get(s,"buttonInputCount"),triggers:e.get(s,"triggerInputCount"),cstick:e.get(s,"cstickInputCount"),joystick:e.get(s,"joystickInputCount"),total:e.get(s,"inputCount")};let u=0,p=0;const m=t.players.filter((e=>e.playerIndex!==n&&(!t.isTeams||e.teamId!==r.teamId))).map((e=>e.playerIndex));let h=0,E=0;return a.filter((e=>e.playerIndex!==n)).forEach((e=>{u++,e.didKill&&e.lastHitBy===n&&(E+=1),e.moves.length>1&&e.moves[0].playerIndex===n&&p++,e.moves.forEach((e=>{e.playerIndex===n&&(h+=e.damage)}))})),{playerIndex:n,inputCounts:i,conversionCount:u,totalDamage:h,killCount:E,successfulConversions:ce(p,u),inputsPerMinute:ce(i.total,c),digitalInputsPerMinute:ce(i.buttons,c),openingsPerKill:ce(u,E),damagePerOpening:ce(h,u),neutralWinRatio:ue(l,n,m,"neutral-win"),counterHitRatio:ue(l,n,m,"counter-attack"),beneficialTradeRatio:pe(l,n,m)}}))}function ce(e,t){return{count:e,total:t,ratio:t?e/t:null}}function ue(t,r,n,s){const o=e.get(t,[r,s])||[],a=e.flatten(n.map((r=>e.get(t,[r,s])||[])));return ce(o.length,o.length+a.length)}function pe(t,r,n){const s=e.get(t,[r,"trade"])||[],o=e.flatten(n.map((r=>e.get(t,[r,"trade"])||[]))),a=[];return e.zip(s,o).forEach((t=>{const r=e.first(t),n=e.last(t);if(r&&n){const e=r.currentPercent-r.startPercent,t=n.currentPercent-n.startPercent;(r.didKill&&!n.didKill||e>t)&&a.push(r)}})),ce(a.length,s.length)}const me={processOnTheFly:!1};class he{constructor(e){this.options=void 0,this.lastProcessedFrame=null,this.frames={},this.players=[],this.allComputers=new Array,this.options=Object.assign({},me,e)}setup(e){this.frames={},this.players=e.players.map((e=>e.playerIndex)),this.allComputers.forEach((t=>t.setup(e)))}register(...e){this.allComputers.push(...e)}process(){if(0===this.players.length)return;let e=null!==this.lastProcessedFrame?this.lastProcessedFrame+1:exports.Frames.FIRST;for(;this.frames[e];){const t=this.frames[e];if(!Ee(this.players,t))return;this.allComputers.forEach((e=>e.processFrame(t,this.frames))),this.lastProcessedFrame=e,e++}}addFrame(e){this.frames[e.frame]=e,this.options.processOnTheFly&&this.process()}}function Ee(t,r){if(!r)return!1;for(const n of t)if(!e.get(r,["players",n,"post"]))return!1;return!0}class Te{constructor(){this.state=new Map,this.playerPermutations=new Array,this.stocks=new Array}setup(e){this.state=new Map,this.playerPermutations=U(e),this.stocks=[],this.playerPermutations.forEach((e=>{this.state.set(e,{stock:null})}))}processFrame(e,t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(e,t,r,n,s){const o=n.players[r.playerIndex].post,a=o.frame,i=a-1,l=e[i]?e[i].players[r.playerIndex].post:null;if(t.stock)if(l&&w(o,l)){var c;t.stock.endFrame=o.frame,t.stock.endPercent=null!=(c=l.percent)?c:0,t.stock.deathAnimation=o.actionStateId,t.stock=null}else{var u;t.stock.currentPercent=null!=(u=o.percent)?u:0}else{if(J(o.actionStateId))return;t.stock={playerIndex:r.playerIndex,startFrame:a,endFrame:null,startPercent:0,endPercent:null,currentPercent:0,count:o.stocksRemaining,deathAnimation:null},s.push(t.stock)}}(t,n,r,e,this.stocks)}))}fetch(){return this.stocks}}var fe,de,Ae,_e,Se;exports.CommunicationType=void 0,(fe=exports.CommunicationType||(exports.CommunicationType={}))[fe.HANDSHAKE=1]="HANDSHAKE",fe[fe.REPLAY=2]="REPLAY",fe[fe.KEEP_ALIVE=3]="KEEP_ALIVE";class Ce{constructor(){this.receiveBuf=Buffer.from([]),this.messages=new Array}receive(e){for(this.receiveBuf=Buffer.concat([this.receiveBuf,e]);this.receiveBuf.length>=4;){const e=this.receiveBuf.readUInt32BE(0);if(this.receiveBuf.length<e+4)return;const t=this.receiveBuf.slice(4,e+4);this.messages.push(o.decode(t)),this.receiveBuf=this.receiveBuf.slice(e+4)}}getReceiveBuffer(){return this.receiveBuf}getMessages(){const e=this.messages;return this.messages=[],e}genHandshakeOut(e,t,r=!1){const n=Buffer.from([0,0,0,0]);n.writeUInt32BE(t,0);const s={type:exports.CommunicationType.HANDSHAKE,payload:{cursor:e,clientToken:Uint8Array.from(n),isRealtime:r}},a=o.encode(s,{optimizeArrays:!0}),i=Buffer.concat([Buffer.from([0,0,0,0]),Buffer.from(a)]);return i.writeUInt32BE(a.byteLength,0),i}}exports.ConnectionEvent=void 0,(de=exports.ConnectionEvent||(exports.ConnectionEvent={})).CONNECT="connect",de.MESSAGE="message",de.HANDSHAKE="handshake",de.STATUS_CHANGE="statusChange",de.DATA="data",de.ERROR="error",exports.ConnectionStatus=void 0,(Ae=exports.ConnectionStatus||(exports.ConnectionStatus={}))[Ae.DISCONNECTED=0]="DISCONNECTED",Ae[Ae.CONNECTING=1]="CONNECTING",Ae[Ae.CONNECTED=2]="CONNECTED",Ae[Ae.RECONNECT_WAIT=3]="RECONNECT_WAIT",exports.Ports=void 0,(_e=exports.Ports||(exports.Ports={}))[_e.DEFAULT=51441]="DEFAULT",_e[_e.LEGACY=666]="LEGACY",_e[_e.RELAY_START=53741]="RELAY_START",function(e){e.INITIAL="initial",e.LEGACY="legacy",e.NORMAL="normal"}(Se||(Se={}));const Re={consoleNick:"unknown",gameDataCursor:Uint8Array.from([0,0,0,0,0,0,0,0]),version:"",clientToken:0},Ne={autoReconnect:!0};var ge,Ie,De;function Oe(t){const r=e.map(t,(e=>{return(t=e.charCodeAt(0))>65280&&t<65375?t-65280+32:12288===t?32:8217===t?39:8221===t?34:t;var t}));return String.fromCharCode(...r)}function xe(e,t,r,n,s){switch(e.source){case Ie.FILE:return h.default.readSync(e.fileDescriptor,t,r,n,s);case Ie.BUFFER:return e.buffer.copy(t,r,s,s+n);default:throw new Error("Source type not supported")}}function ye(e){switch(e.source){case Ie.FILE:return h.default.fstatSync(e.fileDescriptor).size;case Ie.BUFFER:return e.buffer.length;default:throw new Error("Source type not supported")}}function Fe(e){const t=function(e){switch(e.source){case Ie.FILE:if(!e.filePath)throw new Error("File source requires a file path");const t=h.default.openSync(e.filePath,"r");return{source:e.source,fileDescriptor:t};case Ie.BUFFER:return{source:e.source,buffer:e.buffer};default:throw new Error("Source type not supported")}}(e),r=function(e){const t=new Uint8Array(1);return xe(e,t,0,t.length,0),54===t[0]||t[0]!=="{".charCodeAt(0)?0:15}(t),n=function(e,t){const r=ye(e);if(0===t)return r;const n=new Uint8Array(4);xe(e,n,0,n.length,t-4);const s=n[0]<<24|n[1]<<16|n[2]<<8|n[3];return s>0?s:r-t}(t,r),s=r+n+10,o=function(e,t){return ye(e)-t-1}(t,s),a=function(e,t){const r={};if(0===t)return r[54]=320,r[55]=6,r[56]=70,r[57]=1,r;const n=new Uint8Array(2);if(xe(e,n,0,n.length,t),n[0]!==exports.Command.MESSAGE_SIZES)return{};const s=n[1];r[53]=s;const o=new Uint8Array(s-1);xe(e,o,0,o.length,t+2);for(let e=0;e<s-1;e+=3)r[o[e]]=o[e+1]<<8|o[e+2];return r}(t,r);return{ref:t,rawDataPosition:r,rawDataLength:n,metadataPosition:s,metadataLength:o,messageSizes:a}}function Ge(e){e.ref.source===Ie.FILE&&h.default.closeSync(e.ref.fileDescriptor)}function Be(e,t){const r=new DataView(t.buffer);switch(e){case exports.Command.GAME_START:const e=e=>{const n=8*e,s=Ue(r,321+n);let o="None";s!==Ue(r,325+n)?o="Mixed":1===s?o="UCF":2===s&&(o="Dween");const a=353+16*e,i=t.slice(a,a+16),l=d.default.decode(i,"Shift_JIS").split("\0").shift(),c=l?Oe(l):"",u=421+31*e,p=t.slice(u,u+31),m=d.default.decode(p,"Shift_JIS").split("\0").shift(),h=m?Oe(m):"",E=545+10*e,T=t.slice(E,E+10),f=d.default.decode(T,"Shift_JIS").split("\0").shift(),A=f?Oe(f):"",_=585+29*e,S=t.slice(_,_+29),C=d.default.decode(S,"utf8").split("\0").shift(),R=null!=C?C:"",N=36*e;return{playerIndex:e,port:e+1,characterId:ke(r,101+N),characterColor:ke(r,104+N),startStocks:ke(r,103+N),type:ke(r,102+N),teamId:ke(r,110+N),controllerFix:o,nametag:c,displayName:h,connectCode:A,userId:R}};return{slpVersion:`${ke(r,1)}.${ke(r,2)}.${ke(r,3)}`,isTeams:be(r,13),isPAL:be(r,417),stageId:we(r,19),players:[0,1,2,3].map(e),scene:ke(r,419),gameMode:ke(r,420)};case exports.Command.PRE_FRAME_UPDATE:return{frame:Pe(r,1),playerIndex:ke(r,5),isFollower:be(r,6),seed:Ue(r,7),actionStateId:we(r,11),positionX:Le(r,13),positionY:Le(r,17),facingDirection:Le(r,21),joystickX:Le(r,25),joystickY:Le(r,29),cStickX:Le(r,33),cStickY:Le(r,37),trigger:Le(r,41),buttons:Ue(r,45),physicalButtons:we(r,49),physicalLTrigger:Le(r,51),physicalRTrigger:Le(r,55),percent:Le(r,60)};case exports.Command.POST_FRAME_UPDATE:const n={airX:Le(r,53),y:Le(r,57),attackX:Le(r,61),attackY:Le(r,65),groundX:Le(r,69)};return{frame:Pe(r,1),playerIndex:ke(r,5),isFollower:be(r,6),internalCharacterId:ke(r,7),actionStateId:we(r,8),positionX:Le(r,10),positionY:Le(r,14),facingDirection:Le(r,18),percent:Le(r,22),shieldSize:Le(r,26),lastAttackLanded:ke(r,30),currentComboCount:ke(r,31),lastHitBy:ke(r,32),stocksRemaining:ke(r,33),actionStateCounter:Le(r,34),miscActionState:Le(r,43),isAirborne:be(r,47),lastGroundId:we(r,48),jumpsRemaining:ke(r,50),lCancelStatus:ke(r,51),hurtboxCollisionState:ke(r,52),selfInducedSpeeds:n};case exports.Command.ITEM_UPDATE:return{frame:Pe(r,1),typeId:we(r,5),state:ke(r,7),facingDirection:Le(r,8),velocityX:Le(r,12),velocityY:Le(r,16),positionX:Le(r,20),positionY:Le(r,24),damageTaken:we(r,28),expirationTimer:Le(r,30),spawnId:Ue(r,34),missileType:ke(r,38),turnipFace:ke(r,39),chargeShotLaunched:ke(r,40),chargePower:ke(r,41),owner:ve(r,42)};case exports.Command.FRAME_BOOKEND:return{frame:Pe(r,1),latestFinalizedFrame:Pe(r,5)};case exports.Command.GAME_END:return{gameEndMethod:ke(r,1),lrasInitiatorIndex:ve(r,2)};default:return null}}function Me(e,t,r){return t+r<=e.byteLength}function Le(e,t){return Me(e,t,4)?e.getFloat32(t):null}function Pe(e,t){return Me(e,t,4)?e.getInt32(t):null}function ve(e,t){return Me(e,t,1)?e.getInt8(t):null}function Ue(e,t){return Me(e,t,4)?e.getUint32(t):null}function we(e,t){return Me(e,t,2)?e.getUint16(t):null}function ke(e,t){return Me(e,t,1)?e.getUint8(t):null}function be(e,t){return Me(e,t,1)?!!e.getUint8(t):null}exports.DolphinMessageType=void 0,(ge=exports.DolphinMessageType||(exports.DolphinMessageType={})).CONNECT_REPLY="connect_reply",ge.GAME_EVENT="game_event",ge.START_GAME="start_game",ge.END_GAME="end_game",function(e){e.BUFFER="buffer",e.FILE="file"}(Ie||(Ie={})),exports.SlpStreamMode=void 0,(De=exports.SlpStreamMode||(exports.SlpStreamMode={})).AUTO="AUTO",De.MANUAL="MANUAL";const He={suppressErrors:!1,mode:exports.SlpStreamMode.AUTO};var We;exports.SlpStreamEvent=void 0,(We=exports.SlpStreamEvent||(exports.SlpStreamEvent={})).RAW="slp-raw",We.COMMAND="slp-command";class Ke extends s.Writable{constructor(e,t){super(t),this.gameEnded=!1,this.settings=void 0,this.payloadSizes=null,this.previousBuffer=Buffer.from([]),this.settings=Object.assign({},He,e)}restart(){this.gameEnded=!1,this.payloadSizes=null}_write(e,t,r){if("buffer"!==t)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${t}'.`);const n=Uint8Array.from(Buffer.concat([this.previousBuffer,e]));this.previousBuffer=Buffer.from([]);const s=new DataView(n.buffer);let o=0;for(;o<n.length;){if("HELO\0"===Buffer.from(n.slice(o,o+5)).toString()){o+=5;continue}const e=s.getUint8(o);let t=0;var a;if(this.payloadSizes&&(t=null!=(a=this.payloadSizes.get(e))?a:0),n.length-o<t+1){this.previousBuffer=n.slice(o);break}if(this.settings.mode===exports.SlpStreamMode.MANUAL&&this.gameEnded)break;o+=1;const r=n.slice(o),i=new DataView(n.buffer,o);let l=0;try{l=this._processCommand(e,r,i)}catch(e){if(!this.settings.suppressErrors)throw e;l=0}o+=l}r()}_writeCommand(e,t,r){const n=t.slice(0,r),s=Buffer.concat([Buffer.from([e]),n]);return this.emit(exports.SlpStreamEvent.RAW,{command:e,payload:s}),new Uint8Array(s)}_processCommand(e,t,r){if(e===exports.Command.MESSAGE_SIZES){const n=r.getUint8(0);return this.payloadSizes=Ye(r),this._writeCommand(e,t,n),this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:this.payloadSizes}),n}let n=0;var s;this.payloadSizes&&(n=null!=(s=this.payloadSizes.get(e))?s:0);let o,a=null;return n>0&&(o=this._writeCommand(e,t,n),a=Be(e,o)),a?(e===exports.Command.GAME_END&&this.settings.mode===exports.SlpStreamMode.MANUAL&&(this.gameEnded=!0),this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:a}),n):n}}const Ye=e=>{const t=new Map,r=e.getUint8(0);for(let n=1;n<r;n+=3){const r=e.getUint8(n),s=e.getUint16(n+1);t.set(r,s)}return t};class Je extends s.Writable{constructor(e,t,r){super(r),this.filePath=void 0,this.metadata=void 0,this.fileStream=null,this.rawDataLength=0,this.slpStream=void 0,this.usesExternalStream=!1,this.filePath=e,this.metadata={consoleNickname:"unknown",startTime:E.default(),lastFrame:-124,players:{}},this.usesExternalStream=Boolean(t),this.slpStream=t||new Ke({mode:exports.SlpStreamMode.MANUAL}),this._setupListeners(),this._initializeNewGame(this.filePath)}path(){return this.filePath}setMetadata(e){this.metadata=Object.assign({},this.metadata,e)}_write(e,t,r){if("buffer"!==t)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${t}'.`);this.fileStream&&this.fileStream.write(e),this.usesExternalStream||this.slpStream.write(e),this.rawDataLength+=e.length,r()}_onCommand(t){const{command:r,payload:n}=t;switch(r){case exports.Command.GAME_START:const{players:t}=n;e.forEach(t,(e=>{3!==e.type&&(this.metadata.players[e.playerIndex]={characterUsage:{},names:{netplay:e.displayName,code:e.connectCode}})}));break;case exports.Command.POST_FRAME_UPDATE:const{frame:r,playerIndex:s,isFollower:o,internalCharacterId:a}=n;if(o)break;this.metadata.lastFrame=r;const i=this.metadata.players[s],l=i.characterUsage,c=l[a]||0,u={...i,characterUsage:{...l,[a]:c+1}};this.metadata.players[s]=u}}_setupListeners(){const e=e=>{this._onCommand(e)};this.slpStream.on(exports.SlpStreamEvent.COMMAND,e),this.on("finish",(()=>{const t=h.default.openSync(this.filePath,"r+");h.default.writeSync(t,$e(this.rawDataLength),0,4,11),h.default.closeSync(t),this.slpStream.removeListener(exports.SlpStreamEvent.COMMAND,e),this.usesExternalStream||this.slpStream.end()}))}_initializeNewGame(e){this.fileStream=h.default.createWriteStream(e,{encoding:"binary"});const t=Buffer.concat([Buffer.from("{U"),Buffer.from([3]),Buffer.from("raw[$U#l"),Buffer.from([0,0,0,0])]);this.fileStream.write(t)}_final(t){let r=Buffer.concat([Buffer.from("U"),Buffer.from([8]),Buffer.from("metadata{")]);const n=this.metadata.startTime.toISOString();r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("startAtSU"),Buffer.from([n.length]),Buffer.from(n)]);const s=this.metadata.lastFrame;r=Buffer.concat([r,Buffer.from("U"),Buffer.from([9]),Buffer.from("lastFramel"),ze(s)]);const o=this.metadata.consoleNickname||"unknown";r=Buffer.concat([r,Buffer.from("U"),Buffer.from([11]),Buffer.from("consoleNickSU"),Buffer.from([o.length]),Buffer.from(o)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("players{")]),e.forEach(this.metadata.players,((t,n)=>{r=Buffer.concat([r,Buffer.from("U"),Buffer.from([n.length]),Buffer.from(`${n}{`)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([10]),Buffer.from("characters{")]),e.forEach(t.characterUsage,((e,t)=>{r=Buffer.concat([r,Buffer.from("U"),Buffer.from([t.length]),Buffer.from(`${t}l`),$e(e)])})),r=Buffer.concat([r,Buffer.from("}")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([5]),Buffer.from("names{")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("netplaySU"),Buffer.from([t.names.netplay.length]),Buffer.from(`${t.names.netplay}`)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([4]),Buffer.from("codeSU"),Buffer.from([t.names.code.length]),Buffer.from(`${t.names.code}`)]),r=Buffer.concat([r,Buffer.from("}}")])})),r=Buffer.concat([r,Buffer.from("}")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([8]),Buffer.from("playedOnSU"),Buffer.from([7]),Buffer.from("network")]),r=Buffer.concat([r,Buffer.from("}}")]),this.fileStream&&this.fileStream.write(r,t)}}const ze=e=>{const t=Buffer.alloc(4);return t.writeInt32BE(e,0),t},$e=e=>{const t=Buffer.alloc(4);return t.writeUInt32BE(e,0),t},je={outputFiles:!0,folderPath:".",consoleNickname:"unknown",newFilename:function(e,t){return A.default.join(e,`Game_${t.format("YYYYMMDD")}T${t.format("HHmmss")}.slp`)}};var Ze,Ve;exports.SlpFileWriterEvent=void 0,(Ze=exports.SlpFileWriterEvent||(exports.SlpFileWriterEvent={})).NEW_FILE="new-file",Ze.FILE_COMPLETE="file-complete";class Xe{constructor(){this.rollbackFrames={},this.rollbackFrameCount=0,this.rollbackPlayerIdx=null,this.lastFrameWasRollback=!1,this.currentRollbackLength=0,this.rollbackLengths=[]}checkIfRollbackFrame(e,t){if(null===this.rollbackPlayerIdx)this.rollbackPlayerIdx=t;else if(this.rollbackPlayerIdx!==t)return;return e?(this.rollbackFrames[e.frame]?this.rollbackFrames[e.frame].push(e):this.rollbackFrames[e.frame]=[e],this.rollbackFrameCount++,this.currentRollbackLength++,this.lastFrameWasRollback=!0):this.lastFrameWasRollback&&(this.rollbackLengths.push(this.currentRollbackLength),this.currentRollbackLength=0,this.lastFrameWasRollback=!1),this.lastFrameWasRollback}getFrames(){return this.rollbackFrames}getCount(){return this.rollbackFrameCount}getLengths(){return this.rollbackLengths}}exports.SlpParserEvent=void 0,(Ve=exports.SlpParserEvent||(exports.SlpParserEvent={})).SETTINGS="settings",Ve.END="end",Ve.FRAME="frame",Ve.FINALIZED_FRAME="finalized-frame",Ve.ROLLBACK_FRAME="rollback-frame";const qe={strict:!1};class Qe extends t.EventEmitter{constructor(e){super(),this.frames={},this.rollbackCounter=new Xe,this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1,this.options=void 0,this.options=Object.assign({},qe,e)}handleCommand(e,t){switch(e){case exports.Command.GAME_START:this._handleGameStart(t);break;case exports.Command.POST_FRAME_UPDATE:this._handlePostFrameUpdate(t),this._handleFrameUpdate(e,t);break;case exports.Command.PRE_FRAME_UPDATE:this._handleFrameUpdate(e,t);break;case exports.Command.ITEM_UPDATE:this._handleItemUpdate(t);break;case exports.Command.FRAME_BOOKEND:this._handleFrameBookend(t);break;case exports.Command.GAME_END:this._handleGameEnd(t)}}reset(){this.frames={},this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1}getLatestFrameNumber(){var e;return null!=(e=this.latestFrameIndex)?e:exports.Frames.FIRST-1}getPlayableFrameCount(){return null===this.latestFrameIndex||this.latestFrameIndex<exports.Frames.FIRST_PLAYABLE?0:this.latestFrameIndex-exports.Frames.FIRST_PLAYABLE}getLatestFrame(){const t=this.getFrames(),r=null!==this.latestFrameIndex?this.latestFrameIndex:exports.Frames.FIRST;return e.get(t,this.gameEnd?r:r-1)||null}getSettings(){return this.settingsComplete?this.settings:null}getGameEnd(){return this.gameEnd}getFrames(){return this.frames}getRollbackFrames(){return{frames:this.rollbackCounter.getFrames(),count:this.rollbackCounter.getCount(),lengths:this.rollbackCounter.getLengths()}}getFrame(e){return this.frames[e]||null}_handleGameEnd(e){null!==this.latestFrameIndex&&this.latestFrameIndex!==this.lastFinalizedFrame&&this._finalizeFrames(this.latestFrameIndex),this.gameEnd=e=e,this.emit(exports.SlpParserEvent.END,this.gameEnd)}_handleGameStart(e){this.settings=e,this.settings.players=e.players.filter((e=>3!==e.type)),e.slpVersion&&_.default.gte(e.slpVersion,"1.6.0")&&this._completeSettings()}_handlePostFrameUpdate(t){if(!this.settingsComplete){if(t.frame<=exports.Frames.FIRST){const r=t.playerIndex,n=e.keyBy(this.settings.players,"playerIndex");switch(t.internalCharacterId){case 7:n[r].characterId=19;break;case 19:n[r].characterId=18}}t.frame>exports.Frames.FIRST&&this._completeSettings()}}_handleFrameUpdate(t,r){r=r;const n=t===exports.Command.PRE_FRAME_UPDATE?"pre":"post",s=r.isFollower?"followers":"players",o=r.frame;if(this.latestFrameIndex=o,"pre"===n&&!r.isFollower){const e=this.frames[o];this.rollbackCounter.checkIfRollbackFrame(e,r.playerIndex)&&this.emit(exports.SlpParserEvent.ROLLBACK_FRAME,e)}e.set(this.frames,[o,s,r.playerIndex,n],r),e.set(this.frames,[o,"frame"],o);const a=this.getSettings();!a||a.slpVersion&&!_.default.lte(a.slpVersion,"2.2.0")?e.set(this.frames,[o,"isTransferComplete"],!1):(this.emit(exports.SlpParserEvent.FRAME,this.frames[o]),this._finalizeFrames(o-1))}_handleItemUpdate(t){var r,n;const s=t.frame,o=null!=(r=null==(n=this.frames[s])?void 0:n.items)?r:[];o.push(t),e.set(this.frames,[s,"items"],o)}_handleFrameBookend(t){const r=t.latestFinalizedFrame,n=t.frame;if(e.set(this.frames,[n,"isTransferComplete"],!0),this.emit(exports.SlpParserEvent.FRAME,this.frames[n]),this.settings.gameMode===exports.GameMode.ONLINE&&r>=exports.Frames.FIRST){if(this.options.strict&&r<n-7)throw new Error(`latestFinalizedFrame should be within 7 frames of ${n}`);this._finalizeFrames(r)}else this._finalizeFrames(n-7)}_finalizeFrames(e){for(;this.lastFinalizedFrame<e;){const t=this.lastFinalizedFrame+1,r=this.getFrame(t);if(this.options.strict)for(const n of this.settings.players){const s=r.players[n.playerIndex];if(this.settings.players.length>2&&!s)continue;const{pre:o,post:a}=s;if(!o||!a)throw new Error(`Could not finalize frame ${t} of ${e}: missing ${o?"pre":"post"}-frame update for player ${n.playerIndex}`)}this.emit(exports.SlpParserEvent.FINALIZED_FRAME,r),this.lastFinalizedFrame=t}}_completeSettings(){this.settingsComplete||(this.settingsComplete=!0,this.emit(exports.SlpParserEvent.SETTINGS,this.settings))}}exports.ActionsComputer=j,exports.ComboComputer=se,exports.ConsoleCommunication=Ce,exports.ConsoleConnection=class extends t.EventEmitter{constructor(e){super(),this.ipAddress=void 0,this.port=void 0,this.isRealtime=void 0,this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.connDetails={...Re},this.client=null,this.connection=null,this.options=void 0,this.shouldReconnect=!1,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT,this.isRealtime=!1,this.options=Object.assign({},Ne,e)}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{...this.connDetails}}connect(e,t,r=!1,n=2e4){this.ipAddress=e,this.port=t,this.isRealtime=r,this._connectOnPort(e,t,n)}_connectOnPort(e,t,r){const n=f.default((()=>T.default.connect({host:e,port:t,timeout:r})));this._setStatus(exports.ConnectionStatus.CONNECTING);const s=new Ce,o=n({initialDelay:2e3,maxDelay:1e4,strategy:"fibonacci",failAfter:Infinity},(n=>{var o;this.emit(exports.ConnectionEvent.CONNECT),this.shouldReconnect=this.options.autoReconnect,this.client=n;let a=Se.INITIAL;n.on("data",(r=>{if(a===Se.INITIAL&&(a=this._getInitialCommState(r),console.log(`Connected to ${e}:${t} with type: ${a}`),this._setStatus(exports.ConnectionStatus.CONNECTED),console.log(r.toString("hex"))),a===Se.LEGACY)return void this._handleReplayData(r);try{s.receive(r)}catch(e){return console.error("Failed to process new data from server...",{error:e,prevDataBuf:s.getReceiveBuffer(),rcvData:r}),n.destroy(),void this.emit(exports.ConnectionEvent.ERROR,e)}const o=s.getMessages();try{o.forEach((e=>this._processMessage(e)))}catch(e){console.error(e),n.destroy(),this.emit(exports.ConnectionEvent.ERROR,e)}})),n.on("timeout",(()=>{console.warn(`Attempted connection to ${e}:${t} timed out after ${r}ms`),n.destroy()})),n.on("end",(()=>{console.log("disconnect"),this.shouldReconnect||n.destroy()})),n.on("close",(()=>{console.log("connection was closed")}));const i=s.genHandshakeOut(this.connDetails.gameDataCursor,null!=(o=this.connDetails.clientToken)?o:0,this.isRealtime);n.write(i)})),a=()=>{this._setStatus(this.shouldReconnect?exports.ConnectionStatus.RECONNECT_WAIT:exports.ConnectionStatus.CONNECTING)};o.on("connect",a),o.on("reconnect",a),o.on("disconnect",(()=>{this.shouldReconnect||(o.reconnect=!1,o.disconnect(),this._setStatus(exports.ConnectionStatus.DISCONNECTED))})),o.on("error",(e=>{console.warn(`Connection on port ${t} encountered an error.`,e),this._setStatus(exports.ConnectionStatus.DISCONNECTED),this.emit(exports.ConnectionEvent.ERROR,`Connection on port ${t} encountered an error.\n${e}`)})),this.connection=o,o.connect(t)}disconnect(){this.connection&&(this.connection.reconnect=!1,this.connection.disconnect(),this.connection=null),this.client&&this.client.destroy()}_getInitialCommState(e){if(e.length<13)return Se.LEGACY;const t=Buffer.from([123,105,4,116,121,112,101,85,1]);return e.slice(4,13).equals(t)?Se.NORMAL:Se.LEGACY}_processMessage(e){switch(this.emit(exports.ConnectionEvent.MESSAGE,e),e.type){case exports.CommunicationType.KEEP_ALIVE:const t=Buffer.from("HELO\0");this._handleReplayData(t);break;case exports.CommunicationType.REPLAY:const r=Uint8Array.from(e.payload.pos),n=Buffer.compare(this.connDetails.gameDataCursor,r);if(!e.payload.forcePos&&0!==n)throw new Error(`Position of received data is incorrect. Expected: ${this.connDetails.gameDataCursor.toString()}, Received: ${r.toString()}`);e.payload.forcePos&&console.warn("Overflow occured in Nintendont, data has likely been skipped and replay corrupted. Expected, Received:",this.connDetails.gameDataCursor,r),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.nextPos);const s=Uint8Array.from(e.payload.data);this._handleReplayData(s);break;case exports.CommunicationType.HANDSHAKE:const{nick:o,nintendontVersion:a}=e.payload;o&&(this.connDetails.consoleNick=o);const i=Buffer.from(e.payload.clientToken);this.connDetails.clientToken=i.readUInt32BE(0),a&&(this.connDetails.version=a),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.pos),this.emit(exports.ConnectionEvent.HANDSHAKE,this.connDetails)}}_handleReplayData(e){this.emit(exports.ConnectionEvent.DATA,e)}_setStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}},exports.ConversionComputer=oe,exports.DolphinConnection=class extends t.EventEmitter{constructor(){super(),this.ipAddress=void 0,this.port=void 0,this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.gameCursor=0,this.nickname="unknown",this.version="",this.peer=null,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{consoleNick:this.nickname,gameDataCursor:this.gameCursor,version:this.version}}async connect(e,t){console.log(`Connecting to: ${e}:${t}`),this.ipAddress=e,this.port=t;const r=await Promise.resolve().then((function(){return m(require("enet"))})),n=r.createClient({peers:32,channels:3,down:0,up:0},(e=>{e&&console.error(e)}));this.peer=n.connect({address:this.ipAddress,port:this.port},3,1337,((e,t)=>{e?console.error(e):(t.ping(),this.emit(exports.ConnectionEvent.CONNECT),this._setStatus(exports.ConnectionStatus.CONNECTED))})),this.peer.on("connect",(()=>{this.gameCursor=0;const e=new r.Packet(JSON.stringify({type:"connect_request",cursor:this.gameCursor}),r.PACKET_FLAG.RELIABLE);this.peer.send(0,e)})),this.peer.on("message",(e=>{const t=e.data();if(0===t.length)return;const r=t.toString("ascii"),n=JSON.parse(r),{dolphin_closed:s}=n;if(s)this.disconnect();else switch(this.emit(exports.ConnectionEvent.MESSAGE,n),n.type){case exports.DolphinMessageType.CONNECT_REPLY:this.connectionStatus=exports.ConnectionStatus.CONNECTED,this.gameCursor=n.cursor,this.nickname=n.nick,this.version=n.version,this.emit(exports.ConnectionEvent.HANDSHAKE,this.getDetails());break;case exports.DolphinMessageType.GAME_EVENT:{const{payload:e}=n;if(!e)return void this.disconnect();this._updateCursor(n,r);const t=Buffer.from(e,"base64");this._handleReplayData(t);break}case exports.DolphinMessageType.START_GAME:case exports.DolphinMessageType.END_GAME:this._updateCursor(n,r)}})),this.peer.on("disconnect",(()=>{this.disconnect()})),this._setStatus(exports.ConnectionStatus.CONNECTING)}disconnect(){this.peer&&(this.peer.disconnect(),this.peer=null),this._setStatus(exports.ConnectionStatus.DISCONNECTED)}_handleReplayData(e){this.emit(exports.ConnectionEvent.DATA,e)}_setStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}_updateCursor(e,t){const{cursor:r,next_cursor:n}=e;if(this.gameCursor!==r){const e=new Error(`Unexpected game data cursor. Expected: ${this.gameCursor} but got: ${r}. Payload: ${t}`);console.warn(e),this.emit(exports.ConnectionEvent.ERROR,e)}this.gameCursor=n}},exports.InputComputer=ae,exports.MAX_ROLLBACK_FRAMES=7,exports.NETWORK_MESSAGE="HELO\0",exports.SlippiGame=class{constructor(e,t){if(this.input=void 0,this.metadata=null,this.finalStats=null,this.parser=void 0,this.readPosition=null,this.actionsComputer=new j,this.conversionComputer=new oe,this.comboComputer=new se,this.stockComputer=new Te,this.inputComputer=new ae,this.statsComputer=void 0,"string"==typeof e)this.input={source:Ie.FILE,filePath:e};else if(e instanceof Buffer)this.input={source:Ie.BUFFER,buffer:e};else{if(!(e instanceof ArrayBuffer))throw new Error("Cannot create SlippiGame with input of that type");this.input={source:Ie.BUFFER,buffer:Buffer.from(e)}}this.statsComputer=new he(t),this.statsComputer.register(this.actionsComputer,this.comboComputer,this.conversionComputer,this.inputComputer,this.stockComputer),this.parser=new Qe,this.parser.on(exports.SlpParserEvent.SETTINGS,(e=>{this.statsComputer.setup(e)})),this.parser.on(exports.SlpParserEvent.FINALIZED_FRAME,(e=>{this.statsComputer.addFrame(e)}))}_process(t=!1){if(null!==this.parser.getGameEnd())return;const r=Fe(this.input);this.readPosition=function(t,r,n=null){const s=t.ref;let o=null!==n&&n>0?n:t.rawDataPosition;const a=t.rawDataPosition+t.rawDataLength,i=e.mapValues(t.messageSizes,(e=>new Uint8Array(e+1))),l=new Uint8Array(1);for(;o<a;){xe(s,l,0,1,o);const e=l[0],t=i[e];if(void 0===t)return o;if(t.length>a-o)return o;if(xe(s,t,0,t.length,o),r(e,Be(e,t)))break;o+=t.length}return o}(r,((e,r)=>!!r&&(this.parser.handleCommand(e,r),t&&null!==this.parser.getSettings())),this.readPosition),Ge(r)}getSettings(){return this._process(!0),this.parser.getSettings()}getLatestFrame(){return this._process(),this.parser.getLatestFrame()}getGameEnd(){return this._process(),this.parser.getGameEnd()}getFrames(){return this._process(),this.parser.getFrames()}getRollbackFrames(){return this._process(),this.parser.getRollbackFrames()}getStats(){if(this.finalStats)return this.finalStats;this._process();const e=this.parser.getSettings();if(null===e)return null;this.statsComputer.process();const t=this.inputComputer.fetch(),r=this.stockComputer.fetch(),n=this.conversionComputer.fetch(),s=this.parser.getPlayableFrameCount(),o=le({settings:e,inputs:t,conversions:n,playableFrameCount:s}),a={lastFrame:this.parser.getLatestFrameNumber(),playableFrameCount:s,stocks:r,conversions:n,combos:this.comboComputer.fetch(),actionCounts:this.actionsComputer.fetch(),overall:o,gameComplete:null!==this.parser.getGameEnd()};return null!==this.parser.getGameEnd()&&(this.finalStats=a),a}getMetadata(){if(this.metadata)return this.metadata;const e=Fe(this.input);return this.metadata=function(e){if(e.metadataLength<=0)return null;const t=new Uint8Array(e.metadataLength);xe(e.ref,t,0,t.length,e.metadataPosition);let r=null;try{r=o.decode(t)}catch(e){}return r}(e),Ge(e),this.metadata}getFilePath(){var e;return this.input.source!==Ie.FILE?null:null!=(e=this.input.filePath)?e:null}},exports.SlpFile=Je,exports.SlpFileWriter=class extends Ke{constructor(e,t){super(e,t),this.currentFile=null,this.options=void 0,this.options=Object.assign({},je,e),this._setupListeners()}_writePayload(e){this.currentFile&&this.currentFile.write(e)}_setupListeners(){this.on(exports.SlpStreamEvent.RAW,(e=>{const{command:t,payload:r}=e;switch(t){case exports.Command.MESSAGE_SIZES:this._handleNewGame(),this._writePayload(r);break;case exports.Command.GAME_END:this._writePayload(r),this._handleEndGame();break;default:this._writePayload(r)}}))}getCurrentFilename(){return null!==this.currentFile?A.default.resolve(this.currentFile.path()):null}endCurrentFile(){this._handleEndGame()}updateSettings(e){this.options=Object.assign({},this.options,e)}_handleNewGame(){if(this.options.outputFiles){const e=this.options.newFilename(this.options.folderPath,E.default());this.currentFile=new Je(e,this),this.emit(exports.SlpFileWriterEvent.NEW_FILE,e)}}_handleEndGame(){this.currentFile&&(this.currentFile.setMetadata({consoleNickname:this.options.consoleNickname}),this.currentFile.end(),this.emit(exports.SlpFileWriterEvent.FILE_COMPLETE,this.currentFile.path()),this.currentFile=null)}},exports.SlpParser=Qe,exports.SlpStream=Ke,exports.Stats=he,exports.StockComputer=Te,exports.Timers=v,exports.animations={__proto__:null,getDeathDirection:function(e){if(e>10)return null;switch(e){case 0:return"down";case 1:return"left";case 2:return"right";default:return"up"}}},exports.calcDamageTaken=z,exports.characters=g,exports.didLoseStock=w,exports.generateOverallStats=le,exports.getSinglesPlayerPermutationsFromSettings=U,exports.isCommandGrabbed=Y,exports.isDamaged=W,exports.isDead=J,exports.isDown=H,exports.isGrabbed=K,exports.isInControl=k,exports.isTeching=b,exports.moves=x,exports.stages=P;
//# sourceMappingURL=slippi-js.cjs.production.min.js.map
