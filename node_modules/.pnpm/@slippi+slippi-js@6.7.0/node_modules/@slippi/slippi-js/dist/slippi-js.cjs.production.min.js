"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("lodash"),e=require("events"),r=require("date-fns"),n=require("fs"),s=require("stream"),o=require("@shelacek/ubjson"),a=require("net"),i=require("reconnect-core"),E=require("iconv-lite"),l=require("path"),T=require("semver");function c(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function u(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,e}var _=c(n),p=c(a),A=c(i),m=c(E),h=c(l),S=c(T),N={0:{name:"Captain Falcon",shortName:"Falcon",colors:["Black","Red","White","Green","Blue"]},1:{name:"Donkey Kong",shortName:"DK",colors:["Black","Red","Blue","Green"]},2:{name:"Fox",colors:["Red","Blue","Green"]},3:{name:"Mr. Game & Watch",shortName:"G&W",colors:["Red","Blue","Green"]},4:{name:"Kirby",colors:["Yellow","Blue","Red","Green","White"]},5:{name:"Bowser",colors:["Red","Blue","Black"]},6:{name:"Link",colors:["Red","Blue","Black","White"]},7:{name:"Luigi",colors:["White","Blue","Red"]},8:{name:"Mario",colors:["Yellow","Black","Blue","Green"]},9:{name:"Marth",colors:["Red","Green","Black","White"]},10:{name:"Mewtwo",colors:["Red","Blue","Green"]},11:{name:"Ness",colors:["Yellow","Blue","Green"]},12:{name:"Peach",colors:["Daisy","White","Blue","Green"]},13:{name:"Pikachu",colors:["Red","Party Hat","Cowboy Hat"]},14:{name:"Ice Climbers",shortName:"ICs",colors:["Green","Orange","Red"]},15:{name:"Jigglypuff",shortName:"Puff",colors:["Red","Blue","Headband","Crown"]},16:{name:"Samus",colors:["Pink","Black","Green","Purple"]},17:{name:"Yoshi",colors:["Red","Blue","Yellow","Pink","Cyan"]},18:{name:"Zelda",colors:["Red","Blue","Green","White"]},19:{name:"Sheik",colors:["Red","Blue","Green","White"]},20:{name:"Falco",colors:["Red","Blue","Green"]},21:{name:"Young Link",shortName:"YLink",colors:["Red","Blue","White","Black"]},22:{name:"Dr. Mario",shortName:"Doc",colors:["Red","Blue","Green","Black"]},23:{name:"Roy",colors:["Red","Blue","Green","Yellow"]},24:{name:"Pichu",colors:["Red","Blue","Green"]},25:{name:"Ganondorf",shortName:"Ganon",colors:["Red","Blue","Green","Purple"]},26:{name:"Master Hand"},27:{name:"Wireframe (Male)"},28:{name:"Wireframe (Female)"},29:{name:"Gigabowser"},30:{name:"Crazy Hand"},31:{name:"Sandbag"},32:{name:"Popo"}};const R={id:-1,name:"Unknown Character",shortName:"Unknown",colors:["Default"]};function d(t,e){var r,n;return e?{id:t,name:e.name,shortName:null!=(r=e.shortName)?r:e.name,colors:["Default",...null!=(n=e.colors)?n:[]]}:R}function f(t){const e=N[t.toString()];return d(t,e)}var I={__proto__:null,UnknownCharacter:R,getAllCharacters:function(){return Object.entries(N).map((([t,e])=>d(parseInt(t,10),e))).sort(((t,e)=>t.id-e.id))},getCharacterInfo:f,getCharacterShortName:function(t){return f(t).shortName},getCharacterName:function(t){return f(t).name},getCharacterColorName:function(t,e){return f(t).colors[e]||"Default"}},C={1:{name:"Miscellaneous",shortName:"misc"},2:{name:"Jab",shortName:"jab"},3:{name:"Jab",shortName:"jab"},4:{name:"Jab",shortName:"jab"},5:{name:"Rapid Jabs",shortName:"rapid-jabs"},6:{name:"Dash Attack",shortName:"dash"},7:{name:"Forward Tilt",shortName:"ftilt"},8:{name:"Up Tilt",shortName:"utilt"},9:{name:"Down Tilt",shortName:"dtilt"},10:{name:"Forward Smash",shortName:"fsmash"},11:{name:"Up Smash",shortName:"usmash"},12:{name:"Down Smash",shortName:"dsmash"},13:{name:"Neutral Air",shortName:"nair"},14:{name:"Forward Air",shortName:"fair"},15:{name:"Back Air",shortName:"bair"},16:{name:"Up Air",shortName:"uair"},17:{name:"Down Air",shortName:"dair"},18:{name:"Neutral B",shortName:"neutral-b"},19:{name:"Side B",shortName:"side-b"},20:{name:"Up B",shortName:"up-b"},21:{name:"Down B",shortName:"down-b"},50:{name:"Getup Attack",shortName:"getup"},51:{name:"Getup Attack (Slow)",shortName:"getup-slow"},52:{name:"Grab Pummel",shortName:"pummel"},53:{name:"Forward Throw",shortName:"fthrow"},54:{name:"Back Throw",shortName:"bthrow"},55:{name:"Up Throw",shortName:"uthrow"},56:{name:"Down Throw",shortName:"dthrow"},61:{name:"Edge Attack (Slow)",shortName:"edge-slow"},62:{name:"Edge Attack",shortName:"edge"}};const O={id:-1,name:"Unknown Move",shortName:"unknown"};function g(t){const e=C[t.toString()];return e?{id:t,name:e.name,shortName:e.shortName}:O}var F={__proto__:null,UnknownMove:O,getMoveInfo:g,getMoveShortName:function(t){return g(t).shortName},getMoveName:function(t){return g(t).name}},D={2:"Fountain of Dreams",3:"Pokémon Stadium",4:"Princess Peach's Castle",5:"Kongo Jungle",6:"Brinstar",7:"Corneria",8:"Yoshi's Story",9:"Onett",10:"Mute City",11:"Rainbow Cruise",12:"Jungle Japes",13:"Great Bay",14:"Hyrule Temple",15:"Brinstar Depths",16:"Yoshi's Island",17:"Green Greens",18:"Fourside",19:"Mushroom Kingdom I",20:"Mushroom Kingdom II",22:"Venom",23:"Poké Floats",24:"Big Blue",25:"Icicle Mountain",26:"Icetop",27:"Flat Zone",28:"Dream Land N64",29:"Yoshi's Island N64",30:"Kongo Jungle N64",31:"Battlefield",32:"Final Destination",33:"Target Test (Mario)",34:"Target Test (Captain Falcon)",35:"Target Test (Young Link)",36:"Target Test (Donkey Kong)",37:"Target Test (Dr. Mario)",38:"Target Test (Falco)",39:"Target Test (Fox)",40:"Target Test (Ice Climbers)",41:"Target Test (Kirby)",42:"Target Test (Bowser)",43:"Target Test (Link)",44:"Target Test (Luigi)",45:"Target Test (Marth)",46:"Target Test (Mewtwo)",47:"Target Test (Ness)",48:"Target Test (Peach)",49:"Target Test (Pichu)",50:"Target Test (Pikachu)",51:"Target Test (Jigglypuff)",52:"Target Test (Samus)",53:"Target Test (Sheik)",54:"Target Test (Yoshi)",55:"Target Test (Zelda)",56:"Target Test (Mr. Game & Watch)",57:"Target Test (Roy)",58:"Target Test (Ganondorf)",84:"Home-Run Contest"};const x={id:-1,name:"Unknown Stage"};function M(t){const e=D[t.toString()];return e?{id:t,name:e}:x}var y,B,G,L={__proto__:null,UnknownStage:x,getStageInfo:M,getStageName:function(t){return M(t).name}};exports.Character=void 0,(y=exports.Character||(exports.Character={}))[y.CAPTAIN_FALCON=0]="CAPTAIN_FALCON",y[y.DONKEY_KONG=1]="DONKEY_KONG",y[y.FOX=2]="FOX",y[y.GAME_AND_WATCH=3]="GAME_AND_WATCH",y[y.KIRBY=4]="KIRBY",y[y.BOWSER=5]="BOWSER",y[y.LINK=6]="LINK",y[y.LUIGI=7]="LUIGI",y[y.MARIO=8]="MARIO",y[y.MARTH=9]="MARTH",y[y.MEWTWO=10]="MEWTWO",y[y.NESS=11]="NESS",y[y.PEACH=12]="PEACH",y[y.PIKACHU=13]="PIKACHU",y[y.ICE_CLIMBERS=14]="ICE_CLIMBERS",y[y.JIGGLYPUFF=15]="JIGGLYPUFF",y[y.SAMUS=16]="SAMUS",y[y.YOSHI=17]="YOSHI",y[y.ZELDA=18]="ZELDA",y[y.SHEIK=19]="SHEIK",y[y.FALCO=20]="FALCO",y[y.YOUNG_LINK=21]="YOUNG_LINK",y[y.DR_MARIO=22]="DR_MARIO",y[y.ROY=23]="ROY",y[y.PICHU=24]="PICHU",y[y.GANONDORF=25]="GANONDORF",y[y.MASTER_HAND=26]="MASTER_HAND",y[y.WIREFRAME_MALE=27]="WIREFRAME_MALE",y[y.WIREFRAME_FEMALE=28]="WIREFRAME_FEMALE",y[y.GIGA_BOWSER=29]="GIGA_BOWSER",y[y.CRAZY_HAND=30]="CRAZY_HAND",y[y.SANDBAG=31]="SANDBAG",y[y.POPO=32]="POPO",exports.Stage=void 0,(B=exports.Stage||(exports.Stage={}))[B.FOUNTAIN_OF_DREAMS=2]="FOUNTAIN_OF_DREAMS",B[B.POKEMON_STADIUM=3]="POKEMON_STADIUM",B[B.PEACHS_CASTLE=4]="PEACHS_CASTLE",B[B.KONGO_JUNGLE=5]="KONGO_JUNGLE",B[B.BRINSTAR=6]="BRINSTAR",B[B.CORNERIA=7]="CORNERIA",B[B.YOSHIS_STORY=8]="YOSHIS_STORY",B[B.ONETT=9]="ONETT",B[B.MUTE_CITY=10]="MUTE_CITY",B[B.RAINBOW_CRUISE=11]="RAINBOW_CRUISE",B[B.JUNGLE_JAPES=12]="JUNGLE_JAPES",B[B.GREAT_BAY=13]="GREAT_BAY",B[B.HYRULE_TEMPLE=14]="HYRULE_TEMPLE",B[B.BRINSTAR_DEPTHS=15]="BRINSTAR_DEPTHS",B[B.YOSHIS_ISLAND=16]="YOSHIS_ISLAND",B[B.GREEN_GREENS=17]="GREEN_GREENS",B[B.FOURSIDE=18]="FOURSIDE",B[B.MUSHROOM_KINGDOM=19]="MUSHROOM_KINGDOM",B[B.MUSHROOM_KINGDOM_2=20]="MUSHROOM_KINGDOM_2",B[B.VENOM=22]="VENOM",B[B.POKE_FLOATS=23]="POKE_FLOATS",B[B.BIG_BLUE=24]="BIG_BLUE",B[B.ICICLE_MOUNTAIN=25]="ICICLE_MOUNTAIN",B[B.ICETOP=26]="ICETOP",B[B.FLAT_ZONE=27]="FLAT_ZONE",B[B.DREAMLAND=28]="DREAMLAND",B[B.YOSHIS_ISLAND_N64=29]="YOSHIS_ISLAND_N64",B[B.KONGO_JUNGLE_N64=30]="KONGO_JUNGLE_N64",B[B.BATTLEFIELD=31]="BATTLEFIELD",B[B.FINAL_DESTINATION=32]="FINAL_DESTINATION",B[B.TARGET_TEST_MARIO=33]="TARGET_TEST_MARIO",B[B.TARGET_TEST_CAPTAIN_FALCON=34]="TARGET_TEST_CAPTAIN_FALCON",B[B.TARGET_TEST_YOUNG_LINK=35]="TARGET_TEST_YOUNG_LINK",B[B.TARGET_TEST_DONKEY_KONG=36]="TARGET_TEST_DONKEY_KONG",B[B.TARGET_TEST_DR_MARIO=37]="TARGET_TEST_DR_MARIO",B[B.TARGET_TEST_FALCO=38]="TARGET_TEST_FALCO",B[B.TARGET_TEST_FOX=39]="TARGET_TEST_FOX",B[B.TARGET_TEST_ICE_CLIMBERS=40]="TARGET_TEST_ICE_CLIMBERS",B[B.TARGET_TEST_KIRBY=41]="TARGET_TEST_KIRBY",B[B.TARGET_TEST_BOWSER=42]="TARGET_TEST_BOWSER",B[B.TARGET_TEST_LINK=43]="TARGET_TEST_LINK",B[B.TARGET_TEST_LUIGI=44]="TARGET_TEST_LUIGI",B[B.TARGET_TEST_MARTH=45]="TARGET_TEST_MARTH",B[B.TARGET_TEST_MEWTWO=46]="TARGET_TEST_MEWTWO",B[B.TARGET_TEST_NESS=47]="TARGET_TEST_NESS",B[B.TARGET_TEST_PEACH=48]="TARGET_TEST_PEACH",B[B.TARGET_TEST_PICHU=49]="TARGET_TEST_PICHU",B[B.TARGET_TEST_PIKACHU=50]="TARGET_TEST_PIKACHU",B[B.TARGET_TEST_JIGGLYPUFF=51]="TARGET_TEST_JIGGLYPUFF",B[B.TARGET_TEST_SAMUS=52]="TARGET_TEST_SAMUS",B[B.TARGET_TEST_SHEIK=53]="TARGET_TEST_SHEIK",B[B.TARGET_TEST_YOSHI=54]="TARGET_TEST_YOSHI",B[B.TARGET_TEST_ZELDA=55]="TARGET_TEST_ZELDA",B[B.TARGET_TEST_GAME_AND_WATCH=56]="TARGET_TEST_GAME_AND_WATCH",B[B.TARGET_TEST_ROY=57]="TARGET_TEST_ROY",B[B.TARGET_TEST_GANONDORF=58]="TARGET_TEST_GANONDORF",B[B.RACE_TO_THE_FINISH=82]="RACE_TO_THE_FINISH",B[B.GRAB_THE_TROPHIES=83]="GRAB_THE_TROPHIES",B[B.HOME_RUN_CONTEST=84]="HOME_RUN_CONTEST",B[B.ALL_STAR_LOBBY=85]="ALL_STAR_LOBBY",B[B.EVENT_ONE=202]="EVENT_ONE",B[B.EVENT_EIGHTEEN=203]="EVENT_EIGHTEEN",B[B.EVENT_THREE=204]="EVENT_THREE",B[B.EVENT_FOUR=205]="EVENT_FOUR",B[B.EVENT_FIVE=206]="EVENT_FIVE",B[B.EVENT_SIX=207]="EVENT_SIX",B[B.EVENT_SEVEN=208]="EVENT_SEVEN",B[B.EVENT_EIGHT=209]="EVENT_EIGHT",B[B.EVENT_NINE=210]="EVENT_NINE",B[B.EVENT_TEN_PART_ONE=211]="EVENT_TEN_PART_ONE",B[B.EVENT_ELEVEN=212]="EVENT_ELEVEN",B[B.EVENT_TWELVE=213]="EVENT_TWELVE",B[B.EVENT_THIRTEEN=214]="EVENT_THIRTEEN",B[B.EVENT_FOURTEEN=215]="EVENT_FOURTEEN",B[B.EVENT_THIRTY_SEVEN=216]="EVENT_THIRTY_SEVEN",B[B.EVENT_SIXTEEN=217]="EVENT_SIXTEEN",B[B.EVENT_SEVENTEEN=218]="EVENT_SEVENTEEN",B[B.EVENT_TWO=219]="EVENT_TWO",B[B.EVENT_NINETEEN=220]="EVENT_NINETEEN",B[B.EVENT_TWENTY_PART_ONE=221]="EVENT_TWENTY_PART_ONE",B[B.EVENT_TWENTY_ONE=222]="EVENT_TWENTY_ONE",B[B.EVENT_TWENTY_TWO=223]="EVENT_TWENTY_TWO",B[B.EVENT_TWENTY_SEVEN=224]="EVENT_TWENTY_SEVEN",B[B.EVENT_TWENTY_FOUR=225]="EVENT_TWENTY_FOUR",B[B.EVENT_TWENTY_FIVE=226]="EVENT_TWENTY_FIVE",B[B.EVENT_TWENTY_SIX=227]="EVENT_TWENTY_SIX",B[B.EVENT_TWENTY_THREE=228]="EVENT_TWENTY_THREE",B[B.EVENT_TWENTY_EIGHT=229]="EVENT_TWENTY_EIGHT",B[B.EVENT_TWENTY_NINE=230]="EVENT_TWENTY_NINE",B[B.EVENT_THIRTY_PART_ONE=231]="EVENT_THIRTY_PART_ONE",B[B.EVENT_THIRTY_ONE=232]="EVENT_THIRTY_ONE",B[B.EVENT_THIRTY_TWO=233]="EVENT_THIRTY_TWO",B[B.EVENT_THIRTY_THREE=234]="EVENT_THIRTY_THREE",B[B.EVENT_THIRTY_FOUR=235]="EVENT_THIRTY_FOUR",B[B.EVENT_FORTY_EIGHT=236]="EVENT_FORTY_EIGHT",B[B.EVENT_THIRTY_SIX_PART_ONE=237]="EVENT_THIRTY_SIX_PART_ONE",B[B.EVENT_FIFTEEN=238]="EVENT_FIFTEEN",B[B.EVENT_THIRTY_EIGHT=239]="EVENT_THIRTY_EIGHT",B[B.EVENT_THIRTY_NINE=240]="EVENT_THIRTY_NINE",B[B.EVENT_FORTY_PART_ONE=241]="EVENT_FORTY_PART_ONE",B[B.EVENT_FORTY_ONE=242]="EVENT_FORTY_ONE",B[B.EVENT_FORTY_TWO=243]="EVENT_FORTY_TWO",B[B.EVENT_FORTY_THREE=244]="EVENT_FORTY_THREE",B[B.EVENT_FORTY_FOUR=245]="EVENT_FORTY_FOUR",B[B.EVENT_FORTY_FIVE=246]="EVENT_FORTY_FIVE",B[B.EVENT_FORTY_SIX=247]="EVENT_FORTY_SIX",B[B.EVENT_FORTY_SEVEN=248]="EVENT_FORTY_SEVEN",B[B.EVENT_THIRTY_FIVE=249]="EVENT_THIRTY_FIVE",B[B.EVENT_FORTY_NINE_PART_ONE=250]="EVENT_FORTY_NINE_PART_ONE",B[B.EVENT_FIFTY=251]="EVENT_FIFTY",B[B.EVENT_FIFTY_ONE=252]="EVENT_FIFTY_ONE",B[B.EVENT_TEN_PART_TWO=253]="EVENT_TEN_PART_TWO",B[B.EVENT_TEN_PART_THREE=254]="EVENT_TEN_PART_THREE",B[B.EVENT_TEN_PART_FOUR=255]="EVENT_TEN_PART_FOUR",B[B.EVENT_TEN_PART_FIVE=256]="EVENT_TEN_PART_FIVE",B[B.EVENT_TWENTY_PART_TWO=257]="EVENT_TWENTY_PART_TWO",B[B.EVENT_TWENTY_PART_THREE=258]="EVENT_TWENTY_PART_THREE",B[B.EVENT_TWENTY_PART_FOUR=259]="EVENT_TWENTY_PART_FOUR",B[B.EVENT_TWENTY_PART_FIVE=260]="EVENT_TWENTY_PART_FIVE",B[B.EVENT_THIRTY_PART_TWO=261]="EVENT_THIRTY_PART_TWO",B[B.EVENT_THIRTY_PART_THREE=262]="EVENT_THIRTY_PART_THREE",B[B.EVENT_THIRTY_PART_FOUR=263]="EVENT_THIRTY_PART_FOUR",B[B.EVENT_FORTY_PART_TWO=264]="EVENT_FORTY_PART_TWO",B[B.EVENT_FORTY_PART_THREE=265]="EVENT_FORTY_PART_THREE",B[B.EVENT_FORTY_PART_FOUR=266]="EVENT_FORTY_PART_FOUR",B[B.EVENT_FORTY_PART_FIVE=267]="EVENT_FORTY_PART_FIVE",B[B.EVENT_FORTY_NINE_PART_TWO=268]="EVENT_FORTY_NINE_PART_TWO",B[B.EVENT_FORTY_NINE_PART_THREE=269]="EVENT_FORTY_NINE_PART_THREE",B[B.EVENT_FORTY_NINE_PART_FOUR=270]="EVENT_FORTY_NINE_PART_FOUR",B[B.EVENT_FORTY_NINE_PART_FIVE=271]="EVENT_FORTY_NINE_PART_FIVE",B[B.EVENT_FORTY_NINE_PART_SIX=272]="EVENT_FORTY_NINE_PART_SIX",B[B.EVENT_THIRTY_SIX_PART_TWO=273]="EVENT_THIRTY_SIX_PART_TWO",B[B.MULTI_MAN_MELEE=285]="MULTI_MAN_MELEE",exports.State=void 0,(G=exports.State||(exports.State={}))[G.DAMAGE_START=75]="DAMAGE_START",G[G.DAMAGE_END=91]="DAMAGE_END",G[G.CAPTURE_START=223]="CAPTURE_START",G[G.CAPTURE_END=232]="CAPTURE_END",G[G.GUARD_START=178]="GUARD_START",G[G.GUARD_END=182]="GUARD_END",G[G.GROUNDED_CONTROL_START=14]="GROUNDED_CONTROL_START",G[G.GROUNDED_CONTROL_END=24]="GROUNDED_CONTROL_END",G[G.SQUAT_START=39]="SQUAT_START",G[G.SQUAT_END=41]="SQUAT_END",G[G.DOWN_START=183]="DOWN_START",G[G.DOWN_END=198]="DOWN_END",G[G.TECH_START=199]="TECH_START",G[G.TECH_END=204]="TECH_END",G[G.DYING_START=0]="DYING_START",G[G.DYING_END=10]="DYING_END",G[G.CONTROLLED_JUMP_START=24]="CONTROLLED_JUMP_START",G[G.CONTROLLED_JUMP_END=34]="CONTROLLED_JUMP_END",G[G.GROUND_ATTACK_START=44]="GROUND_ATTACK_START",G[G.GROUND_ATTACK_END=64]="GROUND_ATTACK_END",G[G.AERIAL_ATTACK_START=65]="AERIAL_ATTACK_START",G[G.AERIAL_ATTACK_END=74]="AERIAL_ATTACK_END",G[G.ATTACK_FTILT_START=51]="ATTACK_FTILT_START",G[G.ATTACK_FTILT_END=55]="ATTACK_FTILT_END",G[G.ATTACK_FSMASH_START=58]="ATTACK_FSMASH_START",G[G.ATTACK_FSMASH_END=62]="ATTACK_FSMASH_END",G[G.ROLL_FORWARD=233]="ROLL_FORWARD",G[G.ROLL_BACKWARD=234]="ROLL_BACKWARD",G[G.SPOT_DODGE=235]="SPOT_DODGE",G[G.AIR_DODGE=236]="AIR_DODGE",G[G.ACTION_WAIT=14]="ACTION_WAIT",G[G.ACTION_DASH=20]="ACTION_DASH",G[G.ACTION_KNEE_BEND=24]="ACTION_KNEE_BEND",G[G.GUARD_ON=178]="GUARD_ON",G[G.TECH_MISS_UP=183]="TECH_MISS_UP",G[G.JAB_RESET_UP=185]="JAB_RESET_UP",G[G.TECH_MISS_DOWN=191]="TECH_MISS_DOWN",G[G.JAB_RESET_DOWN=193]="JAB_RESET_DOWN",G[G.NEUTRAL_TECH=199]="NEUTRAL_TECH",G[G.FORWARD_TECH=200]="FORWARD_TECH",G[G.BACKWARD_TECH=201]="BACKWARD_TECH",G[G.WALL_TECH=202]="WALL_TECH",G[G.MISSED_WALL_TECH=247]="MISSED_WALL_TECH",G[G.DASH=20]="DASH",G[G.TURN=18]="TURN",G[G.LANDING_FALL_SPECIAL=43]="LANDING_FALL_SPECIAL",G[G.JUMP_FORWARD=25]="JUMP_FORWARD",G[G.JUMP_BACKWARD=26]="JUMP_BACKWARD",G[G.FALL_FORWARD=30]="FALL_FORWARD",G[G.FALL_BACKWARD=31]="FALL_BACKWARD",G[G.GRAB=212]="GRAB",G[G.DASH_GRAB=214]="DASH_GRAB",G[G.GRAB_WAIT=216]="GRAB_WAIT",G[G.PUMMEL=217]="PUMMEL",G[G.CLIFF_CATCH=252]="CLIFF_CATCH",G[G.THROW_UP=221]="THROW_UP",G[G.THROW_FORWARD=219]="THROW_FORWARD",G[G.THROW_DOWN=222]="THROW_DOWN",G[G.THROW_BACK=220]="THROW_BACK",G[G.DAMAGE_FALL=38]="DAMAGE_FALL",G[G.ATTACK_JAB1=44]="ATTACK_JAB1",G[G.ATTACK_JAB2=45]="ATTACK_JAB2",G[G.ATTACK_JAB3=46]="ATTACK_JAB3",G[G.ATTACK_JABM=47]="ATTACK_JABM",G[G.ATTACK_DASH=50]="ATTACK_DASH",G[G.ATTACK_UTILT=56]="ATTACK_UTILT",G[G.ATTACK_DTILT=57]="ATTACK_DTILT",G[G.ATTACK_USMASH=63]="ATTACK_USMASH",G[G.ATTACK_DSMASH=64]="ATTACK_DSMASH",G[G.AERIAL_NAIR=65]="AERIAL_NAIR",G[G.AERIAL_FAIR=66]="AERIAL_FAIR",G[G.AERIAL_BAIR=67]="AERIAL_BAIR",G[G.AERIAL_UAIR=68]="AERIAL_UAIR",G[G.AERIAL_DAIR=69]="AERIAL_DAIR",G[G.GNW_JAB1=341]="GNW_JAB1",G[G.GNW_JABM=342]="GNW_JABM",G[G.GNW_DTILT=345]="GNW_DTILT",G[G.GNW_FSMASH=346]="GNW_FSMASH",G[G.GNW_NAIR=347]="GNW_NAIR",G[G.GNW_BAIR=348]="GNW_BAIR",G[G.GNW_UAIR=349]="GNW_UAIR",G[G.PEACH_FSMASH1=349]="PEACH_FSMASH1",G[G.PEACH_FSMASH2=350]="PEACH_FSMASH2",G[G.PEACH_FSMASH3=351]="PEACH_FSMASH3",G[G.BARREL_WAIT=293]="BARREL_WAIT",G[G.COMMAND_GRAB_RANGE1_START=266]="COMMAND_GRAB_RANGE1_START",G[G.COMMAND_GRAB_RANGE1_END=304]="COMMAND_GRAB_RANGE1_END",G[G.COMMAND_GRAB_RANGE2_START=327]="COMMAND_GRAB_RANGE2_START",G[G.COMMAND_GRAB_RANGE2_END=338]="COMMAND_GRAB_RANGE2_END";const P={PUNISH_RESET_FRAMES:45,RECOVERY_RESET_FRAMES:45,COMBO_STRING_RESET_FRAMES:45};function U(t){return t&&2===t.players.length?[{playerIndex:t.players[0].playerIndex,opponentIndex:t.players[1].playerIndex},{playerIndex:t.players[1].playerIndex,opponentIndex:t.players[0].playerIndex}]:[]}function H(t,e){return!(!t||!e)&&e.stocksRemaining-t.stocksRemaining>0}function v(t){const e=t>=exports.State.GROUNDED_CONTROL_START&&t<=exports.State.GROUNDED_CONTROL_END,r=t>=exports.State.SQUAT_START&&t<=exports.State.SQUAT_END,n=t>exports.State.GROUND_ATTACK_START&&t<=exports.State.GROUND_ATTACK_END,s=t===exports.State.GRAB;return e||r||n||s}function w(t){return t>=exports.State.TECH_START&&t<=exports.State.TECH_END}function k(t){return t>=exports.State.DOWN_START&&t<=exports.State.DOWN_END}function W(t){return t>=exports.State.DAMAGE_START&&t<=exports.State.DAMAGE_END||t===exports.State.DAMAGE_FALL||t===exports.State.JAB_RESET_UP||t===exports.State.JAB_RESET_DOWN}function V(t){return t>=exports.State.CAPTURE_START&&t<=exports.State.CAPTURE_END}function b(t){return(t>=exports.State.COMMAND_GRAB_RANGE1_START&&t<=exports.State.COMMAND_GRAB_RANGE1_END||t>=exports.State.COMMAND_GRAB_RANGE2_START&&t<=exports.State.COMMAND_GRAB_RANGE2_END)&&t!==exports.State.BARREL_WAIT}function Y(t){return t>=exports.State.DYING_START&&t<=exports.State.DYING_END}function K(t,e){var r,n;return(null!=(r=t.percent)?r:0)-(null!=(n=e.percent)?n:0)}const J=[exports.State.DASH,exports.State.TURN,exports.State.DASH];class X{constructor(){this.playerPermutations=new Array,this.state=new Map}setup(t){this.state=new Map,this.playerPermutations=U(t),this.playerPermutations.forEach((t=>{this.state.set(t,{playerCounts:{playerIndex:t.playerIndex,wavedashCount:0,wavelandCount:0,airDodgeCount:0,dashDanceCount:0,spotDodgeCount:0,ledgegrabCount:0,rollCount:0,lCancelCount:{success:0,fail:0},attackCount:{jab1:0,jab2:0,jab3:0,jabm:0,dash:0,ftilt:0,utilt:0,dtilt:0,fsmash:0,usmash:0,dsmash:0,nair:0,fair:0,bair:0,uair:0,dair:0},grabCount:{success:0,fail:0},throwCount:{up:0,forward:0,back:0,down:0},groundTechCount:{away:0,in:0,neutral:0,fail:0},wallTechCount:{success:0,fail:0}},animations:[],actionFrameCounters:[]})}))}processFrame(e){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(e,r,n){const s=n.players[r.playerIndex].post,o=n.players[r.opponentIndex].post,a=(r,n)=>{if(!n)return;const s=t.get(e.playerCounts,r,0);t.set(e.playerCounts,r,s+1)},i=s.actionStateId;e.animations.push(i);const E=s.actionStateCounter;e.actionFrameCounters.push(E);const l=e.animations.slice(-3),T=l[l.length-2];if(!(i!==T||e.actionFrameCounters[e.actionFrameCounters.length-2]>E))return;var c;a("dashDanceCount",t.isEqual(l,J)),a("rollCount",(c=i)===exports.State.ROLL_BACKWARD||c===exports.State.ROLL_FORWARD),a("spotDodgeCount",i===exports.State.SPOT_DODGE),a("airDodgeCount",i===exports.State.AIR_DODGE),a("ledgegrabCount",i===exports.State.CLIFF_CATCH),a("grabCount.success",z(T)&&j(i)),a("grabCount.fail",z(T)&&!j(i)),i===exports.State.DASH_GRAB&&T===exports.State.ATTACK_DASH&&(e.playerCounts.attackCount.dash-=1),a("attackCount.jab1",i===exports.State.ATTACK_JAB1),a("attackCount.jab2",i===exports.State.ATTACK_JAB2),a("attackCount.jab3",i===exports.State.ATTACK_JAB3),a("attackCount.jabm",i===exports.State.ATTACK_JABM),a("attackCount.dash",i===exports.State.ATTACK_DASH),a("attackCount.ftilt",function(t){return t>=exports.State.ATTACK_FTILT_START&&t<=exports.State.ATTACK_FTILT_END}(i)),a("attackCount.utilt",i===exports.State.ATTACK_UTILT),a("attackCount.dtilt",i===exports.State.ATTACK_DTILT),a("attackCount.fsmash",function(t){return t>=exports.State.ATTACK_FSMASH_START&&t<=exports.State.ATTACK_FSMASH_END}(i)),a("attackCount.usmash",i===exports.State.ATTACK_USMASH),a("attackCount.dsmash",i===exports.State.ATTACK_DSMASH),a("attackCount.nair",i===exports.State.AERIAL_NAIR),a("attackCount.fair",i===exports.State.AERIAL_FAIR),a("attackCount.bair",i===exports.State.AERIAL_BAIR),a("attackCount.uair",i===exports.State.AERIAL_UAIR),a("attackCount.dair",i===exports.State.AERIAL_DAIR),24===s.internalCharacterId&&(a("attackCount.jab1",i===exports.State.GNW_JAB1),a("attackCount.jabm",i===exports.State.GNW_JABM),a("attackCount.dtilt",i===exports.State.GNW_DTILT),a("attackCount.fsmash",i===exports.State.GNW_FSMASH),a("attackCount.nair",i===exports.State.GNW_NAIR),a("attackCount.bair",i===exports.State.GNW_BAIR),a("attackCount.uair",i===exports.State.GNW_UAIR)),9===s.internalCharacterId&&(a("attackCount.fsmash",i===exports.State.PEACH_FSMASH1),a("attackCount.fsmash",i===exports.State.PEACH_FSMASH2),a("attackCount.fsmash",i===exports.State.PEACH_FSMASH3)),a("throwCount.up",i===exports.State.THROW_UP),a("throwCount.forward",i===exports.State.THROW_FORWARD),a("throwCount.down",i===exports.State.THROW_DOWN),a("throwCount.back",i===exports.State.THROW_BACK);const u=s.facingDirection===(s.positionX>o.positionX?-1:1);a("groundTechCount.fail",function(t){return t===exports.State.TECH_MISS_DOWN||t===exports.State.TECH_MISS_UP}(i)),a("groundTechCount.in",i===exports.State.FORWARD_TECH&&u),a("groundTechCount.in",i===exports.State.BACKWARD_TECH&&!u),a("groundTechCount.neutral",i===exports.State.NEUTRAL_TECH),a("groundTechCount.away",i===exports.State.BACKWARD_TECH&&u),a("groundTechCount.away",i===exports.State.FORWARD_TECH&&!u),a("wallTechCount.success",i===exports.State.WALL_TECH),a("wallTechCount.fail",i===exports.State.MISSED_WALL_TECH),function(t){return t>=exports.State.AERIAL_ATTACK_START&&t<=exports.State.AERIAL_ATTACK_END}(i)&&(a("lCancelCount.success",1===s.lCancelStatus),a("lCancelCount.fail",2===s.lCancelStatus)),function(e,r){const n=t.last(r)===exports.State.LANDING_FALL_SPECIAL,s=function(t){if(t===exports.State.AIR_DODGE)return!0;const e=t>=exports.State.CONTROLLED_JUMP_START,r=t<=exports.State.CONTROLLED_JUMP_END;return e&&r}(r[r.length-2]);if(!n||!s)return;const o=r.slice(-8),a=t.keyBy(o,(t=>t));2===t.size(a)&&a[exports.State.AIR_DODGE]||(a[exports.State.AIR_DODGE]&&(e.airDodgeCount-=1),a[exports.State.ACTION_KNEE_BEND]?e.wavedashCount+=1:e.wavelandCount+=1)}(e.playerCounts,e.animations)}(n,r,e)}))}fetch(){return Array.from(this.state.values()).map((t=>t.playerCounts))}}function j(t){return t>exports.State.GRAB&&t<=exports.State.THROW_DOWN&&t!==exports.State.DASH_GRAB}function z(t){return t===exports.State.GRAB||t===exports.State.DASH_GRAB}var $,Z,q,Q,tt,et,rt,nt,st,ot;!function(t){t.COMBO_START="COMBO_START",t.COMBO_EXTEND="COMBO_EXTEND",t.COMBO_END="COMBO_END"}($||($={}));class at extends e.EventEmitter{constructor(...t){super(...t),this.playerPermutations=new Array,this.state=new Map,this.combos=new Array,this.settings=null}setup(t){this.settings=t,this.state=new Map,this.combos=[],this.playerPermutations=U(t),this.playerPermutations.forEach((t=>{this.state.set(t,{combo:null,move:null,resetCounter:0,lastHitAnimation:null,event:null})}))}processFrame(e,r){this.playerPermutations.forEach((n=>{const s=this.state.get(n);s&&(function(t,e,r,n,s){const o=n.frame,a=n.players[r.playerIndex].post,i=n.players[r.opponentIndex].post,E=o-1;let l=null,T=null;t[E]&&(l=t[E].players[r.playerIndex].post,T=t[E].players[r.opponentIndex].post);const c=i.actionStateId,u=W(c),_=V(c),p=b(c),A=T?K(i,T):0;if((a.actionStateId!==e.lastHitAnimation||a.actionStateCounter<(l?l.actionStateCounter:0))&&(e.lastHitAnimation=null),u||_||p){let t=!1;var m,h;e.combo||(e.combo={playerIndex:r.opponentIndex,startFrame:o,endFrame:null,startPercent:T&&null!=(m=T.percent)?m:0,currentPercent:null!=(h=i.percent)?h:0,endPercent:null,moves:[],didKill:!1,lastHitBy:r.playerIndex},s.push(e.combo),t=!0),A&&(null===e.lastHitAnimation&&(e.move={playerIndex:r.playerIndex,frame:o,moveId:a.lastAttackLanded,hitCount:0,damage:0},e.combo.moves.push(e.move),t||(e.event=$.COMBO_EXTEND)),e.move&&(e.move.hitCount+=1,e.move.damage+=A),e.lastHitAnimation=l?l.actionStateId:null),t&&(e.event=$.COMBO_START)}if(!e.combo)return;const S=w(c),N=k(c),R=T&&H(i,T),d=Y(c);var f;R||(e.combo.currentPercent=null!=(f=i.percent)?f:0),u||_||p||S||N||d?e.resetCounter=0:e.resetCounter+=1;let I=!1;var C;R&&(e.combo.didKill=!0,I=!0),e.resetCounter>P.COMBO_STRING_RESET_FRAMES&&(I=!0),I&&(e.combo.endFrame=a.frame,e.combo.endPercent=T&&null!=(C=T.percent)?C:0,e.event=$.COMBO_END,e.combo=null,e.move=null)}(r,s,n,e,this.combos),null!==s.event&&(this.emit(s.event,{combo:t.last(this.combos),settings:this.settings}),s.event=null))}))}fetch(){return this.combos}}class it extends e.EventEmitter{constructor(){super(),this.playerPermutations=new Array,this.conversions=new Array,this.state=new Map,this.metadata=void 0,this.settings=null,this.metadata={lastEndFrameByOppIdx:{}}}setup(t){this.playerPermutations=U(t),this.conversions=[],this.state=new Map,this.metadata={lastEndFrameByOppIdx:{}},this.settings=t,this.playerPermutations.forEach((t=>{this.state.set(t,{conversion:null,move:null,resetCounter:0,lastHitAnimation:null})}))}processFrame(e,r){this.playerPermutations.forEach((n=>{const s=this.state.get(n);if(s){const o=function(t,e,r,n,s){const o=n.frame,a=n.players[r.playerIndex].post,i=n.players[r.opponentIndex].post,E=o-1;let l=null,T=null;t[E]&&(l=t[E].players[r.playerIndex].post,T=t[E].players[r.opponentIndex].post);const c=i.actionStateId,u=W(c),_=V(c),p=b(c),A=T?K(i,T):0;var m,h;if((a.actionStateId!==e.lastHitAnimation||a.actionStateCounter<(l?l.actionStateCounter:0))&&(e.lastHitAnimation=null),(u||_||p)&&(e.conversion||(e.conversion={playerIndex:r.opponentIndex,lastHitBy:r.playerIndex,startFrame:o,endFrame:null,startPercent:T&&null!=(m=T.percent)?m:0,currentPercent:null!=(h=i.percent)?h:0,endPercent:null,moves:[],didKill:!1,openingType:"unknown"},s.push(e.conversion)),A&&(null===e.lastHitAnimation&&(e.move={playerIndex:r.playerIndex,frame:o,moveId:a.lastAttackLanded,hitCount:0,damage:0},e.conversion.moves.push(e.move)),e.move&&(e.move.hitCount+=1,e.move.damage+=A),e.lastHitAnimation=l?l.actionStateId:null)),!e.conversion)return!1;const S=v(c),N=T&&H(i,T);var R;N||(e.conversion.currentPercent=null!=(R=i.percent)?R:0),(u||_||p)&&(e.resetCounter=0),(0===e.resetCounter&&S||e.resetCounter>0)&&(e.resetCounter+=1);let d=!1;var f;return N&&(e.conversion.didKill=!0,d=!0),e.resetCounter>P.PUNISH_RESET_FRAMES&&(d=!0),d&&(e.conversion.endFrame=a.frame,e.conversion.endPercent=T&&null!=(f=T.percent)?f:0,e.conversion=null,e.move=null),d}(r,s,n,e,this.conversions);o&&this.emit("CONVERSION",{combo:t.last(this.conversions),settings:this.settings})}}))}fetch(){return this._populateConversionTypes(),this.conversions}_populateConversionTypes(){const e=t.filter(this.conversions,(t=>"unknown"===t.openingType)),r=t.groupBy(e,"startFrame");t.orderBy(r,(e=>t.get(e,[0,"startFrame"]))).forEach((e=>{const r=e.length>=2;e.forEach((e=>{if(this.metadata.lastEndFrameByOppIdx[e.playerIndex]=e.endFrame,r)return void(e.openingType="trade");const n=t.last(e.moves),s=this.metadata.lastEndFrameByOppIdx[n?n.playerIndex:e.playerIndex];e.openingType=s&&s>e.startFrame?"counter-attack":"neutral-win"}))}))}}exports.Command=void 0,(Z=exports.Command||(exports.Command={}))[Z.SPLIT_MESSAGE=16]="SPLIT_MESSAGE",Z[Z.MESSAGE_SIZES=53]="MESSAGE_SIZES",Z[Z.GAME_START=54]="GAME_START",Z[Z.PRE_FRAME_UPDATE=55]="PRE_FRAME_UPDATE",Z[Z.POST_FRAME_UPDATE=56]="POST_FRAME_UPDATE",Z[Z.GAME_END=57]="GAME_END",Z[Z.FRAME_START=58]="FRAME_START",Z[Z.ITEM_UPDATE=59]="ITEM_UPDATE",Z[Z.FRAME_BOOKEND=60]="FRAME_BOOKEND",Z[Z.GECKO_LIST=61]="GECKO_LIST",exports.GameMode=void 0,(q=exports.GameMode||(exports.GameMode={}))[q.VS=2]="VS",q[q.ONLINE=8]="ONLINE",q[q.TARGET_TEST=15]="TARGET_TEST",q[q.HOME_RUN_CONTEST=32]="HOME_RUN_CONTEST",exports.Language=void 0,(Q=exports.Language||(exports.Language={}))[Q.JAPANESE=0]="JAPANESE",Q[Q.ENGLISH=1]="ENGLISH",exports.TimerType=void 0,(tt=exports.TimerType||(exports.TimerType={}))[tt.NONE=0]="NONE",tt[tt.DECREASING=2]="DECREASING",tt[tt.INCREASING=3]="INCREASING",exports.ItemSpawnType=void 0,(et=exports.ItemSpawnType||(exports.ItemSpawnType={}))[et.OFF=255]="OFF",et[et.VERY_LOW=0]="VERY_LOW",et[et.LOW=1]="LOW",et[et.MEDIUM=2]="MEDIUM",et[et.HIGH=3]="HIGH",et[et.VERY_HIGH=4]="VERY_HIGH",exports.EnabledItemType=void 0,(rt=exports.EnabledItemType||(exports.EnabledItemType={}))[rt.METAL_BOX=1]="METAL_BOX",rt[rt.CLOAKING_DEVICE=2]="CLOAKING_DEVICE",rt[rt.POKEBALL=4]="POKEBALL",rt[rt.UNKNOWN_ITEM_BIT_4=8]="UNKNOWN_ITEM_BIT_4",rt[rt.UNKNOWN_ITEM_BIT_5=16]="UNKNOWN_ITEM_BIT_5",rt[rt.UNKNOWN_ITEM_BIT_6=32]="UNKNOWN_ITEM_BIT_6",rt[rt.UNKNOWN_ITEM_BIT_7=64]="UNKNOWN_ITEM_BIT_7",rt[rt.UNKNOWN_ITEM_BIT_8=128]="UNKNOWN_ITEM_BIT_8",rt[rt.FAN=256]="FAN",rt[rt.FIRE_FLOWER=512]="FIRE_FLOWER",rt[rt.SUPER_MUSHROOM=1024]="SUPER_MUSHROOM",rt[rt.POISON_MUSHROOM=2048]="POISON_MUSHROOM",rt[rt.HAMMER=4096]="HAMMER",rt[rt.WARP_STAR=8192]="WARP_STAR",rt[rt.SCREW_ATTACK=16384]="SCREW_ATTACK",rt[rt.BUNNY_HOOD=32768]="BUNNY_HOOD",rt[rt.RAY_GUN=65536]="RAY_GUN",rt[rt.FREEZIE=131072]="FREEZIE",rt[rt.FOOD=262144]="FOOD",rt[rt.MOTION_SENSOR_BOMB=524288]="MOTION_SENSOR_BOMB",rt[rt.FLIPPER=1048576]="FLIPPER",rt[rt.SUPER_SCOPE=2097152]="SUPER_SCOPE",rt[rt.STAR_ROD=4194304]="STAR_ROD",rt[rt.LIPS_STICK=8388608]="LIPS_STICK",rt[rt.HEART_CONTAINER=16777216]="HEART_CONTAINER",rt[rt.MAXIM_TOMATO=33554432]="MAXIM_TOMATO",rt[rt.STARMAN=67108864]="STARMAN",rt[rt.HOME_RUN_BAT=134217728]="HOME_RUN_BAT",rt[rt.BEAM_SWORD=268435456]="BEAM_SWORD",rt[rt.PARASOL=536870912]="PARASOL",rt[rt.GREEN_SHELL=1073741824]="GREEN_SHELL",rt[rt.RED_SHELL=2147483648]="RED_SHELL",rt[rt.CAPSULE=4294967296]="CAPSULE",rt[rt.BOX=8589934592]="BOX",rt[rt.BARREL=17179869184]="BARREL",rt[rt.EGG=34359738368]="EGG",rt[rt.PARTY_BALL=68719476736]="PARTY_BALL",rt[rt.BARREL_CANNON=137438953472]="BARREL_CANNON",rt[rt.BOMB_OMB=274877906944]="BOMB_OMB",rt[rt.MR_SATURN=549755813888]="MR_SATURN",exports.GameEndMethod=void 0,(nt=exports.GameEndMethod||(exports.GameEndMethod={}))[nt.UNRESOLVED=0]="UNRESOLVED",nt[nt.RESOLVED=3]="RESOLVED",nt[nt.TIME=1]="TIME",nt[nt.GAME=2]="GAME",nt[nt.NO_CONTEST=7]="NO_CONTEST",exports.Frames=void 0,(st=exports.Frames||(exports.Frames={}))[st.FIRST=-123]="FIRST",st[st.FIRST_PLAYABLE=-39]="FIRST_PLAYABLE",function(t){t[t.DZ=0]="DZ",t[t.NE=1]="NE",t[t.SE=2]="SE",t[t.SW=3]="SW",t[t.NW=4]="NW",t[t.N=5]="N",t[t.E=6]="E",t[t.S=7]="S",t[t.W=8]="W"}(ot||(ot={}));class Et{constructor(){this.state=new Map,this.playerPermutations=new Array}setup(t){this.state=new Map,this.playerPermutations=U(t),this.playerPermutations.forEach((t=>{this.state.set(t,{playerIndex:t.playerIndex,opponentIndex:t.opponentIndex,inputCount:0,joystickInputCount:0,cstickInputCount:0,buttonInputCount:0,triggerInputCount:0})}))}processFrame(t,e){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(t,e,r,n){const s=n.players[r.playerIndex].pre,o=s.frame,a=o-1,i=t[a]?t[a].players[r.playerIndex].pre:null;if(o<exports.Frames.FIRST_PLAYABLE||!i)return;const E=function(t){let e,r=t;for(e=0;r;e+=1)r&=r-1;return e}(~i.physicalButtons&s.physicalButtons&4095);e.inputCount+=E,e.buttonInputCount+=E;const l=lt(i.joystickX,i.joystickY),T=lt(s.joystickX,s.joystickY);l!==T&&T!==ot.DZ&&(e.inputCount+=1,e.joystickInputCount+=1);const c=lt(i.cStickX,i.cStickY),u=lt(s.cStickX,s.cStickY);c!==u&&u!==ot.DZ&&(e.inputCount+=1,e.cstickInputCount+=1),i.physicalLTrigger<.3&&s.physicalLTrigger>=.3&&(e.inputCount+=1,e.triggerInputCount+=1),i.physicalRTrigger<.3&&s.physicalRTrigger>=.3&&(e.inputCount+=1,e.triggerInputCount+=1)}(e,n,r,t)}))}fetch(){return Array.from(this.state.values())}}function lt(t,e){let r=ot.DZ;return t>=.2875&&e>=.2875?r=ot.NE:t>=.2875&&e<=-.2875?r=ot.SE:t<=-.2875&&e<=-.2875?r=ot.SW:t<=-.2875&&e>=.2875?r=ot.NW:e>=.2875?r=ot.N:t>=.2875?r=ot.E:e<=-.2875?r=ot.S:t<=-.2875&&(r=ot.W),r}function Tt({settings:e,inputs:r,conversions:n,playableFrameCount:s}){const o=t.keyBy(r,"playerIndex"),a=n,i=t.groupBy(n,(t=>{var e;return null==(e=t.moves[0])?void 0:e.playerIndex})),E=t.mapValues(i,(e=>t.groupBy(e,"openingType"))),l=s/3600;return e.players.map((r=>{const n=r.playerIndex,s=t.get(o,n)||{},i={buttons:t.get(s,"buttonInputCount"),triggers:t.get(s,"triggerInputCount"),cstick:t.get(s,"cstickInputCount"),joystick:t.get(s,"joystickInputCount"),total:t.get(s,"inputCount")};let T=0,c=0;const u=e.players.filter((t=>t.playerIndex!==n&&(!e.isTeams||t.teamId!==r.teamId))).map((t=>t.playerIndex));let _=0,p=0;return a.filter((t=>t.playerIndex!==n)).forEach((t=>{T++,t.didKill&&t.lastHitBy===n&&(p+=1),t.moves.length>1&&t.moves[0].playerIndex===n&&c++,t.moves.forEach((t=>{t.playerIndex===n&&(_+=t.damage)}))})),{playerIndex:n,inputCounts:i,conversionCount:T,totalDamage:_,killCount:p,successfulConversions:ct(c,T),inputsPerMinute:ct(i.total,l),digitalInputsPerMinute:ct(i.buttons,l),openingsPerKill:ct(T,p),damagePerOpening:ct(_,T),neutralWinRatio:ut(E,n,u,"neutral-win"),counterHitRatio:ut(E,n,u,"counter-attack"),beneficialTradeRatio:_t(E,n,u)}}))}function ct(t,e){return{count:t,total:e,ratio:e?t/e:null}}function ut(e,r,n,s){const o=t.get(e,[r,s])||[],a=t.flatten(n.map((r=>t.get(e,[r,s])||[])));return ct(o.length,o.length+a.length)}function _t(e,r,n){const s=t.get(e,[r,"trade"])||[],o=t.flatten(n.map((r=>t.get(e,[r,"trade"])||[]))),a=[];return t.zip(s,o).forEach((e=>{const r=t.first(e),n=t.last(e);if(r&&n){const t=r.currentPercent-r.startPercent,e=n.currentPercent-n.startPercent;(r.didKill&&!n.didKill||t>e)&&a.push(r)}})),ct(a.length,s.length)}const pt={processOnTheFly:!1};class At{constructor(t){this.options=void 0,this.lastProcessedFrame=null,this.frames={},this.players=[],this.allComputers=new Array,this.options=Object.assign({},pt,t)}setup(t){this.frames={},this.players=t.players.map((t=>t.playerIndex)),this.allComputers.forEach((e=>e.setup(t)))}register(...t){this.allComputers.push(...t)}process(){if(0===this.players.length)return;let t=null!==this.lastProcessedFrame?this.lastProcessedFrame+1:exports.Frames.FIRST;for(;this.frames[t];){const e=this.frames[t];if(!mt(this.players,e))return;this.allComputers.forEach((t=>t.processFrame(e,this.frames))),this.lastProcessedFrame=t,t++}}addFrame(t){this.frames[t.frame]=t,this.options.processOnTheFly&&this.process()}}function mt(e,r){if(!r)return!1;for(const n of e)if(!t.get(r,["players",n,"post"]))return!1;return!0}class ht{constructor(){this.state=new Map,this.playerPermutations=new Array,this.stocks=new Array}setup(t){this.state=new Map,this.playerPermutations=U(t),this.stocks=[],this.playerPermutations.forEach((t=>{this.state.set(t,{stock:null})}))}processFrame(t,e){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(t,e,r,n,s){const o=n.players[r.playerIndex].post,a=o.frame,i=a-1,E=t[i]?t[i].players[r.playerIndex].post:null;if(e.stock)if(E&&H(o,E)){var l;e.stock.endFrame=o.frame,e.stock.endPercent=null!=(l=E.percent)?l:0,e.stock.deathAnimation=o.actionStateId,e.stock=null}else{var T;e.stock.currentPercent=null!=(T=o.percent)?T:0}else{if(Y(o.actionStateId))return;e.stock={playerIndex:r.playerIndex,startFrame:a,endFrame:null,startPercent:0,endPercent:null,currentPercent:0,count:o.stocksRemaining,deathAnimation:null},s.push(e.stock)}}(e,n,r,t,this.stocks)}))}fetch(){return this.stocks}}function St(t){return null!=t}class Nt{constructor(){this.targetBreaks=new Array,this.isTargetTestGame=!1}setup(t){this.targetBreaks=[],this.isTargetTestGame=t.gameMode===exports.GameMode.TARGET_TEST}processFrame(t,e){this.isTargetTestGame&&function(t,e,r){var n,s,o,a,i,E;const l=e.frame,T=l-1;var c,u,_;l===exports.Frames.FIRST&&(null!=(c=null==(u=t[exports.Frames.FIRST])||null==(_=u.items)?void 0:_.filter((t=>209===t.typeId)))?c:[]).forEach((t=>{r.push({spawnId:t.spawnId,frameDestroyed:null,positionX:t.positionX,positionY:t.positionY})}));const p=null!=(n=null==(s=t[l])||null==(o=s.items)?void 0:o.filter((t=>209===t.typeId)))?n:[],A=null!=(a=null==(i=t[T])||null==(E=i.items)?void 0:E.filter((t=>209===t.typeId)))?a:[],m=p.map((t=>t.spawnId)).filter(St);A.map((t=>t.spawnId)).filter(St).filter((t=>!m.includes(t))).forEach((t=>{const e=r.find((e=>e.spawnId===t));e&&(e.frameDestroyed=l)}))}(e,t,this.targetBreaks)}fetch(){return this.targetBreaks}}var Rt,dt,ft,It,Ct;exports.CommunicationType=void 0,(Rt=exports.CommunicationType||(exports.CommunicationType={}))[Rt.HANDSHAKE=1]="HANDSHAKE",Rt[Rt.REPLAY=2]="REPLAY",Rt[Rt.KEEP_ALIVE=3]="KEEP_ALIVE";class Ot{constructor(){this.receiveBuf=Buffer.from([]),this.messages=new Array}receive(t){for(this.receiveBuf=Buffer.concat([this.receiveBuf,t]);this.receiveBuf.length>=4;){const t=this.receiveBuf.readUInt32BE(0);if(this.receiveBuf.length<t+4)return;const e=this.receiveBuf.slice(4,t+4);this.messages.push(o.decode(e)),this.receiveBuf=this.receiveBuf.slice(t+4)}}getReceiveBuffer(){return this.receiveBuf}getMessages(){const t=this.messages;return this.messages=[],t}genHandshakeOut(t,e,r=!1){const n=Buffer.from([0,0,0,0]);n.writeUInt32BE(e,0);const s={type:exports.CommunicationType.HANDSHAKE,payload:{cursor:t,clientToken:Uint8Array.from(n),isRealtime:r}},a=o.encode(s,{optimizeArrays:!0}),i=Buffer.concat([Buffer.from([0,0,0,0]),Buffer.from(a)]);return i.writeUInt32BE(a.byteLength,0),i}}exports.ConnectionEvent=void 0,(dt=exports.ConnectionEvent||(exports.ConnectionEvent={})).CONNECT="connect",dt.MESSAGE="message",dt.HANDSHAKE="handshake",dt.STATUS_CHANGE="statusChange",dt.DATA="data",dt.ERROR="error",exports.ConnectionStatus=void 0,(ft=exports.ConnectionStatus||(exports.ConnectionStatus={}))[ft.DISCONNECTED=0]="DISCONNECTED",ft[ft.CONNECTING=1]="CONNECTING",ft[ft.CONNECTED=2]="CONNECTED",ft[ft.RECONNECT_WAIT=3]="RECONNECT_WAIT",exports.Ports=void 0,(It=exports.Ports||(exports.Ports={}))[It.DEFAULT=51441]="DEFAULT",It[It.LEGACY=666]="LEGACY",It[It.RELAY_START=53741]="RELAY_START",function(t){t.INITIAL="initial",t.LEGACY="legacy",t.NORMAL="normal"}(Ct||(Ct={}));const gt={consoleNick:"unknown",gameDataCursor:Uint8Array.from([0,0,0,0,0,0,0,0]),version:"",clientToken:0},Ft={autoReconnect:!0};var Dt,xt,Mt;function yt(e){const r=t.map(e,(t=>{return(e=t.charCodeAt(0))>65280&&e<65375?e-65280+32:12288===e?32:8217===e?39:8221===e?34:e;var e}));return String.fromCharCode(...r)}function Bt(t,e,r,n,s){switch(t.source){case exports.SlpInputSource.FILE:return _.default.readSync(t.fileDescriptor,e,r,n,s);case exports.SlpInputSource.BUFFER:return t.buffer.copy(e,r,s,s+n);default:throw new Error("Source type not supported")}}function Gt(t){switch(t.source){case exports.SlpInputSource.FILE:return _.default.fstatSync(t.fileDescriptor).size;case exports.SlpInputSource.BUFFER:return t.buffer.length;default:throw new Error("Source type not supported")}}function Lt(t){const e=function(t){switch(t.source){case exports.SlpInputSource.FILE:if(!t.filePath)throw new Error("File source requires a file path");const e=_.default.openSync(t.filePath,"r");return{source:t.source,fileDescriptor:e};case exports.SlpInputSource.BUFFER:return{source:t.source,buffer:t.buffer};default:throw new Error("Source type not supported")}}(t),r=function(t){const e=new Uint8Array(1);return Bt(t,e,0,e.length,0),54===e[0]||e[0]!=="{".charCodeAt(0)?0:15}(e),n=function(t,e){const r=Gt(t);if(0===e)return r;const n=new Uint8Array(4);Bt(t,n,0,n.length,e-4);const s=n[0]<<24|n[1]<<16|n[2]<<8|n[3];return s>0?s:r-e}(e,r),s=r+n+10,o=function(t,e){return Gt(t)-e-1}(e,s),a=function(t,e){const r={};if(0===e)return r[54]=320,r[55]=6,r[56]=70,r[57]=1,r;const n=new Uint8Array(2);if(Bt(t,n,0,n.length,e),n[0]!==exports.Command.MESSAGE_SIZES)return{};const s=n[1];r[53]=s;const o=new Uint8Array(s-1);Bt(t,o,0,o.length,e+2);for(let t=0;t<s-1;t+=3)r[o[t]]=o[t+1]<<8|o[t+2];return r}(e,r);return{ref:e,rawDataPosition:r,rawDataLength:n,metadataPosition:s,metadataLength:o,messageSizes:a}}function Pt(t){t.ref.source===exports.SlpInputSource.FILE&&_.default.closeSync(t.ref.fileDescriptor)}function Ut(t){return[1,256,65536,16777216,4294967296].reduce(((e,r,n)=>e+Jt(t,40+n)*r),0)}function Ht(t){return{gameBitfield1:Jt(t,5),gameBitfield2:Jt(t,6),gameBitfield3:Jt(t,7),gameBitfield4:Jt(t,8),bombRainEnabled:(255&Jt(t,11))>0,itemSpawnBehavior:bt(t,16),selfDestructScoreValue:bt(t,17),itemSpawnBitfield1:Jt(t,40),itemSpawnBitfield2:Jt(t,41),itemSpawnBitfield3:Jt(t,42),itemSpawnBitfield4:Jt(t,43),itemSpawnBitfield5:Jt(t,44),damageRatio:Wt(t,53)}}function vt(e,r,n=null){const s=e.ref;let o=null!==n&&n>0?n:e.rawDataPosition;const a=e.rawDataPosition+e.rawDataLength,i=t.mapValues(e.messageSizes,(t=>new Uint8Array(t+1)));let E=new Uint8Array(0);const l=new Uint8Array(1);for(;o<a;){var T;Bt(s,l,0,1,o);let t=null!=(T=l[0])?T:0,e=i[t];if(void 0===e)return o;if(e.length>a-o)return o;const n=e.length;if(Bt(s,e,0,e.length,o),t===exports.Command.SPLIT_MESSAGE){var c,u;const r=new DataView(e.buffer),n=null!=(c=Kt(r,513))?c:512,s=Xt(r,516),o=null!=(u=Jt(r,515))?u:0;0===E.length&&(E=new Uint8Array(1),E[0]=o);const a=e.slice(1,1+n),i=new Uint8Array(E.length+a.length);var _;i.set(E),i.set(a,E.length),E=i,s&&(t=null!=(_=E[0])?_:0,e=E,E=new Uint8Array(0))}if(r(t,wt(t,e),e))break;o+=n}return o}function wt(t,e){const r=new DataView(e.buffer);switch(t){case exports.Command.GAME_START:const t=t=>{const n=8*t,s=Yt(r,321+n);let o="None";s!==Yt(r,325+n)?o="Mixed":1===s?o="UCF":2===s&&(o="Dween");const a=353+16*t,i=e.slice(a,a+16),E=m.default.decode(i,"Shift_JIS").split("\0").shift(),l=E?yt(E):"",T=421+31*t,c=e.slice(T,T+31),u=m.default.decode(c,"Shift_JIS").split("\0").shift(),_=u?yt(u):"",p=545+10*t,A=e.slice(p,p+10),h=m.default.decode(A,"Shift_JIS").split("\0").shift(),S=h?yt(h):"",N=585+29*t,R=e.slice(N,N+29),d=m.default.decode(R,"utf8").split("\0").shift(),f=null!=d?d:"",I=36*t;return{playerIndex:t,port:t+1,characterId:Jt(r,101+I),type:Jt(r,102+I),startStocks:Jt(r,103+I),characterColor:Jt(r,104+I),teamShade:Jt(r,108+I),handicap:Jt(r,109+I),teamId:Jt(r,110+I),staminaMode:Boolean(Jt(r,108+36*t,1)),silentCharacter:Boolean(Jt(r,108+36*t,2)),lowGravity:Boolean(Jt(r,108+36*t,4)),invisible:Boolean(Jt(r,108+36*t,8)),blackStockIcon:Boolean(Jt(r,108+36*t,16)),metal:Boolean(Jt(r,108+36*t,32)),startOnAngelPlatform:Boolean(Jt(r,108+36*t,64)),rumbleEnabled:Boolean(Jt(r,108+36*t,128)),cpuLevel:Jt(r,116+I),offenseRatio:Wt(r,125+I),defenseRatio:Wt(r,129+I),modelScale:Wt(r,133+I),controllerFix:o,nametag:l,displayName:_,connectCode:S,userId:f}},a=702,i=e.slice(a,a+51),E=m.default.decode(i,"utf8").split("\0").shift(),l=null!=E?E:"";return{slpVersion:`${Jt(r,1)}.${Jt(r,2)}.${Jt(r,3)}`,timerType:Jt(r,5,3),inGameMode:Jt(r,5,224),friendlyFireEnabled:!!Jt(r,6,1),isTeams:Xt(r,13),itemSpawnBehavior:Jt(r,16),stageId:Kt(r,19),startingTimerSeconds:Yt(r,21),enabledItems:Ut(r),players:[0,1,2,3].map(t),scene:Jt(r,419),gameMode:Jt(r,420),language:Jt(r,701),gameInfoBlock:Ht(r),randomSeed:Yt(r,317),isPAL:Xt(r,417),isFrozenPS:Xt(r,418),matchInfo:{matchId:l,gameNumber:Yt(r,753),tiebreakerNumber:Yt(r,757)}};case exports.Command.FRAME_START:return{frame:Vt(r,1),seed:Yt(r,5),sceneFrameCounter:Yt(r,9)};case exports.Command.PRE_FRAME_UPDATE:return{frame:Vt(r,1),playerIndex:Jt(r,5),isFollower:Xt(r,6),seed:Yt(r,7),actionStateId:Kt(r,11),positionX:Wt(r,13),positionY:Wt(r,17),facingDirection:Wt(r,21),joystickX:Wt(r,25),joystickY:Wt(r,29),cStickX:Wt(r,33),cStickY:Wt(r,37),trigger:Wt(r,41),buttons:Yt(r,45),physicalButtons:Kt(r,49),physicalLTrigger:Wt(r,51),physicalRTrigger:Wt(r,55),rawJoystickX:bt(r,59),percent:Wt(r,60)};case exports.Command.POST_FRAME_UPDATE:const T={airX:Wt(r,53),y:Wt(r,57),attackX:Wt(r,61),attackY:Wt(r,65),groundX:Wt(r,69)};return{frame:Vt(r,1),playerIndex:Jt(r,5),isFollower:Xt(r,6),internalCharacterId:Jt(r,7),actionStateId:Kt(r,8),positionX:Wt(r,10),positionY:Wt(r,14),facingDirection:Wt(r,18),percent:Wt(r,22),shieldSize:Wt(r,26),lastAttackLanded:Jt(r,30),currentComboCount:Jt(r,31),lastHitBy:Jt(r,32),stocksRemaining:Jt(r,33),actionStateCounter:Wt(r,34),miscActionState:Wt(r,43),isAirborne:Xt(r,47),lastGroundId:Kt(r,48),jumpsRemaining:Jt(r,50),lCancelStatus:Jt(r,51),hurtboxCollisionState:Jt(r,52),selfInducedSpeeds:T,hitlagRemaining:Wt(r,73),animationIndex:Yt(r,77)};case exports.Command.ITEM_UPDATE:return{frame:Vt(r,1),typeId:Kt(r,5),state:Jt(r,7),facingDirection:Wt(r,8),velocityX:Wt(r,12),velocityY:Wt(r,16),positionX:Wt(r,20),positionY:Wt(r,24),damageTaken:Kt(r,28),expirationTimer:Wt(r,30),spawnId:Yt(r,34),missileType:Jt(r,38),turnipFace:Jt(r,39),chargeShotLaunched:Jt(r,40),chargePower:Jt(r,41),owner:bt(r,42)};case exports.Command.FRAME_BOOKEND:return{frame:Vt(r,1),latestFinalizedFrame:Vt(r,5)};case exports.Command.GAME_END:const c=[0,1,2,3].map((t=>({playerIndex:t,position:bt(r,3+t)})));return{gameEndMethod:Jt(r,1),lrasInitiatorIndex:bt(r,2),placements:c};case exports.Command.GECKO_LIST:const u=[];let _=1;for(;_<e.length;){var n;const t=null!=(n=Yt(r,_))?n:0,a=t>>24&254,i=2147483648+(33554431&t);let E=8;var s;if(192===a||194===a)E=8+8*(null!=(s=Yt(r,_+4))?s:0);else if(6===a){var o;E=8+((null!=(o=Yt(r,_+4))?o:0)+7&4294967288)}else 8===a&&(E=16);u.push({type:a,address:i,contents:e.slice(_,_+E)}),_+=E}return{contents:e.slice(1),codes:u};default:return null}}function kt(t,e,r){return e+r<=t.byteLength}function Wt(t,e){return kt(t,e,4)?t.getFloat32(e):null}function Vt(t,e){return kt(t,e,4)?t.getInt32(e):null}function bt(t,e){return kt(t,e,1)?t.getInt8(e):null}function Yt(t,e){return kt(t,e,4)?t.getUint32(e):null}function Kt(t,e){return kt(t,e,2)?t.getUint16(e):null}function Jt(t,e,r=255){return kt(t,e,1)?t.getUint8(e)&r:null}function Xt(t,e){return kt(t,e,1)?!!t.getUint8(e):null}function jt(t){if(t.metadataLength<=0)return null;const e=new Uint8Array(t.metadataLength);Bt(t.ref,e,0,e.length,t.metadataPosition);let r=null;try{r=o.decode(e)}catch(t){}return r}function zt(t){const{ref:e,rawDataPosition:r,rawDataLength:n,messageSizes:s}=t,o=s[exports.Command.GAME_END];if(!St(o)||o<=0)return null;const a=o+1,i=r+n-a,E=new Uint8Array(a);return Bt(e,E,0,E.length,i),E[0]!==exports.Command.GAME_END?null:wt(exports.Command.GAME_END,E)||null}function $t(t){const{ref:e,rawDataPosition:r,rawDataLength:n,messageSizes:s}=t,o=s[exports.Command.POST_FRAME_UPDATE],a=s[exports.Command.GAME_END],i=s[exports.Command.FRAME_BOOKEND];if(!St(o))return[];const E=o+1;let l=null,T=r+n-(a?a+1:0)-(i?i+1:0)-E;const c=[];do{const t=new Uint8Array(E);if(Bt(e,t,0,t.length,T),t[0]!==exports.Command.POST_FRAME_UPDATE)break;const r=wt(exports.Command.POST_FRAME_UPDATE,t);if(!r)break;if(null===l)l=r.frame;else if(l!==r.frame)break;c.unshift(r),T-=E}while(T>=r);return c}exports.DolphinMessageType=void 0,(Dt=exports.DolphinMessageType||(exports.DolphinMessageType={})).CONNECT_REPLY="connect_reply",Dt.GAME_EVENT="game_event",Dt.START_GAME="start_game",Dt.END_GAME="end_game",exports.SlpInputSource=void 0,(xt=exports.SlpInputSource||(exports.SlpInputSource={})).BUFFER="buffer",xt.FILE="file",exports.SlpStreamMode=void 0,(Mt=exports.SlpStreamMode||(exports.SlpStreamMode={})).AUTO="AUTO",Mt.MANUAL="MANUAL";const Zt={suppressErrors:!1,mode:exports.SlpStreamMode.AUTO};var qt;exports.SlpStreamEvent=void 0,(qt=exports.SlpStreamEvent||(exports.SlpStreamEvent={})).RAW="slp-raw",qt.COMMAND="slp-command";class Qt extends s.Writable{constructor(t,e){super(e),this.gameEnded=!1,this.settings=void 0,this.payloadSizes=null,this.previousBuffer=Buffer.from([]),this.settings=Object.assign({},Zt,t)}restart(){this.gameEnded=!1,this.payloadSizes=null}_write(t,e,r){if("buffer"!==e)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${e}'.`);const n=Uint8Array.from(Buffer.concat([this.previousBuffer,t]));this.previousBuffer=Buffer.from([]);const s=new DataView(n.buffer);let o=0;for(;o<n.length;){if("HELO\0"===Buffer.from(n.slice(o,o+5)).toString()){o+=5;continue}const t=s.getUint8(o);let e=0;var a;if(this.payloadSizes&&(e=null!=(a=this.payloadSizes.get(t))?a:0),n.length-o<e+1){this.previousBuffer=n.slice(o);break}if(this.settings.mode===exports.SlpStreamMode.MANUAL&&this.gameEnded)break;o+=1;const r=n.slice(o),i=new DataView(n.buffer,o);let E=0;try{E=this._processCommand(t,r,i)}catch(t){if(!this.settings.suppressErrors)throw t;E=0}o+=E}r()}_writeCommand(t,e,r){const n=e.slice(0,r),s=Buffer.concat([Buffer.from([t]),n]);return this.emit(exports.SlpStreamEvent.RAW,{command:t,payload:s}),new Uint8Array(s)}_processCommand(t,e,r){if(t===exports.Command.MESSAGE_SIZES){const n=r.getUint8(0);return this.payloadSizes=te(r),this._writeCommand(t,e,n),this.emit(exports.SlpStreamEvent.COMMAND,{command:t,payload:this.payloadSizes}),n}let n=0;var s;this.payloadSizes&&(n=null!=(s=this.payloadSizes.get(t))?s:0);let o,a=null;return n>0&&(o=this._writeCommand(t,e,n),a=wt(t,o)),a?(t===exports.Command.GAME_END&&this.settings.mode===exports.SlpStreamMode.MANUAL&&(this.gameEnded=!0),this.emit(exports.SlpStreamEvent.COMMAND,{command:t,payload:a}),n):n}}const te=t=>{const e=new Map,r=t.getUint8(0);for(let n=1;n<r;n+=3){const r=t.getUint8(n),s=t.getUint16(n+1);e.set(r,s)}return e};class ee extends s.Writable{constructor(t,e,r){super(r),this.filePath=void 0,this.metadata=void 0,this.fileStream=null,this.rawDataLength=0,this.slpStream=void 0,this.usesExternalStream=!1,this.filePath=t,this.metadata={consoleNickname:"unknown",startTime:new Date,lastFrame:-124,players:{}},this.usesExternalStream=Boolean(e),this.slpStream=e||new Qt({mode:exports.SlpStreamMode.MANUAL}),this._setupListeners(),this._initializeNewGame(this.filePath)}path(){return this.filePath}setMetadata(t){this.metadata=Object.assign({},this.metadata,t)}_write(t,e,r){if("buffer"!==e)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${e}'.`);this.fileStream&&this.fileStream.write(t),this.usesExternalStream||this.slpStream.write(t),this.rawDataLength+=t.length,r()}_onCommand(e){const{command:r,payload:n}=e;switch(r){case exports.Command.GAME_START:const{players:e}=n;t.forEach(e,(t=>{3!==t.type&&(this.metadata.players[t.playerIndex]={characterUsage:{},names:{netplay:t.displayName,code:t.connectCode}})}));break;case exports.Command.POST_FRAME_UPDATE:const{frame:r,playerIndex:s,isFollower:o,internalCharacterId:a}=n;if(o)break;this.metadata.lastFrame=r;const i=this.metadata.players[s],E=i.characterUsage,l=E[a]||0,T={...i,characterUsage:{...E,[a]:l+1}};this.metadata.players[s]=T}}_setupListeners(){const t=t=>{this._onCommand(t)};this.slpStream.on(exports.SlpStreamEvent.COMMAND,t),this.on("finish",(()=>{const e=_.default.openSync(this.filePath,"r+");_.default.writeSync(e,ne(this.rawDataLength),0,4,11),_.default.closeSync(e),this.slpStream.removeListener(exports.SlpStreamEvent.COMMAND,t),this.usesExternalStream||this.slpStream.end()}))}_initializeNewGame(t){this.fileStream=_.default.createWriteStream(t,{encoding:"binary"});const e=Buffer.concat([Buffer.from("{U"),Buffer.from([3]),Buffer.from("raw[$U#l"),Buffer.from([0,0,0,0])]);this.fileStream.write(e)}_final(e){let r=Buffer.concat([Buffer.from("U"),Buffer.from([8]),Buffer.from("metadata{")]);const n=this.metadata.startTime.toISOString();r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("startAtSU"),Buffer.from([n.length]),Buffer.from(n)]);const s=this.metadata.lastFrame;r=Buffer.concat([r,Buffer.from("U"),Buffer.from([9]),Buffer.from("lastFramel"),re(s)]);const o=this.metadata.consoleNickname||"unknown";r=Buffer.concat([r,Buffer.from("U"),Buffer.from([11]),Buffer.from("consoleNickSU"),Buffer.from([o.length]),Buffer.from(o)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("players{")]),t.forEach(this.metadata.players,((e,n)=>{r=Buffer.concat([r,Buffer.from("U"),Buffer.from([n.length]),Buffer.from(`${n}{`)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([10]),Buffer.from("characters{")]),t.forEach(e.characterUsage,((t,e)=>{r=Buffer.concat([r,Buffer.from("U"),Buffer.from([e.length]),Buffer.from(`${e}l`),ne(t)])})),r=Buffer.concat([r,Buffer.from("}")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([5]),Buffer.from("names{")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("netplaySU"),Buffer.from([e.names.netplay.length]),Buffer.from(`${e.names.netplay}`)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([4]),Buffer.from("codeSU"),Buffer.from([e.names.code.length]),Buffer.from(`${e.names.code}`)]),r=Buffer.concat([r,Buffer.from("}}")])})),r=Buffer.concat([r,Buffer.from("}")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([8]),Buffer.from("playedOnSU"),Buffer.from([7]),Buffer.from("network")]),r=Buffer.concat([r,Buffer.from("}}")]),this.fileStream&&this.fileStream.write(r,e)}}const re=t=>{const e=Buffer.alloc(4);return e.writeInt32BE(t,0),e},ne=t=>{const e=Buffer.alloc(4);return e.writeUInt32BE(t,0),e},se={outputFiles:!0,folderPath:".",consoleNickname:"unknown",newFilename:function(t,e){return h.default.join(t,`Game_${r.format(e,"yyyyMMdd")}T${r.format(e,"HHmmss")}.slp`)}};var oe,ae;exports.SlpFileWriterEvent=void 0,(oe=exports.SlpFileWriterEvent||(exports.SlpFileWriterEvent={})).NEW_FILE="new-file",oe.FILE_COMPLETE="file-complete";class ie{constructor(){this.rollbackFrames={},this.rollbackFrameCount=0,this.rollbackPlayerIdx=null,this.lastFrameWasRollback=!1,this.currentRollbackLength=0,this.rollbackLengths=[]}checkIfRollbackFrame(t,e){if(null===this.rollbackPlayerIdx)this.rollbackPlayerIdx=e;else if(this.rollbackPlayerIdx!==e)return;return t&&t.players?(this.rollbackFrames[t.frame]?this.rollbackFrames[t.frame].push(t):this.rollbackFrames[t.frame]=[t],this.rollbackFrameCount++,this.currentRollbackLength++,this.lastFrameWasRollback=!0):this.lastFrameWasRollback&&(this.rollbackLengths.push(this.currentRollbackLength),this.currentRollbackLength=0,this.lastFrameWasRollback=!1),this.lastFrameWasRollback}getFrames(){return this.rollbackFrames}getCount(){return this.rollbackFrameCount}getLengths(){return this.rollbackLengths}}exports.SlpParserEvent=void 0,(ae=exports.SlpParserEvent||(exports.SlpParserEvent={})).SETTINGS="settings",ae.END="end",ae.FRAME="frame",ae.FINALIZED_FRAME="finalized-frame",ae.ROLLBACK_FRAME="rollback-frame";const Ee={strict:!1};class le extends e.EventEmitter{constructor(t){super(),this.frames={},this.rollbackCounter=new ie,this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1,this.options=void 0,this.geckoList=null,this.options=Object.assign({},Ee,t)}handleCommand(t,e){switch(t){case exports.Command.GAME_START:this._handleGameStart(e);break;case exports.Command.FRAME_START:this._handleFrameStart(e);break;case exports.Command.POST_FRAME_UPDATE:this._handlePostFrameUpdate(e),this._handleFrameUpdate(t,e);break;case exports.Command.PRE_FRAME_UPDATE:this._handleFrameUpdate(t,e);break;case exports.Command.ITEM_UPDATE:this._handleItemUpdate(e);break;case exports.Command.FRAME_BOOKEND:this._handleFrameBookend(e);break;case exports.Command.GAME_END:this._handleGameEnd(e);break;case exports.Command.GECKO_LIST:this._handleGeckoList(e)}}reset(){this.frames={},this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1}getLatestFrameNumber(){var t;return null!=(t=this.latestFrameIndex)?t:exports.Frames.FIRST-1}getPlayableFrameCount(){return null===this.latestFrameIndex||this.latestFrameIndex<exports.Frames.FIRST_PLAYABLE?0:this.latestFrameIndex-exports.Frames.FIRST_PLAYABLE}getLatestFrame(){const e=this.getFrames(),r=null!==this.latestFrameIndex?this.latestFrameIndex:exports.Frames.FIRST;return t.get(e,this.gameEnd?r:r-1)||null}getSettings(){return this.settingsComplete?this.settings:null}getItems(){var t,e;if((null==(t=this.settings)?void 0:t.itemSpawnBehavior)===exports.ItemSpawnType.OFF)return null;const r=null==(e=this.settings)?void 0:e.enabledItems;if(!St(r))return null;const n=[];for(let t=0;t<40;t++)1&Math.floor(r/2**t)&&n.push(2**t);return n}getGameEnd(){return this.gameEnd}getFrames(){return this.frames}getRollbackFrames(){return{frames:this.rollbackCounter.getFrames(),count:this.rollbackCounter.getCount(),lengths:this.rollbackCounter.getLengths()}}getFrame(t){return this.frames[t]||null}getGeckoList(){return this.geckoList}_handleGeckoList(t){this.geckoList=t}_handleGameEnd(t){null!==this.latestFrameIndex&&this.latestFrameIndex!==this.lastFinalizedFrame&&this._finalizeFrames(this.latestFrameIndex),this.gameEnd=t,this.emit(exports.SlpParserEvent.END,this.gameEnd)}_handleGameStart(t){this.settings=t,this.settings.players=t.players.filter((t=>3!==t.type)),t.slpVersion&&S.default.gte(t.slpVersion,"1.6.0")&&this._completeSettings()}_handleFrameStart(e){t.set(this.frames,[e.frame,"start"],e)}_handlePostFrameUpdate(e){if(!this.settingsComplete){if(e.frame<=exports.Frames.FIRST){const r=e.playerIndex,n=t.keyBy(this.settings.players,"playerIndex");switch(e.internalCharacterId){case 7:n[r].characterId=19;break;case 19:n[r].characterId=18}}e.frame>exports.Frames.FIRST&&this._completeSettings()}}_handleFrameUpdate(e,r){const n=e===exports.Command.PRE_FRAME_UPDATE?"pre":"post",s=r.isFollower?"followers":"players",o=r.frame;if(this.latestFrameIndex=o,"pre"===n&&!r.isFollower){const t=this.frames[o];this.rollbackCounter.checkIfRollbackFrame(t,r.playerIndex)&&this.emit(exports.SlpParserEvent.ROLLBACK_FRAME,t)}t.set(this.frames,[o,s,r.playerIndex,n],r),t.set(this.frames,[o,"frame"],o);const a=this.getSettings();!a||a.slpVersion&&!S.default.lte(a.slpVersion,"2.2.0")?t.set(this.frames,[o,"isTransferComplete"],!1):(this.emit(exports.SlpParserEvent.FRAME,this.frames[o]),this._finalizeFrames(o-1))}_handleItemUpdate(e){var r,n;const s=e.frame,o=null!=(r=null==(n=this.frames[s])?void 0:n.items)?r:[];o.push(e),t.set(this.frames,[s,"items"],o)}_handleFrameBookend(e){const r=e.latestFinalizedFrame,n=e.frame;if(t.set(this.frames,[n,"isTransferComplete"],!0),this.emit(exports.SlpParserEvent.FRAME,this.frames[n]),this.settings.gameMode===exports.GameMode.ONLINE&&r>=exports.Frames.FIRST){if(this.options.strict&&r<n-7)throw new Error(`latestFinalizedFrame should be within 7 frames of ${n}`);this._finalizeFrames(r)}else this._finalizeFrames(n-7)}_finalizeFrames(t){for(;this.lastFinalizedFrame<t;){const e=this.lastFinalizedFrame+1,r=this.getFrame(e);if(this.options.strict)for(const n of this.settings.players){const s=r.players[n.playerIndex];if(this.settings.players.length>2&&!s)continue;const{pre:o,post:a}=s;if(!o||!a)throw new Error(`Could not finalize frame ${e} of ${t}: missing ${o?"pre":"post"}-frame update for player ${n.playerIndex}`)}this.emit(exports.SlpParserEvent.FINALIZED_FRAME,r),this.lastFinalizedFrame=e}}_completeSettings(){this.settingsComplete||(this.settingsComplete=!0,this.emit(exports.SlpParserEvent.SETTINGS,this.settings))}}exports.ActionsComputer=X,exports.ComboComputer=at,exports.ConsoleCommunication=Ot,exports.ConsoleConnection=class extends e.EventEmitter{constructor(t){super(),this.ipAddress=void 0,this.port=void 0,this.isRealtime=void 0,this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.connDetails={...gt},this.client=null,this.connection=null,this.options=void 0,this.shouldReconnect=!1,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT,this.isRealtime=!1,this.options=Object.assign({},Ft,t)}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{...this.connDetails}}connect(t,e,r=!1,n=2e4){this.ipAddress=t,this.port=e,this.isRealtime=r,this._connectOnPort(t,e,n)}_connectOnPort(t,e,r){const n=A.default((()=>p.default.connect({host:t,port:e,timeout:r})));this._setStatus(exports.ConnectionStatus.CONNECTING);const s=new Ot,o=n({initialDelay:2e3,maxDelay:1e4,strategy:"fibonacci",failAfter:Infinity},(n=>{var o;this.emit(exports.ConnectionEvent.CONNECT),this.shouldReconnect=this.options.autoReconnect,this.client=n;let a=Ct.INITIAL;n.on("data",(r=>{if(a===Ct.INITIAL&&(a=this._getInitialCommState(r),console.log(`Connected to ${t}:${e} with type: ${a}`),this._setStatus(exports.ConnectionStatus.CONNECTED),console.log(r.toString("hex"))),a===Ct.LEGACY)return void this._handleReplayData(r);try{s.receive(r)}catch(t){return console.error("Failed to process new data from server...",{error:t,prevDataBuf:s.getReceiveBuffer(),rcvData:r}),n.destroy(),void this.emit(exports.ConnectionEvent.ERROR,t)}const o=s.getMessages();try{o.forEach((t=>this._processMessage(t)))}catch(t){console.error(t),n.destroy(),this.emit(exports.ConnectionEvent.ERROR,t)}})),n.on("timeout",(()=>{console.warn(`Attempted connection to ${t}:${e} timed out after ${r}ms`),n.destroy()})),n.on("end",(()=>{console.log("disconnect"),this.shouldReconnect||n.destroy()})),n.on("close",(()=>{console.log("connection was closed")}));const i=s.genHandshakeOut(this.connDetails.gameDataCursor,null!=(o=this.connDetails.clientToken)?o:0,this.isRealtime);n.write(i)})),a=()=>{this._setStatus(this.shouldReconnect?exports.ConnectionStatus.RECONNECT_WAIT:exports.ConnectionStatus.CONNECTING)};o.on("connect",a),o.on("reconnect",a),o.on("disconnect",(()=>{this.shouldReconnect||(o.reconnect=!1,o.disconnect(),this._setStatus(exports.ConnectionStatus.DISCONNECTED))})),o.on("error",(t=>{console.warn(`Connection on port ${e} encountered an error.`,t),this._setStatus(exports.ConnectionStatus.DISCONNECTED),this.emit(exports.ConnectionEvent.ERROR,`Connection on port ${e} encountered an error.\n${t}`)})),this.connection=o,o.connect(e)}disconnect(){this.connection&&(this.connection.reconnect=!1,this.connection.disconnect(),this.connection=null),this.client&&this.client.destroy()}_getInitialCommState(t){if(t.length<13)return Ct.LEGACY;const e=Buffer.from([123,105,4,116,121,112,101,85,1]);return t.slice(4,13).equals(e)?Ct.NORMAL:Ct.LEGACY}_processMessage(t){switch(this.emit(exports.ConnectionEvent.MESSAGE,t),t.type){case exports.CommunicationType.KEEP_ALIVE:const e=Buffer.from("HELO\0");this._handleReplayData(e);break;case exports.CommunicationType.REPLAY:const r=Uint8Array.from(t.payload.pos),n=Buffer.compare(this.connDetails.gameDataCursor,r);if(!t.payload.forcePos&&0!==n)throw new Error(`Position of received data is incorrect. Expected: ${this.connDetails.gameDataCursor.toString()}, Received: ${r.toString()}`);t.payload.forcePos&&console.warn("Overflow occured in Nintendont, data has likely been skipped and replay corrupted. Expected, Received:",this.connDetails.gameDataCursor,r),this.connDetails.gameDataCursor=Uint8Array.from(t.payload.nextPos);const s=Uint8Array.from(t.payload.data);this._handleReplayData(s);break;case exports.CommunicationType.HANDSHAKE:const{nick:o,nintendontVersion:a}=t.payload;o&&(this.connDetails.consoleNick=o);const i=Buffer.from(t.payload.clientToken);this.connDetails.clientToken=i.readUInt32BE(0),a&&(this.connDetails.version=a),this.connDetails.gameDataCursor=Uint8Array.from(t.payload.pos),this.emit(exports.ConnectionEvent.HANDSHAKE,this.connDetails)}}_handleReplayData(t){this.emit(exports.ConnectionEvent.DATA,t)}_setStatus(t){this.connectionStatus!==t&&(this.connectionStatus=t,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}},exports.ConversionComputer=it,exports.DolphinConnection=class extends e.EventEmitter{constructor(){super(),this.ipAddress=void 0,this.port=void 0,this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.gameCursor=0,this.nickname="unknown",this.version="",this.peer=null,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{consoleNick:this.nickname,gameDataCursor:this.gameCursor,version:this.version}}async connect(t,e){console.log(`Connecting to: ${t}:${e}`),this.ipAddress=t,this.port=e;const r=await Promise.resolve().then((function(){return u(require("enet"))})),n=r.createClient({peers:32,channels:3,down:0,up:0},(t=>{t&&console.error(t)}));this.peer=n.connect({address:this.ipAddress,port:this.port},3,1337,((t,e)=>{t?console.error(t):(e.ping(),this.emit(exports.ConnectionEvent.CONNECT),this._setStatus(exports.ConnectionStatus.CONNECTED))})),this.peer.on("connect",(()=>{this.gameCursor=0;const t=new r.Packet(JSON.stringify({type:"connect_request",cursor:this.gameCursor}),r.PACKET_FLAG.RELIABLE);this.peer.send(0,t)})),this.peer.on("message",(t=>{const e=t.data();if(0===e.length)return;const r=e.toString("ascii"),n=JSON.parse(r),{dolphin_closed:s}=n;if(s)this.disconnect();else switch(this.emit(exports.ConnectionEvent.MESSAGE,n),n.type){case exports.DolphinMessageType.CONNECT_REPLY:this.connectionStatus=exports.ConnectionStatus.CONNECTED,this.gameCursor=n.cursor,this.nickname=n.nick,this.version=n.version,this.emit(exports.ConnectionEvent.HANDSHAKE,this.getDetails());break;case exports.DolphinMessageType.GAME_EVENT:{const{payload:t}=n;if(!t)return void this.disconnect();this._updateCursor(n,r);const e=Buffer.from(t,"base64");this._handleReplayData(e);break}case exports.DolphinMessageType.START_GAME:case exports.DolphinMessageType.END_GAME:this._updateCursor(n,r)}})),this.peer.on("disconnect",(()=>{this.disconnect()})),this._setStatus(exports.ConnectionStatus.CONNECTING)}disconnect(){this.peer&&(this.peer.disconnect(),this.peer=null),this._setStatus(exports.ConnectionStatus.DISCONNECTED)}_handleReplayData(t){this.emit(exports.ConnectionEvent.DATA,t)}_setStatus(t){this.connectionStatus!==t&&(this.connectionStatus=t,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}_updateCursor(t,e){const{cursor:r,next_cursor:n}=t;if(this.gameCursor!==r){const t=new Error(`Unexpected game data cursor. Expected: ${this.gameCursor} but got: ${r}. Payload: ${e}`);console.warn(t),this.emit(exports.ConnectionEvent.ERROR,t)}this.gameCursor=n}},exports.InputComputer=Et,exports.MAX_ROLLBACK_FRAMES=7,exports.NETWORK_MESSAGE="HELO\0",exports.SlippiGame=class{constructor(t,e){if(this.input=void 0,this.metadata=null,this.finalStats=null,this.parser=void 0,this.readPosition=null,this.actionsComputer=new X,this.conversionComputer=new it,this.comboComputer=new at,this.stockComputer=new ht,this.inputComputer=new Et,this.targetBreakComputer=new Nt,this.statsComputer=void 0,"string"==typeof t)this.input={source:exports.SlpInputSource.FILE,filePath:t};else if(t instanceof Buffer)this.input={source:exports.SlpInputSource.BUFFER,buffer:t};else{if(!(t instanceof ArrayBuffer))throw new Error("Cannot create SlippiGame with input of that type");this.input={source:exports.SlpInputSource.BUFFER,buffer:Buffer.from(t)}}this.statsComputer=new At(e),this.statsComputer.register(this.actionsComputer,this.comboComputer,this.conversionComputer,this.inputComputer,this.stockComputer,this.targetBreakComputer),this.parser=new le,this.parser.on(exports.SlpParserEvent.SETTINGS,(t=>{this.statsComputer.setup(t)})),this.parser.on(exports.SlpParserEvent.FINALIZED_FRAME,(t=>{this.statsComputer.addFrame(t)}))}_process(t=(()=>!1),e){if(null!==this.parser.getGameEnd())return;const r=null!=e?e:Lt(this.input);this.readPosition=vt(r,((e,r)=>!!r&&(this.parser.handleCommand(e,r),t(e,r))),this.readPosition),e||Pt(r)}getSettings(){return this._process((()=>null!==this.parser.getSettings())),this.parser.getSettings()}getItems(){return this._process(),this.parser.getItems()}getLatestFrame(){return this._process(),this.parser.getLatestFrame()}getGameEnd(t={}){if(null!=t&&t.skipProcessing){const t=Lt(this.input),e=zt(t);return Pt(t),e}return this._process(),this.parser.getGameEnd()}getFrames(){return this._process(),this.parser.getFrames()}getRollbackFrames(){return this._process(),this.parser.getRollbackFrames()}getGeckoList(){return this._process((()=>null!==this.parser.getGeckoList())),this.parser.getGeckoList()}getStats(){if(this.finalStats)return this.finalStats;this._process();const t=this.parser.getSettings();if(!t)return null;this.statsComputer.process();const e=this.inputComputer.fetch(),r=this.stockComputer.fetch(),n=this.conversionComputer.fetch(),s=this.parser.getPlayableFrameCount(),o=Tt({settings:t,inputs:e,conversions:n,playableFrameCount:s}),a=null!==this.parser.getGameEnd(),i={lastFrame:this.parser.getLatestFrameNumber(),playableFrameCount:s,stocks:r,conversions:n,combos:this.comboComputer.fetch(),actionCounts:this.actionsComputer.fetch(),overall:o,gameComplete:a};return a&&(this.finalStats=i),i}getStadiumStats(){this._process();const t=this.parser.getSettings();if(!t)return null;const e=this.parser.getLatestFrame();if(!(null==e?void 0:e.players))return null;switch(this.statsComputer.process(),t.gameMode){case exports.GameMode.TARGET_TEST:return{type:"target-test",targetBreaks:this.targetBreakComputer.fetch()};case exports.GameMode.HOME_RUN_CONTEST:const r=function(t,e){var r;const n=Object.values(e.players).filter(St).find((t=>32===t.post.internalCharacterId));if(!n)return null;const s=t.language===exports.Language.JAPANESE?"meters":"feet",o=function(t,e="feet"){let r=0;switch(e){case"feet":r=10*Math.floor(t-66.67234),r=Math.fround(r),r=Math.floor(r/30.4788*10)/10;break;case"meters":r=10*Math.floor(t-70*1.04167),r=Math.fround(r),r=Math.floor(r/100*10)/10;break;default:throw new Error(`Unsupported units: ${e}`)}return r=Math.round(10*r)/10,Math.max(0,r)}(null!=(r=n.post.positionX)?r:0,s);return{distance:o,units:s}}(t,e);return r?{type:"home-run-contest",distance:r.distance,units:r.units}:null;default:return null}}getMetadata(){if(this.metadata)return this.metadata;const t=Lt(this.input);return this.metadata=jt(t),Pt(t),this.metadata}getFilePath(){var t;return this.input.source!==exports.SlpInputSource.FILE?null:null!=(t=this.input.filePath)?t:null}getWinners(){const t=Lt(this.input),e=zt(t);this._process((()=>null!==this.parser.getSettings()),t);const r=this.parser.getSettings();if(!e||!r)return Pt(t),[];let n=[];return e.gameEndMethod===exports.GameEndMethod.TIME&&(n=$t(t)),Pt(t),function(t,e,r){var n,s;const{placements:o,gameEndMethod:a,lrasInitiatorIndex:i}=t,{players:E,isTeams:l}=e;if(a===exports.GameEndMethod.NO_CONTEST||a===exports.GameEndMethod.UNRESOLVED){if(St(i)&&2===E.length){var T;const t=null==(T=E.find((({playerIndex:t})=>t!==i)))?void 0:T.playerIndex;if(St(t))return[{playerIndex:t,position:0}]}return[]}if(a===exports.GameEndMethod.TIME&&2===E.length){const t=r.filter((t=>!t.isFollower));if(t.length!==E.length)return[];const e=t[0],n=t[1];if(e.stocksRemaining>n.stocksRemaining)return[{playerIndex:e.playerIndex,position:0}];if(n.stocksRemaining>e.stocksRemaining)return[{playerIndex:n.playerIndex,position:0}];const s=Math.trunc(e.percent),o=Math.trunc(n.percent);return s<o?[{playerIndex:e.playerIndex,position:0}]:o<s?[{playerIndex:n.playerIndex,position:0}]:[]}const c=o.find((t=>0===t.position));if(!c)return[];const u=null!=(n=null==(s=E.find((({playerIndex:t})=>t===c.playerIndex)))?void 0:s.teamId)?n:null;return l&&St(u)?o.filter((t=>{var e,r;return(null!=(e=null==(r=E.find((({playerIndex:e})=>e===t.playerIndex)))?void 0:r.teamId)?e:null)===u})):[c]}(e,r,n)}},exports.SlpFile=ee,exports.SlpFileWriter=class extends Qt{constructor(t,e){super(t,e),this.currentFile=null,this.options=void 0,this.options=Object.assign({},se,t),this._setupListeners()}_writePayload(t){this.currentFile&&this.currentFile.write(t)}_setupListeners(){this.on(exports.SlpStreamEvent.RAW,(t=>{const{command:e,payload:r}=t;switch(e){case exports.Command.MESSAGE_SIZES:this._handleNewGame(),this._writePayload(r);break;case exports.Command.GAME_END:this._writePayload(r),this._handleEndGame();break;default:this._writePayload(r)}}))}getCurrentFilename(){return null!==this.currentFile?h.default.resolve(this.currentFile.path()):null}endCurrentFile(){this._handleEndGame()}updateSettings(t){this.options=Object.assign({},this.options,t)}_handleNewGame(){if(this.options.outputFiles){const t=this.options.newFilename(this.options.folderPath,new Date);this.currentFile=new ee(t,this),this.emit(exports.SlpFileWriterEvent.NEW_FILE,t)}}_handleEndGame(){this.currentFile&&(this.currentFile.setMetadata({consoleNickname:this.options.consoleNickname}),this.currentFile.end(),this.emit(exports.SlpFileWriterEvent.FILE_COMPLETE,this.currentFile.path()),this.currentFile=null)}},exports.SlpParser=le,exports.SlpStream=Qt,exports.Stats=At,exports.StockComputer=ht,exports.TargetBreakComputer=Nt,exports.Timers=P,exports.animations={__proto__:null,getDeathDirection:function(t){if(t>10)return null;switch(t){case 0:return"down";case 1:return"left";case 2:return"right";default:return"up"}}},exports.calcDamageTaken=K,exports.characters=I,exports.closeSlpFile=Pt,exports.didLoseStock=H,exports.extractFinalPostFrameUpdates=$t,exports.frameToGameTimer=function(t,e){const{timerType:n,startingTimerSeconds:s}=e;if(n===exports.TimerType.DECREASING){if(!St(s))return"Unknown";const e=Math.ceil((60-t%60)%60*99/59),n=new Date(0,0,0,0,0,s-t/60,10*e);return r.format(n,"mm:ss.SS")}if(n===exports.TimerType.INCREASING){const e=Math.floor(t%60*99/59),n=new Date(0,0,0,0,0,t/60,10*e);return r.format(n,"mm:ss.SS")}return"Infinite"},exports.generateOverallStats=Tt,exports.getGameEnd=zt,exports.getMetadata=jt,exports.getSinglesPlayerPermutationsFromSettings=U,exports.isCommandGrabbed=b,exports.isDamaged=W,exports.isDead=Y,exports.isDown=k,exports.isGrabbed=V,exports.isInControl=v,exports.isTeching=w,exports.iterateEvents=vt,exports.moves=F,exports.openSlpFile=Lt,exports.parseMessage=wt,exports.stages=L;
//# sourceMappingURL=slippi-js.cjs.production.min.js.map
