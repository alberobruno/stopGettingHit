{"version":3,"file":"slpReader.esm.js","sources":["../../src/utils/slpReader.ts"],"sourcesContent":["import { decode } from \"@shelacek/ubjson\";\nimport fs from \"fs\";\nimport iconv from \"iconv-lite\";\nimport { mapValues } from \"lodash\";\n\nimport type {\n  EventCallbackFunc,\n  EventPayloadTypes,\n  GameEndType,\n  GameInfoType,\n  GeckoCodeType,\n  MetadataType,\n  PlacementType,\n  PlayerType,\n  PostFrameUpdateType,\n  SelfInducedSpeedsType,\n} from \"../types\";\nimport { Command } from \"../types\";\nimport { exists } from \"./exists\";\nimport { toHalfwidth } from \"./fullwidth\";\n\nexport enum SlpInputSource {\n  BUFFER = \"buffer\",\n  FILE = \"file\",\n}\n\nexport interface SlpReadInput {\n  source: SlpInputSource;\n  filePath?: string;\n  buffer?: Buffer;\n}\n\nexport type SlpRefType = SlpFileSourceRef | SlpBufferSourceRef;\n\nexport interface SlpFileType {\n  ref: SlpRefType;\n  rawDataPosition: number;\n  rawDataLength: number;\n  metadataPosition: number;\n  metadataLength: number;\n  messageSizes: {\n    [command: number]: number;\n  };\n}\n\nexport interface SlpFileSourceRef {\n  source: SlpInputSource;\n  fileDescriptor: number;\n}\n\nexport interface SlpBufferSourceRef {\n  source: SlpInputSource;\n  buffer: Buffer;\n}\n\nfunction getRef(input: SlpReadInput): SlpRefType {\n  switch (input.source) {\n    case SlpInputSource.FILE:\n      if (!input.filePath) {\n        throw new Error(\"File source requires a file path\");\n      }\n      const fd = fs.openSync(input.filePath, \"r\");\n      return {\n        source: input.source,\n        fileDescriptor: fd,\n      } as SlpFileSourceRef;\n    case SlpInputSource.BUFFER:\n      return {\n        source: input.source,\n        buffer: input.buffer,\n      } as SlpBufferSourceRef;\n    default:\n      throw new Error(\"Source type not supported\");\n  }\n}\n\nfunction readRef(ref: SlpRefType, buffer: Uint8Array, offset: number, length: number, position: number): number {\n  switch (ref.source) {\n    case SlpInputSource.FILE:\n      return fs.readSync((ref as SlpFileSourceRef).fileDescriptor, buffer, offset, length, position);\n    case SlpInputSource.BUFFER:\n      return (ref as SlpBufferSourceRef).buffer.copy(buffer, offset, position, position + length);\n    default:\n      throw new Error(\"Source type not supported\");\n  }\n}\n\nfunction getLenRef(ref: SlpRefType): number {\n  switch (ref.source) {\n    case SlpInputSource.FILE:\n      const fileStats = fs.fstatSync((ref as SlpFileSourceRef).fileDescriptor);\n      return fileStats.size;\n    case SlpInputSource.BUFFER:\n      return (ref as SlpBufferSourceRef).buffer.length;\n    default:\n      throw new Error(\"Source type not supported\");\n  }\n}\n\n/**\n * Opens a file at path\n */\nexport function openSlpFile(input: SlpReadInput): SlpFileType {\n  const ref = getRef(input);\n\n  const rawDataPosition = getRawDataPosition(ref);\n  const rawDataLength = getRawDataLength(ref, rawDataPosition);\n  const metadataPosition = rawDataPosition + rawDataLength + 10; // remove metadata string\n  const metadataLength = getMetadataLength(ref, metadataPosition);\n  const messageSizes = getMessageSizes(ref, rawDataPosition);\n\n  return {\n    ref,\n    rawDataPosition,\n    rawDataLength,\n    metadataPosition,\n    metadataLength,\n    messageSizes,\n  };\n}\n\nexport function closeSlpFile(file: SlpFileType): void {\n  switch (file.ref.source) {\n    case SlpInputSource.FILE:\n      fs.closeSync((file.ref as SlpFileSourceRef).fileDescriptor);\n      break;\n  }\n}\n\n// This function gets the position where the raw data starts\nfunction getRawDataPosition(ref: SlpRefType): number {\n  const buffer = new Uint8Array(1);\n  readRef(ref, buffer, 0, buffer.length, 0);\n\n  if (buffer[0] === 0x36) {\n    return 0;\n  }\n\n  if (buffer[0] !== \"{\".charCodeAt(0)) {\n    return 0; // return error?\n  }\n\n  return 15;\n}\n\nfunction getRawDataLength(ref: SlpRefType, position: number): number {\n  const fileSize = getLenRef(ref);\n  if (position === 0) {\n    return fileSize;\n  }\n\n  const buffer = new Uint8Array(4);\n  readRef(ref, buffer, 0, buffer.length, position - 4);\n\n  const rawDataLen = (buffer[0]! << 24) | (buffer[1]! << 16) | (buffer[2]! << 8) | buffer[3]!;\n  if (rawDataLen > 0) {\n    // If this method manages to read a number, it's probably trustworthy\n    return rawDataLen;\n  }\n\n  // If the above does not return a valid data length,\n  // return a file size based on file length. This enables\n  // some support for severed files\n  return fileSize - position;\n}\n\nfunction getMetadataLength(ref: SlpRefType, position: number): number {\n  const len = getLenRef(ref);\n  return len - position - 1;\n}\n\nfunction getMessageSizes(\n  ref: SlpRefType,\n  position: number,\n): {\n  [command: number]: number;\n} {\n  const messageSizes: {\n    [command: number]: number;\n  } = {};\n  // Support old file format\n  if (position === 0) {\n    messageSizes[0x36] = 0x140;\n    messageSizes[0x37] = 0x6;\n    messageSizes[0x38] = 0x46;\n    messageSizes[0x39] = 0x1;\n    return messageSizes;\n  }\n\n  const buffer = new Uint8Array(2);\n  readRef(ref, buffer, 0, buffer.length, position);\n  if (buffer[0] !== Command.MESSAGE_SIZES) {\n    return {};\n  }\n\n  const payloadLength = buffer[1] as number;\n  (messageSizes[0x35] as any) = payloadLength;\n\n  const messageSizesBuffer = new Uint8Array(payloadLength - 1);\n  readRef(ref, messageSizesBuffer, 0, messageSizesBuffer.length, position + 2);\n  for (let i = 0; i < payloadLength - 1; i += 3) {\n    const command = messageSizesBuffer[i] as number;\n\n    // Get size of command\n    (messageSizes[command] as any) = (messageSizesBuffer[i + 1]! << 8) | messageSizesBuffer[i + 2]!;\n  }\n\n  return messageSizes;\n}\n\nfunction getEnabledItems(view: DataView): number {\n  const offsets = [0x1, 0x100, 0x10000, 0x1000000, 0x100000000];\n  const enabledItems = offsets.reduce((acc, byteOffset, index) => {\n    const byte = readUint8(view, 0x28 + index) as number;\n    return acc + byte * byteOffset;\n  }, 0);\n\n  return enabledItems;\n}\n\nfunction getGameInfoBlock(view: DataView): GameInfoType {\n  const offset = 0x5;\n\n  return {\n    gameBitfield1: readUint8(view, 0x0 + offset),\n    gameBitfield2: readUint8(view, 0x1 + offset),\n    gameBitfield3: readUint8(view, 0x2 + offset),\n    gameBitfield4: readUint8(view, 0x3 + offset),\n    bombRainEnabled: (readUint8(view, 0x6 + offset)! & 0xff) > 0 ? true : false,\n    itemSpawnBehavior: readInt8(view, 0xb + offset),\n    selfDestructScoreValue: readInt8(view, 0xc + offset),\n    //stageId: readUint16(view, 0xe + offset),\n    //gameTimer: readUint32(view, 0x10 + offset),\n    itemSpawnBitfield1: readUint8(view, 0x23 + offset),\n    itemSpawnBitfield2: readUint8(view, 0x24 + offset),\n    itemSpawnBitfield3: readUint8(view, 0x25 + offset),\n    itemSpawnBitfield4: readUint8(view, 0x26 + offset),\n    itemSpawnBitfield5: readUint8(view, 0x27 + offset),\n    damageRatio: readFloat(view, 0x30 + offset),\n  } as GameInfoType;\n}\n\n/**\n * Iterates through slp events and parses payloads\n */\nexport function iterateEvents(\n  slpFile: SlpFileType,\n  callback: EventCallbackFunc,\n  startPos: number | null = null,\n): number {\n  const ref = slpFile.ref;\n\n  let readPosition = startPos !== null && startPos > 0 ? startPos : slpFile.rawDataPosition;\n  const stopReadingAt = slpFile.rawDataPosition + slpFile.rawDataLength;\n\n  // Generate read buffers for each\n  const commandPayloadBuffers = mapValues(slpFile.messageSizes, (size) => new Uint8Array(size + 1));\n  let splitMessageBuffer = new Uint8Array(0);\n\n  const commandByteBuffer = new Uint8Array(1);\n  while (readPosition < stopReadingAt) {\n    readRef(ref, commandByteBuffer, 0, 1, readPosition);\n    let commandByte = (commandByteBuffer[0] as number) ?? 0;\n    let buffer = commandPayloadBuffers[commandByte];\n    if (buffer === undefined) {\n      // If we don't have an entry for this command, return false to indicate failed read\n      return readPosition;\n    }\n\n    if (buffer.length > stopReadingAt - readPosition) {\n      return readPosition;\n    }\n\n    const advanceAmount = buffer.length;\n\n    readRef(ref, buffer, 0, buffer.length, readPosition);\n    if (commandByte === Command.SPLIT_MESSAGE) {\n      // Here we have a split message, we will collect data from them until the last\n      // message of the list is received\n      const view = new DataView(buffer.buffer);\n      const size = readUint16(view, 0x201) ?? 512;\n      const isLastMessage = readBool(view, 0x204);\n      const internalCommand = readUint8(view, 0x203) ?? 0;\n\n      // If this is the first message, initialize the splitMessageBuffer\n      // with the internal command byte because our parseMessage function\n      // seems to expect a command byte at the start\n      if (splitMessageBuffer.length === 0) {\n        splitMessageBuffer = new Uint8Array(1);\n        splitMessageBuffer[0] = internalCommand;\n      }\n\n      // Collect new data into splitMessageBuffer\n      const appendBuf = buffer.slice(0x1, 0x1 + size);\n      const mergedBuf = new Uint8Array(splitMessageBuffer.length + appendBuf.length);\n      mergedBuf.set(splitMessageBuffer);\n      mergedBuf.set(appendBuf, splitMessageBuffer.length);\n      splitMessageBuffer = mergedBuf;\n\n      if (isLastMessage) {\n        commandByte = splitMessageBuffer[0] ?? 0;\n        buffer = splitMessageBuffer;\n        splitMessageBuffer = new Uint8Array(0);\n      }\n    }\n\n    const parsedPayload = parseMessage(commandByte, buffer);\n    const shouldStop = callback(commandByte, parsedPayload, buffer);\n    if (shouldStop) {\n      break;\n    }\n\n    readPosition += advanceAmount;\n  }\n\n  return readPosition;\n}\n\nexport function parseMessage(command: Command, payload: Uint8Array): EventPayloadTypes | null {\n  const view = new DataView(payload.buffer);\n  switch (command) {\n    case Command.GAME_START:\n      const getPlayerObject = (playerIndex: number): PlayerType => {\n        // Controller Fix stuff\n        const cfOffset = playerIndex * 0x8;\n        const dashback = readUint32(view, 0x141 + cfOffset);\n        const shieldDrop = readUint32(view, 0x145 + cfOffset);\n        let controllerFix = \"None\";\n        if (dashback !== shieldDrop) {\n          controllerFix = \"Mixed\";\n        } else if (dashback === 1) {\n          controllerFix = \"UCF\";\n        } else if (dashback === 2) {\n          controllerFix = \"Dween\";\n        }\n\n        // Nametag stuff\n        const nametagLength = 0x10;\n        const nametagOffset = playerIndex * nametagLength;\n        const nametagStart = 0x161 + nametagOffset;\n        const nametagBuf = payload.slice(nametagStart, nametagStart + nametagLength);\n        const nameTagString = iconv\n          .decode(nametagBuf as Buffer, \"Shift_JIS\")\n          .split(\"\\0\")\n          .shift();\n        const nametag = nameTagString ? toHalfwidth(nameTagString) : \"\";\n\n        // Display name\n        const displayNameLength = 0x1f;\n        const displayNameOffset = playerIndex * displayNameLength;\n        const displayNameStart = 0x1a5 + displayNameOffset;\n        const displayNameBuf = payload.slice(displayNameStart, displayNameStart + displayNameLength);\n        const displayNameString = iconv\n          .decode(displayNameBuf as Buffer, \"Shift_JIS\")\n          .split(\"\\0\")\n          .shift();\n        const displayName = displayNameString ? toHalfwidth(displayNameString) : \"\";\n\n        // Connect code\n        const connectCodeLength = 0xa;\n        const connectCodeOffset = playerIndex * connectCodeLength;\n        const connectCodeStart = 0x221 + connectCodeOffset;\n        const connectCodeBuf = payload.slice(connectCodeStart, connectCodeStart + connectCodeLength);\n        const connectCodeString = iconv\n          .decode(connectCodeBuf as Buffer, \"Shift_JIS\")\n          .split(\"\\0\")\n          .shift();\n        const connectCode = connectCodeString ? toHalfwidth(connectCodeString) : \"\";\n\n        const userIdLength = 0x1d;\n        const userIdOffset = playerIndex * userIdLength;\n        const userIdStart = 0x249 + userIdOffset;\n        const userIdBuf = payload.slice(userIdStart, userIdStart + userIdLength);\n        const userIdString = iconv\n          .decode(userIdBuf as Buffer, \"utf8\")\n          .split(\"\\0\")\n          .shift();\n        const userId = userIdString ?? \"\";\n\n        const offset = playerIndex * 0x24;\n        return {\n          playerIndex,\n          port: playerIndex + 1,\n          characterId: readUint8(view, 0x65 + offset),\n          type: readUint8(view, 0x66 + offset),\n          startStocks: readUint8(view, 0x67 + offset),\n          characterColor: readUint8(view, 0x68 + offset),\n          teamShade: readUint8(view, 0x6c + offset),\n          handicap: readUint8(view, 0x6d + offset),\n          teamId: readUint8(view, 0x6e + offset),\n          staminaMode: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x01)),\n          silentCharacter: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x02)),\n          lowGravity: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x04)),\n          invisible: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x08)),\n          blackStockIcon: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x10)),\n          metal: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x20)),\n          startOnAngelPlatform: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x40)),\n          rumbleEnabled: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x80)),\n          cpuLevel: readUint8(view, 0x74 + offset),\n          offenseRatio: readFloat(view, 0x7d + offset),\n          defenseRatio: readFloat(view, 0x81 + offset),\n          modelScale: readFloat(view, 0x85 + offset),\n          controllerFix,\n          nametag,\n          displayName,\n          connectCode,\n          userId,\n        };\n      };\n\n      const matchIdLength = 51;\n      const matchIdStart = 0x2be;\n      const matchIdBuf = payload.slice(matchIdStart, matchIdStart + matchIdLength);\n      const matchIdString = iconv\n        .decode(matchIdBuf as Buffer, \"utf8\")\n        .split(\"\\0\")\n        .shift();\n      const matchId = matchIdString ?? \"\";\n\n      return {\n        slpVersion: `${readUint8(view, 0x1)}.${readUint8(view, 0x2)}.${readUint8(view, 0x3)}`,\n        timerType: readUint8(view, 0x5, 0x03),\n        inGameMode: readUint8(view, 0x5, 0xe0),\n        friendlyFireEnabled: !!readUint8(view, 0x6, 0x01),\n        isTeams: readBool(view, 0xd),\n        itemSpawnBehavior: readUint8(view, 0x10),\n        stageId: readUint16(view, 0x13),\n        startingTimerSeconds: readUint32(view, 0x15),\n        enabledItems: getEnabledItems(view),\n        players: [0, 1, 2, 3].map(getPlayerObject),\n        scene: readUint8(view, 0x1a3),\n        gameMode: readUint8(view, 0x1a4),\n        language: readUint8(view, 0x2bd),\n        gameInfoBlock: getGameInfoBlock(view),\n        randomSeed: readUint32(view, 0x13d),\n        isPAL: readBool(view, 0x1a1),\n        isFrozenPS: readBool(view, 0x1a2),\n        matchInfo: {\n          matchId,\n          gameNumber: readUint32(view, 0x2f1),\n          tiebreakerNumber: readUint32(view, 0x2f5),\n        },\n      };\n    case Command.FRAME_START:\n      return {\n        frame: readInt32(view, 0x1),\n        seed: readUint32(view, 0x5),\n        sceneFrameCounter: readUint32(view, 0x9),\n      };\n\n    case Command.PRE_FRAME_UPDATE:\n      return {\n        frame: readInt32(view, 0x1),\n        playerIndex: readUint8(view, 0x5),\n        isFollower: readBool(view, 0x6),\n        seed: readUint32(view, 0x7),\n        actionStateId: readUint16(view, 0xb),\n        positionX: readFloat(view, 0xd),\n        positionY: readFloat(view, 0x11),\n        facingDirection: readFloat(view, 0x15),\n        joystickX: readFloat(view, 0x19),\n        joystickY: readFloat(view, 0x1d),\n        cStickX: readFloat(view, 0x21),\n        cStickY: readFloat(view, 0x25),\n        trigger: readFloat(view, 0x29),\n        buttons: readUint32(view, 0x2d),\n        physicalButtons: readUint16(view, 0x31),\n        physicalLTrigger: readFloat(view, 0x33),\n        physicalRTrigger: readFloat(view, 0x37),\n        rawJoystickX: readInt8(view, 0x3b),\n        percent: readFloat(view, 0x3c),\n      };\n    case Command.POST_FRAME_UPDATE:\n      const selfInducedSpeeds: SelfInducedSpeedsType = {\n        airX: readFloat(view, 0x35),\n        y: readFloat(view, 0x39),\n        attackX: readFloat(view, 0x3d),\n        attackY: readFloat(view, 0x41),\n        groundX: readFloat(view, 0x45),\n      };\n      return {\n        frame: readInt32(view, 0x1),\n        playerIndex: readUint8(view, 0x5),\n        isFollower: readBool(view, 0x6),\n        internalCharacterId: readUint8(view, 0x7),\n        actionStateId: readUint16(view, 0x8),\n        positionX: readFloat(view, 0xa),\n        positionY: readFloat(view, 0xe),\n        facingDirection: readFloat(view, 0x12),\n        percent: readFloat(view, 0x16),\n        shieldSize: readFloat(view, 0x1a),\n        lastAttackLanded: readUint8(view, 0x1e),\n        currentComboCount: readUint8(view, 0x1f),\n        lastHitBy: readUint8(view, 0x20),\n        stocksRemaining: readUint8(view, 0x21),\n        actionStateCounter: readFloat(view, 0x22),\n        miscActionState: readFloat(view, 0x2b),\n        isAirborne: readBool(view, 0x2f),\n        lastGroundId: readUint16(view, 0x30),\n        jumpsRemaining: readUint8(view, 0x32),\n        lCancelStatus: readUint8(view, 0x33),\n        hurtboxCollisionState: readUint8(view, 0x34),\n        selfInducedSpeeds: selfInducedSpeeds,\n        hitlagRemaining: readFloat(view, 0x49),\n        animationIndex: readUint32(view, 0x4d),\n      };\n    case Command.ITEM_UPDATE:\n      return {\n        frame: readInt32(view, 0x1),\n        typeId: readUint16(view, 0x5),\n        state: readUint8(view, 0x7),\n        facingDirection: readFloat(view, 0x8),\n        velocityX: readFloat(view, 0xc),\n        velocityY: readFloat(view, 0x10),\n        positionX: readFloat(view, 0x14),\n        positionY: readFloat(view, 0x18),\n        damageTaken: readUint16(view, 0x1c),\n        expirationTimer: readFloat(view, 0x1e),\n        spawnId: readUint32(view, 0x22),\n        missileType: readUint8(view, 0x26),\n        turnipFace: readUint8(view, 0x27),\n        chargeShotLaunched: readUint8(view, 0x28),\n        chargePower: readUint8(view, 0x29),\n        owner: readInt8(view, 0x2a),\n      };\n    case Command.FRAME_BOOKEND:\n      return {\n        frame: readInt32(view, 0x1),\n        latestFinalizedFrame: readInt32(view, 0x5),\n      };\n    case Command.GAME_END:\n      const placements = [0, 1, 2, 3].map((playerIndex): PlacementType => {\n        const position = readInt8(view, 0x3 + playerIndex);\n        return { playerIndex, position };\n      });\n\n      return {\n        gameEndMethod: readUint8(view, 0x1),\n        lrasInitiatorIndex: readInt8(view, 0x2),\n        placements,\n      };\n    case Command.GECKO_LIST:\n      const codes: GeckoCodeType[] = [];\n      let pos = 1;\n      while (pos < payload.length) {\n        const word1 = readUint32(view, pos) ?? 0;\n        const codetype = (word1 >> 24) & 0xfe;\n        const address = (word1 & 0x01ffffff) + 0x80000000;\n\n        let offset = 8; // Default code length, most codes are this length\n        if (codetype === 0xc0 || codetype === 0xc2) {\n          const lineCount = readUint32(view, pos + 4) ?? 0;\n          offset = 8 + lineCount * 8;\n        } else if (codetype === 0x06) {\n          const byteLen = readUint32(view, pos + 4) ?? 0;\n          offset = 8 + ((byteLen + 7) & 0xfffffff8);\n        } else if (codetype === 0x08) {\n          offset = 16;\n        }\n\n        codes.push({\n          type: codetype,\n          address: address,\n          contents: payload.slice(pos, pos + offset),\n        });\n\n        pos += offset;\n      }\n\n      return {\n        contents: payload.slice(1),\n        codes: codes,\n      };\n    default:\n      return null;\n  }\n}\n\nfunction canReadFromView(view: DataView, offset: number, length: number): boolean {\n  const viewLength = view.byteLength;\n  return offset + length <= viewLength;\n}\n\nfunction readFloat(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 4)) {\n    return null;\n  }\n\n  return view.getFloat32(offset);\n}\n\nfunction readInt32(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 4)) {\n    return null;\n  }\n\n  return view.getInt32(offset);\n}\n\nfunction readInt8(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 1)) {\n    return null;\n  }\n\n  return view.getInt8(offset);\n}\n\nfunction readUint32(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 4)) {\n    return null;\n  }\n\n  return view.getUint32(offset);\n}\n\nfunction readUint16(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 2)) {\n    return null;\n  }\n\n  return view.getUint16(offset);\n}\n\nfunction readUint8(view: DataView, offset: number, bitmask = 0xff): number | null {\n  if (!canReadFromView(view, offset, 1)) {\n    return null;\n  }\n\n  return view.getUint8(offset) & bitmask;\n}\n\nfunction readBool(view: DataView, offset: number): boolean | null {\n  if (!canReadFromView(view, offset, 1)) {\n    return null;\n  }\n\n  return !!view.getUint8(offset);\n}\n\nexport function getMetadata(slpFile: SlpFileType): MetadataType | null {\n  if (slpFile.metadataLength <= 0) {\n    // This will happen on a severed incomplete file\n    // $FlowFixMe\n    return null;\n  }\n\n  const buffer = new Uint8Array(slpFile.metadataLength);\n\n  readRef(slpFile.ref, buffer, 0, buffer.length, slpFile.metadataPosition);\n\n  let metadata = null;\n  try {\n    metadata = decode(buffer);\n  } catch (ex) {\n    // Do nothing\n    // console.log(ex);\n  }\n\n  // $FlowFixMe\n  return metadata;\n}\n\nexport function getGameEnd(slpFile: SlpFileType): GameEndType | null {\n  const { ref, rawDataPosition, rawDataLength, messageSizes } = slpFile;\n  const gameEndPayloadSize = messageSizes[Command.GAME_END];\n  if (!exists(gameEndPayloadSize) || gameEndPayloadSize <= 0) {\n    return null;\n  }\n\n  // Add one to account for command byte\n  const gameEndSize = gameEndPayloadSize + 1;\n  const gameEndPosition = rawDataPosition + rawDataLength - gameEndSize;\n\n  const buffer = new Uint8Array(gameEndSize);\n  readRef(ref, buffer, 0, buffer.length, gameEndPosition);\n  if (buffer[0] !== Command.GAME_END) {\n    // This isn't even a game end payload\n    return null;\n  }\n\n  const gameEndMessage = parseMessage(Command.GAME_END, buffer);\n  if (!gameEndMessage) {\n    return null;\n  }\n\n  return gameEndMessage as GameEndType;\n}\n\nexport function extractFinalPostFrameUpdates(slpFile: SlpFileType): PostFrameUpdateType[] {\n  const { ref, rawDataPosition, rawDataLength, messageSizes } = slpFile;\n\n  // The following should exist on all replay versions\n  const postFramePayloadSize = messageSizes[Command.POST_FRAME_UPDATE];\n  const gameEndPayloadSize = messageSizes[Command.GAME_END];\n  const frameBookendPayloadSize = messageSizes[Command.FRAME_BOOKEND];\n\n  // Technically this should not be possible\n  if (!exists(postFramePayloadSize)) {\n    return [];\n  }\n\n  const gameEndSize = gameEndPayloadSize ? gameEndPayloadSize + 1 : 0;\n  const postFrameSize = postFramePayloadSize + 1;\n  const frameBookendSize = frameBookendPayloadSize ? frameBookendPayloadSize + 1 : 0;\n\n  let frameNum: number | null = null;\n  let postFramePosition = rawDataPosition + rawDataLength - gameEndSize - frameBookendSize - postFrameSize;\n  const postFrameUpdates: PostFrameUpdateType[] = [];\n  do {\n    const buffer = new Uint8Array(postFrameSize);\n    readRef(ref, buffer, 0, buffer.length, postFramePosition);\n    if (buffer[0] !== Command.POST_FRAME_UPDATE) {\n      break;\n    }\n\n    const postFrameMessage = parseMessage(Command.POST_FRAME_UPDATE, buffer) as PostFrameUpdateType | null;\n    if (!postFrameMessage) {\n      break;\n    }\n\n    if (frameNum === null) {\n      frameNum = postFrameMessage.frame;\n    } else if (frameNum !== postFrameMessage.frame) {\n      // If post frame message is found but the frame doesn't match, it's not part of the final frame\n      break;\n    }\n\n    postFrameUpdates.unshift(postFrameMessage);\n    postFramePosition -= postFrameSize;\n  } while (postFramePosition >= rawDataPosition);\n\n  return postFrameUpdates;\n}\n"],"names":["SlpInputSource","getRef","input","source","FILE","filePath","Error","fd","fs","openSync","fileDescriptor","BUFFER","buffer","readRef","ref","offset","length","position","readSync","copy","getLenRef","fileStats","fstatSync","size","openSlpFile","rawDataPosition","getRawDataPosition","rawDataLength","getRawDataLength","metadataPosition","metadataLength","getMetadataLength","messageSizes","getMessageSizes","closeSlpFile","file","closeSync","Uint8Array","charCodeAt","fileSize","rawDataLen","len","Command","MESSAGE_SIZES","payloadLength","messageSizesBuffer","i","command","getEnabledItems","view","offsets","enabledItems","reduce","acc","byteOffset","index","byte","readUint8","getGameInfoBlock","gameBitfield1","gameBitfield2","gameBitfield3","gameBitfield4","bombRainEnabled","itemSpawnBehavior","readInt8","selfDestructScoreValue","itemSpawnBitfield1","itemSpawnBitfield2","itemSpawnBitfield3","itemSpawnBitfield4","itemSpawnBitfield5","damageRatio","readFloat","iterateEvents","slpFile","callback","startPos","readPosition","stopReadingAt","commandPayloadBuffers","mapValues","splitMessageBuffer","commandByteBuffer","commandByte","undefined","advanceAmount","SPLIT_MESSAGE","DataView","readUint16","isLastMessage","readBool","internalCommand","appendBuf","slice","mergedBuf","set","parsedPayload","parseMessage","shouldStop","payload","GAME_START","getPlayerObject","playerIndex","cfOffset","dashback","readUint32","shieldDrop","controllerFix","nametagLength","nametagOffset","nametagStart","nametagBuf","nameTagString","iconv","decode","split","shift","nametag","toHalfwidth","displayNameLength","displayNameOffset","displayNameStart","displayNameBuf","displayNameString","displayName","connectCodeLength","connectCodeOffset","connectCodeStart","connectCodeBuf","connectCodeString","connectCode","userIdLength","userIdOffset","userIdStart","userIdBuf","userIdString","userId","port","characterId","type","startStocks","characterColor","teamShade","handicap","teamId","staminaMode","Boolean","silentCharacter","lowGravity","invisible","blackStockIcon","metal","startOnAngelPlatform","rumbleEnabled","cpuLevel","offenseRatio","defenseRatio","modelScale","matchIdLength","matchIdStart","matchIdBuf","matchIdString","matchId","slpVersion","timerType","inGameMode","friendlyFireEnabled","isTeams","stageId","startingTimerSeconds","players","map","scene","gameMode","language","gameInfoBlock","randomSeed","isPAL","isFrozenPS","matchInfo","gameNumber","tiebreakerNumber","FRAME_START","frame","readInt32","seed","sceneFrameCounter","PRE_FRAME_UPDATE","isFollower","actionStateId","positionX","positionY","facingDirection","joystickX","joystickY","cStickX","cStickY","trigger","buttons","physicalButtons","physicalLTrigger","physicalRTrigger","rawJoystickX","percent","POST_FRAME_UPDATE","selfInducedSpeeds","airX","y","attackX","attackY","groundX","internalCharacterId","shieldSize","lastAttackLanded","currentComboCount","lastHitBy","stocksRemaining","actionStateCounter","miscActionState","isAirborne","lastGroundId","jumpsRemaining","lCancelStatus","hurtboxCollisionState","hitlagRemaining","animationIndex","ITEM_UPDATE","typeId","state","velocityX","velocityY","damageTaken","expirationTimer","spawnId","missileType","turnipFace","chargeShotLaunched","chargePower","owner","FRAME_BOOKEND","latestFinalizedFrame","GAME_END","placements","gameEndMethod","lrasInitiatorIndex","GECKO_LIST","codes","pos","word1","codetype","address","lineCount","byteLen","push","contents","canReadFromView","viewLength","byteLength","getFloat32","getInt32","getInt8","getUint32","getUint16","bitmask","getUint8","getMetadata","metadata","ex","getGameEnd","gameEndPayloadSize","exists","gameEndSize","gameEndPosition","gameEndMessage","extractFinalPostFrameUpdates","postFramePayloadSize","frameBookendPayloadSize","postFrameSize","frameBookendSize","frameNum","postFramePosition","postFrameUpdates","postFrameMessage","unshift"],"mappings":"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"}