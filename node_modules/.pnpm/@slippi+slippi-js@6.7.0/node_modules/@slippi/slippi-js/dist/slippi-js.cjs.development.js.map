{"version":3,"file":"slippi-js.cjs.development.js","sources":["../src/melee/animationUtils.ts","../src/melee/characterUtils.ts","../src/melee/moveUtils.ts","../src/melee/stageUtils.ts","../src/melee/types.ts","../src/stats/common.ts","../src/stats/actions.ts","../src/stats/combos.ts","../src/stats/conversions.ts","../src/types.ts","../src/stats/inputs.ts","../src/stats/overall.ts","../src/stats/stats.ts","../src/stats/stocks.ts","../src/utils/exists.ts","../src/stats/targets.ts","../src/utils/gameTimer.ts","../src/console/communication.ts","../src/console/types.ts","../src/console/consoleConnection.ts","../src/console/dolphinConnection.ts","../src/utils/fullwidth.ts","../src/utils/slpReader.ts","../src/utils/slpStream.ts","../src/utils/slpFile.ts","../src/utils/slpFileWriter.ts","../src/utils/rollbackCounter.ts","../src/utils/slpParser.ts","../src/utils/getWinners.ts","../src/utils/homeRunDistance.ts","../src/SlippiGame.ts"],"sourcesContent":["// eslint-disable-next-line\nexport function getDeathDirection(actionStateId: number) {\n  if (actionStateId > 0xa) {\n    return null;\n  }\n\n  switch (actionStateId) {\n    case 0:\n      return \"down\";\n    case 1:\n      return \"left\";\n    case 2:\n      return \"right\";\n    default:\n      return \"up\";\n  }\n}\n","import characters from \"./characters.json\";\n\nexport type CharacterColor = string;\nconst DEFAULT_COLOR: CharacterColor = \"Default\";\n\nexport interface CharacterInfo {\n  id: number;\n  name: string;\n  shortName: string;\n  colors: CharacterColor[];\n}\n\nexport const UnknownCharacter: CharacterInfo = {\n  id: -1,\n  name: \"Unknown Character\",\n  shortName: \"Unknown\",\n  colors: [DEFAULT_COLOR],\n};\n\ntype CharacterId = keyof typeof characters;\n\nfunction generateCharacterInfo(\n  id: number,\n  info?: {\n    name: string;\n    shortName?: string;\n    colors?: CharacterColor[];\n  },\n): CharacterInfo {\n  if (!info) {\n    return UnknownCharacter;\n  }\n\n  return {\n    id,\n    name: info.name,\n    shortName: info.shortName ?? info.name,\n    colors: [DEFAULT_COLOR, ...(info.colors ?? [])],\n  };\n}\n\nexport function getAllCharacters(): CharacterInfo[] {\n  return Object.entries(characters)\n    .map(([id, data]) => generateCharacterInfo(parseInt(id, 10), data))\n    .sort((a, b) => a.id - b.id);\n}\n\nexport function getCharacterInfo(externalCharacterId: number): CharacterInfo {\n  const data = characters[externalCharacterId.toString() as CharacterId];\n  return generateCharacterInfo(externalCharacterId, data);\n}\n\nexport function getCharacterShortName(externalCharacterId: number): string {\n  const character = getCharacterInfo(externalCharacterId);\n  return character.shortName;\n}\n\nexport function getCharacterName(externalCharacterId: number): string {\n  const character = getCharacterInfo(externalCharacterId);\n  return character.name;\n}\n\n// Return a human-readable color from a characterCode.\nexport function getCharacterColorName(externalCharacterId: number, characterColor: number): CharacterColor {\n  const character = getCharacterInfo(externalCharacterId);\n  const color = character.colors[characterColor];\n  if (color) {\n    return color;\n  }\n  return DEFAULT_COLOR;\n}\n","import moveNames from \"./moves.json\";\n\nexport interface Move {\n  id: number;\n  name: string;\n  shortName: string;\n}\n\nexport const UnknownMove: Move = {\n  id: -1,\n  name: \"Unknown Move\",\n  shortName: \"unknown\",\n};\n\ntype MoveId = keyof typeof moveNames;\n\nexport function getMoveInfo(moveId: number): Move {\n  const moveName = moveNames[moveId.toString() as MoveId];\n  if (!moveName) {\n    return UnknownMove;\n  }\n  return {\n    id: moveId,\n    name: moveName.name,\n    shortName: moveName.shortName,\n  };\n}\n\nexport function getMoveShortName(moveId: number): string {\n  const move = getMoveInfo(moveId);\n  return move.shortName;\n}\n\nexport function getMoveName(moveId: number): string {\n  const move = getMoveInfo(moveId);\n  return move.name;\n}\n","import stageNames from \"./stages.json\";\n\nexport interface StageInfo {\n  id: number;\n  name: string;\n}\n\nexport const UnknownStage: StageInfo = {\n  id: -1,\n  name: \"Unknown Stage\",\n};\n\ntype StageId = keyof typeof stageNames;\n\nexport function getStageInfo(stageId: number): StageInfo {\n  const stageName = stageNames[stageId.toString() as StageId];\n  if (!stageName) {\n    return UnknownStage;\n  }\n  return {\n    id: stageId,\n    name: stageName,\n  };\n}\n\nexport function getStageName(stageId: number): string {\n  const stage = getStageInfo(stageId);\n  return stage.name;\n}\n","export enum Character {\n  CAPTAIN_FALCON = 0,\n  DONKEY_KONG = 1,\n  FOX = 2,\n  GAME_AND_WATCH = 3,\n  KIRBY = 4,\n  BOWSER = 5,\n  LINK = 6,\n  LUIGI = 7,\n  MARIO = 8,\n  MARTH = 9,\n  MEWTWO = 10,\n  NESS = 11,\n  PEACH = 12,\n  PIKACHU = 13,\n  ICE_CLIMBERS = 14,\n  JIGGLYPUFF = 15,\n  SAMUS = 16,\n  YOSHI = 17,\n  ZELDA = 18,\n  SHEIK = 19,\n  FALCO = 20,\n  YOUNG_LINK = 21,\n  DR_MARIO = 22,\n  ROY = 23,\n  PICHU = 24,\n  GANONDORF = 25,\n  MASTER_HAND = 26,\n  WIREFRAME_MALE = 27,\n  WIREFRAME_FEMALE = 28,\n  GIGA_BOWSER = 29,\n  CRAZY_HAND = 30,\n  SANDBAG = 31,\n  POPO = 32,\n}\n\nexport enum Stage {\n  FOUNTAIN_OF_DREAMS = 2,\n  POKEMON_STADIUM = 3,\n  PEACHS_CASTLE = 4,\n  KONGO_JUNGLE = 5,\n  BRINSTAR = 6,\n  CORNERIA = 7,\n  YOSHIS_STORY = 8,\n  ONETT = 9,\n  MUTE_CITY = 10,\n  RAINBOW_CRUISE = 11,\n  JUNGLE_JAPES = 12,\n  GREAT_BAY = 13,\n  HYRULE_TEMPLE = 14,\n  BRINSTAR_DEPTHS = 15,\n  YOSHIS_ISLAND = 16,\n  GREEN_GREENS = 17,\n  FOURSIDE = 18,\n  MUSHROOM_KINGDOM = 19,\n  MUSHROOM_KINGDOM_2 = 20,\n  VENOM = 22,\n  POKE_FLOATS = 23,\n  BIG_BLUE = 24,\n  ICICLE_MOUNTAIN = 25,\n  ICETOP = 26,\n  FLAT_ZONE = 27,\n  DREAMLAND = 28,\n  YOSHIS_ISLAND_N64 = 29,\n  KONGO_JUNGLE_N64 = 30,\n  BATTLEFIELD = 31,\n  FINAL_DESTINATION = 32,\n  TARGET_TEST_MARIO = 33,\n  TARGET_TEST_CAPTAIN_FALCON = 34,\n  TARGET_TEST_YOUNG_LINK = 35,\n  TARGET_TEST_DONKEY_KONG = 36,\n  TARGET_TEST_DR_MARIO = 37,\n  TARGET_TEST_FALCO = 38,\n  TARGET_TEST_FOX = 39,\n  TARGET_TEST_ICE_CLIMBERS = 40,\n  TARGET_TEST_KIRBY = 41,\n  TARGET_TEST_BOWSER = 42,\n  TARGET_TEST_LINK = 43,\n  TARGET_TEST_LUIGI = 44,\n  TARGET_TEST_MARTH = 45,\n  TARGET_TEST_MEWTWO = 46,\n  TARGET_TEST_NESS = 47,\n  TARGET_TEST_PEACH = 48,\n  TARGET_TEST_PICHU = 49,\n  TARGET_TEST_PIKACHU = 50,\n  TARGET_TEST_JIGGLYPUFF = 51,\n  TARGET_TEST_SAMUS = 52,\n  TARGET_TEST_SHEIK = 53,\n  TARGET_TEST_YOSHI = 54,\n  TARGET_TEST_ZELDA = 55,\n  TARGET_TEST_GAME_AND_WATCH = 56,\n  TARGET_TEST_ROY = 57,\n  TARGET_TEST_GANONDORF = 58,\n  RACE_TO_THE_FINISH = 82,\n  GRAB_THE_TROPHIES = 83,\n  HOME_RUN_CONTEST = 84,\n  ALL_STAR_LOBBY = 85,\n  EVENT_ONE = 202,\n  EVENT_EIGHTEEN = 203,\n  EVENT_THREE = 204,\n  EVENT_FOUR = 205,\n  EVENT_FIVE = 206,\n  EVENT_SIX = 207,\n  EVENT_SEVEN = 208,\n  EVENT_EIGHT = 209,\n  EVENT_NINE = 210,\n  EVENT_TEN_PART_ONE = 211,\n  EVENT_ELEVEN = 212,\n  EVENT_TWELVE = 213,\n  EVENT_THIRTEEN = 214,\n  EVENT_FOURTEEN = 215,\n  EVENT_THIRTY_SEVEN = 216,\n  EVENT_SIXTEEN = 217,\n  EVENT_SEVENTEEN = 218,\n  EVENT_TWO = 219,\n  EVENT_NINETEEN = 220,\n  EVENT_TWENTY_PART_ONE = 221,\n  EVENT_TWENTY_ONE = 222,\n  EVENT_TWENTY_TWO = 223,\n  EVENT_TWENTY_SEVEN = 224,\n  EVENT_TWENTY_FOUR = 225,\n  EVENT_TWENTY_FIVE = 226,\n  EVENT_TWENTY_SIX = 227,\n  EVENT_TWENTY_THREE = 228,\n  EVENT_TWENTY_EIGHT = 229,\n  EVENT_TWENTY_NINE = 230,\n  EVENT_THIRTY_PART_ONE = 231,\n  EVENT_THIRTY_ONE = 232,\n  EVENT_THIRTY_TWO = 233,\n  EVENT_THIRTY_THREE = 234,\n  EVENT_THIRTY_FOUR = 235,\n  EVENT_FORTY_EIGHT = 236,\n  EVENT_THIRTY_SIX_PART_ONE = 237,\n  EVENT_FIFTEEN = 238,\n  EVENT_THIRTY_EIGHT = 239,\n  EVENT_THIRTY_NINE = 240,\n  EVENT_FORTY_PART_ONE = 241,\n  EVENT_FORTY_ONE = 242,\n  EVENT_FORTY_TWO = 243,\n  EVENT_FORTY_THREE = 244,\n  EVENT_FORTY_FOUR = 245,\n  EVENT_FORTY_FIVE = 246,\n  EVENT_FORTY_SIX = 247,\n  EVENT_FORTY_SEVEN = 248,\n  EVENT_THIRTY_FIVE = 249,\n  EVENT_FORTY_NINE_PART_ONE = 250,\n  EVENT_FIFTY = 251,\n  EVENT_FIFTY_ONE = 252,\n  EVENT_TEN_PART_TWO = 253,\n  EVENT_TEN_PART_THREE = 254,\n  EVENT_TEN_PART_FOUR = 255,\n  EVENT_TEN_PART_FIVE = 256,\n  EVENT_TWENTY_PART_TWO = 257,\n  EVENT_TWENTY_PART_THREE = 258,\n  EVENT_TWENTY_PART_FOUR = 259,\n  EVENT_TWENTY_PART_FIVE = 260,\n  EVENT_THIRTY_PART_TWO = 261,\n  EVENT_THIRTY_PART_THREE = 262,\n  EVENT_THIRTY_PART_FOUR = 263,\n  EVENT_FORTY_PART_TWO = 264,\n  EVENT_FORTY_PART_THREE = 265,\n  EVENT_FORTY_PART_FOUR = 266,\n  EVENT_FORTY_PART_FIVE = 267,\n  EVENT_FORTY_NINE_PART_TWO = 268,\n  EVENT_FORTY_NINE_PART_THREE = 269,\n  EVENT_FORTY_NINE_PART_FOUR = 270,\n  EVENT_FORTY_NINE_PART_FIVE = 271,\n  EVENT_FORTY_NINE_PART_SIX = 272,\n  EVENT_THIRTY_SIX_PART_TWO = 273,\n  MULTI_MAN_MELEE = 285,\n}\n","import type { GameStartType, PostFrameUpdateType } from \"../types\";\n\nexport interface StatsType {\n  gameComplete: boolean;\n  lastFrame: number;\n  playableFrameCount: number;\n  stocks: StockType[];\n  conversions: ConversionType[];\n  combos: ComboType[];\n  actionCounts: ActionCountsType[];\n  overall: OverallType[];\n}\n\nexport type StadiumStatsType = HomeRunContestResultType | TargetTestResultType;\n\nexport interface TargetTestResultType {\n  type: \"target-test\";\n  targetBreaks: TargetBreakType[];\n}\n\nexport interface HomeRunContestResultType {\n  type: \"home-run-contest\";\n  distance: number;\n  units: \"feet\" | \"meters\";\n}\n\nexport interface RatioType {\n  count: number;\n  total: number;\n  ratio: number | null;\n}\n\nexport interface PlayerIndexedType {\n  playerIndex: number;\n  opponentIndex: number;\n}\n\nexport interface DurationType {\n  startFrame: number;\n  endFrame?: number | null;\n}\n\nexport interface DamageType {\n  startPercent: number;\n  currentPercent: number;\n  endPercent?: number | null;\n}\n\nexport interface StockType extends DurationType, DamageType {\n  playerIndex: number;\n  count: number;\n  deathAnimation?: number | null;\n}\n\nexport interface MoveLandedType {\n  playerIndex: number;\n  frame: number;\n  moveId: number;\n  hitCount: number;\n  damage: number;\n}\n\nexport interface ComboType extends DurationType, DamageType {\n  playerIndex: number;\n  moves: MoveLandedType[];\n  didKill: boolean;\n  lastHitBy: number | null;\n}\n\nexport interface TargetBreakType {\n  spawnId: number;\n  frameDestroyed: number | null;\n  positionX: number;\n  positionY: number;\n}\n\nexport interface ConversionType extends ComboType {\n  openingType: string;\n}\n\nexport interface ActionCountsType {\n  playerIndex: number;\n  wavedashCount: number;\n  wavelandCount: number;\n  airDodgeCount: number;\n  dashDanceCount: number;\n  spotDodgeCount: number;\n  ledgegrabCount: number;\n  rollCount: number;\n  lCancelCount: {\n    success: number;\n    fail: number;\n  };\n  attackCount: {\n    jab1: number;\n    jab2: number;\n    jab3: number;\n    jabm: number;\n    dash: number;\n    ftilt: number;\n    utilt: number;\n    dtilt: number;\n    fsmash: number;\n    usmash: number;\n    dsmash: number;\n    nair: number;\n    fair: number;\n    bair: number;\n    uair: number;\n    dair: number;\n  };\n  grabCount: {\n    success: number;\n    fail: number;\n  };\n  throwCount: {\n    up: number;\n    forward: number;\n    back: number;\n    down: number;\n  };\n  groundTechCount: {\n    // tech away/in are in reference to the opponents position and not the stage\n    away: number;\n    in: number;\n    neutral: number;\n    fail: number;\n  };\n  wallTechCount: {\n    success: number;\n    fail: number;\n  };\n}\n\nexport interface InputCountsType {\n  buttons: number;\n  triggers: number;\n  joystick: number;\n  cstick: number;\n  total: number;\n}\n\nexport interface OverallType {\n  playerIndex: number;\n  inputCounts: InputCountsType;\n  conversionCount: number;\n  totalDamage: number;\n  killCount: number;\n  successfulConversions: RatioType;\n  inputsPerMinute: RatioType;\n  digitalInputsPerMinute: RatioType;\n  openingsPerKill: RatioType;\n  damagePerOpening: RatioType;\n  neutralWinRatio: RatioType;\n  counterHitRatio: RatioType;\n  beneficialTradeRatio: RatioType;\n}\n\nexport enum State {\n  // Animation ID ranges\n  DAMAGE_START = 0x4b,\n  DAMAGE_END = 0x5b,\n  CAPTURE_START = 0xdf,\n  CAPTURE_END = 0xe8,\n  GUARD_START = 0xb2,\n  GUARD_END = 0xb6,\n  GROUNDED_CONTROL_START = 0xe,\n  GROUNDED_CONTROL_END = 0x18,\n  SQUAT_START = 0x27,\n  SQUAT_END = 0x29,\n  DOWN_START = 0xb7,\n  DOWN_END = 0xc6,\n  TECH_START = 0xc7,\n  TECH_END = 0xcc,\n  DYING_START = 0x0,\n  DYING_END = 0xa,\n  CONTROLLED_JUMP_START = 0x18,\n  CONTROLLED_JUMP_END = 0x22,\n  GROUND_ATTACK_START = 0x2c,\n  GROUND_ATTACK_END = 0x40,\n  AERIAL_ATTACK_START = 0x41,\n  AERIAL_ATTACK_END = 0x4a,\n  ATTACK_FTILT_START = 0x33,\n  ATTACK_FTILT_END = 0x37,\n  ATTACK_FSMASH_START = 0x3a,\n  ATTACK_FSMASH_END = 0x3e,\n\n  // Animation ID specific\n  ROLL_FORWARD = 0xe9,\n  ROLL_BACKWARD = 0xea,\n  SPOT_DODGE = 0xeb,\n  AIR_DODGE = 0xec,\n  ACTION_WAIT = 0xe,\n  ACTION_DASH = 0x14,\n  ACTION_KNEE_BEND = 0x18,\n  GUARD_ON = 0xb2,\n  TECH_MISS_UP = 0xb7,\n  JAB_RESET_UP = 0xb9,\n  TECH_MISS_DOWN = 0xbf,\n  JAB_RESET_DOWN = 0xc1,\n  NEUTRAL_TECH = 0xc7,\n  FORWARD_TECH = 0xc8,\n  BACKWARD_TECH = 0xc9,\n  WALL_TECH = 0xca,\n  MISSED_WALL_TECH = 0xf7,\n  DASH = 0x14,\n  TURN = 0x12,\n  LANDING_FALL_SPECIAL = 0x2b,\n  JUMP_FORWARD = 0x19,\n  JUMP_BACKWARD = 0x1a,\n  FALL_FORWARD = 0x1e,\n  FALL_BACKWARD = 0x1f,\n  GRAB = 0xd4,\n  DASH_GRAB = 0xd6,\n  GRAB_WAIT = 0xd8,\n  PUMMEL = 0xd9,\n  CLIFF_CATCH = 0xfc,\n  THROW_UP = 0xdd,\n  THROW_FORWARD = 0xdb,\n  THROW_DOWN = 0xde,\n  THROW_BACK = 0xdc,\n  DAMAGE_FALL = 0x26,\n  ATTACK_JAB1 = 0x2c,\n  ATTACK_JAB2 = 0x2d,\n  ATTACK_JAB3 = 0x2e,\n  ATTACK_JABM = 0x2f,\n  ATTACK_DASH = 0x32,\n  ATTACK_UTILT = 0x38,\n  ATTACK_DTILT = 0x39,\n  ATTACK_USMASH = 0x3f,\n  ATTACK_DSMASH = 0x40,\n  AERIAL_NAIR = 0x41,\n  AERIAL_FAIR = 0x42,\n  AERIAL_BAIR = 0x43,\n  AERIAL_UAIR = 0x44,\n  AERIAL_DAIR = 0x45,\n\n  // Weird GnW IDs\n  GNW_JAB1 = 0x155,\n  GNW_JABM = 0x156,\n  GNW_DTILT = 0x159,\n  GNW_FSMASH = 0x15a,\n  GNW_NAIR = 0x15b,\n  GNW_BAIR = 0x15c,\n  GNW_UAIR = 0x15d,\n\n  // Peach FSMASH ID\n  // FSMASH1 = Golf Club, FSMASH2 = Frying Pan, FSMASH3 = Tennis Racket\n  PEACH_FSMASH1 = 0x15d,\n  PEACH_FSMASH2 = 0x15e,\n  PEACH_FSMASH3 = 0x15f,\n\n  // Command Grabs\n  BARREL_WAIT = 0x125,\n  COMMAND_GRAB_RANGE1_START = 0x10a,\n  COMMAND_GRAB_RANGE1_END = 0x130,\n\n  COMMAND_GRAB_RANGE2_START = 0x147,\n  COMMAND_GRAB_RANGE2_END = 0x152,\n}\n\nexport const Timers = {\n  PUNISH_RESET_FRAMES: 45,\n  RECOVERY_RESET_FRAMES: 45,\n  COMBO_STRING_RESET_FRAMES: 45,\n};\n\nexport function getSinglesPlayerPermutationsFromSettings(settings: GameStartType): PlayerIndexedType[] {\n  if (!settings || settings.players.length !== 2) {\n    // Only return opponent indices for singles\n    return [];\n  }\n\n  return [\n    {\n      playerIndex: settings.players[0]!.playerIndex,\n      opponentIndex: settings.players[1]!.playerIndex,\n    },\n    {\n      playerIndex: settings.players[1]!.playerIndex,\n      opponentIndex: settings.players[0]!.playerIndex,\n    },\n  ];\n}\n\nexport function didLoseStock(frame: PostFrameUpdateType, prevFrame: PostFrameUpdateType): boolean {\n  if (!frame || !prevFrame) {\n    return false;\n  }\n\n  return prevFrame.stocksRemaining! - frame.stocksRemaining! > 0;\n}\n\nexport function isInControl(state: number): boolean {\n  const ground = state >= State.GROUNDED_CONTROL_START && state <= State.GROUNDED_CONTROL_END;\n  const squat = state >= State.SQUAT_START && state <= State.SQUAT_END;\n  const groundAttack = state > State.GROUND_ATTACK_START && state <= State.GROUND_ATTACK_END;\n  const isGrab = state === State.GRAB;\n  // TODO: Add grounded b moves?\n  return ground || squat || groundAttack || isGrab;\n}\n\nexport function isTeching(state: number): boolean {\n  return state >= State.TECH_START && state <= State.TECH_END;\n}\n\nexport function isDown(state: number): boolean {\n  return state >= State.DOWN_START && state <= State.DOWN_END;\n}\n\nexport function isDamaged(state: number): boolean {\n  return (\n    (state >= State.DAMAGE_START && state <= State.DAMAGE_END) ||\n    state === State.DAMAGE_FALL ||\n    state === State.JAB_RESET_UP ||\n    state === State.JAB_RESET_DOWN\n  );\n}\n\nexport function isGrabbed(state: number): boolean {\n  return state >= State.CAPTURE_START && state <= State.CAPTURE_END;\n}\n\n// TODO: Find better implementation of 3 seperate ranges\nexport function isCommandGrabbed(state: number): boolean {\n  return (\n    ((state >= State.COMMAND_GRAB_RANGE1_START && state <= State.COMMAND_GRAB_RANGE1_END) ||\n      (state >= State.COMMAND_GRAB_RANGE2_START && state <= State.COMMAND_GRAB_RANGE2_END)) &&\n    state !== State.BARREL_WAIT\n  );\n}\n\nexport function isDead(state: number): boolean {\n  return state >= State.DYING_START && state <= State.DYING_END;\n}\n\nexport function calcDamageTaken(frame: PostFrameUpdateType, prevFrame: PostFrameUpdateType): number {\n  const percent = frame.percent ?? 0;\n  const prevPercent = prevFrame.percent ?? 0;\n\n  return percent - prevPercent;\n}\n","import { get, isEqual, keyBy, last, set, size } from \"lodash\";\n\nimport type { FrameEntryType, GameStartType } from \"../types\";\nimport type { ActionCountsType, PlayerIndexedType } from \"./common\";\nimport { getSinglesPlayerPermutationsFromSettings, State } from \"./common\";\nimport type { StatComputer } from \"./stats\";\n\n// Frame pattern that indicates a dash dance turn was executed\nconst dashDanceAnimations = [State.DASH, State.TURN, State.DASH];\n\ninterface PlayerActionState {\n  playerCounts: ActionCountsType;\n  animations: number[];\n  actionFrameCounters: number[];\n}\n\nexport class ActionsComputer implements StatComputer<ActionCountsType[]> {\n  private playerPermutations = new Array<PlayerIndexedType>();\n  private state = new Map<PlayerIndexedType, PlayerActionState>();\n\n  public setup(settings: GameStartType): void {\n    this.state = new Map();\n    this.playerPermutations = getSinglesPlayerPermutationsFromSettings(settings);\n    this.playerPermutations.forEach((indices) => {\n      const playerCounts: ActionCountsType = {\n        playerIndex: indices.playerIndex,\n        wavedashCount: 0,\n        wavelandCount: 0,\n        airDodgeCount: 0,\n        dashDanceCount: 0,\n        spotDodgeCount: 0,\n        ledgegrabCount: 0,\n        rollCount: 0,\n        lCancelCount: {\n          success: 0,\n          fail: 0,\n        },\n        attackCount: {\n          jab1: 0,\n          jab2: 0,\n          jab3: 0,\n          jabm: 0,\n          dash: 0,\n          ftilt: 0,\n          utilt: 0,\n          dtilt: 0,\n          fsmash: 0,\n          usmash: 0,\n          dsmash: 0,\n          nair: 0,\n          fair: 0,\n          bair: 0,\n          uair: 0,\n          dair: 0,\n        },\n        grabCount: {\n          success: 0,\n          fail: 0,\n        },\n        throwCount: {\n          up: 0,\n          forward: 0,\n          back: 0,\n          down: 0,\n        },\n        groundTechCount: {\n          // tech away/in are in reference to the opponents position and not the stage\n          away: 0,\n          in: 0,\n          neutral: 0,\n          fail: 0,\n        },\n        wallTechCount: {\n          success: 0,\n          fail: 0,\n        },\n      };\n      const playerState: PlayerActionState = {\n        playerCounts: playerCounts,\n        animations: [],\n        actionFrameCounters: [],\n      };\n      this.state.set(indices, playerState);\n    });\n  }\n\n  public processFrame(frame: FrameEntryType): void {\n    this.playerPermutations.forEach((indices) => {\n      const state = this.state.get(indices);\n      if (state) {\n        handleActionCompute(state, indices, frame);\n      }\n    });\n  }\n\n  public fetch(): ActionCountsType[] {\n    return Array.from(this.state.values()).map((val) => val.playerCounts);\n  }\n}\n\nfunction isMissGroundTech(animation: State): boolean {\n  return animation === State.TECH_MISS_DOWN || animation === State.TECH_MISS_UP;\n}\n\nfunction isRolling(animation: State): boolean {\n  return animation === State.ROLL_BACKWARD || animation === State.ROLL_FORWARD;\n}\n\nfunction isGrabAction(animation: State): boolean {\n  // Includes Grab pull, wait, pummel, and throws\n  return animation > State.GRAB && animation <= State.THROW_DOWN && animation !== State.DASH_GRAB;\n}\n\nfunction isGrabbing(animation: State): boolean {\n  return animation === State.GRAB || animation === State.DASH_GRAB;\n}\n\nfunction isAerialAttack(animation: State): boolean {\n  return animation >= State.AERIAL_ATTACK_START && animation <= State.AERIAL_ATTACK_END;\n}\n\nfunction isForwardTilt(animation: State): boolean {\n  return animation >= State.ATTACK_FTILT_START && animation <= State.ATTACK_FTILT_END;\n}\n\nfunction isForwardSmash(animation: State): boolean {\n  return animation >= State.ATTACK_FSMASH_START && animation <= State.ATTACK_FSMASH_END;\n}\n\nfunction handleActionCompute(state: PlayerActionState, indices: PlayerIndexedType, frame: FrameEntryType): void {\n  const playerFrame = frame.players[indices.playerIndex]!.post;\n  const opponentFrame = frame.players[indices.opponentIndex]!.post;\n  const incrementCount = (field: string, condition: boolean): void => {\n    if (!condition) {\n      return;\n    }\n\n    const current: number = get(state.playerCounts, field, 0);\n    set(state.playerCounts, field, current + 1);\n  };\n\n  // Manage animation state\n  const currentAnimation = playerFrame.actionStateId!;\n  state.animations.push(currentAnimation);\n  const currentFrameCounter = playerFrame.actionStateCounter!;\n  state.actionFrameCounters.push(currentFrameCounter);\n\n  // Grab last 3 frames\n  const last3Frames = state.animations.slice(-3);\n  const prevAnimation = last3Frames[last3Frames.length - 2] as number;\n  const prevFrameCounter = state.actionFrameCounters[state.actionFrameCounters.length - 2] as number;\n\n  // New action if new animation or frame counter goes back down (repeated action)\n  const isNewAction = currentAnimation !== prevAnimation || prevFrameCounter > currentFrameCounter;\n  if (!isNewAction) {\n    return;\n  }\n\n  // Increment counts based on conditions\n  const didDashDance = isEqual(last3Frames, dashDanceAnimations);\n  incrementCount(\"dashDanceCount\", didDashDance);\n\n  incrementCount(\"rollCount\", isRolling(currentAnimation));\n  incrementCount(\"spotDodgeCount\", currentAnimation === State.SPOT_DODGE);\n  incrementCount(\"airDodgeCount\", currentAnimation === State.AIR_DODGE);\n  incrementCount(\"ledgegrabCount\", currentAnimation === State.CLIFF_CATCH);\n\n  // Grabs\n  incrementCount(\"grabCount.success\", isGrabbing(prevAnimation) && isGrabAction(currentAnimation));\n  incrementCount(\"grabCount.fail\", isGrabbing(prevAnimation) && !isGrabAction(currentAnimation));\n  if (currentAnimation === State.DASH_GRAB && prevAnimation === State.ATTACK_DASH) {\n    state.playerCounts.attackCount.dash -= 1; // subtract from dash attack if boost grab\n  }\n\n  // Basic attacks\n  incrementCount(\"attackCount.jab1\", currentAnimation === State.ATTACK_JAB1);\n  incrementCount(\"attackCount.jab2\", currentAnimation === State.ATTACK_JAB2);\n  incrementCount(\"attackCount.jab3\", currentAnimation === State.ATTACK_JAB3);\n  incrementCount(\"attackCount.jabm\", currentAnimation === State.ATTACK_JABM);\n  incrementCount(\"attackCount.dash\", currentAnimation === State.ATTACK_DASH);\n  incrementCount(\"attackCount.ftilt\", isForwardTilt(currentAnimation));\n  incrementCount(\"attackCount.utilt\", currentAnimation === State.ATTACK_UTILT);\n  incrementCount(\"attackCount.dtilt\", currentAnimation === State.ATTACK_DTILT);\n  incrementCount(\"attackCount.fsmash\", isForwardSmash(currentAnimation));\n  incrementCount(\"attackCount.usmash\", currentAnimation === State.ATTACK_USMASH);\n  incrementCount(\"attackCount.dsmash\", currentAnimation === State.ATTACK_DSMASH);\n  incrementCount(\"attackCount.nair\", currentAnimation === State.AERIAL_NAIR);\n  incrementCount(\"attackCount.fair\", currentAnimation === State.AERIAL_FAIR);\n  incrementCount(\"attackCount.bair\", currentAnimation === State.AERIAL_BAIR);\n  incrementCount(\"attackCount.uair\", currentAnimation === State.AERIAL_UAIR);\n  incrementCount(\"attackCount.dair\", currentAnimation === State.AERIAL_DAIR);\n\n  // GnW is weird and has unique IDs for some moves\n  if (playerFrame.internalCharacterId === 0x18) {\n    incrementCount(\"attackCount.jab1\", currentAnimation === State.GNW_JAB1);\n    incrementCount(\"attackCount.jabm\", currentAnimation === State.GNW_JABM);\n    incrementCount(\"attackCount.dtilt\", currentAnimation === State.GNW_DTILT);\n    incrementCount(\"attackCount.fsmash\", currentAnimation === State.GNW_FSMASH);\n    incrementCount(\"attackCount.nair\", currentAnimation === State.GNW_NAIR);\n    incrementCount(\"attackCount.bair\", currentAnimation === State.GNW_BAIR);\n    incrementCount(\"attackCount.uair\", currentAnimation === State.GNW_UAIR);\n  }\n\n  // Peach is also weird and has a unique ID for her fsmash\n  // FSMASH1 = Golf Club, FSMASH2 = Frying Pan, FSMASH3 = Tennis Racket\n  if (playerFrame.internalCharacterId === 0x09) {\n    incrementCount(\"attackCount.fsmash\", currentAnimation === State.PEACH_FSMASH1);\n    incrementCount(\"attackCount.fsmash\", currentAnimation === State.PEACH_FSMASH2);\n    incrementCount(\"attackCount.fsmash\", currentAnimation === State.PEACH_FSMASH3);\n  }\n\n  // Throws\n  incrementCount(\"throwCount.up\", currentAnimation === State.THROW_UP);\n  incrementCount(\"throwCount.forward\", currentAnimation === State.THROW_FORWARD);\n  incrementCount(\"throwCount.down\", currentAnimation === State.THROW_DOWN);\n  incrementCount(\"throwCount.back\", currentAnimation === State.THROW_BACK);\n\n  // Techs\n  const opponentDir = playerFrame.positionX! > opponentFrame.positionX! ? -1 : 1;\n  const facingOpponent = playerFrame.facingDirection === opponentDir;\n\n  incrementCount(\"groundTechCount.fail\", isMissGroundTech(currentAnimation));\n  incrementCount(\"groundTechCount.in\", currentAnimation === State.FORWARD_TECH && facingOpponent);\n  incrementCount(\"groundTechCount.in\", currentAnimation === State.BACKWARD_TECH && !facingOpponent);\n  incrementCount(\"groundTechCount.neutral\", currentAnimation === State.NEUTRAL_TECH);\n  incrementCount(\"groundTechCount.away\", currentAnimation === State.BACKWARD_TECH && facingOpponent);\n  incrementCount(\"groundTechCount.away\", currentAnimation === State.FORWARD_TECH && !facingOpponent);\n  incrementCount(\"wallTechCount.success\", currentAnimation === State.WALL_TECH);\n  incrementCount(\"wallTechCount.fail\", currentAnimation === State.MISSED_WALL_TECH);\n\n  if (isAerialAttack(currentAnimation)) {\n    incrementCount(\"lCancelCount.success\", playerFrame.lCancelStatus === 1);\n    incrementCount(\"lCancelCount.fail\", playerFrame.lCancelStatus === 2);\n  }\n\n  // Handles wavedash detection (and waveland)\n  handleActionWavedash(state.playerCounts, state.animations);\n}\n\nfunction handleActionWavedash(counts: ActionCountsType, animations: State[]): void {\n  const currentAnimation = last(animations);\n  const prevAnimation = animations[animations.length - 2] as number;\n\n  const isSpecialLanding = currentAnimation === State.LANDING_FALL_SPECIAL;\n  const isAcceptablePrevious = isWavedashInitiationAnimation(prevAnimation);\n  const isPossibleWavedash = isSpecialLanding && isAcceptablePrevious;\n\n  if (!isPossibleWavedash) {\n    return;\n  }\n\n  // Here we special landed, it might be a wavedash, let's check\n  // We grab the last 8 frames here because that should be enough time to execute a\n  // wavedash. This number could be tweaked if we find false negatives\n  const recentFrames = animations.slice(-8);\n  const recentAnimations = keyBy(recentFrames, (animation) => animation);\n\n  if (size(recentAnimations) === 2 && recentAnimations[State.AIR_DODGE]) {\n    // If the only other animation is air dodge, this might be really late to the point\n    // where it was actually an air dodge. Air dodge animation is really long\n    return;\n  }\n\n  if (recentAnimations[State.AIR_DODGE]) {\n    // If one of the recent animations was an air dodge, let's remove that from the\n    // air dodge counter, we don't want to count air dodges used to wavedash/land\n    counts.airDodgeCount -= 1;\n  }\n\n  if (recentAnimations[State.ACTION_KNEE_BEND]) {\n    // If a jump was started recently, we will consider this a wavedash\n    counts.wavedashCount += 1;\n  } else {\n    // If there was no jump recently, this is a waveland\n    counts.wavelandCount += 1;\n  }\n}\n\nfunction isWavedashInitiationAnimation(animation: State): boolean {\n  if (animation === State.AIR_DODGE) {\n    return true;\n  }\n\n  const isAboveMin = animation >= State.CONTROLLED_JUMP_START;\n  const isBelowMax = animation <= State.CONTROLLED_JUMP_END;\n  return isAboveMin && isBelowMax;\n}\n","import { EventEmitter } from \"events\";\nimport { last } from \"lodash\";\n\nimport type { FrameEntryType, FramesType, GameStartType, PostFrameUpdateType } from \"../types\";\nimport type { ComboType, MoveLandedType, PlayerIndexedType } from \"./common\";\nimport {\n  calcDamageTaken,\n  didLoseStock,\n  getSinglesPlayerPermutationsFromSettings,\n  isCommandGrabbed,\n  isDamaged,\n  isDead,\n  isDown,\n  isGrabbed,\n  isTeching,\n  Timers,\n} from \"./common\";\nimport type { StatComputer } from \"./stats\";\n\nexport enum ComboEvent {\n  COMBO_START = \"COMBO_START\",\n  COMBO_EXTEND = \"COMBO_EXTEND\",\n  COMBO_END = \"COMBO_END\",\n}\n\ninterface ComboState {\n  combo: ComboType | null;\n  move: MoveLandedType | null;\n  resetCounter: number;\n  lastHitAnimation: number | null;\n  event: ComboEvent | null;\n}\n\nexport class ComboComputer extends EventEmitter implements StatComputer<ComboType[]> {\n  private playerPermutations = new Array<PlayerIndexedType>();\n  private state = new Map<PlayerIndexedType, ComboState>();\n  private combos = new Array<ComboType>();\n  private settings: GameStartType | null = null;\n\n  public setup(settings: GameStartType): void {\n    // Reset the state\n    this.settings = settings;\n    this.state = new Map();\n    this.combos = [];\n    this.playerPermutations = getSinglesPlayerPermutationsFromSettings(settings);\n\n    this.playerPermutations.forEach((indices) => {\n      const playerState: ComboState = {\n        combo: null,\n        move: null,\n        resetCounter: 0,\n        lastHitAnimation: null,\n        event: null,\n      };\n      this.state.set(indices, playerState);\n    });\n  }\n\n  public processFrame(frame: FrameEntryType, allFrames: FramesType): void {\n    this.playerPermutations.forEach((indices) => {\n      const state = this.state.get(indices);\n      if (state) {\n        handleComboCompute(allFrames, state, indices, frame, this.combos);\n\n        // Emit an event for the new combo\n        if (state.event !== null) {\n          this.emit(state.event, {\n            combo: last(this.combos),\n            settings: this.settings,\n          });\n          state.event = null;\n        }\n      }\n    });\n  }\n\n  public fetch(): ComboType[] {\n    return this.combos;\n  }\n}\n\nfunction handleComboCompute(\n  frames: FramesType,\n  state: ComboState,\n  indices: PlayerIndexedType,\n  frame: FrameEntryType,\n  combos: ComboType[],\n): void {\n  const currentFrameNumber = frame.frame;\n  const playerFrame = frame.players[indices.playerIndex]!.post;\n  const opponentFrame = frame.players[indices.opponentIndex]!.post;\n\n  const prevFrameNumber = currentFrameNumber - 1;\n  let prevPlayerFrame: PostFrameUpdateType | null = null;\n  let prevOpponentFrame: PostFrameUpdateType | null = null;\n\n  if (frames[prevFrameNumber]) {\n    prevPlayerFrame = frames[prevFrameNumber]!.players[indices.playerIndex]!.post;\n    prevOpponentFrame = frames[prevFrameNumber]!.players[indices.opponentIndex]!.post;\n  }\n\n  const oppActionStateId = opponentFrame.actionStateId!;\n  const opntIsDamaged = isDamaged(oppActionStateId);\n  const opntIsGrabbed = isGrabbed(oppActionStateId);\n  const opntIsCommandGrabbed = isCommandGrabbed(oppActionStateId);\n  const opntDamageTaken = prevOpponentFrame ? calcDamageTaken(opponentFrame, prevOpponentFrame) : 0;\n\n  // Keep track of whether actionState changes after a hit. Used to compute move count\n  // When purely using action state there was a bug where if you did two of the same\n  // move really fast (such as ganon's jab), it would count as one move. Added\n  // the actionStateCounter at this point which counts the number of frames since\n  // an animation started. Should be more robust, for old files it should always be\n  // null and null < null = false\n  const actionChangedSinceHit = playerFrame.actionStateId !== state.lastHitAnimation;\n  const actionCounter = playerFrame.actionStateCounter!;\n  const prevActionCounter = prevPlayerFrame ? prevPlayerFrame.actionStateCounter! : 0;\n  const actionFrameCounterReset = actionCounter < prevActionCounter;\n  if (actionChangedSinceHit || actionFrameCounterReset) {\n    state.lastHitAnimation = null;\n  }\n\n  // If opponent took damage and was put in some kind of stun this frame, either\n  // start a combo or count the moves for the existing combo\n  if (opntIsDamaged || opntIsGrabbed || opntIsCommandGrabbed) {\n    let comboStarted = false;\n    if (!state.combo) {\n      state.combo = {\n        playerIndex: indices.opponentIndex,\n        startFrame: currentFrameNumber,\n        endFrame: null,\n        startPercent: prevOpponentFrame ? prevOpponentFrame.percent ?? 0 : 0,\n        currentPercent: opponentFrame.percent ?? 0,\n        endPercent: null,\n        moves: [],\n        didKill: false,\n        lastHitBy: indices.playerIndex,\n      };\n\n      combos.push(state.combo);\n\n      // Track whether this is a new combo or not\n      comboStarted = true;\n    }\n\n    if (opntDamageTaken) {\n      // If animation of last hit has been cleared that means this is a new move. This\n      // prevents counting multiple hits from the same move such as fox's drill\n      if (state.lastHitAnimation === null) {\n        state.move = {\n          playerIndex: indices.playerIndex,\n          frame: currentFrameNumber,\n          moveId: playerFrame.lastAttackLanded!,\n          hitCount: 0,\n          damage: 0,\n        };\n\n        state.combo.moves.push(state.move);\n\n        // Make sure we don't overwrite the START event\n        if (!comboStarted) {\n          state.event = ComboEvent.COMBO_EXTEND;\n        }\n      }\n\n      if (state.move) {\n        state.move.hitCount += 1;\n        state.move.damage += opntDamageTaken;\n      }\n\n      // Store previous frame animation to consider the case of a trade, the previous\n      // frame should always be the move that actually connected... I hope\n      state.lastHitAnimation = prevPlayerFrame ? prevPlayerFrame.actionStateId : null;\n    }\n\n    if (comboStarted) {\n      state.event = ComboEvent.COMBO_START;\n    }\n  }\n\n  if (!state.combo) {\n    // The rest of the function handles combo termination logic, so if we don't\n    // have a combo started, there is no need to continue\n    return;\n  }\n\n  const opntIsTeching = isTeching(oppActionStateId);\n  const opntIsDowned = isDown(oppActionStateId);\n  const opntDidLoseStock = prevOpponentFrame && didLoseStock(opponentFrame, prevOpponentFrame);\n  const opntIsDying = isDead(oppActionStateId);\n\n  // Update percent if opponent didn't lose stock\n  if (!opntDidLoseStock) {\n    state.combo.currentPercent = opponentFrame.percent ?? 0;\n  }\n\n  if (opntIsDamaged || opntIsGrabbed || opntIsCommandGrabbed || opntIsTeching || opntIsDowned || opntIsDying) {\n    // If opponent got grabbed or damaged, reset the reset counter\n    state.resetCounter = 0;\n  } else {\n    state.resetCounter += 1;\n  }\n\n  let shouldTerminate = false;\n\n  // Termination condition 1 - player kills opponent\n  if (opntDidLoseStock) {\n    state.combo.didKill = true;\n    shouldTerminate = true;\n  }\n\n  // Termination condition 2 - combo resets on time\n  if (state.resetCounter > Timers.COMBO_STRING_RESET_FRAMES) {\n    shouldTerminate = true;\n  }\n\n  // If combo should terminate, mark the end states and add it to list\n  if (shouldTerminate) {\n    state.combo.endFrame = playerFrame.frame;\n    state.combo.endPercent = prevOpponentFrame ? prevOpponentFrame.percent ?? 0 : 0;\n    state.event = ComboEvent.COMBO_END;\n\n    state.combo = null;\n    state.move = null;\n  }\n}\n","import { EventEmitter } from \"events\";\nimport { filter, get, groupBy, last, orderBy } from \"lodash\";\n\nimport type { FrameEntryType, FramesType, GameStartType, PostFrameUpdateType } from \"../types\";\nimport type { ConversionType, MoveLandedType, PlayerIndexedType } from \"./common\";\nimport {\n  calcDamageTaken,\n  didLoseStock,\n  getSinglesPlayerPermutationsFromSettings,\n  isCommandGrabbed,\n  isDamaged,\n  isGrabbed,\n  isInControl,\n  Timers,\n} from \"./common\";\nimport type { StatComputer } from \"./stats\";\n\ninterface PlayerConversionState {\n  conversion: ConversionType | null;\n  move: MoveLandedType | null;\n  resetCounter: number;\n  lastHitAnimation: number | null;\n}\n\ninterface MetadataType {\n  lastEndFrameByOppIdx: {\n    [oppIdx: number]: number;\n  };\n}\n\nexport class ConversionComputer extends EventEmitter implements StatComputer<ConversionType[]> {\n  private playerPermutations = new Array<PlayerIndexedType>();\n  private conversions = new Array<ConversionType>();\n  private state = new Map<PlayerIndexedType, PlayerConversionState>();\n  private metadata: MetadataType;\n  private settings: GameStartType | null = null;\n\n  public constructor() {\n    super();\n    this.metadata = {\n      lastEndFrameByOppIdx: {},\n    };\n  }\n\n  public setup(settings: GameStartType): void {\n    // Reset the state\n    this.playerPermutations = getSinglesPlayerPermutationsFromSettings(settings);\n    this.conversions = [];\n    this.state = new Map();\n    this.metadata = {\n      lastEndFrameByOppIdx: {},\n    };\n    this.settings = settings;\n\n    this.playerPermutations.forEach((indices) => {\n      const playerState: PlayerConversionState = {\n        conversion: null,\n        move: null,\n        resetCounter: 0,\n        lastHitAnimation: null,\n      };\n      this.state.set(indices, playerState);\n    });\n  }\n\n  public processFrame(frame: FrameEntryType, allFrames: FramesType): void {\n    this.playerPermutations.forEach((indices) => {\n      const state = this.state.get(indices);\n      if (state) {\n        const terminated = handleConversionCompute(allFrames, state, indices, frame, this.conversions);\n        if (terminated) {\n          this.emit(\"CONVERSION\", {\n            combo: last(this.conversions),\n            settings: this.settings,\n          });\n        }\n      }\n    });\n  }\n\n  public fetch(): ConversionType[] {\n    this._populateConversionTypes();\n    return this.conversions;\n  }\n\n  private _populateConversionTypes(): void {\n    // Post-processing step: set the openingTypes\n    const conversionsToHandle = filter(this.conversions, (conversion) => {\n      return conversion.openingType === \"unknown\";\n    });\n\n    // Group new conversions by startTime and sort\n    const groupedConversions = groupBy(conversionsToHandle, \"startFrame\");\n    const sortedConversions = orderBy(groupedConversions, (conversions) => get(conversions, [0, \"startFrame\"]));\n\n    // Set the opening types on the conversions we need to handle\n    sortedConversions.forEach((conversions) => {\n      const isTrade = conversions.length >= 2;\n      conversions.forEach((conversion) => {\n        // Set end frame for this conversion\n        this.metadata.lastEndFrameByOppIdx[conversion.playerIndex] = conversion.endFrame!;\n\n        if (isTrade) {\n          // If trade, just short-circuit\n          conversion.openingType = \"trade\";\n          return;\n        }\n\n        // If not trade, check the opponent endFrame\n        const lastMove = last(conversion.moves);\n        const oppEndFrame =\n          this.metadata.lastEndFrameByOppIdx[lastMove ? lastMove.playerIndex : conversion.playerIndex];\n        const isCounterAttack = oppEndFrame && oppEndFrame > conversion.startFrame;\n        conversion.openingType = isCounterAttack ? \"counter-attack\" : \"neutral-win\";\n      });\n    });\n  }\n}\n\nfunction handleConversionCompute(\n  frames: FramesType,\n  state: PlayerConversionState,\n  indices: PlayerIndexedType,\n  frame: FrameEntryType,\n  conversions: ConversionType[],\n): boolean {\n  const currentFrameNumber = frame.frame;\n  const playerFrame: PostFrameUpdateType = frame.players[indices.playerIndex]!.post;\n  const opponentFrame = frame.players[indices.opponentIndex]!.post;\n\n  const prevFrameNumber = currentFrameNumber - 1;\n  let prevPlayerFrame: PostFrameUpdateType | null = null;\n  let prevOpponentFrame: PostFrameUpdateType | null = null;\n\n  if (frames[prevFrameNumber]) {\n    prevPlayerFrame = frames[prevFrameNumber]!.players[indices.playerIndex]!.post;\n    prevOpponentFrame = frames[prevFrameNumber]!.players[indices.opponentIndex]!.post;\n  }\n\n  const oppActionStateId = opponentFrame.actionStateId!;\n  const opntIsDamaged = isDamaged(oppActionStateId);\n  const opntIsGrabbed = isGrabbed(oppActionStateId);\n  const opntIsCommandGrabbed = isCommandGrabbed(oppActionStateId);\n  const opntDamageTaken = prevOpponentFrame ? calcDamageTaken(opponentFrame, prevOpponentFrame) : 0;\n\n  // Keep track of whether actionState changes after a hit. Used to compute move count\n  // When purely using action state there was a bug where if you did two of the same\n  // move really fast (such as ganon's jab), it would count as one move. Added\n  // the actionStateCounter at this point which counts the number of frames since\n  // an animation started. Should be more robust, for old files it should always be\n  // null and null < null = false\n  const actionChangedSinceHit = playerFrame.actionStateId !== state.lastHitAnimation;\n  const actionCounter = playerFrame.actionStateCounter!;\n  const prevActionCounter = prevPlayerFrame ? prevPlayerFrame.actionStateCounter! : 0;\n  const actionFrameCounterReset = actionCounter < prevActionCounter;\n  if (actionChangedSinceHit || actionFrameCounterReset) {\n    state.lastHitAnimation = null;\n  }\n\n  // If opponent took damage and was put in some kind of stun this frame, either\n  // start a conversion or\n  if (opntIsDamaged || opntIsGrabbed || opntIsCommandGrabbed) {\n    if (!state.conversion) {\n      state.conversion = {\n        playerIndex: indices.opponentIndex,\n        lastHitBy: indices.playerIndex,\n        startFrame: currentFrameNumber,\n        endFrame: null,\n        startPercent: prevOpponentFrame ? prevOpponentFrame.percent ?? 0 : 0,\n        currentPercent: opponentFrame.percent ?? 0,\n        endPercent: null,\n        moves: [],\n        didKill: false,\n        openingType: \"unknown\", // Will be updated later\n      };\n\n      conversions.push(state.conversion);\n    }\n\n    if (opntDamageTaken) {\n      // If animation of last hit has been cleared that means this is a new move. This\n      // prevents counting multiple hits from the same move such as fox's drill\n      if (state.lastHitAnimation === null) {\n        state.move = {\n          playerIndex: indices.playerIndex,\n          frame: currentFrameNumber,\n          moveId: playerFrame.lastAttackLanded!,\n          hitCount: 0,\n          damage: 0,\n        };\n\n        state.conversion.moves.push(state.move);\n      }\n\n      if (state.move) {\n        state.move.hitCount += 1;\n        state.move.damage += opntDamageTaken;\n      }\n\n      // Store previous frame animation to consider the case of a trade, the previous\n      // frame should always be the move that actually connected... I hope\n      state.lastHitAnimation = prevPlayerFrame ? prevPlayerFrame.actionStateId : null;\n    }\n  }\n\n  if (!state.conversion) {\n    // The rest of the function handles conversion termination logic, so if we don't\n    // have a conversion started, there is no need to continue\n    return false;\n  }\n\n  const opntInControl = isInControl(oppActionStateId);\n  const opntDidLoseStock = prevOpponentFrame && didLoseStock(opponentFrame, prevOpponentFrame);\n\n  // Update percent if opponent didn't lose stock\n  if (!opntDidLoseStock) {\n    state.conversion.currentPercent = opponentFrame.percent ?? 0;\n  }\n\n  if (opntIsDamaged || opntIsGrabbed || opntIsCommandGrabbed) {\n    // If opponent got grabbed or damaged, reset the reset counter\n    state.resetCounter = 0;\n  }\n\n  const shouldStartResetCounter = state.resetCounter === 0 && opntInControl;\n  const shouldContinueResetCounter = state.resetCounter > 0;\n  if (shouldStartResetCounter || shouldContinueResetCounter) {\n    // This will increment the reset timer under the following conditions:\n    // 1) if we were punishing opponent but they have now entered an actionable state\n    // 2) if counter has already started counting meaning opponent has entered actionable state\n    state.resetCounter += 1;\n  }\n\n  let shouldTerminate = false;\n\n  // Termination condition 1 - player kills opponent\n  if (opntDidLoseStock) {\n    state.conversion.didKill = true;\n    shouldTerminate = true;\n  }\n\n  // Termination condition 2 - conversion resets on time\n  if (state.resetCounter > Timers.PUNISH_RESET_FRAMES) {\n    shouldTerminate = true;\n  }\n\n  // If conversion should terminate, mark the end states and add it to list\n  if (shouldTerminate) {\n    state.conversion.endFrame = playerFrame.frame;\n    state.conversion.endPercent = prevOpponentFrame ? prevOpponentFrame.percent ?? 0 : 0;\n\n    state.conversion = null;\n    state.move = null;\n  }\n\n  return shouldTerminate;\n}\n","export enum Command {\n  SPLIT_MESSAGE = 0x10,\n  MESSAGE_SIZES = 0x35,\n  GAME_START = 0x36,\n  PRE_FRAME_UPDATE = 0x37,\n  POST_FRAME_UPDATE = 0x38,\n  GAME_END = 0x39,\n  FRAME_START = 0x3a,\n  ITEM_UPDATE = 0x3b,\n  FRAME_BOOKEND = 0x3c,\n  GECKO_LIST = 0x3d,\n}\n\nexport interface PlayerType {\n  playerIndex: number;\n  port: number;\n  characterId: number | null;\n  type: number | null;\n  startStocks: number | null;\n  characterColor: number | null;\n  teamShade: number | null;\n  handicap: number | null;\n  teamId: number | null;\n  staminaMode: boolean | null;\n  silentCharacter: boolean | null;\n  invisible: boolean | null;\n  lowGravity: boolean | null;\n  blackStockIcon: boolean | null;\n  metal: boolean | null;\n  startOnAngelPlatform: boolean | null;\n  rumbleEnabled: boolean | null;\n  cpuLevel: number | null;\n  offenseRatio: number | null;\n  defenseRatio: number | null;\n  modelScale: number | null;\n  controllerFix: string | null;\n  nametag: string | null;\n  displayName: string;\n  connectCode: string;\n  userId: string;\n}\n\nexport enum GameMode {\n  VS = 0x02,\n  ONLINE = 0x08,\n  TARGET_TEST = 0x0f,\n  HOME_RUN_CONTEST = 0x20,\n}\n\nexport enum Language {\n  JAPANESE = 0,\n  ENGLISH = 1,\n}\n\nexport interface GameStartType {\n  slpVersion: string | null;\n  timerType: TimerType | null;\n  inGameMode: number | null;\n  friendlyFireEnabled: boolean | null;\n  isTeams: boolean | null;\n  stageId: number | null;\n  startingTimerSeconds: number | null;\n  itemSpawnBehavior: ItemSpawnType | null;\n  enabledItems: number | null;\n  players: PlayerType[];\n  scene: number | null;\n  gameMode: GameMode | null;\n  language: Language | null;\n  gameInfoBlock: GameInfoType | null;\n  randomSeed: number | null;\n  isPAL: boolean | null;\n  isFrozenPS: boolean | null;\n  matchInfo: MatchInfo | null;\n}\n\ninterface MatchInfo {\n  matchId: string | null;\n  gameNumber: number | null;\n  tiebreakerNumber: number | null;\n}\n\nexport interface FrameStartType {\n  frame: number | null;\n  seed: number | null;\n  sceneFrameCounter: number | null;\n}\n\nexport interface GameInfoType {\n  gameBitfield1: number | null;\n  gameBitfield2: number | null;\n  gameBitfield3: number | null;\n  gameBitfield4: number | null;\n  bombRainEnabled: boolean | null;\n  selfDestructScoreValue: number | null;\n  itemSpawnBitfield1: number | null;\n  itemSpawnBitfield2: number | null;\n  itemSpawnBitfield3: number | null;\n  itemSpawnBitfield4: number | null;\n  itemSpawnBitfield5: number | null;\n  damageRatio: number | null;\n}\n\nexport enum TimerType {\n  NONE = 0b00,\n  DECREASING = 0b10,\n  INCREASING = 0b11,\n}\n\nexport enum ItemSpawnType {\n  OFF = 0xff,\n  VERY_LOW = 0x00,\n  LOW = 0x01,\n  MEDIUM = 0x02,\n  HIGH = 0x03,\n  VERY_HIGH = 0x04,\n}\n\nexport enum EnabledItemType {\n  METAL_BOX = 2 ** 0,\n  CLOAKING_DEVICE = 2 ** 1,\n  POKEBALL = 2 ** 2,\n  // Bits 4 through 8 of item bitfield 1 are unknown\n  UNKNOWN_ITEM_BIT_4 = 2 ** 3,\n  UNKNOWN_ITEM_BIT_5 = 2 ** 4,\n  UNKNOWN_ITEM_BIT_6 = 2 ** 5,\n  UNKNOWN_ITEM_BIT_7 = 2 ** 6,\n  UNKNOWN_ITEM_BIT_8 = 2 ** 7,\n  FAN = 2 ** 8,\n  FIRE_FLOWER = 2 ** 9,\n  SUPER_MUSHROOM = 2 ** 10,\n  POISON_MUSHROOM = 2 ** 11,\n  HAMMER = 2 ** 12,\n  WARP_STAR = 2 ** 13,\n  SCREW_ATTACK = 2 ** 14,\n  BUNNY_HOOD = 2 ** 15,\n  RAY_GUN = 2 ** 16,\n  FREEZIE = 2 ** 17,\n  FOOD = 2 ** 18,\n  MOTION_SENSOR_BOMB = 2 ** 19,\n  FLIPPER = 2 ** 20,\n  SUPER_SCOPE = 2 ** 21,\n  STAR_ROD = 2 ** 22,\n  LIPS_STICK = 2 ** 23,\n  HEART_CONTAINER = 2 ** 24,\n  MAXIM_TOMATO = 2 ** 25,\n  STARMAN = 2 ** 26,\n  HOME_RUN_BAT = 2 ** 27,\n  BEAM_SWORD = 2 ** 28,\n  PARASOL = 2 ** 29,\n  GREEN_SHELL = 2 ** 30,\n  RED_SHELL = 2 ** 31,\n  CAPSULE = 2 ** 32,\n  BOX = 2 ** 33,\n  BARREL = 2 ** 34,\n  EGG = 2 ** 35,\n  PARTY_BALL = 2 ** 36,\n  BARREL_CANNON = 2 ** 37,\n  BOMB_OMB = 2 ** 38,\n  MR_SATURN = 2 ** 39,\n}\n\nexport interface PreFrameUpdateType {\n  frame: number | null;\n  playerIndex: number | null;\n  isFollower: boolean | null;\n  seed: number | null;\n  actionStateId: number | null;\n  positionX: number | null;\n  positionY: number | null;\n  facingDirection: number | null;\n  joystickX: number | null;\n  joystickY: number | null;\n  cStickX: number | null;\n  cStickY: number | null;\n  trigger: number | null;\n  buttons: number | null;\n  physicalButtons: number | null;\n  physicalLTrigger: number | null;\n  physicalRTrigger: number | null;\n  rawJoystickX: number | null;\n  percent: number | null;\n}\n\nexport interface PostFrameUpdateType {\n  frame: number | null;\n  playerIndex: number | null;\n  isFollower: boolean | null;\n  internalCharacterId: number | null;\n  actionStateId: number | null;\n  positionX: number | null;\n  positionY: number | null;\n  facingDirection: number | null;\n  percent: number | null;\n  shieldSize: number | null;\n  lastAttackLanded: number | null;\n  currentComboCount: number | null;\n  lastHitBy: number | null;\n  stocksRemaining: number | null;\n  actionStateCounter: number | null;\n  miscActionState: number | null;\n  isAirborne: boolean | null;\n  lastGroundId: number | null;\n  jumpsRemaining: number | null;\n  lCancelStatus: number | null;\n  hurtboxCollisionState: number | null;\n  selfInducedSpeeds: SelfInducedSpeedsType | null;\n  hitlagRemaining: number | null;\n  animationIndex: number | null;\n}\n\nexport interface SelfInducedSpeedsType {\n  airX: number | null;\n  y: number | null;\n  attackX: number | null;\n  attackY: number | null;\n  groundX: number | null;\n}\n\nexport interface ItemUpdateType {\n  frame: number | null;\n  typeId: number | null;\n  state: number | null;\n  facingDirection: number | null;\n  velocityX: number | null;\n  velocityY: number | null;\n  positionX: number | null;\n  positionY: number | null;\n  damageTaken: number | null;\n  expirationTimer: number | null;\n  spawnId: number | null;\n  missileType: number | null;\n  turnipFace: number | null;\n  chargeShotLaunched: number | null;\n  chargePower: number | null;\n  owner: number | null;\n}\n\nexport interface FrameBookendType {\n  frame: number | null;\n  latestFinalizedFrame: number | null;\n}\n\nexport enum GameEndMethod {\n  UNRESOLVED = 0,\n  RESOLVED = 3,\n  // The following options are only returned in version 2.0.0 onwards\n  TIME = 1,\n  GAME = 2,\n  NO_CONTEST = 7,\n}\n\nexport interface GameEndType {\n  gameEndMethod: GameEndMethod | null;\n  lrasInitiatorIndex: number | null;\n  placements: PlacementType[];\n}\n\nexport interface PlacementType {\n  playerIndex: number;\n  position: number | null;\n}\n\nexport interface GeckoListType {\n  codes: GeckoCodeType[];\n  contents: Uint8Array;\n}\n\nexport interface GeckoCodeType {\n  type: number | null;\n  address: number | null;\n  contents: Uint8Array;\n}\n\nexport interface MetadataType {\n  startAt?: string | null;\n  playedOn?: string | null;\n  lastFrame?: number | null;\n  players?: {\n    [playerIndex: number]: {\n      characters: {\n        [internalCharacterId: number]: number;\n      };\n      names?: {\n        netplay?: string | null;\n        code?: string | null;\n      };\n    };\n  } | null;\n  consoleNick?: string | null;\n}\n\nexport type EventPayloadTypes =\n  | GameStartType\n  | FrameStartType\n  | PreFrameUpdateType\n  | PostFrameUpdateType\n  | ItemUpdateType\n  | FrameBookendType\n  | GameEndType\n  | GeckoListType;\n\nexport type EventCallbackFunc = (\n  command: Command,\n  payload?: EventPayloadTypes | null,\n  buffer?: Uint8Array | null,\n) => boolean;\n\nexport interface FrameEntryType {\n  frame: number;\n  start?: FrameStartType;\n  players: {\n    [playerIndex: number]: {\n      pre: PreFrameUpdateType;\n      post: PostFrameUpdateType;\n    } | null;\n  };\n  followers: {\n    [playerIndex: number]: {\n      pre: PreFrameUpdateType;\n      post: PostFrameUpdateType;\n    } | null;\n  };\n  items?: ItemUpdateType[];\n}\n\nexport enum Frames {\n  FIRST = -123,\n  FIRST_PLAYABLE = -39,\n}\n\nexport interface FramesType {\n  [frameIndex: number]: FrameEntryType;\n}\n\nexport interface RollbackFramesType {\n  [frameIndex: number]: FrameEntryType[];\n}\n\nexport interface RollbackFrames {\n  frames: RollbackFramesType;\n  count: number;\n  lengths: number[];\n}\n","import type { FrameEntryType, FramesType, GameStartType } from \"../types\";\nimport { Frames } from \"../types\";\nimport type { PlayerIndexedType } from \"./common\";\nimport { getSinglesPlayerPermutationsFromSettings } from \"./common\";\nimport type { StatComputer } from \"./stats\";\n\nenum JoystickRegion {\n  DZ = 0,\n  NE = 1,\n  SE = 2,\n  SW = 3,\n  NW = 4,\n  N = 5,\n  E = 6,\n  S = 7,\n  W = 8,\n}\n\nexport interface PlayerInput {\n  playerIndex: number;\n  opponentIndex: number;\n  inputCount: number;\n  joystickInputCount: number;\n  cstickInputCount: number;\n  buttonInputCount: number;\n  triggerInputCount: number;\n}\n\nexport class InputComputer implements StatComputer<PlayerInput[]> {\n  private state = new Map<PlayerIndexedType, PlayerInput>();\n  private playerPermutations = new Array<PlayerIndexedType>();\n\n  public setup(settings: GameStartType): void {\n    // Reset the state\n    this.state = new Map();\n    this.playerPermutations = getSinglesPlayerPermutationsFromSettings(settings);\n\n    this.playerPermutations.forEach((indices) => {\n      const playerState: PlayerInput = {\n        playerIndex: indices.playerIndex,\n        opponentIndex: indices.opponentIndex,\n        inputCount: 0,\n        joystickInputCount: 0,\n        cstickInputCount: 0,\n        buttonInputCount: 0,\n        triggerInputCount: 0,\n      };\n      this.state.set(indices, playerState);\n    });\n  }\n\n  public processFrame(frame: FrameEntryType, allFrames: FramesType): void {\n    this.playerPermutations.forEach((indices) => {\n      const state = this.state.get(indices);\n      if (state) {\n        handleInputCompute(allFrames, state, indices, frame);\n      }\n    });\n  }\n\n  public fetch(): PlayerInput[] {\n    return Array.from(this.state.values());\n  }\n}\n\nfunction handleInputCompute(\n  frames: FramesType,\n  state: PlayerInput,\n  indices: PlayerIndexedType,\n  frame: FrameEntryType,\n): void {\n  const playerFrame = frame.players[indices.playerIndex]!.pre;\n  const currentFrameNumber = playerFrame.frame!;\n  const prevFrameNumber = currentFrameNumber - 1;\n  const prevPlayerFrame = frames[prevFrameNumber] ? frames[prevFrameNumber]!.players[indices.playerIndex]!.pre : null;\n\n  if (currentFrameNumber < Frames.FIRST_PLAYABLE || !prevPlayerFrame) {\n    // Don't count inputs until the game actually starts\n    return;\n  }\n\n  // First count the number of buttons that go from 0 to 1\n  // Increment action count by amount of button presses\n  const invertedPreviousButtons = ~prevPlayerFrame.physicalButtons!;\n  const currentButtons = playerFrame.physicalButtons!;\n  const buttonChanges = invertedPreviousButtons & currentButtons & 0xfff;\n  const newInputsPressed = countSetBits(buttonChanges);\n  state.inputCount += newInputsPressed;\n  state.buttonInputCount += newInputsPressed;\n\n  // Increment action count when sticks change from one region to another.\n  // Don't increment when stick returns to deadzone\n  const prevAnalogRegion = getJoystickRegion(prevPlayerFrame.joystickX!, prevPlayerFrame.joystickY!);\n  const currentAnalogRegion = getJoystickRegion(playerFrame.joystickX!, playerFrame.joystickY!);\n  if (prevAnalogRegion !== currentAnalogRegion && currentAnalogRegion !== JoystickRegion.DZ) {\n    state.inputCount += 1;\n    state.joystickInputCount += 1;\n  }\n\n  // Do the same for c-stick\n  const prevCstickRegion = getJoystickRegion(prevPlayerFrame.cStickX!, prevPlayerFrame.cStickY!);\n  const currentCstickRegion = getJoystickRegion(playerFrame.cStickX!, playerFrame.cStickY!);\n  if (prevCstickRegion !== currentCstickRegion && currentCstickRegion !== JoystickRegion.DZ) {\n    state.inputCount += 1;\n    state.cstickInputCount += 1;\n  }\n\n  // Increment action on analog trigger... I'm not sure when. This needs revision\n  // Currently will update input count when the button gets pressed past 0.3\n  // Changes from hard shield to light shield should probably count as inputs but\n  // are not counted here\n  if (prevPlayerFrame.physicalLTrigger! < 0.3 && playerFrame.physicalLTrigger! >= 0.3) {\n    state.inputCount += 1;\n    state.triggerInputCount += 1;\n  }\n  if (prevPlayerFrame.physicalRTrigger! < 0.3 && playerFrame.physicalRTrigger! >= 0.3) {\n    state.inputCount += 1;\n    state.triggerInputCount += 1;\n  }\n}\n\nfunction countSetBits(x: number): number {\n  // This function solves the Hamming Weight problem. Effectively it counts the number of\n  // bits in the input that are set to 1\n  // This implementation is supposedly very efficient when most bits are zero.\n  // Found: https://en.wikipedia.org/wiki/Hamming_weight#Efficient_implementation\n  let bits = x;\n\n  let count;\n  for (count = 0; bits; count += 1) {\n    bits &= bits - 1;\n  }\n  return count;\n}\n\nfunction getJoystickRegion(x: number, y: number): JoystickRegion {\n  let region = JoystickRegion.DZ;\n\n  if (x >= 0.2875 && y >= 0.2875) {\n    region = JoystickRegion.NE;\n  } else if (x >= 0.2875 && y <= -0.2875) {\n    region = JoystickRegion.SE;\n  } else if (x <= -0.2875 && y <= -0.2875) {\n    region = JoystickRegion.SW;\n  } else if (x <= -0.2875 && y >= 0.2875) {\n    region = JoystickRegion.NW;\n  } else if (y >= 0.2875) {\n    region = JoystickRegion.N;\n  } else if (x >= 0.2875) {\n    region = JoystickRegion.E;\n  } else if (y <= -0.2875) {\n    region = JoystickRegion.S;\n  } else if (x <= -0.2875) {\n    region = JoystickRegion.W;\n  }\n\n  return region;\n}\n","import { first, flatten, get, groupBy, keyBy, last, mapValues, zip } from \"lodash\";\n\nimport type { GameStartType } from \"../types\";\nimport type { ConversionType, InputCountsType, OverallType, RatioType } from \"./common\";\nimport type { PlayerInput } from \"./inputs\";\n\ninterface ConversionsByPlayerByOpening {\n  [playerIndex: string]: {\n    [openingType: string]: ConversionType[];\n  };\n}\n\nexport function generateOverallStats({\n  settings,\n  inputs,\n  conversions,\n  playableFrameCount,\n}: {\n  settings: GameStartType;\n  inputs: PlayerInput[];\n  conversions: ConversionType[];\n  playableFrameCount: number;\n}): OverallType[] {\n  const inputsByPlayer = keyBy(inputs, \"playerIndex\");\n  const originalConversions = conversions;\n  const conversionsByPlayer = groupBy(conversions, (conv) => conv.moves[0]?.playerIndex);\n  const conversionsByPlayerByOpening: ConversionsByPlayerByOpening = mapValues(conversionsByPlayer, (conversions) =>\n    groupBy(conversions, \"openingType\"),\n  );\n\n  const gameMinutes = playableFrameCount / 3600;\n\n  const overall = settings.players.map((player) => {\n    const playerIndex = player.playerIndex;\n\n    const playerInputs = get(inputsByPlayer, playerIndex) || {};\n    const inputCounts: InputCountsType = {\n      buttons: get(playerInputs, \"buttonInputCount\"),\n      triggers: get(playerInputs, \"triggerInputCount\"),\n      cstick: get(playerInputs, \"cstickInputCount\"),\n      joystick: get(playerInputs, \"joystickInputCount\"),\n      total: get(playerInputs, \"inputCount\"),\n    };\n    // const conversions = get(conversionsByPlayer, playerIndex) || [];\n    // const successfulConversions = conversions.filter((conversion) => conversion.moves.length > 1);\n    let conversionCount = 0;\n    let successfulConversionCount = 0;\n\n    const opponentIndices = settings.players\n      .filter((opp) => {\n        // We want players which aren't ourselves\n        if (opp.playerIndex === playerIndex) {\n          return false;\n        }\n\n        // Make sure they're not on our team either\n        return !settings.isTeams || opp.teamId !== player.teamId;\n      })\n      .map((opp) => opp.playerIndex);\n\n    let totalDamage = 0;\n    let killCount = 0;\n\n    // These are the conversions that we did on our opponents\n    originalConversions\n      // Filter down to conversions of our opponent\n      .filter((conversion) => conversion.playerIndex !== playerIndex)\n      .forEach((conversion) => {\n        conversionCount++;\n\n        // We killed the opponent\n        if (conversion.didKill && conversion.lastHitBy === playerIndex) {\n          killCount += 1;\n        }\n        if (conversion.moves.length > 1 && conversion.moves[0]!.playerIndex === playerIndex) {\n          successfulConversionCount++;\n        }\n        conversion.moves.forEach((move) => {\n          if (move.playerIndex === playerIndex) {\n            totalDamage += move.damage;\n          }\n        });\n      });\n\n    return {\n      playerIndex: playerIndex,\n      inputCounts: inputCounts,\n      conversionCount: conversionCount,\n      totalDamage: totalDamage,\n      killCount: killCount,\n\n      successfulConversions: getRatio(successfulConversionCount, conversionCount),\n      inputsPerMinute: getRatio(inputCounts.total, gameMinutes),\n      digitalInputsPerMinute: getRatio(inputCounts.buttons, gameMinutes),\n      openingsPerKill: getRatio(conversionCount, killCount),\n      damagePerOpening: getRatio(totalDamage, conversionCount),\n      neutralWinRatio: getOpeningRatio(conversionsByPlayerByOpening, playerIndex, opponentIndices, \"neutral-win\"),\n      counterHitRatio: getOpeningRatio(conversionsByPlayerByOpening, playerIndex, opponentIndices, \"counter-attack\"),\n      beneficialTradeRatio: getBeneficialTradeRatio(conversionsByPlayerByOpening, playerIndex, opponentIndices),\n    };\n  });\n\n  return overall;\n}\n\nfunction getRatio(count: number, total: number): RatioType {\n  return {\n    count: count,\n    total: total,\n    ratio: total ? count / total : null,\n  };\n}\n\nfunction getOpeningRatio(\n  conversionsByPlayerByOpening: ConversionsByPlayerByOpening,\n  playerIndex: number,\n  opponentIndices: number[],\n  type: string,\n): RatioType {\n  const openings = get(conversionsByPlayerByOpening, [playerIndex, type]) || [];\n\n  const opponentOpenings = flatten(\n    opponentIndices.map((opponentIndex) => get(conversionsByPlayerByOpening, [opponentIndex, type]) || []),\n  );\n\n  return getRatio(openings.length, openings.length + opponentOpenings.length);\n}\n\nfunction getBeneficialTradeRatio(\n  conversionsByPlayerByOpening: ConversionsByPlayerByOpening,\n  playerIndex: number,\n  opponentIndices: number[],\n): RatioType {\n  const playerTrades = get(conversionsByPlayerByOpening, [playerIndex, \"trade\"]) || [];\n  const opponentTrades = flatten(\n    opponentIndices.map((opponentIndex) => get(conversionsByPlayerByOpening, [opponentIndex, \"trade\"]) || []),\n  );\n\n  const benefitsPlayer = [];\n\n  // Figure out which punishes benefited this player\n  const zippedTrades = zip(playerTrades, opponentTrades);\n  zippedTrades.forEach((conversionPair) => {\n    const playerConversion = first(conversionPair);\n    const opponentConversion = last(conversionPair);\n    if (playerConversion && opponentConversion) {\n      const playerDamage = playerConversion.currentPercent - playerConversion.startPercent;\n      const opponentDamage = opponentConversion.currentPercent - opponentConversion.startPercent;\n\n      if (playerConversion!.didKill && !opponentConversion!.didKill) {\n        benefitsPlayer.push(playerConversion);\n      } else if (playerDamage > opponentDamage) {\n        benefitsPlayer.push(playerConversion);\n      }\n    }\n  });\n\n  return getRatio(benefitsPlayer.length, playerTrades.length);\n}\n","import { get } from \"lodash\";\n\nimport type { FrameEntryType, FramesType, GameStartType } from \"../types\";\nimport { Frames } from \"../types\";\n\nexport interface StatComputer<T> {\n  setup(settings: GameStartType): void;\n  processFrame(newFrame: FrameEntryType, allFrames: FramesType): void;\n  fetch(): T;\n}\n\nexport interface StatOptions {\n  processOnTheFly: boolean;\n}\n\nconst defaultOptions: StatOptions = {\n  processOnTheFly: false,\n};\n\nexport class Stats {\n  private options: StatOptions;\n  private lastProcessedFrame: number | null = null;\n  private frames: FramesType = {};\n  private players: number[] = [];\n  private allComputers = new Array<StatComputer<unknown>>();\n\n  public constructor(options?: StatOptions) {\n    this.options = Object.assign({}, defaultOptions, options);\n  }\n\n  /**\n   * Should reset the frames to their default values.\n   */\n  public setup(settings: GameStartType): void {\n    // Reset the frames since it's a new game\n    this.frames = {};\n    this.players = settings.players.map((v) => v.playerIndex);\n\n    // Forward the settings on to the individual stat computer\n    this.allComputers.forEach((comp) => comp.setup(settings));\n  }\n\n  public register(...computer: StatComputer<unknown>[]): void {\n    this.allComputers.push(...computer);\n  }\n\n  public process(): void {\n    if (this.players.length === 0) {\n      return;\n    }\n\n    let i = this.lastProcessedFrame !== null ? this.lastProcessedFrame + 1 : Frames.FIRST;\n    while (this.frames[i]) {\n      const frame = this.frames[i];\n      // Don't attempt to compute stats on frames that have not been fully received\n      if (!isCompletedFrame(this.players, frame)) {\n        return;\n      }\n      this.allComputers.forEach((comp) => comp.processFrame(frame, this.frames));\n      this.lastProcessedFrame = i;\n      i++;\n    }\n  }\n\n  public addFrame(frame: FrameEntryType): void {\n    this.frames[frame.frame] = frame;\n\n    if (this.options.processOnTheFly) {\n      this.process();\n    }\n  }\n}\n\nfunction isCompletedFrame(players: number[], frame?: FrameEntryType): frame is FrameEntryType {\n  if (!frame) {\n    return false;\n  }\n\n  // This function checks whether we have successfully received an entire frame.\n  // It is not perfect because it does not wait for follower frames. Fortunately,\n  // follower frames are not used for any stat calculations so this doesn't matter\n  // for our purposes.\n  for (const player of players) {\n    const playerPostFrame = get(frame, [\"players\", player, \"post\"]);\n    if (!playerPostFrame) {\n      return false;\n    }\n  }\n\n  return true;\n}\n","import type { FrameEntryType, FramesType, GameStartType } from \"../types\";\nimport type { PlayerIndexedType, StockType } from \"./common\";\nimport { didLoseStock, getSinglesPlayerPermutationsFromSettings, isDead } from \"./common\";\nimport type { StatComputer } from \"./stats\";\n\ninterface StockState {\n  stock?: StockType | null;\n}\n\nexport class StockComputer implements StatComputer<StockType[]> {\n  private state = new Map<PlayerIndexedType, StockState>();\n  private playerPermutations = new Array<PlayerIndexedType>();\n  private stocks = new Array<StockType>();\n\n  public setup(settings: GameStartType): void {\n    // Reset state\n    this.state = new Map();\n    this.playerPermutations = getSinglesPlayerPermutationsFromSettings(settings);\n    this.stocks = [];\n\n    this.playerPermutations.forEach((indices) => {\n      const playerState: StockState = {\n        stock: null,\n      };\n      this.state.set(indices, playerState);\n    });\n  }\n\n  public processFrame(frame: FrameEntryType, allFrames: FramesType): void {\n    this.playerPermutations.forEach((indices) => {\n      const state = this.state.get(indices);\n      if (state) {\n        handleStockCompute(allFrames, state, indices, frame, this.stocks);\n      }\n    });\n  }\n\n  public fetch(): StockType[] {\n    return this.stocks;\n  }\n}\n\nfunction handleStockCompute(\n  frames: FramesType,\n  state: StockState,\n  indices: PlayerIndexedType,\n  frame: FrameEntryType,\n  stocks: StockType[],\n): void {\n  const playerFrame = frame.players[indices.playerIndex]!.post;\n  const currentFrameNumber = playerFrame.frame!;\n  const prevFrameNumber = currentFrameNumber - 1;\n  const prevPlayerFrame = frames[prevFrameNumber] ? frames[prevFrameNumber]!.players[indices.playerIndex]!.post : null;\n\n  // If there is currently no active stock, wait until the player is no longer spawning.\n  // Once the player is no longer spawning, start the stock\n  if (!state.stock) {\n    const isPlayerDead = isDead(playerFrame.actionStateId!);\n    if (isPlayerDead) {\n      return;\n    }\n\n    state.stock = {\n      playerIndex: indices.playerIndex,\n      startFrame: currentFrameNumber,\n      endFrame: null,\n      startPercent: 0,\n      endPercent: null,\n      currentPercent: 0,\n      count: playerFrame.stocksRemaining!,\n      deathAnimation: null,\n    };\n\n    stocks.push(state.stock);\n  } else if (prevPlayerFrame && didLoseStock(playerFrame, prevPlayerFrame)) {\n    state.stock.endFrame = playerFrame.frame;\n    state.stock.endPercent = prevPlayerFrame.percent ?? 0;\n    state.stock.deathAnimation = playerFrame.actionStateId;\n    state.stock = null;\n  } else {\n    state.stock.currentPercent = playerFrame.percent ?? 0;\n  }\n}\n","// Based on https://github.com/wilsonzlin/edgesearch/blob/d03816dd4b18d3d2eb6d08cb1ae14f96f046141d/demo/wiki/client/src/util/util.ts\n\n// Ensures value is not null or undefined.\n// != does no type validation so we don't need to explcitly check for undefined.\nexport function exists<T>(value: T | null | undefined): value is T {\n  return value != null;\n}\n","import type { FrameEntryType, FramesType, GameStartType } from \"../types\";\nimport { Frames, GameMode } from \"../types\";\nimport { exists } from \"../utils/exists\";\nimport type { TargetBreakType } from \"./common\";\nimport type { StatComputer } from \"./stats\";\n\n// The Target item's in-game ID\nconst TARGET_ITEM_TYPE_ID = 209;\n\nexport class TargetBreakComputer implements StatComputer<TargetBreakType[]> {\n  private targetBreaks = new Array<TargetBreakType>();\n  private isTargetTestGame = false;\n\n  public setup(settings: GameStartType): void {\n    // Reset the state\n    this.targetBreaks = [];\n    this.isTargetTestGame = settings.gameMode === GameMode.TARGET_TEST;\n  }\n\n  public processFrame(frame: FrameEntryType, allFrames: FramesType): void {\n    if (!this.isTargetTestGame) {\n      return;\n    }\n\n    handleTargetBreak(allFrames, frame, this.targetBreaks);\n  }\n\n  public fetch(): TargetBreakType[] {\n    return this.targetBreaks;\n  }\n}\n\nfunction handleTargetBreak(frames: FramesType, frame: FrameEntryType, targetBreaks: TargetBreakType[]) {\n  const currentFrameNumber = frame.frame;\n  const prevFrameNumber = currentFrameNumber - 1;\n\n  // Add all targets on the first frame\n  if (currentFrameNumber === Frames.FIRST) {\n    const targets = frames[Frames.FIRST]?.items?.filter((item) => item.typeId === TARGET_ITEM_TYPE_ID) ?? [];\n\n    targets.forEach((target) => {\n      targetBreaks.push({\n        spawnId: target.spawnId as number,\n        frameDestroyed: null,\n        positionX: target.positionX as number,\n        positionY: target.positionY as number,\n      });\n    });\n  }\n\n  const currentTargets = frames[currentFrameNumber]?.items?.filter((item) => item.typeId === TARGET_ITEM_TYPE_ID) ?? [];\n  const previousTargets = frames[prevFrameNumber]?.items?.filter((item) => item.typeId === TARGET_ITEM_TYPE_ID) ?? [];\n\n  const currentTargetIds = currentTargets.map((item) => item.spawnId).filter(exists);\n  const previousTargetIds = previousTargets.map((item) => item.spawnId).filter(exists);\n\n  // Check if any targets were destroyed\n  const brokenTargetIds = previousTargetIds.filter((id) => !currentTargetIds.includes(id));\n  brokenTargetIds.forEach((id) => {\n    // Update the target break\n    const targetBreak = targetBreaks.find((targetBreak) => targetBreak.spawnId === id);\n    if (targetBreak) {\n      targetBreak.frameDestroyed = currentFrameNumber;\n    }\n  });\n}\n","import { format } from \"date-fns\";\n\nimport type { GameStartType } from \"../types\";\nimport { TimerType } from \"../types\";\nimport { exists } from \"./exists\";\n\nexport function frameToGameTimer(\n  frame: number,\n  options: Pick<GameStartType, \"timerType\" | \"startingTimerSeconds\">,\n): string {\n  const { timerType, startingTimerSeconds } = options;\n\n  if (timerType === TimerType.DECREASING) {\n    if (!exists(startingTimerSeconds)) {\n      return \"Unknown\";\n    }\n    const centiseconds = Math.ceil((((60 - (frame % 60)) % 60) * 99) / 59);\n    const date = new Date(0, 0, 0, 0, 0, startingTimerSeconds - frame / 60, centiseconds * 10);\n    return format(date, \"mm:ss.SS\");\n  }\n\n  if (timerType === TimerType.INCREASING) {\n    const centiseconds = Math.floor(((frame % 60) * 99) / 59);\n    const date = new Date(0, 0, 0, 0, 0, frame / 60, centiseconds * 10);\n    return format(date, \"mm:ss.SS\");\n  }\n\n  return \"Infinite\";\n}\n","import { decode, encode } from \"@shelacek/ubjson\";\n\nexport enum CommunicationType {\n  HANDSHAKE = 1,\n  REPLAY = 2,\n  KEEP_ALIVE = 3,\n}\n\nexport interface CommunicationMessage {\n  type: CommunicationType;\n  payload: {\n    cursor: Uint8Array;\n    clientToken: Uint8Array;\n    pos: Uint8Array;\n    nextPos: Uint8Array;\n    data: Uint8Array;\n    nick: string | null;\n    forcePos: boolean;\n    nintendontVersion: string | null;\n  };\n}\n\n// This class is responsible for handling the communication protocol between the Wii and the\n// desktop app\nexport class ConsoleCommunication {\n  private receiveBuf = Buffer.from([]);\n  private messages = new Array<CommunicationMessage>();\n\n  public receive(data: Buffer): void {\n    this.receiveBuf = Buffer.concat([this.receiveBuf, data]);\n\n    while (this.receiveBuf.length >= 4) {\n      // First get the size of the message we are expecting\n      const msgSize = this.receiveBuf.readUInt32BE(0);\n\n      if (this.receiveBuf.length < msgSize + 4) {\n        // If we haven't received all the data yet, let's wait for more\n        return;\n      }\n\n      // Here we have received all the data, so let's decode it\n      const ubjsonData = this.receiveBuf.slice(4, msgSize + 4);\n      this.messages.push(decode(ubjsonData));\n\n      // Remove the processed data from receiveBuf\n      this.receiveBuf = this.receiveBuf.slice(msgSize + 4);\n    }\n  }\n\n  public getReceiveBuffer(): Buffer {\n    return this.receiveBuf;\n  }\n\n  public getMessages(): Array<CommunicationMessage> {\n    const toReturn = this.messages;\n    this.messages = [];\n\n    return toReturn;\n  }\n\n  public genHandshakeOut(cursor: Uint8Array, clientToken: number, isRealtime = false): Buffer {\n    const clientTokenBuf = Buffer.from([0, 0, 0, 0]);\n    clientTokenBuf.writeUInt32BE(clientToken, 0);\n\n    const message = {\n      type: CommunicationType.HANDSHAKE,\n      payload: {\n        cursor: cursor,\n        clientToken: Uint8Array.from(clientTokenBuf), // TODO: Use real instance token\n        isRealtime: isRealtime,\n      },\n    };\n\n    const buf = encode(message, {\n      optimizeArrays: true,\n    });\n\n    const msg = Buffer.concat([Buffer.from([0, 0, 0, 0]), Buffer.from(buf)]);\n\n    msg.writeUInt32BE(buf.byteLength, 0);\n\n    return msg;\n  }\n}\n","import type { EventEmitter } from \"events\";\n\nexport enum ConnectionEvent {\n  CONNECT = \"connect\",\n  MESSAGE = \"message\",\n  HANDSHAKE = \"handshake\",\n  STATUS_CHANGE = \"statusChange\",\n  DATA = \"data\",\n  ERROR = \"error\",\n}\n\nexport enum ConnectionStatus {\n  DISCONNECTED = 0,\n  CONNECTING = 1,\n  CONNECTED = 2,\n  RECONNECT_WAIT = 3,\n}\n\nexport enum Ports {\n  DEFAULT = 51441,\n  LEGACY = 666,\n  RELAY_START = 53741,\n}\n\nexport interface ConnectionDetails {\n  consoleNick: string;\n  gameDataCursor: number | Uint8Array;\n  version: string;\n  clientToken?: number;\n}\n\nexport interface ConnectionSettings {\n  ipAddress: string;\n  port: number;\n}\n\nexport interface Connection extends EventEmitter {\n  getStatus(): ConnectionStatus;\n  getSettings(): ConnectionSettings;\n  getDetails(): ConnectionDetails;\n  connect(ip: string, port: number): void;\n  disconnect(): void;\n}\n","import { EventEmitter } from \"events\";\nimport net from \"net\";\nimport inject from \"reconnect-core\";\n\nimport type { CommunicationMessage } from \"./communication\";\nimport { CommunicationType, ConsoleCommunication } from \"./communication\";\nimport type { Connection, ConnectionDetails, ConnectionSettings } from \"./types\";\nimport { ConnectionEvent, ConnectionStatus, Ports } from \"./types\";\n\nexport const NETWORK_MESSAGE = \"HELO\\0\";\n\nconst DEFAULT_CONNECTION_TIMEOUT_MS = 20000;\n\nenum CommunicationState {\n  INITIAL = \"initial\",\n  LEGACY = \"legacy\",\n  NORMAL = \"normal\",\n}\n\nconst defaultConnectionDetails: ConnectionDetails = {\n  consoleNick: \"unknown\",\n  gameDataCursor: Uint8Array.from([0, 0, 0, 0, 0, 0, 0, 0]),\n  version: \"\",\n  clientToken: 0,\n};\n\nconst consoleConnectionOptions = {\n  autoReconnect: true,\n};\n\nexport type ConsoleConnectionOptions = typeof consoleConnectionOptions;\n\n/**\n * Responsible for maintaining connection to a Slippi relay connection or Wii connection.\n * Events are emitted whenever data is received.\n *\n * Basic usage example:\n *\n * ```javascript\n * const { ConsoleConnection } = require(\"@slippi/slippi-js\");\n *\n * const connection = new ConsoleConnection();\n * connection.connect(\"localhost\", 667); // You should set these values appropriately\n *\n * connection.on(\"data\", (data) => {\n *   // Received data from console\n *   console.log(data);\n * });\n *\n * connection.on(\"statusChange\", (status) => {\n *   console.log(`status changed: ${status}`);\n * });\n * ```\n */\nexport class ConsoleConnection extends EventEmitter implements Connection {\n  private ipAddress: string;\n  private port: number;\n  private isRealtime: boolean;\n  private connectionStatus = ConnectionStatus.DISCONNECTED;\n  private connDetails: ConnectionDetails = { ...defaultConnectionDetails };\n  private client: net.Socket | null = null;\n  private connection: inject.Instance<unknown, net.Socket> | null = null;\n  private options: ConsoleConnectionOptions;\n  private shouldReconnect = false;\n\n  public constructor(options?: Partial<ConsoleConnectionOptions>) {\n    super();\n    this.ipAddress = \"0.0.0.0\";\n    this.port = Ports.DEFAULT;\n    this.isRealtime = false;\n    this.options = Object.assign({}, consoleConnectionOptions, options);\n  }\n\n  /**\n   * @returns The current connection status.\n   */\n  public getStatus(): ConnectionStatus {\n    return this.connectionStatus;\n  }\n\n  /**\n   * @returns The IP address and port of the current connection.\n   */\n  public getSettings(): ConnectionSettings {\n    return {\n      ipAddress: this.ipAddress,\n      port: this.port,\n    };\n  }\n\n  /**\n   * @returns The specific details about the connected console.\n   */\n  public getDetails(): ConnectionDetails {\n    return { ...this.connDetails };\n  }\n\n  /**\n   * Initiate a connection to the Wii or Slippi relay.\n   * @param ip   The IP address of the Wii or Slippi relay.\n   * @param port The port to connect to.\n   * @param isRealtime Optional. A flag to tell the Wii to send data as quickly as possible\n   * @param timeout Optional. The timeout in milliseconds when attempting to connect\n   *                to the Wii or relay.\n   */\n  public connect(ip: string, port: number, isRealtime = false, timeout = DEFAULT_CONNECTION_TIMEOUT_MS): void {\n    this.ipAddress = ip;\n    this.port = port;\n    this.isRealtime = isRealtime;\n    this._connectOnPort(ip, port, timeout);\n  }\n\n  private _connectOnPort(ip: string, port: number, timeout: number): void {\n    // set up reconnect\n    const reconnect = inject(() =>\n      net.connect({\n        host: ip,\n        port: port,\n        timeout: timeout,\n      }),\n    );\n\n    // Indicate we are connecting\n    this._setStatus(ConnectionStatus.CONNECTING);\n\n    // Prepare console communication obj for talking UBJSON\n    const consoleComms = new ConsoleCommunication();\n\n    // TODO: reconnect on failed reconnect, not sure how\n    // TODO: to do this\n    const connection = reconnect(\n      {\n        initialDelay: 2000,\n        maxDelay: 10000,\n        strategy: \"fibonacci\",\n        failAfter: Infinity,\n      },\n      (client) => {\n        this.emit(ConnectionEvent.CONNECT);\n        // We successfully connected so turn on auto-reconnect\n        this.shouldReconnect = this.options.autoReconnect;\n        this.client = client;\n\n        let commState: CommunicationState = CommunicationState.INITIAL;\n        client.on(\"data\", (data) => {\n          if (commState === CommunicationState.INITIAL) {\n            commState = this._getInitialCommState(data);\n            console.log(`Connected to ${ip}:${port} with type: ${commState}`);\n            this._setStatus(ConnectionStatus.CONNECTED);\n            console.log(data.toString(\"hex\"));\n          }\n\n          if (commState === CommunicationState.LEGACY) {\n            // If the first message received was not a handshake message, either we\n            // connected to an old Nintendont version or a relay instance\n            this._handleReplayData(data);\n            return;\n          }\n\n          try {\n            consoleComms.receive(data);\n          } catch (err) {\n            console.error(\"Failed to process new data from server...\", {\n              error: err,\n              prevDataBuf: consoleComms.getReceiveBuffer(),\n              rcvData: data,\n            });\n            client.destroy();\n            this.emit(ConnectionEvent.ERROR, err);\n            return;\n          }\n          const messages = consoleComms.getMessages();\n\n          // Process all of the received messages\n          try {\n            messages.forEach((message) => this._processMessage(message));\n          } catch (err) {\n            // Disconnect client to send another handshake message\n            console.error(err);\n            client.destroy();\n            this.emit(ConnectionEvent.ERROR, err);\n          }\n        });\n\n        client.on(\"timeout\", () => {\n          // const previouslyConnected = this.connectionStatus === ConnectionStatus.CONNECTED;\n          console.warn(`Attempted connection to ${ip}:${port} timed out after ${timeout}ms`);\n          client.destroy();\n        });\n\n        client.on(\"end\", () => {\n          console.log(\"disconnect\");\n          if (!this.shouldReconnect) {\n            client.destroy();\n          }\n        });\n\n        client.on(\"close\", () => {\n          console.log(\"connection was closed\");\n        });\n\n        const handshakeMsgOut = consoleComms.genHandshakeOut(\n          this.connDetails.gameDataCursor as Uint8Array,\n          this.connDetails.clientToken ?? 0,\n          this.isRealtime,\n        );\n\n        client.write(handshakeMsgOut);\n      },\n    );\n\n    const setConnectingStatus = (): void => {\n      // Indicate we are connecting\n      this._setStatus(this.shouldReconnect ? ConnectionStatus.RECONNECT_WAIT : ConnectionStatus.CONNECTING);\n    };\n\n    connection.on(\"connect\", setConnectingStatus);\n    connection.on(\"reconnect\", setConnectingStatus);\n\n    connection.on(\"disconnect\", () => {\n      if (!this.shouldReconnect) {\n        connection.reconnect = false;\n        connection.disconnect();\n        this._setStatus(ConnectionStatus.DISCONNECTED);\n      }\n      // TODO: Figure out how to set RECONNECT_WAIT state here. Currently it will stay on\n      // TODO: Connecting... forever\n    });\n\n    connection.on(\"error\", (err) => {\n      console.warn(`Connection on port ${port} encountered an error.`, err);\n\n      this._setStatus(ConnectionStatus.DISCONNECTED);\n      this.emit(ConnectionEvent.ERROR, `Connection on port ${port} encountered an error.\\n${err}`);\n    });\n\n    this.connection = connection;\n    connection.connect(port);\n  }\n\n  /**\n   * Terminate the current connection.\n   */\n  public disconnect(): void {\n    // Prevent reconnections and disconnect\n    if (this.connection) {\n      this.connection.reconnect = false;\n      this.connection.disconnect();\n      this.connection = null;\n    }\n\n    if (this.client) {\n      this.client.destroy();\n    }\n  }\n\n  private _getInitialCommState(data: Buffer): CommunicationState {\n    if (data.length < 13) {\n      return CommunicationState.LEGACY;\n    }\n\n    const openingBytes = Buffer.from([0x7b, 0x69, 0x04, 0x74, 0x79, 0x70, 0x65, 0x55, 0x01]);\n\n    const dataStart = data.slice(4, 13);\n\n    return dataStart.equals(openingBytes) ? CommunicationState.NORMAL : CommunicationState.LEGACY;\n  }\n\n  private _processMessage(message: CommunicationMessage): void {\n    this.emit(ConnectionEvent.MESSAGE, message);\n    switch (message.type) {\n      case CommunicationType.KEEP_ALIVE:\n        // console.log(\"Keep alive message received\");\n\n        // TODO: This is the jankiest shit ever but it will allow for relay connections not\n        // TODO: to time out as long as the main connection is still receving keep alive messages\n        // TODO: Need to figure out a better solution for this. There should be no need to have an\n        // TODO: active Wii connection for the relay connection to keep itself alive\n        const fakeKeepAlive = Buffer.from(NETWORK_MESSAGE);\n        this._handleReplayData(fakeKeepAlive);\n\n        break;\n      case CommunicationType.REPLAY:\n        const readPos = Uint8Array.from(message.payload.pos);\n        const cmp = Buffer.compare(this.connDetails.gameDataCursor as Uint8Array, readPos);\n        if (!message.payload.forcePos && cmp !== 0) {\n          // The readPos is not the one we are waiting on, throw error\n          throw new Error(\n            `Position of received data is incorrect. Expected: ${this.connDetails.gameDataCursor.toString()}, Received: ${readPos.toString()}`,\n          );\n        }\n\n        if (message.payload.forcePos) {\n          console.warn(\n            \"Overflow occured in Nintendont, data has likely been skipped and replay corrupted. \" +\n              \"Expected, Received:\",\n            this.connDetails.gameDataCursor,\n            readPos,\n          );\n        }\n\n        this.connDetails.gameDataCursor = Uint8Array.from(message.payload.nextPos);\n\n        const data = Uint8Array.from(message.payload.data);\n        this._handleReplayData(data);\n        break;\n      case CommunicationType.HANDSHAKE:\n        const { nick, nintendontVersion } = message.payload;\n        if (nick) {\n          this.connDetails.consoleNick = nick;\n        }\n        const tokenBuf = Buffer.from(message.payload.clientToken);\n        this.connDetails.clientToken = tokenBuf.readUInt32BE(0);\n        if (nintendontVersion) {\n          this.connDetails.version = nintendontVersion;\n        }\n        this.connDetails.gameDataCursor = Uint8Array.from(message.payload.pos);\n        this.emit(ConnectionEvent.HANDSHAKE, this.connDetails);\n        break;\n      default:\n        // Should this be an error?\n        break;\n    }\n  }\n\n  private _handleReplayData(data: Uint8Array): void {\n    this.emit(ConnectionEvent.DATA, data);\n  }\n\n  private _setStatus(status: ConnectionStatus): void {\n    // Don't fire the event if the status hasn't actually changed\n    if (this.connectionStatus !== status) {\n      this.connectionStatus = status;\n      this.emit(ConnectionEvent.STATUS_CHANGE, this.connectionStatus);\n    }\n  }\n}\n","import { EventEmitter } from \"events\";\n\nimport type { Connection, ConnectionDetails, ConnectionSettings } from \"./types\";\nimport { ConnectionEvent, ConnectionStatus, Ports } from \"./types\";\n\nconst MAX_PEERS = 32;\n\nexport enum DolphinMessageType {\n  CONNECT_REPLY = \"connect_reply\",\n  GAME_EVENT = \"game_event\",\n  START_GAME = \"start_game\",\n  END_GAME = \"end_game\",\n}\n\nexport class DolphinConnection extends EventEmitter implements Connection {\n  private ipAddress: string;\n  private port: number;\n  private connectionStatus = ConnectionStatus.DISCONNECTED;\n  private gameCursor = 0;\n  private nickname = \"unknown\";\n  private version = \"\";\n  private peer: any | null = null;\n\n  public constructor() {\n    super();\n    this.ipAddress = \"0.0.0.0\";\n    this.port = Ports.DEFAULT;\n  }\n\n  /**\n   * @returns The current connection status.\n   */\n  public getStatus(): ConnectionStatus {\n    return this.connectionStatus;\n  }\n\n  /**\n   * @returns The IP address and port of the current connection.\n   */\n  public getSettings(): ConnectionSettings {\n    return {\n      ipAddress: this.ipAddress,\n      port: this.port,\n    };\n  }\n\n  public getDetails(): ConnectionDetails {\n    return {\n      consoleNick: this.nickname,\n      gameDataCursor: this.gameCursor,\n      version: this.version,\n    };\n  }\n\n  public async connect(ip: string, port: number): Promise<void> {\n    console.log(`Connecting to: ${ip}:${port}`);\n    this.ipAddress = ip;\n    this.port = port;\n\n    const enet = await import(\"enet\");\n    // Create the enet client\n    const client = enet.createClient({ peers: MAX_PEERS, channels: 3, down: 0, up: 0 }, (err) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n    });\n\n    this.peer = client.connect(\n      {\n        address: this.ipAddress,\n        port: this.port,\n      },\n      3,\n      1337, // Data to send, not sure what this is or what this represents\n      (err: any, newPeer: any) => {\n        if (err) {\n          console.error(err);\n          return;\n        }\n\n        newPeer.ping();\n        this.emit(ConnectionEvent.CONNECT);\n        this._setStatus(ConnectionStatus.CONNECTED);\n      },\n    );\n\n    this.peer.on(\"connect\", () => {\n      // Reset the game cursor to the beginning of the game. Do we need to do this or\n      // should it just continue from where it left off?\n      this.gameCursor = 0;\n\n      const request = {\n        type: \"connect_request\",\n        cursor: this.gameCursor,\n      };\n      const packet = new enet.Packet(JSON.stringify(request), enet.PACKET_FLAG.RELIABLE);\n      this.peer.send(0, packet);\n    });\n\n    this.peer.on(\"message\", (packet: any) => {\n      const data = packet.data();\n      if (data.length === 0) {\n        return;\n      }\n\n      const dataString = data.toString(\"ascii\");\n      const message = JSON.parse(dataString);\n      const { dolphin_closed } = message;\n      if (dolphin_closed) {\n        // We got a disconnection request\n        this.disconnect();\n        return;\n      }\n      this.emit(ConnectionEvent.MESSAGE, message);\n      switch (message.type) {\n        case DolphinMessageType.CONNECT_REPLY:\n          this.connectionStatus = ConnectionStatus.CONNECTED;\n          this.gameCursor = message.cursor;\n          this.nickname = message.nick;\n          this.version = message.version;\n          this.emit(ConnectionEvent.HANDSHAKE, this.getDetails());\n          break;\n        case DolphinMessageType.GAME_EVENT: {\n          const { payload } = message;\n          //TODO: remove after game start and end messages have been in stable Ishii for a bit\n          if (!payload) {\n            // We got a disconnection request\n            this.disconnect();\n            return;\n          }\n\n          this._updateCursor(message, dataString);\n\n          const gameData = Buffer.from(payload, \"base64\");\n          this._handleReplayData(gameData);\n          break;\n        }\n        case DolphinMessageType.START_GAME: {\n          this._updateCursor(message, dataString);\n          break;\n        }\n        case DolphinMessageType.END_GAME: {\n          this._updateCursor(message, dataString);\n          break;\n        }\n      }\n    });\n\n    this.peer.on(\"disconnect\", () => {\n      this.disconnect();\n    });\n\n    this._setStatus(ConnectionStatus.CONNECTING);\n  }\n\n  public disconnect(): void {\n    if (this.peer) {\n      this.peer.disconnect();\n      this.peer = null;\n    }\n    this._setStatus(ConnectionStatus.DISCONNECTED);\n  }\n\n  private _handleReplayData(data: Uint8Array): void {\n    this.emit(ConnectionEvent.DATA, data);\n  }\n\n  private _setStatus(status: ConnectionStatus): void {\n    // Don't fire the event if the status hasn't actually changed\n    if (this.connectionStatus !== status) {\n      this.connectionStatus = status;\n      this.emit(ConnectionEvent.STATUS_CHANGE, this.connectionStatus);\n    }\n  }\n\n  private _updateCursor(message: { cursor: number; next_cursor: number }, dataString: string): void {\n    const { cursor, next_cursor } = message;\n\n    if (this.gameCursor !== cursor) {\n      const err = new Error(\n        `Unexpected game data cursor. Expected: ${this.gameCursor} but got: ${cursor}. Payload: ${dataString}`,\n      );\n      console.warn(err);\n      this.emit(ConnectionEvent.ERROR, err);\n    }\n\n    this.gameCursor = next_cursor;\n  }\n}\n","import { map } from \"lodash\";\n\nexport function toHalfwidth(str: string): string {\n  // Converts a fullwidth character to halfwidth\n  const convertChar = (charCode: number): number => {\n    /**\n     * Standard full width encodings\n     * https://en.wikipedia.org/wiki/Halfwidth_and_Fullwidth_Forms_(Unicode_block)\n     */\n    if (charCode > 0xff00 && charCode < 0xff5f) {\n      return 0x0020 + (charCode - 0xff00);\n    }\n\n    // space:\n    if (charCode === 0x3000) {\n      return 0x0020;\n    }\n\n    /**\n     * Exceptions found in Melee/Japanese keyboards\n     */\n    // single quote: '\n    if (charCode === 0x2019) {\n      return 0x0027;\n    }\n\n    // double quote: \"\n    if (charCode === 0x201d) {\n      return 0x0022;\n    }\n\n    return charCode;\n  };\n\n  const ret = map(str, (char) => convertChar(char.charCodeAt(0)));\n\n  return String.fromCharCode(...ret);\n}\n","import { decode } from \"@shelacek/ubjson\";\nimport fs from \"fs\";\nimport iconv from \"iconv-lite\";\nimport { mapValues } from \"lodash\";\n\nimport type {\n  EventCallbackFunc,\n  EventPayloadTypes,\n  GameEndType,\n  GameInfoType,\n  GeckoCodeType,\n  MetadataType,\n  PlacementType,\n  PlayerType,\n  PostFrameUpdateType,\n  SelfInducedSpeedsType,\n} from \"../types\";\nimport { Command } from \"../types\";\nimport { exists } from \"./exists\";\nimport { toHalfwidth } from \"./fullwidth\";\n\nexport enum SlpInputSource {\n  BUFFER = \"buffer\",\n  FILE = \"file\",\n}\n\nexport interface SlpReadInput {\n  source: SlpInputSource;\n  filePath?: string;\n  buffer?: Buffer;\n}\n\nexport type SlpRefType = SlpFileSourceRef | SlpBufferSourceRef;\n\nexport interface SlpFileType {\n  ref: SlpRefType;\n  rawDataPosition: number;\n  rawDataLength: number;\n  metadataPosition: number;\n  metadataLength: number;\n  messageSizes: {\n    [command: number]: number;\n  };\n}\n\nexport interface SlpFileSourceRef {\n  source: SlpInputSource;\n  fileDescriptor: number;\n}\n\nexport interface SlpBufferSourceRef {\n  source: SlpInputSource;\n  buffer: Buffer;\n}\n\nfunction getRef(input: SlpReadInput): SlpRefType {\n  switch (input.source) {\n    case SlpInputSource.FILE:\n      if (!input.filePath) {\n        throw new Error(\"File source requires a file path\");\n      }\n      const fd = fs.openSync(input.filePath, \"r\");\n      return {\n        source: input.source,\n        fileDescriptor: fd,\n      } as SlpFileSourceRef;\n    case SlpInputSource.BUFFER:\n      return {\n        source: input.source,\n        buffer: input.buffer,\n      } as SlpBufferSourceRef;\n    default:\n      throw new Error(\"Source type not supported\");\n  }\n}\n\nfunction readRef(ref: SlpRefType, buffer: Uint8Array, offset: number, length: number, position: number): number {\n  switch (ref.source) {\n    case SlpInputSource.FILE:\n      return fs.readSync((ref as SlpFileSourceRef).fileDescriptor, buffer, offset, length, position);\n    case SlpInputSource.BUFFER:\n      return (ref as SlpBufferSourceRef).buffer.copy(buffer, offset, position, position + length);\n    default:\n      throw new Error(\"Source type not supported\");\n  }\n}\n\nfunction getLenRef(ref: SlpRefType): number {\n  switch (ref.source) {\n    case SlpInputSource.FILE:\n      const fileStats = fs.fstatSync((ref as SlpFileSourceRef).fileDescriptor);\n      return fileStats.size;\n    case SlpInputSource.BUFFER:\n      return (ref as SlpBufferSourceRef).buffer.length;\n    default:\n      throw new Error(\"Source type not supported\");\n  }\n}\n\n/**\n * Opens a file at path\n */\nexport function openSlpFile(input: SlpReadInput): SlpFileType {\n  const ref = getRef(input);\n\n  const rawDataPosition = getRawDataPosition(ref);\n  const rawDataLength = getRawDataLength(ref, rawDataPosition);\n  const metadataPosition = rawDataPosition + rawDataLength + 10; // remove metadata string\n  const metadataLength = getMetadataLength(ref, metadataPosition);\n  const messageSizes = getMessageSizes(ref, rawDataPosition);\n\n  return {\n    ref,\n    rawDataPosition,\n    rawDataLength,\n    metadataPosition,\n    metadataLength,\n    messageSizes,\n  };\n}\n\nexport function closeSlpFile(file: SlpFileType): void {\n  switch (file.ref.source) {\n    case SlpInputSource.FILE:\n      fs.closeSync((file.ref as SlpFileSourceRef).fileDescriptor);\n      break;\n  }\n}\n\n// This function gets the position where the raw data starts\nfunction getRawDataPosition(ref: SlpRefType): number {\n  const buffer = new Uint8Array(1);\n  readRef(ref, buffer, 0, buffer.length, 0);\n\n  if (buffer[0] === 0x36) {\n    return 0;\n  }\n\n  if (buffer[0] !== \"{\".charCodeAt(0)) {\n    return 0; // return error?\n  }\n\n  return 15;\n}\n\nfunction getRawDataLength(ref: SlpRefType, position: number): number {\n  const fileSize = getLenRef(ref);\n  if (position === 0) {\n    return fileSize;\n  }\n\n  const buffer = new Uint8Array(4);\n  readRef(ref, buffer, 0, buffer.length, position - 4);\n\n  const rawDataLen = (buffer[0]! << 24) | (buffer[1]! << 16) | (buffer[2]! << 8) | buffer[3]!;\n  if (rawDataLen > 0) {\n    // If this method manages to read a number, it's probably trustworthy\n    return rawDataLen;\n  }\n\n  // If the above does not return a valid data length,\n  // return a file size based on file length. This enables\n  // some support for severed files\n  return fileSize - position;\n}\n\nfunction getMetadataLength(ref: SlpRefType, position: number): number {\n  const len = getLenRef(ref);\n  return len - position - 1;\n}\n\nfunction getMessageSizes(\n  ref: SlpRefType,\n  position: number,\n): {\n  [command: number]: number;\n} {\n  const messageSizes: {\n    [command: number]: number;\n  } = {};\n  // Support old file format\n  if (position === 0) {\n    messageSizes[0x36] = 0x140;\n    messageSizes[0x37] = 0x6;\n    messageSizes[0x38] = 0x46;\n    messageSizes[0x39] = 0x1;\n    return messageSizes;\n  }\n\n  const buffer = new Uint8Array(2);\n  readRef(ref, buffer, 0, buffer.length, position);\n  if (buffer[0] !== Command.MESSAGE_SIZES) {\n    return {};\n  }\n\n  const payloadLength = buffer[1] as number;\n  (messageSizes[0x35] as any) = payloadLength;\n\n  const messageSizesBuffer = new Uint8Array(payloadLength - 1);\n  readRef(ref, messageSizesBuffer, 0, messageSizesBuffer.length, position + 2);\n  for (let i = 0; i < payloadLength - 1; i += 3) {\n    const command = messageSizesBuffer[i] as number;\n\n    // Get size of command\n    (messageSizes[command] as any) = (messageSizesBuffer[i + 1]! << 8) | messageSizesBuffer[i + 2]!;\n  }\n\n  return messageSizes;\n}\n\nfunction getEnabledItems(view: DataView): number {\n  const offsets = [0x1, 0x100, 0x10000, 0x1000000, 0x100000000];\n  const enabledItems = offsets.reduce((acc, byteOffset, index) => {\n    const byte = readUint8(view, 0x28 + index) as number;\n    return acc + byte * byteOffset;\n  }, 0);\n\n  return enabledItems;\n}\n\nfunction getGameInfoBlock(view: DataView): GameInfoType {\n  const offset = 0x5;\n\n  return {\n    gameBitfield1: readUint8(view, 0x0 + offset),\n    gameBitfield2: readUint8(view, 0x1 + offset),\n    gameBitfield3: readUint8(view, 0x2 + offset),\n    gameBitfield4: readUint8(view, 0x3 + offset),\n    bombRainEnabled: (readUint8(view, 0x6 + offset)! & 0xff) > 0 ? true : false,\n    itemSpawnBehavior: readInt8(view, 0xb + offset),\n    selfDestructScoreValue: readInt8(view, 0xc + offset),\n    //stageId: readUint16(view, 0xe + offset),\n    //gameTimer: readUint32(view, 0x10 + offset),\n    itemSpawnBitfield1: readUint8(view, 0x23 + offset),\n    itemSpawnBitfield2: readUint8(view, 0x24 + offset),\n    itemSpawnBitfield3: readUint8(view, 0x25 + offset),\n    itemSpawnBitfield4: readUint8(view, 0x26 + offset),\n    itemSpawnBitfield5: readUint8(view, 0x27 + offset),\n    damageRatio: readFloat(view, 0x30 + offset),\n  } as GameInfoType;\n}\n\n/**\n * Iterates through slp events and parses payloads\n */\nexport function iterateEvents(\n  slpFile: SlpFileType,\n  callback: EventCallbackFunc,\n  startPos: number | null = null,\n): number {\n  const ref = slpFile.ref;\n\n  let readPosition = startPos !== null && startPos > 0 ? startPos : slpFile.rawDataPosition;\n  const stopReadingAt = slpFile.rawDataPosition + slpFile.rawDataLength;\n\n  // Generate read buffers for each\n  const commandPayloadBuffers = mapValues(slpFile.messageSizes, (size) => new Uint8Array(size + 1));\n  let splitMessageBuffer = new Uint8Array(0);\n\n  const commandByteBuffer = new Uint8Array(1);\n  while (readPosition < stopReadingAt) {\n    readRef(ref, commandByteBuffer, 0, 1, readPosition);\n    let commandByte = (commandByteBuffer[0] as number) ?? 0;\n    let buffer = commandPayloadBuffers[commandByte];\n    if (buffer === undefined) {\n      // If we don't have an entry for this command, return false to indicate failed read\n      return readPosition;\n    }\n\n    if (buffer.length > stopReadingAt - readPosition) {\n      return readPosition;\n    }\n\n    const advanceAmount = buffer.length;\n\n    readRef(ref, buffer, 0, buffer.length, readPosition);\n    if (commandByte === Command.SPLIT_MESSAGE) {\n      // Here we have a split message, we will collect data from them until the last\n      // message of the list is received\n      const view = new DataView(buffer.buffer);\n      const size = readUint16(view, 0x201) ?? 512;\n      const isLastMessage = readBool(view, 0x204);\n      const internalCommand = readUint8(view, 0x203) ?? 0;\n\n      // If this is the first message, initialize the splitMessageBuffer\n      // with the internal command byte because our parseMessage function\n      // seems to expect a command byte at the start\n      if (splitMessageBuffer.length === 0) {\n        splitMessageBuffer = new Uint8Array(1);\n        splitMessageBuffer[0] = internalCommand;\n      }\n\n      // Collect new data into splitMessageBuffer\n      const appendBuf = buffer.slice(0x1, 0x1 + size);\n      const mergedBuf = new Uint8Array(splitMessageBuffer.length + appendBuf.length);\n      mergedBuf.set(splitMessageBuffer);\n      mergedBuf.set(appendBuf, splitMessageBuffer.length);\n      splitMessageBuffer = mergedBuf;\n\n      if (isLastMessage) {\n        commandByte = splitMessageBuffer[0] ?? 0;\n        buffer = splitMessageBuffer;\n        splitMessageBuffer = new Uint8Array(0);\n      }\n    }\n\n    const parsedPayload = parseMessage(commandByte, buffer);\n    const shouldStop = callback(commandByte, parsedPayload, buffer);\n    if (shouldStop) {\n      break;\n    }\n\n    readPosition += advanceAmount;\n  }\n\n  return readPosition;\n}\n\nexport function parseMessage(command: Command, payload: Uint8Array): EventPayloadTypes | null {\n  const view = new DataView(payload.buffer);\n  switch (command) {\n    case Command.GAME_START:\n      const getPlayerObject = (playerIndex: number): PlayerType => {\n        // Controller Fix stuff\n        const cfOffset = playerIndex * 0x8;\n        const dashback = readUint32(view, 0x141 + cfOffset);\n        const shieldDrop = readUint32(view, 0x145 + cfOffset);\n        let controllerFix = \"None\";\n        if (dashback !== shieldDrop) {\n          controllerFix = \"Mixed\";\n        } else if (dashback === 1) {\n          controllerFix = \"UCF\";\n        } else if (dashback === 2) {\n          controllerFix = \"Dween\";\n        }\n\n        // Nametag stuff\n        const nametagLength = 0x10;\n        const nametagOffset = playerIndex * nametagLength;\n        const nametagStart = 0x161 + nametagOffset;\n        const nametagBuf = payload.slice(nametagStart, nametagStart + nametagLength);\n        const nameTagString = iconv\n          .decode(nametagBuf as Buffer, \"Shift_JIS\")\n          .split(\"\\0\")\n          .shift();\n        const nametag = nameTagString ? toHalfwidth(nameTagString) : \"\";\n\n        // Display name\n        const displayNameLength = 0x1f;\n        const displayNameOffset = playerIndex * displayNameLength;\n        const displayNameStart = 0x1a5 + displayNameOffset;\n        const displayNameBuf = payload.slice(displayNameStart, displayNameStart + displayNameLength);\n        const displayNameString = iconv\n          .decode(displayNameBuf as Buffer, \"Shift_JIS\")\n          .split(\"\\0\")\n          .shift();\n        const displayName = displayNameString ? toHalfwidth(displayNameString) : \"\";\n\n        // Connect code\n        const connectCodeLength = 0xa;\n        const connectCodeOffset = playerIndex * connectCodeLength;\n        const connectCodeStart = 0x221 + connectCodeOffset;\n        const connectCodeBuf = payload.slice(connectCodeStart, connectCodeStart + connectCodeLength);\n        const connectCodeString = iconv\n          .decode(connectCodeBuf as Buffer, \"Shift_JIS\")\n          .split(\"\\0\")\n          .shift();\n        const connectCode = connectCodeString ? toHalfwidth(connectCodeString) : \"\";\n\n        const userIdLength = 0x1d;\n        const userIdOffset = playerIndex * userIdLength;\n        const userIdStart = 0x249 + userIdOffset;\n        const userIdBuf = payload.slice(userIdStart, userIdStart + userIdLength);\n        const userIdString = iconv\n          .decode(userIdBuf as Buffer, \"utf8\")\n          .split(\"\\0\")\n          .shift();\n        const userId = userIdString ?? \"\";\n\n        const offset = playerIndex * 0x24;\n        return {\n          playerIndex,\n          port: playerIndex + 1,\n          characterId: readUint8(view, 0x65 + offset),\n          type: readUint8(view, 0x66 + offset),\n          startStocks: readUint8(view, 0x67 + offset),\n          characterColor: readUint8(view, 0x68 + offset),\n          teamShade: readUint8(view, 0x6c + offset),\n          handicap: readUint8(view, 0x6d + offset),\n          teamId: readUint8(view, 0x6e + offset),\n          staminaMode: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x01)),\n          silentCharacter: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x02)),\n          lowGravity: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x04)),\n          invisible: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x08)),\n          blackStockIcon: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x10)),\n          metal: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x20)),\n          startOnAngelPlatform: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x40)),\n          rumbleEnabled: Boolean(readUint8(view, 0x6c + playerIndex * 0x24, 0x80)),\n          cpuLevel: readUint8(view, 0x74 + offset),\n          offenseRatio: readFloat(view, 0x7d + offset),\n          defenseRatio: readFloat(view, 0x81 + offset),\n          modelScale: readFloat(view, 0x85 + offset),\n          controllerFix,\n          nametag,\n          displayName,\n          connectCode,\n          userId,\n        };\n      };\n\n      const matchIdLength = 51;\n      const matchIdStart = 0x2be;\n      const matchIdBuf = payload.slice(matchIdStart, matchIdStart + matchIdLength);\n      const matchIdString = iconv\n        .decode(matchIdBuf as Buffer, \"utf8\")\n        .split(\"\\0\")\n        .shift();\n      const matchId = matchIdString ?? \"\";\n\n      return {\n        slpVersion: `${readUint8(view, 0x1)}.${readUint8(view, 0x2)}.${readUint8(view, 0x3)}`,\n        timerType: readUint8(view, 0x5, 0x03),\n        inGameMode: readUint8(view, 0x5, 0xe0),\n        friendlyFireEnabled: !!readUint8(view, 0x6, 0x01),\n        isTeams: readBool(view, 0xd),\n        itemSpawnBehavior: readUint8(view, 0x10),\n        stageId: readUint16(view, 0x13),\n        startingTimerSeconds: readUint32(view, 0x15),\n        enabledItems: getEnabledItems(view),\n        players: [0, 1, 2, 3].map(getPlayerObject),\n        scene: readUint8(view, 0x1a3),\n        gameMode: readUint8(view, 0x1a4),\n        language: readUint8(view, 0x2bd),\n        gameInfoBlock: getGameInfoBlock(view),\n        randomSeed: readUint32(view, 0x13d),\n        isPAL: readBool(view, 0x1a1),\n        isFrozenPS: readBool(view, 0x1a2),\n        matchInfo: {\n          matchId,\n          gameNumber: readUint32(view, 0x2f1),\n          tiebreakerNumber: readUint32(view, 0x2f5),\n        },\n      };\n    case Command.FRAME_START:\n      return {\n        frame: readInt32(view, 0x1),\n        seed: readUint32(view, 0x5),\n        sceneFrameCounter: readUint32(view, 0x9),\n      };\n\n    case Command.PRE_FRAME_UPDATE:\n      return {\n        frame: readInt32(view, 0x1),\n        playerIndex: readUint8(view, 0x5),\n        isFollower: readBool(view, 0x6),\n        seed: readUint32(view, 0x7),\n        actionStateId: readUint16(view, 0xb),\n        positionX: readFloat(view, 0xd),\n        positionY: readFloat(view, 0x11),\n        facingDirection: readFloat(view, 0x15),\n        joystickX: readFloat(view, 0x19),\n        joystickY: readFloat(view, 0x1d),\n        cStickX: readFloat(view, 0x21),\n        cStickY: readFloat(view, 0x25),\n        trigger: readFloat(view, 0x29),\n        buttons: readUint32(view, 0x2d),\n        physicalButtons: readUint16(view, 0x31),\n        physicalLTrigger: readFloat(view, 0x33),\n        physicalRTrigger: readFloat(view, 0x37),\n        rawJoystickX: readInt8(view, 0x3b),\n        percent: readFloat(view, 0x3c),\n      };\n    case Command.POST_FRAME_UPDATE:\n      const selfInducedSpeeds: SelfInducedSpeedsType = {\n        airX: readFloat(view, 0x35),\n        y: readFloat(view, 0x39),\n        attackX: readFloat(view, 0x3d),\n        attackY: readFloat(view, 0x41),\n        groundX: readFloat(view, 0x45),\n      };\n      return {\n        frame: readInt32(view, 0x1),\n        playerIndex: readUint8(view, 0x5),\n        isFollower: readBool(view, 0x6),\n        internalCharacterId: readUint8(view, 0x7),\n        actionStateId: readUint16(view, 0x8),\n        positionX: readFloat(view, 0xa),\n        positionY: readFloat(view, 0xe),\n        facingDirection: readFloat(view, 0x12),\n        percent: readFloat(view, 0x16),\n        shieldSize: readFloat(view, 0x1a),\n        lastAttackLanded: readUint8(view, 0x1e),\n        currentComboCount: readUint8(view, 0x1f),\n        lastHitBy: readUint8(view, 0x20),\n        stocksRemaining: readUint8(view, 0x21),\n        actionStateCounter: readFloat(view, 0x22),\n        miscActionState: readFloat(view, 0x2b),\n        isAirborne: readBool(view, 0x2f),\n        lastGroundId: readUint16(view, 0x30),\n        jumpsRemaining: readUint8(view, 0x32),\n        lCancelStatus: readUint8(view, 0x33),\n        hurtboxCollisionState: readUint8(view, 0x34),\n        selfInducedSpeeds: selfInducedSpeeds,\n        hitlagRemaining: readFloat(view, 0x49),\n        animationIndex: readUint32(view, 0x4d),\n      };\n    case Command.ITEM_UPDATE:\n      return {\n        frame: readInt32(view, 0x1),\n        typeId: readUint16(view, 0x5),\n        state: readUint8(view, 0x7),\n        facingDirection: readFloat(view, 0x8),\n        velocityX: readFloat(view, 0xc),\n        velocityY: readFloat(view, 0x10),\n        positionX: readFloat(view, 0x14),\n        positionY: readFloat(view, 0x18),\n        damageTaken: readUint16(view, 0x1c),\n        expirationTimer: readFloat(view, 0x1e),\n        spawnId: readUint32(view, 0x22),\n        missileType: readUint8(view, 0x26),\n        turnipFace: readUint8(view, 0x27),\n        chargeShotLaunched: readUint8(view, 0x28),\n        chargePower: readUint8(view, 0x29),\n        owner: readInt8(view, 0x2a),\n      };\n    case Command.FRAME_BOOKEND:\n      return {\n        frame: readInt32(view, 0x1),\n        latestFinalizedFrame: readInt32(view, 0x5),\n      };\n    case Command.GAME_END:\n      const placements = [0, 1, 2, 3].map((playerIndex): PlacementType => {\n        const position = readInt8(view, 0x3 + playerIndex);\n        return { playerIndex, position };\n      });\n\n      return {\n        gameEndMethod: readUint8(view, 0x1),\n        lrasInitiatorIndex: readInt8(view, 0x2),\n        placements,\n      };\n    case Command.GECKO_LIST:\n      const codes: GeckoCodeType[] = [];\n      let pos = 1;\n      while (pos < payload.length) {\n        const word1 = readUint32(view, pos) ?? 0;\n        const codetype = (word1 >> 24) & 0xfe;\n        const address = (word1 & 0x01ffffff) + 0x80000000;\n\n        let offset = 8; // Default code length, most codes are this length\n        if (codetype === 0xc0 || codetype === 0xc2) {\n          const lineCount = readUint32(view, pos + 4) ?? 0;\n          offset = 8 + lineCount * 8;\n        } else if (codetype === 0x06) {\n          const byteLen = readUint32(view, pos + 4) ?? 0;\n          offset = 8 + ((byteLen + 7) & 0xfffffff8);\n        } else if (codetype === 0x08) {\n          offset = 16;\n        }\n\n        codes.push({\n          type: codetype,\n          address: address,\n          contents: payload.slice(pos, pos + offset),\n        });\n\n        pos += offset;\n      }\n\n      return {\n        contents: payload.slice(1),\n        codes: codes,\n      };\n    default:\n      return null;\n  }\n}\n\nfunction canReadFromView(view: DataView, offset: number, length: number): boolean {\n  const viewLength = view.byteLength;\n  return offset + length <= viewLength;\n}\n\nfunction readFloat(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 4)) {\n    return null;\n  }\n\n  return view.getFloat32(offset);\n}\n\nfunction readInt32(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 4)) {\n    return null;\n  }\n\n  return view.getInt32(offset);\n}\n\nfunction readInt8(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 1)) {\n    return null;\n  }\n\n  return view.getInt8(offset);\n}\n\nfunction readUint32(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 4)) {\n    return null;\n  }\n\n  return view.getUint32(offset);\n}\n\nfunction readUint16(view: DataView, offset: number): number | null {\n  if (!canReadFromView(view, offset, 2)) {\n    return null;\n  }\n\n  return view.getUint16(offset);\n}\n\nfunction readUint8(view: DataView, offset: number, bitmask = 0xff): number | null {\n  if (!canReadFromView(view, offset, 1)) {\n    return null;\n  }\n\n  return view.getUint8(offset) & bitmask;\n}\n\nfunction readBool(view: DataView, offset: number): boolean | null {\n  if (!canReadFromView(view, offset, 1)) {\n    return null;\n  }\n\n  return !!view.getUint8(offset);\n}\n\nexport function getMetadata(slpFile: SlpFileType): MetadataType | null {\n  if (slpFile.metadataLength <= 0) {\n    // This will happen on a severed incomplete file\n    // $FlowFixMe\n    return null;\n  }\n\n  const buffer = new Uint8Array(slpFile.metadataLength);\n\n  readRef(slpFile.ref, buffer, 0, buffer.length, slpFile.metadataPosition);\n\n  let metadata = null;\n  try {\n    metadata = decode(buffer);\n  } catch (ex) {\n    // Do nothing\n    // console.log(ex);\n  }\n\n  // $FlowFixMe\n  return metadata;\n}\n\nexport function getGameEnd(slpFile: SlpFileType): GameEndType | null {\n  const { ref, rawDataPosition, rawDataLength, messageSizes } = slpFile;\n  const gameEndPayloadSize = messageSizes[Command.GAME_END];\n  if (!exists(gameEndPayloadSize) || gameEndPayloadSize <= 0) {\n    return null;\n  }\n\n  // Add one to account for command byte\n  const gameEndSize = gameEndPayloadSize + 1;\n  const gameEndPosition = rawDataPosition + rawDataLength - gameEndSize;\n\n  const buffer = new Uint8Array(gameEndSize);\n  readRef(ref, buffer, 0, buffer.length, gameEndPosition);\n  if (buffer[0] !== Command.GAME_END) {\n    // This isn't even a game end payload\n    return null;\n  }\n\n  const gameEndMessage = parseMessage(Command.GAME_END, buffer);\n  if (!gameEndMessage) {\n    return null;\n  }\n\n  return gameEndMessage as GameEndType;\n}\n\nexport function extractFinalPostFrameUpdates(slpFile: SlpFileType): PostFrameUpdateType[] {\n  const { ref, rawDataPosition, rawDataLength, messageSizes } = slpFile;\n\n  // The following should exist on all replay versions\n  const postFramePayloadSize = messageSizes[Command.POST_FRAME_UPDATE];\n  const gameEndPayloadSize = messageSizes[Command.GAME_END];\n  const frameBookendPayloadSize = messageSizes[Command.FRAME_BOOKEND];\n\n  // Technically this should not be possible\n  if (!exists(postFramePayloadSize)) {\n    return [];\n  }\n\n  const gameEndSize = gameEndPayloadSize ? gameEndPayloadSize + 1 : 0;\n  const postFrameSize = postFramePayloadSize + 1;\n  const frameBookendSize = frameBookendPayloadSize ? frameBookendPayloadSize + 1 : 0;\n\n  let frameNum: number | null = null;\n  let postFramePosition = rawDataPosition + rawDataLength - gameEndSize - frameBookendSize - postFrameSize;\n  const postFrameUpdates: PostFrameUpdateType[] = [];\n  do {\n    const buffer = new Uint8Array(postFrameSize);\n    readRef(ref, buffer, 0, buffer.length, postFramePosition);\n    if (buffer[0] !== Command.POST_FRAME_UPDATE) {\n      break;\n    }\n\n    const postFrameMessage = parseMessage(Command.POST_FRAME_UPDATE, buffer) as PostFrameUpdateType | null;\n    if (!postFrameMessage) {\n      break;\n    }\n\n    if (frameNum === null) {\n      frameNum = postFrameMessage.frame;\n    } else if (frameNum !== postFrameMessage.frame) {\n      // If post frame message is found but the frame doesn't match, it's not part of the final frame\n      break;\n    }\n\n    postFrameUpdates.unshift(postFrameMessage);\n    postFramePosition -= postFrameSize;\n  } while (postFramePosition >= rawDataPosition);\n\n  return postFrameUpdates;\n}\n","import type { WritableOptions } from \"stream\";\nimport { Writable } from \"stream\";\n\nimport { NETWORK_MESSAGE } from \"../console\";\nimport type { EventPayloadTypes } from \"../types\";\nimport { Command } from \"../types\";\nimport { parseMessage } from \"./slpReader\";\n\nexport enum SlpStreamMode {\n  AUTO = \"AUTO\", // Always reading data, but errors on invalid command\n  MANUAL = \"MANUAL\", // Stops parsing inputs after a valid game end command, requires manual restarting\n}\n\nconst defaultSettings = {\n  suppressErrors: false,\n  mode: SlpStreamMode.AUTO,\n};\n\nexport type SlpStreamSettings = typeof defaultSettings;\n\nexport type MessageSizes = Map<Command, number>;\n\nexport interface SlpCommandEventPayload {\n  command: Command;\n  payload: EventPayloadTypes | MessageSizes;\n}\n\nexport interface SlpRawEventPayload {\n  command: Command;\n  payload: Buffer;\n}\n\nexport enum SlpStreamEvent {\n  RAW = \"slp-raw\",\n  COMMAND = \"slp-command\",\n}\n\n/**\n * SlpStream is a writable stream of Slippi data. It passes the data being written in\n * and emits an event based on what kind of Slippi messages were processed.\n *\n * SlpStream emits two events: \"slp-raw\" and \"slp-command\". The \"slp-raw\" event emits the raw buffer\n * bytes whenever it processes each command. You can manually parse this or write it to a\n * file. The \"slp-command\" event returns the parsed payload which you can access the attributes.\n *\n * @class SlpStream\n * @extends {Writable}\n */\nexport class SlpStream extends Writable {\n  private gameEnded = false; // True only if in manual mode and the game has completed\n  private settings: SlpStreamSettings;\n  private payloadSizes: MessageSizes | null = null;\n  private previousBuffer: Uint8Array = Buffer.from([]);\n\n  /**\n   *Creates an instance of SlpStream.\n   * @param {Partial<SlpStreamSettings>} [slpOptions]\n   * @param {WritableOptions} [opts]\n   * @memberof SlpStream\n   */\n  public constructor(slpOptions?: Partial<SlpStreamSettings>, opts?: WritableOptions) {\n    super(opts);\n    this.settings = Object.assign({}, defaultSettings, slpOptions);\n  }\n\n  public restart(): void {\n    this.gameEnded = false;\n    this.payloadSizes = null;\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  public _write(newData: Buffer, encoding: string, callback: (error?: Error | null, data?: any) => void): void {\n    if (encoding !== \"buffer\") {\n      throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${encoding}'.`);\n    }\n\n    // Join the current data with the old data\n    const data = Uint8Array.from(Buffer.concat([this.previousBuffer, newData]));\n\n    // Clear previous data\n    this.previousBuffer = Buffer.from([]);\n\n    const dataView = new DataView(data.buffer);\n\n    // Iterate through the data\n    let index = 0;\n    while (index < data.length) {\n      // We want to filter out the network messages\n      if (Buffer.from(data.slice(index, index + 5)).toString() === NETWORK_MESSAGE) {\n        index += 5;\n        continue;\n      }\n\n      // Make sure we have enough data to read a full payload\n      const command = dataView.getUint8(index);\n      let payloadSize = 0;\n      if (this.payloadSizes) {\n        payloadSize = this.payloadSizes.get(command) ?? 0;\n      }\n      const remainingLen = data.length - index;\n      if (remainingLen < payloadSize + 1) {\n        // If remaining length is not long enough for full payload, save the remaining\n        // data until we receive more data. The data has been split up.\n        this.previousBuffer = data.slice(index);\n        break;\n      }\n\n      // Only process if the game is still going\n      if (this.settings.mode === SlpStreamMode.MANUAL && this.gameEnded) {\n        break;\n      }\n\n      // Increment by one for the command byte\n      index += 1;\n\n      const payloadPtr = data.slice(index);\n      const payloadDataView = new DataView(data.buffer, index);\n      let payloadLen = 0;\n      try {\n        payloadLen = this._processCommand(command, payloadPtr, payloadDataView);\n      } catch (err) {\n        // Only throw the error if we're not suppressing the errors\n        if (!this.settings.suppressErrors) {\n          throw err;\n        }\n        payloadLen = 0;\n      }\n      index += payloadLen;\n    }\n\n    callback();\n  }\n\n  private _writeCommand(command: Command, entirePayload: Uint8Array, payloadSize: number): Uint8Array {\n    const payloadBuf = entirePayload.slice(0, payloadSize);\n    const bufToWrite = Buffer.concat([Buffer.from([command]), payloadBuf]);\n    // Forward the raw buffer onwards\n    this.emit(SlpStreamEvent.RAW, {\n      command: command,\n      payload: bufToWrite,\n    } as SlpRawEventPayload);\n    return new Uint8Array(bufToWrite);\n  }\n\n  private _processCommand(command: Command, entirePayload: Uint8Array, dataView: DataView): number {\n    // Handle the message size command\n    if (command === Command.MESSAGE_SIZES) {\n      const payloadSize = dataView.getUint8(0);\n      // Set the payload sizes\n      this.payloadSizes = processReceiveCommands(dataView);\n      // Emit the raw command event\n      this._writeCommand(command, entirePayload, payloadSize);\n      this.emit(SlpStreamEvent.COMMAND, {\n        command: command,\n        payload: this.payloadSizes,\n      } as SlpCommandEventPayload);\n      return payloadSize;\n    }\n\n    let payloadSize = 0;\n    if (this.payloadSizes) {\n      payloadSize = this.payloadSizes.get(command) ?? 0;\n    }\n\n    // Fetch the payload and parse it\n    let payload: Uint8Array;\n    let parsedPayload: EventPayloadTypes | null = null;\n    if (payloadSize > 0) {\n      payload = this._writeCommand(command, entirePayload, payloadSize);\n      parsedPayload = parseMessage(command, payload);\n    }\n    if (!parsedPayload) {\n      return payloadSize;\n    }\n\n    switch (command) {\n      case Command.GAME_END:\n        // Stop parsing data until we manually restart the stream\n        if (this.settings.mode === SlpStreamMode.MANUAL) {\n          this.gameEnded = true;\n        }\n        break;\n    }\n\n    this.emit(SlpStreamEvent.COMMAND, {\n      command: command,\n      payload: parsedPayload,\n    } as SlpCommandEventPayload);\n    return payloadSize;\n  }\n}\n\nconst processReceiveCommands = (dataView: DataView): MessageSizes => {\n  const payloadSizes = new Map<Command, number>();\n  const payloadLen = dataView.getUint8(0);\n  for (let i = 1; i < payloadLen; i += 3) {\n    const commandByte = dataView.getUint8(i);\n    const payloadSize = dataView.getUint16(i + 1);\n    payloadSizes.set(commandByte, payloadSize);\n  }\n  return payloadSizes;\n};\n","import type { WriteStream } from \"fs\";\nimport fs from \"fs\";\nimport { forEach } from \"lodash\";\nimport type { WritableOptions } from \"stream\";\nimport { Writable } from \"stream\";\n\nimport type { GameStartType, PostFrameUpdateType } from \"../types\";\nimport { Command } from \"../types\";\nimport type { SlpCommandEventPayload } from \"./slpStream\";\nimport { SlpStream, SlpStreamEvent, SlpStreamMode } from \"./slpStream\";\n\nconst DEFAULT_NICKNAME = \"unknown\";\n\nexport interface SlpFileMetadata {\n  startTime: Date;\n  lastFrame: number;\n  players: {\n    [playerIndex: number]: {\n      characterUsage: {\n        [internalCharacterId: number]: number;\n      };\n      names: {\n        netplay: string;\n        code: string;\n      };\n    };\n  };\n  consoleNickname?: string;\n}\n\n/**\n * SlpFile is a class that wraps a Writable stream. It handles the writing of the binary\n * header and footer, and also handles the overwriting of the raw data length.\n *\n * @class SlpFile\n * @extends {Writable}\n */\nexport class SlpFile extends Writable {\n  private filePath: string;\n  private metadata: SlpFileMetadata;\n  private fileStream: WriteStream | null = null;\n  private rawDataLength = 0;\n  private slpStream: SlpStream;\n  private usesExternalStream = false;\n\n  /**\n   * Creates an instance of SlpFile.\n   * @param {string} filePath The file location to write to.\n   * @param {WritableOptions} [opts] Options for writing.\n   * @memberof SlpFile\n   */\n  public constructor(filePath: string, slpStream?: SlpStream, opts?: WritableOptions) {\n    super(opts);\n    this.filePath = filePath;\n    this.metadata = {\n      consoleNickname: DEFAULT_NICKNAME,\n      startTime: new Date(),\n      lastFrame: -124,\n      players: {},\n    };\n    this.usesExternalStream = Boolean(slpStream);\n\n    // Create a new SlpStream if one wasn't already provided\n    // This SLP stream represents a single game not multiple, so use manual mode\n    this.slpStream = slpStream ? slpStream : new SlpStream({ mode: SlpStreamMode.MANUAL });\n\n    this._setupListeners();\n    this._initializeNewGame(this.filePath);\n  }\n\n  /**\n   * Get the current file path being written to.\n   *\n   * @returns {string} The location of the current file path\n   * @memberof SlpFile\n   */\n  public path(): string {\n    return this.filePath;\n  }\n\n  /**\n   * Sets the metadata of the Slippi file, such as consoleNickname, lastFrame, and players.\n   * @param metadata The metadata to be written\n   */\n  public setMetadata(metadata: Partial<SlpFileMetadata>): void {\n    this.metadata = Object.assign({}, this.metadata, metadata);\n  }\n\n  public _write(chunk: Uint8Array, encoding: string, callback: (error?: Error | null) => void): void {\n    if (encoding !== \"buffer\") {\n      throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${encoding}'.`);\n    }\n    // Write it to the file\n    if (this.fileStream) {\n      this.fileStream.write(chunk);\n    }\n\n    // Parse the data manually if it's an internal stream\n    if (!this.usesExternalStream) {\n      this.slpStream.write(chunk);\n    }\n\n    // Keep track of the bytes we've written\n    this.rawDataLength += chunk.length;\n    callback();\n  }\n\n  /**\n   * Here we define what to do on each command. We need to populate the metadata field\n   * so we keep track of the latest frame, as well as the number of frames each character has\n   * been used.\n   *\n   * @param data The parsed data from a SlpStream\n   */\n  private _onCommand(data: SlpCommandEventPayload): void {\n    const { command, payload } = data;\n    switch (command) {\n      case Command.GAME_START:\n        const { players } = payload as GameStartType;\n        forEach(players, (player) => {\n          if (player.type === 3) {\n            return;\n          }\n\n          this.metadata.players[player.playerIndex] = {\n            characterUsage: {},\n            names: {\n              netplay: player.displayName,\n              code: player.connectCode,\n            },\n          };\n        });\n        break;\n      case Command.POST_FRAME_UPDATE:\n        // Here we need to update some metadata fields\n        const { frame, playerIndex, isFollower, internalCharacterId } = payload as PostFrameUpdateType;\n        if (isFollower) {\n          // No need to do this for follower\n          break;\n        }\n\n        // Update frame index\n        this.metadata.lastFrame = frame!;\n\n        // Update character usage\n        const prevPlayer = this.metadata.players[playerIndex!];\n        const characterUsage = prevPlayer!.characterUsage;\n        const curCharFrames = characterUsage[internalCharacterId!] || 0;\n        const player = {\n          ...prevPlayer,\n          characterUsage: {\n            ...characterUsage,\n            [internalCharacterId!]: curCharFrames + 1,\n          },\n        };\n        (this.metadata.players as any)[playerIndex!] = player;\n        break;\n    }\n  }\n\n  private _setupListeners(): void {\n    const streamListener = (data: SlpCommandEventPayload): void => {\n      this._onCommand(data);\n    };\n    this.slpStream.on(SlpStreamEvent.COMMAND, streamListener);\n\n    this.on(\"finish\", () => {\n      // Update file with bytes written\n      const fd = fs.openSync(this.filePath, \"r+\");\n      fs.writeSync(fd, createUInt32Buffer(this.rawDataLength), 0, 4, 11);\n      fs.closeSync(fd);\n\n      // Unsubscribe from the stream\n      this.slpStream.removeListener(SlpStreamEvent.COMMAND, streamListener);\n      // Terminate the internal stream\n      if (!this.usesExternalStream) {\n        this.slpStream.end();\n      }\n    });\n  }\n\n  private _initializeNewGame(filePath: string): void {\n    this.fileStream = fs.createWriteStream(filePath, {\n      encoding: \"binary\",\n    });\n\n    const header = Buffer.concat([\n      Buffer.from(\"{U\"),\n      Buffer.from([3]),\n      Buffer.from(\"raw[$U#l\"),\n      Buffer.from([0, 0, 0, 0]),\n    ]);\n    this.fileStream.write(header);\n  }\n\n  public _final(callback: (error?: Error | null) => void): void {\n    let footer = Buffer.concat([Buffer.from(\"U\"), Buffer.from([8]), Buffer.from(\"metadata{\")]);\n\n    // Write game start time\n    const startTimeStr = this.metadata.startTime.toISOString();\n    footer = Buffer.concat([\n      footer,\n      Buffer.from(\"U\"),\n      Buffer.from([7]),\n      Buffer.from(\"startAtSU\"),\n      Buffer.from([startTimeStr.length]),\n      Buffer.from(startTimeStr),\n    ]);\n\n    // Write last frame index\n    // TODO: Get last frame\n    const lastFrame = this.metadata.lastFrame;\n    footer = Buffer.concat([\n      footer,\n      Buffer.from(\"U\"),\n      Buffer.from([9]),\n      Buffer.from(\"lastFramel\"),\n      createInt32Buffer(lastFrame),\n    ]);\n\n    // write the Console Nickname\n    const consoleNick = this.metadata.consoleNickname || DEFAULT_NICKNAME;\n    footer = Buffer.concat([\n      footer,\n      Buffer.from(\"U\"),\n      Buffer.from([11]),\n      Buffer.from(\"consoleNickSU\"),\n      Buffer.from([consoleNick.length]),\n      Buffer.from(consoleNick),\n    ]);\n\n    // Start writting player specific data\n    footer = Buffer.concat([footer, Buffer.from(\"U\"), Buffer.from([7]), Buffer.from(\"players{\")]);\n    const players = this.metadata.players;\n    forEach(players, (player, index) => {\n      // Start player obj with index being the player index\n      footer = Buffer.concat([footer, Buffer.from(\"U\"), Buffer.from([index.length]), Buffer.from(`${index}{`)]);\n\n      // Start characters key for this player\n      footer = Buffer.concat([footer, Buffer.from(\"U\"), Buffer.from([10]), Buffer.from(\"characters{\")]);\n\n      // Write character usage\n      forEach(player.characterUsage, (usage, internalId) => {\n        // Write this character\n        footer = Buffer.concat([\n          footer,\n          Buffer.from(\"U\"),\n          Buffer.from([internalId.length]),\n          Buffer.from(`${internalId}l`),\n          createUInt32Buffer(usage),\n        ]);\n      });\n\n      // Close characters\n      footer = Buffer.concat([footer, Buffer.from(\"}\")]);\n\n      // Start names key for this player\n      footer = Buffer.concat([footer, Buffer.from(\"U\"), Buffer.from([5]), Buffer.from(\"names{\")]);\n\n      // Write display name\n      footer = Buffer.concat([\n        footer,\n        Buffer.from(\"U\"),\n        Buffer.from([7]),\n        Buffer.from(\"netplaySU\"),\n        Buffer.from([player.names.netplay.length]),\n        Buffer.from(`${player.names.netplay}`),\n      ]);\n\n      // Write connect code\n      footer = Buffer.concat([\n        footer,\n        Buffer.from(\"U\"),\n        Buffer.from([4]),\n        Buffer.from(\"codeSU\"),\n        Buffer.from([player.names.code.length]),\n        Buffer.from(`${player.names.code}`),\n      ]);\n\n      // Close names and player\n      footer = Buffer.concat([footer, Buffer.from(\"}}\")]);\n    });\n\n    // Close players\n    footer = Buffer.concat([footer, Buffer.from(\"}\")]);\n\n    // Write played on\n    footer = Buffer.concat([\n      footer,\n      Buffer.from(\"U\"),\n      Buffer.from([8]),\n      Buffer.from(\"playedOnSU\"),\n      Buffer.from([7]),\n      Buffer.from(\"network\"),\n    ]);\n\n    // Close metadata and file\n    footer = Buffer.concat([footer, Buffer.from(\"}}\")]);\n\n    // End the stream\n    if (this.fileStream) {\n      this.fileStream.write(footer, callback);\n    }\n  }\n}\n\nconst createInt32Buffer = (number: number): Buffer => {\n  const buf = Buffer.alloc(4);\n  buf.writeInt32BE(number, 0);\n  return buf;\n};\n\nconst createUInt32Buffer = (number: number): Buffer => {\n  const buf = Buffer.alloc(4);\n  buf.writeUInt32BE(number, 0);\n  return buf;\n};\n","import { format } from \"date-fns\";\nimport path from \"path\";\nimport type { WritableOptions } from \"stream\";\n\nimport { Command } from \"../types\";\nimport { SlpFile } from \"./slpFile\";\nimport type { SlpRawEventPayload, SlpStreamSettings } from \"./slpStream\";\nimport { SlpStream, SlpStreamEvent } from \"./slpStream\";\n\n/**\n * The default function to use for generating new SLP files.\n */\nfunction getNewFilePath(folder: string, date: Date): string {\n  return path.join(folder, `Game_${format(date, \"yyyyMMdd\")}T${format(date, \"HHmmss\")}.slp`);\n}\n\nexport interface SlpFileWriterOptions extends Partial<SlpStreamSettings> {\n  outputFiles: boolean;\n  folderPath: string;\n  consoleNickname: string;\n  newFilename: (folder: string, startTime: Date) => string;\n}\n\nconst defaultSettings: SlpFileWriterOptions = {\n  outputFiles: true,\n  folderPath: \".\",\n  consoleNickname: \"unknown\",\n  newFilename: getNewFilePath,\n};\n\nexport enum SlpFileWriterEvent {\n  NEW_FILE = \"new-file\",\n  FILE_COMPLETE = \"file-complete\",\n}\n\n/**\n * SlpFileWriter lets us not only emit events as an SlpStream but also\n * writes the data that is being passed in to an SLP file. Use this if\n * you want to process Slippi data in real time but also want to be able\n * to write out the data to an SLP file.\n *\n * @export\n * @class SlpFileWriter\n * @extends {SlpStream}\n */\nexport class SlpFileWriter extends SlpStream {\n  private currentFile: SlpFile | null = null;\n  private options: SlpFileWriterOptions;\n\n  /**\n   * Creates an instance of SlpFileWriter.\n   */\n  public constructor(options?: Partial<SlpFileWriterOptions>, opts?: WritableOptions) {\n    super(options, opts);\n    this.options = Object.assign({}, defaultSettings, options);\n    this._setupListeners();\n  }\n\n  private _writePayload(payload: Buffer): void {\n    // Write data to the current file\n    if (this.currentFile) {\n      this.currentFile.write(payload);\n    }\n  }\n\n  private _setupListeners(): void {\n    this.on(SlpStreamEvent.RAW, (data: SlpRawEventPayload) => {\n      const { command, payload } = data;\n      switch (command) {\n        case Command.MESSAGE_SIZES:\n          // Create the new game first before writing the payload\n          this._handleNewGame();\n          this._writePayload(payload);\n          break;\n        case Command.GAME_END:\n          // Write payload first before ending the game\n          this._writePayload(payload);\n          this._handleEndGame();\n          break;\n        default:\n          this._writePayload(payload);\n          break;\n      }\n    });\n  }\n\n  /**\n   * Return the name of the SLP file currently being written or null if\n   * no file is being written to currently.\n   *\n   * @returns {(string | null)}\n   * @memberof SlpFileWriter\n   */\n  public getCurrentFilename(): string | null {\n    if (this.currentFile !== null) {\n      return path.resolve(this.currentFile.path());\n    }\n    return null;\n  }\n\n  /**\n   * Ends the current file being written to.\n   *\n   * @returns {(string | null)}\n   * @memberof SlpFileWriter\n   */\n  public endCurrentFile(): void {\n    this._handleEndGame();\n  }\n\n  /**\n   * Updates the settings to be the desired ones passed in.\n   *\n   * @param {Partial<SlpFileWriterOptions>} settings\n   * @memberof SlpFileWriter\n   */\n  public updateSettings(settings: Partial<SlpFileWriterOptions>): void {\n    this.options = Object.assign({}, this.options, settings);\n  }\n\n  private _handleNewGame(): void {\n    // Only create a new file if we're outputting files\n    if (this.options.outputFiles) {\n      const filePath = this.options.newFilename(this.options.folderPath, new Date());\n      this.currentFile = new SlpFile(filePath, this);\n      // console.log(`Creating new file at: ${filePath}`);\n      this.emit(SlpFileWriterEvent.NEW_FILE, filePath);\n    }\n  }\n\n  private _handleEndGame(): void {\n    // End the stream\n    if (this.currentFile) {\n      // Set the console nickname\n      this.currentFile.setMetadata({\n        consoleNickname: this.options.consoleNickname,\n      });\n      this.currentFile.end();\n\n      // console.log(`Finished writing file: ${this.currentFile.path()}`);\n      this.emit(SlpFileWriterEvent.FILE_COMPLETE, this.currentFile.path());\n\n      // Clear current file\n      this.currentFile = null;\n    }\n  }\n}\n","import type { FrameEntryType, RollbackFramesType } from \"../types\";\n\nexport class RollbackCounter {\n  private rollbackFrames: RollbackFramesType = {};\n  private rollbackFrameCount = 0;\n  private rollbackPlayerIdx: number | null = null; // for keeping track of rollbacks by following a single player\n  private lastFrameWasRollback = false;\n  private currentRollbackLength = 0;\n  private rollbackLengths: number[] = [];\n\n  public checkIfRollbackFrame(currentFrame: FrameEntryType | undefined, playerIdx: number) {\n    if (this.rollbackPlayerIdx === null) {\n      // we only want to follow a single player to avoid double counting. So we use whoever is on first.\n      this.rollbackPlayerIdx = playerIdx;\n    } else if (this.rollbackPlayerIdx !== playerIdx) {\n      return;\n    }\n\n    if (currentFrame && currentFrame.players) {\n      // frame already exists for currentFrameNumber so we must be rolling back\n      // Note: We detect during PreFrameUpdate, but new versions have a\n      // FrameStart command that has already initialized the frame, so we must\n      // check for player data too.\n      if (this.rollbackFrames[currentFrame.frame]) {\n        this.rollbackFrames[currentFrame.frame]!.push(currentFrame);\n      } else {\n        this.rollbackFrames[currentFrame.frame] = [currentFrame];\n      }\n      this.rollbackFrameCount++;\n      this.currentRollbackLength++;\n      this.lastFrameWasRollback = true;\n    } else if (this.lastFrameWasRollback) {\n      this.rollbackLengths.push(this.currentRollbackLength);\n      this.currentRollbackLength = 0;\n      this.lastFrameWasRollback = false;\n    }\n    return this.lastFrameWasRollback;\n  }\n\n  public getFrames() {\n    return this.rollbackFrames;\n  }\n\n  public getCount() {\n    return this.rollbackFrameCount;\n  }\n\n  public getLengths() {\n    return this.rollbackLengths;\n  }\n}\n","import { EventEmitter } from \"events\";\nimport { get, keyBy, set } from \"lodash\";\nimport semver from \"semver\";\n\nimport type {\n  EnabledItemType,\n  FrameBookendType,\n  FrameEntryType,\n  FrameStartType,\n  FramesType,\n  GameEndType,\n  GameStartType,\n  GeckoListType,\n  ItemUpdateType,\n  PostFrameUpdateType,\n  PreFrameUpdateType,\n  RollbackFrames,\n} from \"../types\";\nimport { ItemSpawnType } from \"../types\";\nimport { Command, Frames, GameMode } from \"../types\";\nimport { exists } from \"./exists\";\nimport { RollbackCounter } from \"./rollbackCounter\";\n\n// There are 5 bytes of item bitfields that can be enabled\nconst ITEM_SETTINGS_BIT_COUNT = 40;\nexport const MAX_ROLLBACK_FRAMES = 7;\n\nexport enum SlpParserEvent {\n  SETTINGS = \"settings\",\n  END = \"end\",\n  FRAME = \"frame\", // Emitted for every frame\n  FINALIZED_FRAME = \"finalized-frame\", // Emitted for only finalized frames\n  ROLLBACK_FRAME = \"rollback-frame\", // Emitted if a frame is being replaced\n}\n\n// If strict mode is on, we will do strict validation checking\n// which could throw errors on invalid data.\n// Default to false though since probably only real time applications\n// would care about valid data.\nconst defaultSlpParserOptions = {\n  strict: false,\n};\n\nexport type SlpParserOptions = typeof defaultSlpParserOptions;\n\nexport class SlpParser extends EventEmitter {\n  private frames: FramesType = {};\n  private rollbackCounter: RollbackCounter = new RollbackCounter();\n  private settings: GameStartType | null = null;\n  private gameEnd: GameEndType | null = null;\n  private latestFrameIndex: number | null = null;\n  private settingsComplete = false;\n  private lastFinalizedFrame = Frames.FIRST - 1;\n  private options: SlpParserOptions;\n  private geckoList: GeckoListType | null = null;\n\n  public constructor(options?: Partial<SlpParserOptions>) {\n    super();\n    this.options = Object.assign({}, defaultSlpParserOptions, options);\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  public handleCommand(command: Command, payload: any): void {\n    switch (command) {\n      case Command.GAME_START:\n        this._handleGameStart(payload as GameStartType);\n        break;\n      case Command.FRAME_START:\n        this._handleFrameStart(payload as FrameStartType);\n        break;\n      case Command.POST_FRAME_UPDATE:\n        // We need to handle the post frame update first since that\n        // will finalize the settings object, before we fire the frame update\n        this._handlePostFrameUpdate(payload as PostFrameUpdateType);\n        this._handleFrameUpdate(command, payload as PostFrameUpdateType);\n        break;\n      case Command.PRE_FRAME_UPDATE:\n        this._handleFrameUpdate(command, payload as PreFrameUpdateType);\n        break;\n      case Command.ITEM_UPDATE:\n        this._handleItemUpdate(payload as ItemUpdateType);\n        break;\n      case Command.FRAME_BOOKEND:\n        this._handleFrameBookend(payload as FrameBookendType);\n        break;\n      case Command.GAME_END:\n        this._handleGameEnd(payload as GameEndType);\n        break;\n      case Command.GECKO_LIST:\n        this._handleGeckoList(payload as GeckoListType);\n        break;\n    }\n  }\n\n  /**\n   * Resets the parser state to their default values.\n   */\n  public reset(): void {\n    this.frames = {};\n    this.settings = null;\n    this.gameEnd = null;\n    this.latestFrameIndex = null;\n    this.settingsComplete = false;\n    this.lastFinalizedFrame = Frames.FIRST - 1;\n  }\n\n  public getLatestFrameNumber(): number {\n    return this.latestFrameIndex ?? Frames.FIRST - 1;\n  }\n\n  public getPlayableFrameCount(): number {\n    if (this.latestFrameIndex === null) {\n      return 0;\n    }\n    return this.latestFrameIndex < Frames.FIRST_PLAYABLE ? 0 : this.latestFrameIndex - Frames.FIRST_PLAYABLE;\n  }\n\n  public getLatestFrame(): FrameEntryType | null {\n    // return this.playerFrames[this.latestFrameIndex];\n\n    // TODO: Modify this to check if we actually have all the latest frame data and return that\n    // TODO: If we do. For now I'm just going to take a shortcut\n    const allFrames = this.getFrames();\n    const frameIndex = this.latestFrameIndex !== null ? this.latestFrameIndex : Frames.FIRST;\n    const indexToUse = this.gameEnd ? frameIndex : frameIndex - 1;\n    return get(allFrames, indexToUse) || null;\n  }\n\n  public getSettings(): GameStartType | null {\n    return this.settingsComplete ? this.settings : null;\n  }\n\n  public getItems(): EnabledItemType[] | null {\n    if (this.settings?.itemSpawnBehavior === ItemSpawnType.OFF) {\n      return null;\n    }\n\n    const itemBitfield = this.settings?.enabledItems;\n    if (!exists(itemBitfield)) {\n      return null;\n    }\n\n    const enabledItems: EnabledItemType[] = [];\n\n    // Ideally we would be able to do this with bitshifting instead, but javascript\n    // truncates numbers after 32 bits when doing bitwise operations\n    for (let i = 0; i < ITEM_SETTINGS_BIT_COUNT; i++) {\n      if (Math.floor(itemBitfield / 2 ** i) & 1) {\n        enabledItems.push(2 ** i);\n      }\n    }\n\n    return enabledItems;\n  }\n\n  public getGameEnd(): GameEndType | null {\n    return this.gameEnd;\n  }\n\n  public getFrames(): FramesType {\n    return this.frames;\n  }\n\n  public getRollbackFrames(): RollbackFrames {\n    return {\n      frames: this.rollbackCounter.getFrames(),\n      count: this.rollbackCounter.getCount(),\n      lengths: this.rollbackCounter.getLengths(),\n    };\n  }\n\n  public getFrame(num: number): FrameEntryType | null {\n    return this.frames[num] || null;\n  }\n\n  public getGeckoList(): GeckoListType | null {\n    return this.geckoList;\n  }\n\n  private _handleGeckoList(payload: GeckoListType): void {\n    this.geckoList = payload;\n  }\n\n  private _handleGameEnd(payload: GameEndType): void {\n    // Finalize remaining frames if necessary\n    if (this.latestFrameIndex !== null && this.latestFrameIndex !== this.lastFinalizedFrame) {\n      this._finalizeFrames(this.latestFrameIndex);\n    }\n\n    payload = payload as GameEndType;\n    this.gameEnd = payload;\n    this.emit(SlpParserEvent.END, this.gameEnd);\n  }\n\n  private _handleGameStart(payload: GameStartType): void {\n    this.settings = payload;\n    const players = payload.players;\n    this.settings.players = players.filter((player) => player.type !== 3);\n\n    // Check to see if the file was created after the sheik fix so we know\n    // we don't have to process the first frame of the game for the full settings\n    if (payload.slpVersion && semver.gte(payload.slpVersion, \"1.6.0\")) {\n      this._completeSettings();\n    }\n  }\n\n  private _handleFrameStart(payload: FrameStartType): void {\n    const currentFrameNumber = payload.frame!;\n\n    set(this.frames, [currentFrameNumber, \"start\"], payload);\n  }\n\n  private _handlePostFrameUpdate(payload: PostFrameUpdateType): void {\n    if (this.settingsComplete) {\n      return;\n    }\n\n    // Finish calculating settings\n    if (payload.frame! <= Frames.FIRST) {\n      const playerIndex = payload.playerIndex!;\n      const playersByIndex = keyBy(this.settings!.players, \"playerIndex\");\n\n      switch (payload.internalCharacterId) {\n        case 0x7:\n          playersByIndex[playerIndex]!.characterId = 0x13; // Sheik\n          break;\n        case 0x13:\n          playersByIndex[playerIndex]!.characterId = 0x12; // Zelda\n          break;\n      }\n    }\n    if (payload.frame! > Frames.FIRST) {\n      this._completeSettings();\n    }\n  }\n\n  private _handleFrameUpdate(command: Command, payload: PreFrameUpdateType | PostFrameUpdateType): void {\n    payload = payload as PostFrameUpdateType;\n    const location = command === Command.PRE_FRAME_UPDATE ? \"pre\" : \"post\";\n    const field = payload.isFollower ? \"followers\" : \"players\";\n    const currentFrameNumber = payload.frame!;\n    this.latestFrameIndex = currentFrameNumber;\n    if (location === \"pre\" && !payload.isFollower) {\n      const currentFrame = this.frames[currentFrameNumber];\n      const wasRolledback = this.rollbackCounter.checkIfRollbackFrame(currentFrame, payload.playerIndex!);\n      if (wasRolledback) {\n        // frame is about to be overwritten\n        this.emit(SlpParserEvent.ROLLBACK_FRAME, currentFrame);\n      }\n    }\n    set(this.frames, [currentFrameNumber, field, payload.playerIndex!, location], payload);\n    set(this.frames, [currentFrameNumber, \"frame\"], currentFrameNumber);\n\n    // If file is from before frame bookending, add frame to stats computer here. Does a little\n    // more processing than necessary, but it works\n    const settings = this.getSettings();\n    if (settings && (!settings.slpVersion || semver.lte(settings.slpVersion, \"2.2.0\"))) {\n      this.emit(SlpParserEvent.FRAME, this.frames[currentFrameNumber]);\n      // Finalize the previous frame since no bookending exists\n      this._finalizeFrames(currentFrameNumber - 1);\n    } else {\n      set(this.frames, [currentFrameNumber, \"isTransferComplete\"], false);\n    }\n  }\n\n  private _handleItemUpdate(payload: ItemUpdateType): void {\n    const currentFrameNumber = payload.frame!;\n    const items = this.frames[currentFrameNumber]?.items ?? [];\n    items.push(payload);\n\n    // Set items with newest\n    set(this.frames, [currentFrameNumber, \"items\"], items);\n  }\n\n  private _handleFrameBookend(payload: FrameBookendType): void {\n    const latestFinalizedFrame = payload.latestFinalizedFrame!;\n    const currentFrameNumber = payload.frame!;\n    set(this.frames, [currentFrameNumber, \"isTransferComplete\"], true);\n    // Fire off a normal frame event\n    this.emit(SlpParserEvent.FRAME, this.frames[currentFrameNumber]);\n\n    // Finalize frames if necessary\n    const validLatestFrame = this.settings!.gameMode === GameMode.ONLINE;\n    if (validLatestFrame && latestFinalizedFrame >= Frames.FIRST) {\n      // Ensure valid latestFinalizedFrame\n      if (this.options.strict && latestFinalizedFrame < currentFrameNumber - MAX_ROLLBACK_FRAMES) {\n        throw new Error(`latestFinalizedFrame should be within ${MAX_ROLLBACK_FRAMES} frames of ${currentFrameNumber}`);\n      }\n      this._finalizeFrames(latestFinalizedFrame);\n    } else {\n      // Since we don't have a valid finalized frame, just finalize the frame based on MAX_ROLLBACK_FRAMES\n      this._finalizeFrames(currentFrameNumber - MAX_ROLLBACK_FRAMES);\n    }\n  }\n\n  /**\n   * Fires off the FINALIZED_FRAME event for frames up until a certain number\n   * @param num The frame to finalize until\n   */\n  private _finalizeFrames(num: number): void {\n    while (this.lastFinalizedFrame < num) {\n      const frameToFinalize = this.lastFinalizedFrame + 1;\n      const frame = this.getFrame(frameToFinalize)!;\n\n      // Check that we have all the pre and post frame data for all players if we're in strict mode\n      if (this.options.strict) {\n        for (const player of this.settings!.players) {\n          const playerFrameInfo = frame.players[player.playerIndex];\n          // Allow player frame info to be empty in non 1v1 games since\n          // players which have been defeated will have no frame info.\n          if (this.settings!.players.length > 2 && !playerFrameInfo) {\n            continue;\n          }\n\n          const { pre, post } = playerFrameInfo!;\n          if (!pre || !post) {\n            const preOrPost = pre ? \"pre\" : \"post\";\n            throw new Error(\n              `Could not finalize frame ${frameToFinalize} of ${num}: missing ${preOrPost}-frame update for player ${player.playerIndex}`,\n            );\n          }\n        }\n      }\n\n      // Our frame is complete so finalize the frame\n      this.emit(SlpParserEvent.FINALIZED_FRAME, frame);\n      this.lastFinalizedFrame = frameToFinalize;\n    }\n  }\n\n  private _completeSettings(): void {\n    if (!this.settingsComplete) {\n      this.settingsComplete = true;\n      this.emit(SlpParserEvent.SETTINGS, this.settings);\n    }\n  }\n}\n","import type { GameEndType, GameStartType, PlacementType, PostFrameUpdateType } from \"../types\";\nimport { GameEndMethod } from \"../types\";\nimport { exists } from \"./exists\";\n\nexport function getWinners(\n  gameEnd: GameEndType,\n  settings: Pick<GameStartType, \"players\" | \"isTeams\">,\n  finalPostFrameUpdates: PostFrameUpdateType[],\n): PlacementType[] {\n  const { placements, gameEndMethod, lrasInitiatorIndex } = gameEnd;\n  const { players, isTeams } = settings;\n\n  if (gameEndMethod === GameEndMethod.NO_CONTEST || gameEndMethod === GameEndMethod.UNRESOLVED) {\n    // The winner is the person who didn't LRAS\n    if (exists(lrasInitiatorIndex) && players.length === 2) {\n      const winnerIndex = players.find(({ playerIndex }) => playerIndex !== lrasInitiatorIndex)?.playerIndex;\n      if (exists(winnerIndex)) {\n        return [\n          {\n            playerIndex: winnerIndex,\n            position: 0,\n          },\n        ];\n      }\n    }\n\n    return [];\n  }\n\n  if (gameEndMethod === GameEndMethod.TIME && players.length === 2) {\n    const nonFollowerUpdates = finalPostFrameUpdates.filter((pfu) => !pfu.isFollower);\n    if (nonFollowerUpdates.length !== players.length) {\n      return [];\n    }\n\n    const p1 = nonFollowerUpdates[0]!;\n    const p2 = nonFollowerUpdates[1]!;\n    if (p1.stocksRemaining! > p2.stocksRemaining!) {\n      return [{ playerIndex: p1.playerIndex!, position: 0 }];\n    } else if (p2.stocksRemaining! > p1.stocksRemaining!) {\n      return [{ playerIndex: p2.playerIndex!, position: 0 }];\n    }\n\n    const p1Health = Math.trunc(p1.percent!);\n    const p2Health = Math.trunc(p2.percent!);\n    if (p1Health < p2Health) {\n      return [{ playerIndex: p1.playerIndex!, position: 0 }];\n    } else if (p2Health < p1Health) {\n      return [{ playerIndex: p2.playerIndex!, position: 0 }];\n    }\n\n    // If stocks and percents were tied, no winner\n    return [];\n  }\n\n  const firstPosition = placements.find((placement) => placement.position === 0);\n  if (!firstPosition) {\n    return [];\n  }\n\n  const winningTeam = players.find(({ playerIndex }) => playerIndex === firstPosition.playerIndex)?.teamId ?? null;\n  if (isTeams && exists(winningTeam)) {\n    return placements.filter((placement) => {\n      const teamId = players.find(({ playerIndex }) => playerIndex === placement.playerIndex)?.teamId ?? null;\n      return teamId === winningTeam;\n    });\n  }\n\n  return [firstPosition];\n}\n","import type { FrameEntryType, GameStartType } from \"../types\";\nimport { Language } from \"../types\";\nimport { exists } from \"./exists\";\n\nconst SANDBAG_INTERNAL_ID = 32;\n\nconst FEET_CONVERSION_FACTOR = 0.952462;\nconst METERS_CONVERSION_FACTOR = 1.04167;\n\ntype HomeRunDistanceUnits = \"feet\" | \"meters\";\n\nexport function positionToHomeRunDistance(distance: number, units: HomeRunDistanceUnits = \"feet\"): number {\n  let score = 0;\n  switch (units) {\n    case \"feet\":\n      score = 10 * Math.floor(distance - 70 * FEET_CONVERSION_FACTOR);\n      // convert to float32\n      score = Math.fround(score);\n      score = Math.floor((score / 30.4788) * 10) / 10;\n      break;\n    case \"meters\":\n      score = 10 * Math.floor(distance - 70 * METERS_CONVERSION_FACTOR);\n      // convert to float32\n      score = Math.fround(score);\n      score = Math.floor((score / 100) * 10) / 10;\n      break;\n    default:\n      throw new Error(`Unsupported units: ${units}`);\n  }\n\n  // round to 1 decimal\n  score = Math.round(score * 10) / 10;\n  return Math.max(0, score);\n}\n\nexport function extractDistanceInfoFromFrame(\n  settings: Pick<GameStartType, \"language\">,\n  lastFrame: Pick<FrameEntryType, \"players\">,\n): { distance: number; units: HomeRunDistanceUnits } | null {\n  const sandbagLastFrame = Object.values(lastFrame.players)\n    .filter(exists)\n    .find((playerFrame) => playerFrame.post.internalCharacterId === SANDBAG_INTERNAL_ID);\n\n  if (!sandbagLastFrame) {\n    return null;\n  }\n\n  // Only return the distance in meters if it's a Japanese replay.\n  // Technically we should check if the replay is PAL but we don't yet support\n  // stadium replays in PAL.\n  const units: HomeRunDistanceUnits = settings.language === Language.JAPANESE ? \"meters\" : \"feet\";\n  const distance = positionToHomeRunDistance(sandbagLastFrame.post.positionX ?? 0, units);\n  return {\n    distance,\n    units,\n  };\n}\n","import type { StadiumStatsType, StatOptions, StatsType } from \"./stats\";\nimport { TargetBreakComputer } from \"./stats\";\nimport {\n  ActionsComputer,\n  ComboComputer,\n  ConversionComputer,\n  generateOverallStats,\n  InputComputer,\n  Stats,\n  StockComputer,\n} from \"./stats\";\nimport type {\n  EnabledItemType,\n  EventCallbackFunc,\n  FrameEntryType,\n  FramesType,\n  GameEndType,\n  GameStartType,\n  GeckoListType,\n  MetadataType,\n  PlacementType,\n  PostFrameUpdateType,\n  RollbackFrames,\n} from \"./types\";\nimport { GameEndMethod, GameMode } from \"./types\";\nimport { getWinners } from \"./utils/getWinners\";\nimport { extractDistanceInfoFromFrame } from \"./utils/homeRunDistance\";\nimport { SlpParser, SlpParserEvent } from \"./utils/slpParser\";\nimport type { SlpFileType, SlpReadInput } from \"./utils/slpReader\";\nimport {\n  closeSlpFile,\n  extractFinalPostFrameUpdates,\n  getGameEnd,\n  getMetadata,\n  iterateEvents,\n  openSlpFile,\n  SlpInputSource,\n} from \"./utils/slpReader\";\n\n/**\n * Slippi Game class that wraps a file\n */\nexport class SlippiGame {\n  private input: SlpReadInput;\n  private metadata: MetadataType | null = null;\n  private finalStats: StatsType | null = null;\n  private parser: SlpParser;\n  private readPosition: number | null = null;\n  private actionsComputer: ActionsComputer = new ActionsComputer();\n  private conversionComputer: ConversionComputer = new ConversionComputer();\n  private comboComputer: ComboComputer = new ComboComputer();\n  private stockComputer: StockComputer = new StockComputer();\n  private inputComputer: InputComputer = new InputComputer();\n  private targetBreakComputer: TargetBreakComputer = new TargetBreakComputer();\n  protected statsComputer: Stats;\n\n  public constructor(input: string | Buffer | ArrayBuffer, opts?: StatOptions) {\n    if (typeof input === \"string\") {\n      this.input = {\n        source: SlpInputSource.FILE,\n        filePath: input,\n      };\n    } else if (input instanceof Buffer) {\n      this.input = {\n        source: SlpInputSource.BUFFER,\n        buffer: input,\n      };\n    } else if (input instanceof ArrayBuffer) {\n      this.input = {\n        source: SlpInputSource.BUFFER,\n        buffer: Buffer.from(input),\n      };\n    } else {\n      throw new Error(\"Cannot create SlippiGame with input of that type\");\n    }\n\n    // Set up stats calculation\n    this.statsComputer = new Stats(opts);\n    this.statsComputer.register(\n      this.actionsComputer,\n      this.comboComputer,\n      this.conversionComputer,\n      this.inputComputer,\n      this.stockComputer,\n      this.targetBreakComputer,\n    );\n\n    this.parser = new SlpParser();\n    this.parser.on(SlpParserEvent.SETTINGS, (settings) => {\n      this.statsComputer.setup(settings);\n    });\n\n    // Use finalized frames for stats computation\n    this.parser.on(SlpParserEvent.FINALIZED_FRAME, (frame: FrameEntryType) => {\n      this.statsComputer.addFrame(frame);\n    });\n  }\n\n  private _process(shouldStop: EventCallbackFunc = () => false, file?: SlpFileType): void {\n    if (this.parser.getGameEnd() !== null) {\n      return;\n    }\n    const slpfile = file ?? openSlpFile(this.input);\n    // Generate settings from iterating through file\n    this.readPosition = iterateEvents(\n      slpfile,\n      (command, payload) => {\n        if (!payload) {\n          // If payload is falsy, keep iterating. The parser probably just doesn't know\n          // about this command yet\n          return false;\n        }\n        this.parser.handleCommand(command, payload);\n        return shouldStop(command, payload);\n      },\n      this.readPosition,\n    );\n    if (!file) {\n      closeSlpFile(slpfile);\n    }\n  }\n\n  /**\n   * Gets the game settings, these are the settings that describe the starting state of\n   * the game such as characters, stage, etc.\n   */\n  public getSettings(): GameStartType | null {\n    // Settings is only complete after post-frame update\n    this._process(() => this.parser.getSettings() !== null);\n    return this.parser.getSettings();\n  }\n\n  public getItems(): EnabledItemType[] | null {\n    this._process();\n    return this.parser.getItems();\n  }\n\n  public getLatestFrame(): FrameEntryType | null {\n    this._process();\n    return this.parser.getLatestFrame();\n  }\n\n  public getGameEnd(options: { skipProcessing?: boolean } = {}): GameEndType | null {\n    if (options?.skipProcessing) {\n      // Read game end block directly\n      const slpfile = openSlpFile(this.input);\n      const gameEnd = getGameEnd(slpfile);\n      closeSlpFile(slpfile);\n      return gameEnd;\n    }\n\n    this._process();\n    return this.parser.getGameEnd();\n  }\n\n  public getFrames(): FramesType {\n    this._process();\n    return this.parser.getFrames();\n  }\n\n  public getRollbackFrames(): RollbackFrames {\n    this._process();\n    return this.parser.getRollbackFrames();\n  }\n\n  public getGeckoList(): GeckoListType | null {\n    this._process(() => this.parser.getGeckoList() !== null);\n    return this.parser.getGeckoList();\n  }\n\n  public getStats(): StatsType | null {\n    if (this.finalStats) {\n      return this.finalStats;\n    }\n\n    this._process();\n\n    const settings = this.parser.getSettings();\n    if (!settings) {\n      return null;\n    }\n\n    // Finish processing if we're not up to date\n    this.statsComputer.process();\n    const inputs = this.inputComputer.fetch();\n    const stocks = this.stockComputer.fetch();\n    const conversions = this.conversionComputer.fetch();\n    const playableFrameCount = this.parser.getPlayableFrameCount();\n    const overall = generateOverallStats({ settings, inputs, conversions, playableFrameCount });\n\n    const gameEnd = this.parser.getGameEnd();\n    const gameComplete = gameEnd !== null;\n\n    const stats: StatsType = {\n      lastFrame: this.parser.getLatestFrameNumber(),\n      playableFrameCount,\n      stocks: stocks,\n      conversions: conversions,\n      combos: this.comboComputer.fetch(),\n      actionCounts: this.actionsComputer.fetch(),\n      overall: overall,\n      gameComplete,\n    };\n\n    if (gameComplete) {\n      // If the game is complete, store a cached version of stats because it should not\n      // change anymore. Ideally the statsCompuer.process and fetch functions would simply do no\n      // work in this case instead but currently the conversions fetch function,\n      // generateOverallStats, and maybe more are doing work on every call.\n      this.finalStats = stats;\n    }\n\n    return stats;\n  }\n\n  public getStadiumStats(): StadiumStatsType | null {\n    this._process();\n\n    const settings = this.parser.getSettings();\n    if (!settings) {\n      return null;\n    }\n\n    const latestFrame = this.parser.getLatestFrame();\n    const players = latestFrame?.players;\n\n    if (!players) {\n      return null;\n    }\n\n    this.statsComputer.process();\n\n    switch (settings.gameMode) {\n      case GameMode.TARGET_TEST:\n        return {\n          type: \"target-test\",\n          targetBreaks: this.targetBreakComputer.fetch(),\n        };\n      case GameMode.HOME_RUN_CONTEST:\n        const distanceInfo = extractDistanceInfoFromFrame(settings, latestFrame);\n        if (!distanceInfo) {\n          return null;\n        }\n\n        return {\n          type: \"home-run-contest\",\n          distance: distanceInfo.distance,\n          units: distanceInfo.units,\n        };\n      default:\n        return null;\n    }\n  }\n\n  public getMetadata(): MetadataType | null {\n    if (this.metadata) {\n      return this.metadata;\n    }\n    const slpfile = openSlpFile(this.input);\n    this.metadata = getMetadata(slpfile);\n    closeSlpFile(slpfile);\n    return this.metadata;\n  }\n\n  public getFilePath(): string | null {\n    if (this.input.source !== SlpInputSource.FILE) {\n      return null;\n    }\n\n    return this.input.filePath ?? null;\n  }\n\n  public getWinners(): PlacementType[] {\n    // Read game end block directly\n    const slpfile = openSlpFile(this.input);\n    const gameEnd = getGameEnd(slpfile);\n    this._process(() => this.parser.getSettings() !== null, slpfile);\n    const settings = this.parser.getSettings();\n    if (!gameEnd || !settings) {\n      // Technically using the final post frame updates, it should be possible to compute winners for\n      // replays without a gameEnd message. But I'll leave this here anyway\n      closeSlpFile(slpfile);\n      return [];\n    }\n\n    // If we went to time, let's fetch the post frame updates to compute the winner\n    let finalPostFrameUpdates: PostFrameUpdateType[] = [];\n    if (gameEnd.gameEndMethod === GameEndMethod.TIME) {\n      finalPostFrameUpdates = extractFinalPostFrameUpdates(slpfile);\n    }\n\n    closeSlpFile(slpfile);\n    return getWinners(gameEnd, settings, finalPostFrameUpdates);\n  }\n}\n"],"names":["getDeathDirection","actionStateId","DEFAULT_COLOR","UnknownCharacter","id","name","shortName","colors","generateCharacterInfo","info","getAllCharacters","Object","entries","characters","map","data","parseInt","sort","a","b","getCharacterInfo","externalCharacterId","toString","getCharacterShortName","character","getCharacterName","getCharacterColorName","characterColor","color","UnknownMove","getMoveInfo","moveId","moveName","moveNames","getMoveShortName","move","getMoveName","UnknownStage","getStageInfo","stageId","stageName","stageNames","getStageName","stage","Character","Stage","State","Timers","PUNISH_RESET_FRAMES","RECOVERY_RESET_FRAMES","COMBO_STRING_RESET_FRAMES","getSinglesPlayerPermutationsFromSettings","settings","players","length","playerIndex","opponentIndex","didLoseStock","frame","prevFrame","stocksRemaining","isInControl","state","ground","GROUNDED_CONTROL_START","GROUNDED_CONTROL_END","squat","SQUAT_START","SQUAT_END","groundAttack","GROUND_ATTACK_START","GROUND_ATTACK_END","isGrab","GRAB","isTeching","TECH_START","TECH_END","isDown","DOWN_START","DOWN_END","isDamaged","DAMAGE_START","DAMAGE_END","DAMAGE_FALL","JAB_RESET_UP","JAB_RESET_DOWN","isGrabbed","CAPTURE_START","CAPTURE_END","isCommandGrabbed","COMMAND_GRAB_RANGE1_START","COMMAND_GRAB_RANGE1_END","COMMAND_GRAB_RANGE2_START","COMMAND_GRAB_RANGE2_END","BARREL_WAIT","isDead","DYING_START","DYING_END","calcDamageTaken","percent","prevPercent","dashDanceAnimations","DASH","TURN","ActionsComputer","playerPermutations","Array","Map","setup","forEach","indices","playerCounts","wavedashCount","wavelandCount","airDodgeCount","dashDanceCount","spotDodgeCount","ledgegrabCount","rollCount","lCancelCount","success","fail","attackCount","jab1","jab2","jab3","jabm","dash","ftilt","utilt","dtilt","fsmash","usmash","dsmash","nair","fair","bair","uair","dair","grabCount","throwCount","up","forward","back","down","groundTechCount","away","in","neutral","wallTechCount","playerState","animations","actionFrameCounters","set","processFrame","get","handleActionCompute","fetch","from","values","val","isMissGroundTech","animation","TECH_MISS_DOWN","TECH_MISS_UP","isRolling","ROLL_BACKWARD","ROLL_FORWARD","isGrabAction","THROW_DOWN","DASH_GRAB","isGrabbing","isAerialAttack","AERIAL_ATTACK_START","AERIAL_ATTACK_END","isForwardTilt","ATTACK_FTILT_START","ATTACK_FTILT_END","isForwardSmash","ATTACK_FSMASH_START","ATTACK_FSMASH_END","playerFrame","post","opponentFrame","incrementCount","field","condition","current","currentAnimation","push","currentFrameCounter","actionStateCounter","last3Frames","slice","prevAnimation","prevFrameCounter","isNewAction","didDashDance","isEqual","SPOT_DODGE","AIR_DODGE","CLIFF_CATCH","ATTACK_DASH","ATTACK_JAB1","ATTACK_JAB2","ATTACK_JAB3","ATTACK_JABM","ATTACK_UTILT","ATTACK_DTILT","ATTACK_USMASH","ATTACK_DSMASH","AERIAL_NAIR","AERIAL_FAIR","AERIAL_BAIR","AERIAL_UAIR","AERIAL_DAIR","internalCharacterId","GNW_JAB1","GNW_JABM","GNW_DTILT","GNW_FSMASH","GNW_NAIR","GNW_BAIR","GNW_UAIR","PEACH_FSMASH1","PEACH_FSMASH2","PEACH_FSMASH3","THROW_UP","THROW_FORWARD","THROW_BACK","opponentDir","positionX","facingOpponent","facingDirection","FORWARD_TECH","BACKWARD_TECH","NEUTRAL_TECH","WALL_TECH","MISSED_WALL_TECH","lCancelStatus","handleActionWavedash","counts","last","isSpecialLanding","LANDING_FALL_SPECIAL","isAcceptablePrevious","isWavedashInitiationAnimation","isPossibleWavedash","recentFrames","recentAnimations","keyBy","size","ACTION_KNEE_BEND","isAboveMin","CONTROLLED_JUMP_START","isBelowMax","CONTROLLED_JUMP_END","ComboEvent","ComboComputer","EventEmitter","combos","combo","resetCounter","lastHitAnimation","event","allFrames","handleComboCompute","emit","frames","currentFrameNumber","prevFrameNumber","prevPlayerFrame","prevOpponentFrame","oppActionStateId","opntIsDamaged","opntIsGrabbed","opntIsCommandGrabbed","opntDamageTaken","actionChangedSinceHit","actionCounter","prevActionCounter","actionFrameCounterReset","comboStarted","startFrame","endFrame","startPercent","currentPercent","endPercent","moves","didKill","lastHitBy","lastAttackLanded","hitCount","damage","COMBO_EXTEND","COMBO_START","opntIsTeching","opntIsDowned","opntDidLoseStock","opntIsDying","shouldTerminate","COMBO_END","ConversionComputer","constructor","conversions","metadata","lastEndFrameByOppIdx","conversion","terminated","handleConversionCompute","_populateConversionTypes","conversionsToHandle","filter","openingType","groupedConversions","groupBy","sortedConversions","orderBy","isTrade","lastMove","oppEndFrame","isCounterAttack","opntInControl","shouldStartResetCounter","shouldContinueResetCounter","Command","GameMode","Language","TimerType","ItemSpawnType","EnabledItemType","GameEndMethod","Frames","JoystickRegion","InputComputer","inputCount","joystickInputCount","cstickInputCount","buttonInputCount","triggerInputCount","handleInputCompute","pre","FIRST_PLAYABLE","invertedPreviousButtons","physicalButtons","currentButtons","buttonChanges","newInputsPressed","countSetBits","prevAnalogRegion","getJoystickRegion","joystickX","joystickY","currentAnalogRegion","DZ","prevCstickRegion","cStickX","cStickY","currentCstickRegion","physicalLTrigger","physicalRTrigger","x","bits","count","y","region","NE","SE","SW","NW","N","E","S","W","generateOverallStats","inputs","playableFrameCount","inputsByPlayer","originalConversions","conversionsByPlayer","conv","conversionsByPlayerByOpening","mapValues","gameMinutes","overall","player","playerInputs","inputCounts","buttons","triggers","cstick","joystick","total","conversionCount","successfulConversionCount","opponentIndices","opp","isTeams","teamId","totalDamage","killCount","successfulConversions","getRatio","inputsPerMinute","digitalInputsPerMinute","openingsPerKill","damagePerOpening","neutralWinRatio","getOpeningRatio","counterHitRatio","beneficialTradeRatio","getBeneficialTradeRatio","ratio","type","openings","opponentOpenings","flatten","playerTrades","opponentTrades","benefitsPlayer","zippedTrades","zip","conversionPair","playerConversion","first","opponentConversion","playerDamage","opponentDamage","defaultOptions","processOnTheFly","Stats","options","lastProcessedFrame","allComputers","assign","v","comp","register","computer","process","i","FIRST","isCompletedFrame","addFrame","playerPostFrame","StockComputer","stocks","stock","handleStockCompute","isPlayerDead","deathAnimation","exists","value","TARGET_ITEM_TYPE_ID","TargetBreakComputer","targetBreaks","isTargetTestGame","gameMode","TARGET_TEST","handleTargetBreak","targets","items","item","typeId","target","spawnId","frameDestroyed","positionY","currentTargets","previousTargets","currentTargetIds","previousTargetIds","brokenTargetIds","includes","targetBreak","find","frameToGameTimer","timerType","startingTimerSeconds","DECREASING","centiseconds","Math","ceil","date","Date","format","INCREASING","floor","CommunicationType","ConsoleCommunication","receiveBuf","Buffer","messages","receive","concat","msgSize","readUInt32BE","ubjsonData","decode","getReceiveBuffer","getMessages","toReturn","genHandshakeOut","cursor","clientToken","isRealtime","clientTokenBuf","writeUInt32BE","message","HANDSHAKE","payload","Uint8Array","buf","encode","optimizeArrays","msg","byteLength","ConnectionEvent","ConnectionStatus","Ports","NETWORK_MESSAGE","DEFAULT_CONNECTION_TIMEOUT_MS","CommunicationState","defaultConnectionDetails","consoleNick","gameDataCursor","version","consoleConnectionOptions","autoReconnect","ConsoleConnection","ipAddress","port","connectionStatus","DISCONNECTED","connDetails","client","connection","shouldReconnect","DEFAULT","getStatus","getSettings","getDetails","connect","ip","timeout","_connectOnPort","reconnect","inject","net","host","_setStatus","CONNECTING","consoleComms","initialDelay","maxDelay","strategy","failAfter","Infinity","CONNECT","commState","INITIAL","on","_getInitialCommState","console","log","CONNECTED","LEGACY","_handleReplayData","err","error","prevDataBuf","rcvData","destroy","ERROR","_processMessage","warn","handshakeMsgOut","write","setConnectingStatus","RECONNECT_WAIT","disconnect","openingBytes","dataStart","equals","NORMAL","MESSAGE","KEEP_ALIVE","fakeKeepAlive","REPLAY","readPos","pos","cmp","compare","forcePos","Error","nextPos","nick","nintendontVersion","tokenBuf","DATA","status","STATUS_CHANGE","MAX_PEERS","DolphinMessageType","DolphinConnection","gameCursor","nickname","peer","enet","createClient","peers","channels","address","newPeer","ping","request","packet","Packet","JSON","stringify","PACKET_FLAG","RELIABLE","send","dataString","parse","dolphin_closed","CONNECT_REPLY","GAME_EVENT","_updateCursor","gameData","START_GAME","END_GAME","next_cursor","toHalfwidth","str","convertChar","charCode","ret","char","charCodeAt","String","fromCharCode","SlpInputSource","getRef","input","source","FILE","filePath","fd","fs","openSync","fileDescriptor","BUFFER","buffer","readRef","ref","offset","position","readSync","copy","getLenRef","fileStats","fstatSync","openSlpFile","rawDataPosition","getRawDataPosition","rawDataLength","getRawDataLength","metadataPosition","metadataLength","getMetadataLength","messageSizes","getMessageSizes","closeSlpFile","file","closeSync","fileSize","rawDataLen","len","MESSAGE_SIZES","payloadLength","messageSizesBuffer","command","getEnabledItems","view","offsets","enabledItems","reduce","acc","byteOffset","index","byte","readUint8","getGameInfoBlock","gameBitfield1","gameBitfield2","gameBitfield3","gameBitfield4","bombRainEnabled","itemSpawnBehavior","readInt8","selfDestructScoreValue","itemSpawnBitfield1","itemSpawnBitfield2","itemSpawnBitfield3","itemSpawnBitfield4","itemSpawnBitfield5","damageRatio","readFloat","iterateEvents","slpFile","callback","startPos","readPosition","stopReadingAt","commandPayloadBuffers","splitMessageBuffer","commandByteBuffer","commandByte","undefined","advanceAmount","SPLIT_MESSAGE","DataView","readUint16","isLastMessage","readBool","internalCommand","appendBuf","mergedBuf","parsedPayload","parseMessage","shouldStop","GAME_START","getPlayerObject","cfOffset","dashback","readUint32","shieldDrop","controllerFix","nametagLength","nametagOffset","nametagStart","nametagBuf","nameTagString","iconv","split","shift","nametag","displayNameLength","displayNameOffset","displayNameStart","displayNameBuf","displayNameString","displayName","connectCodeLength","connectCodeOffset","connectCodeStart","connectCodeBuf","connectCodeString","connectCode","userIdLength","userIdOffset","userIdStart","userIdBuf","userIdString","userId","characterId","startStocks","teamShade","handicap","staminaMode","Boolean","silentCharacter","lowGravity","invisible","blackStockIcon","metal","startOnAngelPlatform","rumbleEnabled","cpuLevel","offenseRatio","defenseRatio","modelScale","matchIdLength","matchIdStart","matchIdBuf","matchIdString","matchId","slpVersion","inGameMode","friendlyFireEnabled","scene","language","gameInfoBlock","randomSeed","isPAL","isFrozenPS","matchInfo","gameNumber","tiebreakerNumber","FRAME_START","readInt32","seed","sceneFrameCounter","PRE_FRAME_UPDATE","isFollower","trigger","rawJoystickX","POST_FRAME_UPDATE","selfInducedSpeeds","airX","attackX","attackY","groundX","shieldSize","currentComboCount","miscActionState","isAirborne","lastGroundId","jumpsRemaining","hurtboxCollisionState","hitlagRemaining","animationIndex","ITEM_UPDATE","velocityX","velocityY","damageTaken","expirationTimer","missileType","turnipFace","chargeShotLaunched","chargePower","owner","FRAME_BOOKEND","latestFinalizedFrame","GAME_END","placements","gameEndMethod","lrasInitiatorIndex","GECKO_LIST","codes","word1","codetype","lineCount","byteLen","contents","canReadFromView","viewLength","getFloat32","getInt32","getInt8","getUint32","getUint16","bitmask","getUint8","getMetadata","ex","getGameEnd","gameEndPayloadSize","gameEndSize","gameEndPosition","gameEndMessage","extractFinalPostFrameUpdates","postFramePayloadSize","frameBookendPayloadSize","postFrameSize","frameBookendSize","frameNum","postFramePosition","postFrameUpdates","postFrameMessage","unshift","SlpStreamMode","defaultSettings","suppressErrors","mode","AUTO","SlpStreamEvent","SlpStream","Writable","slpOptions","opts","gameEnded","payloadSizes","previousBuffer","restart","_write","newData","encoding","dataView","payloadSize","remainingLen","MANUAL","payloadPtr","payloadDataView","payloadLen","_processCommand","_writeCommand","entirePayload","payloadBuf","bufToWrite","RAW","processReceiveCommands","COMMAND","DEFAULT_NICKNAME","SlpFile","slpStream","fileStream","usesExternalStream","consoleNickname","startTime","lastFrame","_setupListeners","_initializeNewGame","path","setMetadata","chunk","_onCommand","characterUsage","names","netplay","code","prevPlayer","curCharFrames","streamListener","writeSync","createUInt32Buffer","removeListener","end","createWriteStream","header","_final","footer","startTimeStr","toISOString","createInt32Buffer","usage","internalId","number","alloc","writeInt32BE","getNewFilePath","folder","join","outputFiles","folderPath","newFilename","SlpFileWriterEvent","SlpFileWriter","currentFile","_writePayload","_handleNewGame","_handleEndGame","getCurrentFilename","resolve","endCurrentFile","updateSettings","NEW_FILE","FILE_COMPLETE","RollbackCounter","rollbackFrames","rollbackFrameCount","rollbackPlayerIdx","lastFrameWasRollback","currentRollbackLength","rollbackLengths","checkIfRollbackFrame","currentFrame","playerIdx","getFrames","getCount","getLengths","ITEM_SETTINGS_BIT_COUNT","MAX_ROLLBACK_FRAMES","SlpParserEvent","defaultSlpParserOptions","strict","SlpParser","rollbackCounter","gameEnd","latestFrameIndex","settingsComplete","lastFinalizedFrame","geckoList","handleCommand","_handleGameStart","_handleFrameStart","_handlePostFrameUpdate","_handleFrameUpdate","_handleItemUpdate","_handleFrameBookend","_handleGameEnd","_handleGeckoList","reset","getLatestFrameNumber","getPlayableFrameCount","getLatestFrame","frameIndex","indexToUse","getItems","OFF","itemBitfield","getRollbackFrames","lengths","getFrame","num","getGeckoList","_finalizeFrames","END","semver","gte","_completeSettings","playersByIndex","location","wasRolledback","ROLLBACK_FRAME","lte","FRAME","validLatestFrame","ONLINE","frameToFinalize","playerFrameInfo","preOrPost","FINALIZED_FRAME","SETTINGS","getWinners","finalPostFrameUpdates","NO_CONTEST","UNRESOLVED","winnerIndex","TIME","nonFollowerUpdates","pfu","p1","p2","p1Health","trunc","p2Health","firstPosition","placement","winningTeam","SANDBAG_INTERNAL_ID","FEET_CONVERSION_FACTOR","METERS_CONVERSION_FACTOR","positionToHomeRunDistance","distance","units","score","fround","round","max","extractDistanceInfoFromFrame","sandbagLastFrame","JAPANESE","SlippiGame","finalStats","parser","actionsComputer","conversionComputer","comboComputer","stockComputer","inputComputer","targetBreakComputer","statsComputer","ArrayBuffer","_process","slpfile","skipProcessing","getStats","gameComplete","stats","actionCounts","getStadiumStats","latestFrame","HOME_RUN_CONTEST","distanceInfo","getFilePath"],"mappings":"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"}