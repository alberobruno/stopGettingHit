Object.defineProperty(exports,"t",{value:!0});class t{constructor(t={}){this.i=t,this.h=new("undefined"!=typeof TextEncoder?TextEncoder:require("util").TextEncoder)}encode(t){const r=this.u(t),e=r.reduce(((t,r)=>t+r.byteLength),0),s=new Uint8Array(e),i={array:s,view:new DataView(s.buffer)};let n=0;for(const t of r)t.storer(i,n),n+=t.byteLength;return s.buffer}u(t){const r=this.o(t);return[this.l(r),...this.p(t,r)]}p(t,r){let e,s;switch(r){case"C":return e=t.charCodeAt(),[this.A((({view:t},r)=>t.setInt8(r,e)),1)];case"S":return s=this.h.encode(t),[...this.u(s.byteLength),this._(s)];case"i":return[this.A((({view:r},e)=>r.setInt8(e,t)),1)];case"U":return[this.A((({view:r},e)=>r.setUint8(e,t)),1)];case"I":return[this.A((({view:r},e)=>r.setInt16(e,t)),2)];case"l":return[this.A((({view:r},e)=>r.setInt32(e,t)),4)];case"d":return[this.A((({view:r},e)=>r.setFloat32(e,t)),4)];case"D":return[this.A((({view:r},e)=>r.setFloat64(e,t)),8)];case"[":return this.v(t);case"{":return this.I(t)}return[]}o(t){if(null===t)return"Z";switch(typeof t){case"undefined":return"N";case"boolean":return t?"T":"F";case"string":return 1===t.length&&t.charCodeAt()<=127?"C":"S";case"number":if(Number.isInteger(t)){if(-128<=t&&t<=127)return"i";if(0<=t&&t<=255)return"U";if(-32768<=t&&t<=32767)return"I";if(-2147483648<=t&&t<=2147483647)return"l"}return Number.isNaN(t)||Math.fround(t)===t?"d":"D";case"object":return Array.isArray(t)||ArrayBuffer.isView(t)?"[":"{"}throw Error("Value cannot be serialized")}v(t){let r;if((!0===this.i.optimizeArrays||"onlyTypedArrays"===this.i.optimizeArrays)&&ArrayBuffer.isView(t))switch(t.constructor.name){case"Int8Array":return[].concat(this.U("i",t.length),this._(t));case"Uint8Array":return[].concat(this.U("U",t.length),this._(t));case"Int16Array":r="I";break;case"Int32Array":r="l";break;case"Float32Array":r="d";break;case"Float64Array":r="D"}const e=(Array.isArray(t)?t:Array.from(t)).map((t=>({type:r||this.o(t),value:t})));return this.k(e,"]",r||!0===this.i.optimizeArrays)}I(t){const r=Object.entries(t).map((t=>({key:t[0],type:this.o(t[1]),value:t[1]})));return this.k(r,"}",!0===this.i.optimizeObjects)}U(t,r){const e=[];return null!=r&&(t&&e.push(this.l("$"),this.l(t)),e.push(this.l("#"),...this.u(r))),e}k(t,r,e){let s,i;e&&(t.length&&(s=this.T(t)),i=t.length);const n=this.U(s,i);for(const r of t)null!=r.key&&"N"!==r.type&&n.push(...this.p(r.key,"S")),!s&&n.push(this.l(r.type)),n.push(...this.p(r.value,s||r.type));return null==i&&n.push(this.l(r)),n}T(t){const r=t.map((t=>t.type)).reduce(this.g);return"U"===r&&t.some((t=>t.value<0))?"I":r}g(t,r){if(t===r)return t;if(!t)return null;const e=e=>e[Math.min(e.indexOf(t),e.indexOf(r))];return e("Dd")||e("SC")||e("lIUi")}l(t){return this.A((({view:r},e)=>r.setInt8(e,t.charCodeAt())),1)}_(t){return this.A((({array:r},e)=>r.set(t,e)),t.byteLength)}A(t,r){return{storer:t,byteLength:r}}}class r{constructor(t={}){this.i=t,this.D=new("undefined"!=typeof TextDecoder?TextDecoder:require("util").TextDecoder)}decode(t){const r=new Uint8Array(t),e=new DataView(r.buffer);return this.S={array:r,view:e},this.C=0,this.m()}m(t=this.F(!1)){switch(t){case"Z":return null;case"N":return;case"T":return!0;case"F":return!1;case"i":return this.N((({view:t},r)=>t.getInt8(r)),1);case"U":return this.N((({view:t},r)=>t.getUint8(r)),1);case"I":return this.N((({view:t},r)=>t.getInt16(r)),2);case"l":return this.N((({view:t},r)=>t.getInt32(r)),4);case"L":return this.j(8,this.i.int64Handling,!0);case"d":return this.N((({view:t},r)=>t.getFloat32(r)),4);case"D":return this.N((({view:t},r)=>t.getFloat64(r)),8);case"H":return this.j(this.M(),this.i.highPrecisionNumberHandling,!1);case"C":return String.fromCharCode(this.m("i"));case"S":return this.O(this.M());case"[":return this.V();case"{":return this.Z()}throw Error("Unexpected type")}q(){let t,r;switch(this.F(!0)){case"$":if(this.B(),t=this.F(!1),"#"!==this.F(!0))throw Error("Expected count marker");case"#":this.B(),r=this.M()}return{type:t,count:r}}V(){const{type:t,count:r}=this.q();if(-1!=="ZTF".indexOf(t))return Array(r).fill(this.m(t));if(this.i.useTypedArrays)switch(t){case"i":return this.L(r);case"U":return this.R(r);case"I":return Int16Array.from({length:r},(()=>this.m(t)));case"l":return Int32Array.from({length:r},(()=>this.m(t)));case"d":return Float32Array.from({length:r},(()=>this.m(t)));case"D":return Float64Array.from({length:r},(()=>this.m(t)))}if(null!=r){const e=Array(r);for(let s=0;s<r;s++)e[s]=this.m(t);return e}{const t=[];for(;"]"!==this.F(!0);)t.push(this.m());return this.B(),t}}Z(){const{type:t,count:r}=this.q(),e={};if(null!=r)for(let s=0;s<r;s++)e[this.m("S")]=this.m(t);else{for(;"}"!==this.F(!0);)e[this.m("S")]=this.m();this.B()}return e}M(){const t=this.m();if(Number.isInteger(t)&&t>=0)return t;throw Error("Invalid length/count")}j(t,r,e){if("function"==typeof r)return this.N(r,t);switch(r){case"skip":return void this.B(t);case"raw":return e?this.R(t):this.O(t)}throw Error("Unsuported type")}R(t){return this.N((({array:r},e)=>new Uint8Array(r.buffer,e,t)),t)}L(t){return this.N((({array:r},e)=>new Int8Array(r.buffer,e,t)),t)}O(t){return this.N((({array:r},e)=>this.D.decode(new DataView(r.buffer,e,t))),t)}B(t=1){this.$(t),this.C+=t}F(t){const{array:r,view:e}=this.S;let s="N";for(;"N"===s&&this.C<r.byteLength;)s=String.fromCharCode(e.getInt8(this.C++));return t&&this.C--,s}N(t,r){this.$(r);const e=t(this.S,this.C,r);return this.C+=r,e}$(t){if(this.C+t>this.S.array.byteLength)throw Error("Unexpected EOF")}}function e(r,e){return new t(e).encode(r)}function s(t,e){return new r(e).decode(t)}const i={encode:e,decode:s};exports.Ubjson=i,exports.UbjsonDecoder=r,exports.UbjsonEncoder=t,exports.decode=s,exports.encode=e;
//# sourceMappingURL=ubjson.js.map
